<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Preprocesamiento y visualización - Estacionariedad, ACF/PACF, STL, ARIMA, Puntos de cambio y Pronóstico | Propuesta de serie de tiempo: Predicción de demanda eléctrica a corto plazo</title>
  <meta name="description" content="4 Preprocesamiento y visualización - Estacionariedad, ACF/PACF, STL, ARIMA, Puntos de cambio y Pronóstico | Propuesta de serie de tiempo: Predicción de demanda eléctrica a corto plazo" />
  <meta name="generator" content="bookdown 0.45 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Preprocesamiento y visualización - Estacionariedad, ACF/PACF, STL, ARIMA, Puntos de cambio y Pronóstico | Propuesta de serie de tiempo: Predicción de demanda eléctrica a corto plazo" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Preprocesamiento y visualización - Estacionariedad, ACF/PACF, STL, ARIMA, Puntos de cambio y Pronóstico | Propuesta de serie de tiempo: Predicción de demanda eléctrica a corto plazo" />
  
  
  

<meta name="author" content="Fredy A. Ordoñez · Oscar F. Velásquez · José L. Sánchez" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Presentación del Bookdown</a></li>
<li class="chapter" data-level="2" data-path="propuesta.html"><a href="propuesta.html"><i class="fa fa-check"></i><b>2</b> Propuesta de serie de tiempo: Predicción de demanda eléctrica a corto plazo</a>
<ul>
<li class="chapter" data-level="2.1" data-path="propuesta.html"><a href="propuesta.html#qu%C3%A9-voy-a-pronosticar"><i class="fa fa-check"></i><b>2.1</b> ¿Qué voy a pronosticar?</a></li>
<li class="chapter" data-level="2.2" data-path="propuesta.html"><a href="propuesta.html#por-qu%C3%A9-es-importante"><i class="fa fa-check"></i><b>2.2</b> ¿Por qué es importante?</a></li>
<li class="chapter" data-level="2.3" data-path="propuesta.html"><a href="propuesta.html#fuente-de-datos-y-permisos"><i class="fa fa-check"></i><b>2.3</b> Fuente de datos y permisos</a></li>
<li class="chapter" data-level="2.4" data-path="propuesta.html"><a href="propuesta.html#impacto-esperado"><i class="fa fa-check"></i><b>2.4</b> Impacto esperado</a></li>
<li class="chapter" data-level="2.5" data-path="propuesta.html"><a href="propuesta.html#referencias"><i class="fa fa-check"></i><b>2.5</b> Referencias</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><i class="fa fa-check"></i><b>3</b> Análisis de Serie de Tiempo: Potencia Eléctrica Horaria</a>
<ul>
<li class="chapter" data-level="3.1" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#contexto-y-objetivos"><i class="fa fa-check"></i><b>3.1</b> Contexto y objetivos</a></li>
<li class="chapter" data-level="3.2" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#cargue-de-librer%C3%ADas"><i class="fa fa-check"></i><b>3.2</b> Cargue de Librerías</a></li>
<li class="chapter" data-level="3.3" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#lectura-y-preparaci%C3%B3n-de-los-datos"><i class="fa fa-check"></i><b>3.3</b> Lectura y preparación de los datos</a></li>
<li class="chapter" data-level="3.4" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#funciones-auxiliares-de-visualizaci%C3%B3n-de-la-serie-de-tiempo"><i class="fa fa-check"></i><b>3.4</b> Funciones auxiliares de visualización de la serie de tiempo</a></li>
<li class="chapter" data-level="3.5" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#vista-general-del-comportamiento-de-la-potencia-el%C3%A9ctrica-por-escalas-diaria-semanal-mensual-anual"><i class="fa fa-check"></i><b>3.5</b> Vista general del comportamiento de la potencia eléctrica por escalas (diaria, semanal, mensual, anual)</a></li>
<li class="chapter" data-level="3.6" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#curvas-de-potencia-el%C3%A9ctrica-por-periodo-d%C3%ADa-semana-mes-a%C3%B1o"><i class="fa fa-check"></i><b>3.6</b> Curvas de potencia eléctrica por periodo (día, semana, mes, año)</a></li>
<li class="chapter" data-level="3.7" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#promedios-m%C3%B3viles"><i class="fa fa-check"></i><b>3.7</b> Promedios móviles</a></li>
<li class="chapter" data-level="3.8" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#rezagos-lags-y-autocorrelaci%C3%B3n"><i class="fa fa-check"></i><b>3.8</b> Rezagos (lags) y autocorrelación</a></li>
<li class="chapter" data-level="3.9" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#estacionalidad-gr%C3%A1ficos-y-descomposici%C3%B3n"><i class="fa fa-check"></i><b>3.9</b> Estacionalidad (gráficos y descomposición)</a></li>
<li class="chapter" data-level="3.10" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#indicadores-resumidos"><i class="fa fa-check"></i><b>3.10</b> Indicadores resumidos</a></li>
<li class="chapter" data-level="3.11" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#conclusiones"><i class="fa fa-check"></i><b>3.11</b> Conclusiones</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html"><i class="fa fa-check"></i><b>4</b> Preprocesamiento y visualización - Estacionariedad, ACF/PACF, STL, ARIMA, Puntos de cambio y Pronóstico</a>
<ul>
<li class="chapter" data-level="4.1" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#resumen"><i class="fa fa-check"></i><b>4.1</b> Resumen</a></li>
<li class="chapter" data-level="4.2" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#carga-de-librer%C3%ADas"><i class="fa fa-check"></i><b>4.2</b> Carga de librerías</a></li>
<li class="chapter" data-level="4.3" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#carga-de-datos-y-visualizaci%C3%B3n"><i class="fa fa-check"></i><b>4.3</b> Carga de datos y visualización</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#bandas-para-huecos-na-y-vistas-multiescala"><i class="fa fa-check"></i><b>4.3.1</b> Bandas para huecos (NA) y vistas multiescala</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#estacionariedad-prueba-adf-augmented-dickey-fuller-test-y-diferenciaci%C3%B3n"><i class="fa fa-check"></i><b>4.4</b> Estacionariedad: prueba ADF (Augmented Dickey-Fuller Test) y diferenciación</a></li>
<li class="chapter" data-level="4.5" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#acf-y-pacf-original-y-diferenciada"><i class="fa fa-check"></i><b>4.5</b> ACF y PACF (original y diferenciada)</a></li>
<li class="chapter" data-level="4.6" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#descomposici%C3%B3n-stl-seasonal-trend-decomposition-using-loess-y-mstl-multiple-seasonal-trend-decomposition-using-loess"><i class="fa fa-check"></i><b>4.6</b> Descomposición STL (Seasonal-Trend decomposition using Loess) y MSTL (Multiple Seasonal-Trend decomposition using Loess)</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#descomposici%C3%B3n-de-la-serie-por-estacionalidades"><i class="fa fa-check"></i><b>4.6.1</b> Descomposición de la serie por estacionalidades</a></li>
<li class="chapter" data-level="4.6.2" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#descomposici%C3%B3n-de-la-serie-en-una-ventana-de-4-semanas"><i class="fa fa-check"></i><b>4.6.2</b> Descomposición de la serie en una ventana de 4 semanas</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#selecci%C3%B3n-del-modelo-eficiente-auto.arima-y-pron%C3%B3stico"><i class="fa fa-check"></i><b>4.7</b> Selección del modelo eficiente (auto.arima) y Pronóstico</a>
<ul>
<li class="chapter" data-level="4.7.1" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#zoom-al-pron%C3%B3stico"><i class="fa fa-check"></i><b>4.7.1</b> Zoom al Pronóstico</a></li>
</ul></li>
<li class="chapter" data-level="4.8" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#puntos-de-cambio-y-visualizaci%C3%B3n"><i class="fa fa-check"></i><b>4.8</b> Puntos de cambio y visualización</a></li>
<li class="chapter" data-level="4.9" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#outliers-y-verificaci%C3%B3n-de-supuestos-del-arima"><i class="fa fa-check"></i><b>4.9</b> Outliers y verificación de supuestos del ARIMA</a>
<ul>
<li class="chapter" data-level="4.9.1" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#qq-plot-de-los-residuos-del-modelo-arima"><i class="fa fa-check"></i><b>4.9.1</b> Q–Q Plot de los residuos del modelo ARIMA</a></li>
</ul></li>
<li class="chapter" data-level="4.10" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#transformaci%C3%B3n-logar%C3%ADtmica-para-estabilizar-la-varianza"><i class="fa fa-check"></i><b>4.10</b> Transformación logarítmica para estabilizar la varianza</a></li>
<li class="chapter" data-level="4.11" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#ajuste-del-modelo-arima-en-escala-logar%C3%ADtmica"><i class="fa fa-check"></i><b>4.11</b> Ajuste del modelo ARIMA en escala logarítmica</a></li>
<li class="chapter" data-level="4.12" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#verificaci%C3%B3n-de-supuestos-del-nuevo-modelo"><i class="fa fa-check"></i><b>4.12</b> Verificación de supuestos del nuevo modelo</a></li>
<li class="chapter" data-level="4.13" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#pron%C3%B3stico-con-el-modelo-mejorado-escala-logar%C3%ADtmica"><i class="fa fa-check"></i><b>4.13</b> Pronóstico con el modelo mejorado (escala logarítmica)</a>
<ul>
<li class="chapter" data-level="4.13.1" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#reconversi%C3%B3n-a-escala-original-exponencial-inversa"><i class="fa fa-check"></i><b>4.13.1</b> Reconversión a escala original (exponencial inversa)</a></li>
</ul></li>
<li class="chapter" data-level="4.14" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#conclusiones-1"><i class="fa fa-check"></i><b>4.14</b> Conclusiones</a>
<ul>
<li class="chapter" data-level="4.14.1" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#resumen-de-tiempos-de-ejecuci%C3%B3n-del-c%C3%B3digo"><i class="fa fa-check"></i><b>4.14.1</b> Resumen de tiempos de ejecución del código</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Propuesta de serie de tiempo: Predicción de demanda eléctrica a corto plazo</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="Preprocesamiento" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">4</span> Preprocesamiento y visualización - Estacionariedad, ACF/PACF, STL, ARIMA, Puntos de cambio y Pronóstico<a href="Preprocesamiento.html#Preprocesamiento" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="resumen" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Resumen<a href="Preprocesamiento.html#resumen" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Este cápitulo presenta una interpretación detallada de los resultados de Preprocesamiento y visualización de la serie temporal horaria de potencia. Se describen los patrones de tendencia y estacionalidad a distintas escalas (diaria, semanal, mensual y anual), la verificación/inducción de estacionariedad (diferenciación), el análisis ACF/PACF, la descomposición STL/MSTL, la detección de puntos de cambio, la identificación de outliers, el ajuste SARIMA (auto.arima) y el pronóstico.</p>
</div>
<div id="carga-de-librerías" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Carga de librerías<a href="Preprocesamiento.html#carga-de-librer%C3%ADas" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="Preprocesamiento.html#cb39-1" tabindex="-1"></a><span class="fu">library</span>(readr) </span>
<span id="cb39-2"><a href="Preprocesamiento.html#cb39-2" tabindex="-1"></a><span class="fu">library</span>(dplyr) </span>
<span id="cb39-3"><a href="Preprocesamiento.html#cb39-3" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb39-4"><a href="Preprocesamiento.html#cb39-4" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb39-5"><a href="Preprocesamiento.html#cb39-5" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb39-6"><a href="Preprocesamiento.html#cb39-6" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb39-7"><a href="Preprocesamiento.html#cb39-7" tabindex="-1"></a><span class="fu">library</span>(zoo)</span>
<span id="cb39-8"><a href="Preprocesamiento.html#cb39-8" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb39-9"><a href="Preprocesamiento.html#cb39-9" tabindex="-1"></a><span class="fu">library</span>(tseries)</span>
<span id="cb39-10"><a href="Preprocesamiento.html#cb39-10" tabindex="-1"></a><span class="fu">library</span>(changepoint)</span></code></pre></div>
</div>
<div id="carga-de-datos-y-visualización" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> Carga de datos y visualización<a href="Preprocesamiento.html#carga-de-datos-y-visualizaci%C3%B3n" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="Preprocesamiento.html#cb40-1" tabindex="-1"></a>csv_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(csv_dir, csv_name)</span>
<span id="cb40-2"><a href="Preprocesamiento.html#cb40-2" tabindex="-1"></a>time_col <span class="ot">&lt;-</span> <span class="st">&quot;FECHA&quot;</span>; y_col <span class="ot">&lt;-</span> <span class="st">&quot;VALOR_IMPUTADO&quot;</span></span>
<span id="cb40-3"><a href="Preprocesamiento.html#cb40-3" tabindex="-1"></a></span>
<span id="cb40-4"><a href="Preprocesamiento.html#cb40-4" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(readr<span class="sc">::</span><span class="fu">read_csv</span>(csv_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>),</span>
<span id="cb40-5"><a href="Preprocesamiento.html#cb40-5" tabindex="-1"></a><span class="at">error =</span> <span class="cf">function</span>(e) readr<span class="sc">::</span><span class="fu">read_csv2</span>(csv_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb40-6"><a href="Preprocesamiento.html#cb40-6" tabindex="-1"></a></span>
<span id="cb40-7"><a href="Preprocesamiento.html#cb40-7" tabindex="-1"></a><span class="co"># Parseo robusto de fecha-hora y valor</span></span>
<span id="cb40-8"><a href="Preprocesamiento.html#cb40-8" tabindex="-1"></a></span>
<span id="cb40-9"><a href="Preprocesamiento.html#cb40-9" tabindex="-1"></a>df[[time_col]] <span class="ot">&lt;-</span> <span class="fu">parse_date_time</span>(df[[time_col]],</span>
<span id="cb40-10"><a href="Preprocesamiento.html#cb40-10" tabindex="-1"></a><span class="at">orders =</span> <span class="fu">c</span>(<span class="st">&quot;ymd HMS&quot;</span>,<span class="st">&quot;ymd HM&quot;</span>,<span class="st">&quot;dmy HMS&quot;</span>,<span class="st">&quot;dmy HM&quot;</span>,<span class="st">&quot;ymd&quot;</span>,<span class="st">&quot;dmy&quot;</span>),</span>
<span id="cb40-11"><a href="Preprocesamiento.html#cb40-11" tabindex="-1"></a><span class="at">tz =</span> TZ)</span>
<span id="cb40-12"><a href="Preprocesamiento.html#cb40-12" tabindex="-1"></a>df[[y_col]] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(df[[y_col]]))</span>
<span id="cb40-13"><a href="Preprocesamiento.html#cb40-13" tabindex="-1"></a></span>
<span id="cb40-14"><a href="Preprocesamiento.html#cb40-14" tabindex="-1"></a><span class="co"># Malla horaria completa para marcar NA (sin imputar)</span></span>
<span id="cb40-15"><a href="Preprocesamiento.html#cb40-15" tabindex="-1"></a></span>
<span id="cb40-16"><a href="Preprocesamiento.html#cb40-16" tabindex="-1"></a>df0 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(.data[[time_col]])) <span class="sc">%&gt;%</span></span>
<span id="cb40-17"><a href="Preprocesamiento.html#cb40-17" tabindex="-1"></a><span class="fu">arrange</span>(.data[[time_col]]) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">!!</span>time_col, <span class="sc">!!</span>y_col)</span>
<span id="cb40-18"><a href="Preprocesamiento.html#cb40-18" tabindex="-1"></a></span>
<span id="cb40-19"><a href="Preprocesamiento.html#cb40-19" tabindex="-1"></a>full_time <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="sc">!!</span><span class="at">time_col :=</span> <span class="fu">seq</span>(<span class="fu">min</span>(df0[[time_col]]), <span class="fu">max</span>(df0[[time_col]]), <span class="at">by =</span> <span class="st">&quot;1 hour&quot;</span>))</span>
<span id="cb40-20"><a href="Preprocesamiento.html#cb40-20" tabindex="-1"></a></span>
<span id="cb40-21"><a href="Preprocesamiento.html#cb40-21" tabindex="-1"></a>df_full <span class="ot">&lt;-</span> full_time <span class="sc">%&gt;%</span></span>
<span id="cb40-22"><a href="Preprocesamiento.html#cb40-22" tabindex="-1"></a><span class="fu">left_join</span>(df0, <span class="at">by =</span> time_col) <span class="sc">%&gt;%</span></span>
<span id="cb40-23"><a href="Preprocesamiento.html#cb40-23" tabindex="-1"></a><span class="fu">mutate</span>(<span class="at">is_na =</span> <span class="fu">is.na</span>(.data[[y_col]])) <span class="sc">%&gt;%</span></span>
<span id="cb40-24"><a href="Preprocesamiento.html#cb40-24" tabindex="-1"></a><span class="fu">arrange</span>(.data[[time_col]])</span>
<span id="cb40-25"><a href="Preprocesamiento.html#cb40-25" tabindex="-1"></a></span>
<span id="cb40-26"><a href="Preprocesamiento.html#cb40-26" tabindex="-1"></a><span class="co"># Serie imputada (para métodos que exigen regularidad)</span></span>
<span id="cb40-27"><a href="Preprocesamiento.html#cb40-27" tabindex="-1"></a></span>
<span id="cb40-28"><a href="Preprocesamiento.html#cb40-28" tabindex="-1"></a><span class="fu">tm</span>(<span class="st">&quot;Imputación (na.interp)&quot;</span>, {</span>
<span id="cb40-29"><a href="Preprocesamiento.html#cb40-29" tabindex="-1"></a>df_impu <span class="ot">&lt;&lt;-</span> df_full <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">val_impu =</span> forecast<span class="sc">::</span><span class="fu">na.interp</span>(.data[[y_col]]))</span>
<span id="cb40-30"><a href="Preprocesamiento.html#cb40-30" tabindex="-1"></a>})</span>
<span id="cb40-31"><a href="Preprocesamiento.html#cb40-31" tabindex="-1"></a></span>
<span id="cb40-32"><a href="Preprocesamiento.html#cb40-32" tabindex="-1"></a><span class="co"># Vista rápida: primer tramo</span></span>
<span id="cb40-33"><a href="Preprocesamiento.html#cb40-33" tabindex="-1"></a></span>
<span id="cb40-34"><a href="Preprocesamiento.html#cb40-34" tabindex="-1"></a><span class="fu">ggplot</span>(df_full, <span class="fu">aes</span>(<span class="at">x =</span> .data[[time_col]], <span class="at">y =</span> .data[[y_col]])) <span class="sc">+</span></span>
<span id="cb40-35"><a href="Preprocesamiento.html#cb40-35" tabindex="-1"></a><span class="fu">geom_line</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb40-36"><a href="Preprocesamiento.html#cb40-36" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Serie horaria de potencia (con huecos)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia&quot;</span>) <span class="sc">+</span></span>
<span id="cb40-37"><a href="Preprocesamiento.html#cb40-37" tabindex="-1"></a><span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-15-1.png" width="960" /></p>
<ul>
<li>Se observa la secuencia temporal de los valores de potencia con discontinuidades.</li>
</ul>
<div id="bandas-para-huecos-na-y-vistas-multiescala" class="section level3 hasAnchor" number="4.3.1">
<h3><span class="header-section-number">4.3.1</span> Bandas para huecos (NA) y vistas multiescala<a href="Preprocesamiento.html#bandas-para-huecos-na-y-vistas-multiescala" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="Preprocesamiento.html#cb41-1" tabindex="-1"></a>na_spans_runs <span class="ot">&lt;-</span> <span class="cf">function</span>(x_time, is_na_logical) {</span>
<span id="cb41-2"><a href="Preprocesamiento.html#cb41-2" tabindex="-1"></a>r  <span class="ot">&lt;-</span> <span class="fu">rle</span>(is_na_logical)</span>
<span id="cb41-3"><a href="Preprocesamiento.html#cb41-3" tabindex="-1"></a>ed <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(r<span class="sc">$</span>lengths); st <span class="ot">&lt;-</span> ed <span class="sc">-</span> r<span class="sc">$</span>lengths <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb41-4"><a href="Preprocesamiento.html#cb41-4" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">is_na =</span> r<span class="sc">$</span>values, <span class="at">i_start =</span> st, <span class="at">i_end =</span> ed) <span class="sc">%&gt;%</span></span>
<span id="cb41-5"><a href="Preprocesamiento.html#cb41-5" tabindex="-1"></a><span class="fu">filter</span>(is_na) <span class="sc">%&gt;%</span></span>
<span id="cb41-6"><a href="Preprocesamiento.html#cb41-6" tabindex="-1"></a><span class="fu">transmute</span>(<span class="at">xmin =</span> x_time[i_start], <span class="at">xmax =</span> x_time[i_end] <span class="sc">+</span> <span class="fu">hours</span>(<span class="dv">1</span>))</span>
<span id="cb41-7"><a href="Preprocesamiento.html#cb41-7" tabindex="-1"></a>}</span>
<span id="cb41-8"><a href="Preprocesamiento.html#cb41-8" tabindex="-1"></a></span>
<span id="cb41-9"><a href="Preprocesamiento.html#cb41-9" tabindex="-1"></a>agg_by <span class="ot">&lt;-</span> <span class="cf">function</span>(data, unit, label, time_col, y_col) {</span>
<span id="cb41-10"><a href="Preprocesamiento.html#cb41-10" tabindex="-1"></a>data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">period =</span> <span class="fu">floor_date</span>(.data[[time_col]], unit)) <span class="sc">%&gt;%</span></span>
<span id="cb41-11"><a href="Preprocesamiento.html#cb41-11" tabindex="-1"></a><span class="fu">group_by</span>(period) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">value =</span> <span class="fu">mean</span>(.data[[y_col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-12"><a href="Preprocesamiento.html#cb41-12" tabindex="-1"></a><span class="fu">mutate</span>(<span class="at">freq =</span> label)</span>
<span id="cb41-13"><a href="Preprocesamiento.html#cb41-13" tabindex="-1"></a>}</span>
<span id="cb41-14"><a href="Preprocesamiento.html#cb41-14" tabindex="-1"></a></span>
<span id="cb41-15"><a href="Preprocesamiento.html#cb41-15" tabindex="-1"></a>na_runs <span class="ot">&lt;-</span> <span class="fu">na_spans_runs</span>(df_full[[time_col]], df_full<span class="sc">$</span>is_na)</span>
<span id="cb41-16"><a href="Preprocesamiento.html#cb41-16" tabindex="-1"></a></span>
<span id="cb41-17"><a href="Preprocesamiento.html#cb41-17" tabindex="-1"></a>diaria  <span class="ot">&lt;-</span> <span class="fu">agg_by</span>(df_full, <span class="st">&quot;day&quot;</span>,   <span class="st">&quot;Diaria&quot;</span>,  time_col, y_col)</span>
<span id="cb41-18"><a href="Preprocesamiento.html#cb41-18" tabindex="-1"></a>semanal <span class="ot">&lt;-</span> <span class="fu">agg_by</span>(df_full, <span class="st">&quot;week&quot;</span>,  <span class="st">&quot;Semanal&quot;</span>, time_col, y_col)</span>
<span id="cb41-19"><a href="Preprocesamiento.html#cb41-19" tabindex="-1"></a>mensual <span class="ot">&lt;-</span> <span class="fu">agg_by</span>(df_full, <span class="st">&quot;month&quot;</span>, <span class="st">&quot;Mensual&quot;</span>, time_col, y_col)</span>
<span id="cb41-20"><a href="Preprocesamiento.html#cb41-20" tabindex="-1"></a>anual   <span class="ot">&lt;-</span> <span class="fu">agg_by</span>(df_full, <span class="st">&quot;year&quot;</span>,  <span class="st">&quot;Anual&quot;</span>,   time_col, y_col)</span>
<span id="cb41-21"><a href="Preprocesamiento.html#cb41-21" tabindex="-1"></a></span>
<span id="cb41-22"><a href="Preprocesamiento.html#cb41-22" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(diaria, semanal, mensual, anual) <span class="sc">%&gt;%</span></span>
<span id="cb41-23"><a href="Preprocesamiento.html#cb41-23" tabindex="-1"></a><span class="fu">mutate</span>(<span class="at">freq =</span> <span class="fu">factor</span>(freq, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;Diaria&quot;</span>, <span class="st">&quot;Semanal&quot;</span>, <span class="st">&quot;Mensual&quot;</span>, <span class="st">&quot;Anual&quot;</span>)))</span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="Preprocesamiento.html#cb42-1" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb42-2"><a href="Preprocesamiento.html#cb42-2" tabindex="-1"></a><span class="fu">geom_rect</span>(<span class="at">data =</span> na_runs, <span class="fu">aes</span>(<span class="at">xmin =</span> xmin, <span class="at">xmax =</span> xmax, <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>),</span>
<span id="cb42-3"><a href="Preprocesamiento.html#cb42-3" tabindex="-1"></a><span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb42-4"><a href="Preprocesamiento.html#cb42-4" tabindex="-1"></a><span class="fu">geom_line</span>(<span class="at">data =</span> plot_df, <span class="fu">aes</span>(<span class="at">x =</span> period, <span class="at">y =</span> value), <span class="at">linewidth =</span> <span class="fl">0.6</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb42-5"><a href="Preprocesamiento.html#cb42-5" tabindex="-1"></a><span class="fu">facet_wrap</span>(<span class="sc">~</span> freq, <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb42-6"><a href="Preprocesamiento.html#cb42-6" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Potencia — vistas diaria, semanal, mensual y anual&quot;</span>,</span>
<span id="cb42-7"><a href="Preprocesamiento.html#cb42-7" tabindex="-1"></a><span class="at">subtitle =</span> <span class="st">&quot;Bandas rojas: periodos con NA en la serie original&quot;</span>,</span>
<span id="cb42-8"><a href="Preprocesamiento.html#cb42-8" tabindex="-1"></a><span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia&quot;</span>) <span class="sc">+</span></span>
<span id="cb42-9"><a href="Preprocesamiento.html#cb42-9" tabindex="-1"></a><span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>)</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-17-1.png" width="960" /></p>
<ul>
<li><p>Las discontinuidades se indicaron con franjas de color rojo.</p></li>
<li><p>Estos huecos fueron imputados usando forecast::na.interp, método lineal-local que mantiene la coherencia temporal.</p></li>
<li><p>La imputación es obligatoria para construir una serie regular (necesaria para ARIMA, STL y MSTL). Si no se hace, los modelos no convergen ni generan predicciones confiables.</p></li>
<li><p>La potencia muestra una variabilidad cíclica, con fluctuaciones más suaves en las escalas semanales y mensuales.</p></li>
<li><p>Las bandas rojas señalan períodos con datos ausentes; su distribución ayuda a evaluar si hay estacionalidad interrumpida.</p></li>
<li><p><strong>El análisis multiescala permite identificar tendencias de largo plazo y patrones repetitivos en diferentes horizontes</strong>.</p></li>
</ul>
</div>
</div>
<div id="estacionariedad-prueba-adf-augmented-dickey-fuller-test-y-diferenciación" class="section level2 hasAnchor" number="4.4">
<h2><span class="header-section-number">4.4</span> Estacionariedad: prueba ADF (Augmented Dickey-Fuller Test) y diferenciación<a href="Preprocesamiento.html#estacionariedad-prueba-adf-augmented-dickey-fuller-test-y-diferenciaci%C3%B3n" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="Preprocesamiento.html#cb43-1" tabindex="-1"></a><span class="co"># Vector numérico imputado</span></span>
<span id="cb43-2"><a href="Preprocesamiento.html#cb43-2" tabindex="-1"></a></span>
<span id="cb43-3"><a href="Preprocesamiento.html#cb43-3" tabindex="-1"></a>serie_vec <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(df_impu<span class="sc">$</span>val_impu)</span>
<span id="cb43-4"><a href="Preprocesamiento.html#cb43-4" tabindex="-1"></a></span>
<span id="cb43-5"><a href="Preprocesamiento.html#cb43-5" tabindex="-1"></a><span class="co"># ADF en serie original</span></span>
<span id="cb43-6"><a href="Preprocesamiento.html#cb43-6" tabindex="-1"></a></span>
<span id="cb43-7"><a href="Preprocesamiento.html#cb43-7" tabindex="-1"></a>adf_raw <span class="ot">&lt;-</span> tseries<span class="sc">::</span><span class="fu">adf.test</span>(serie_vec, <span class="at">k =</span> <span class="dv">24</span>)</span>
<span id="cb43-8"><a href="Preprocesamiento.html#cb43-8" tabindex="-1"></a>adf_raw</span></code></pre></div>
<pre><code>## 
##  Augmented Dickey-Fuller Test
## 
## data:  serie_vec
## Dickey-Fuller = -24.434, Lag order = 24, p-value = 0.01
## alternative hypothesis: stationary</code></pre>
<ul>
<li>El resultado de la <strong>Prueba ADF (Dickey-Fuller aumentada)</strong> indica que p-value = 0.01 &lt; 0.05, indicando que es una <strong>serie estacionaria en media</strong>.</li>
</ul>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="Preprocesamiento.html#cb45-1" tabindex="-1"></a><span class="co"># Diferenciación sugerida y gráfico</span></span>
<span id="cb45-2"><a href="Preprocesamiento.html#cb45-2" tabindex="-1"></a></span>
<span id="cb45-3"><a href="Preprocesamiento.html#cb45-3" tabindex="-1"></a>d_sugerido <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">ndiffs</span>(serie_vec)</span>
<span id="cb45-4"><a href="Preprocesamiento.html#cb45-4" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Diferenciaciones sugeridas por ndiffs:&quot;</span>, d_sugerido, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Diferenciaciones sugeridas por ndiffs: 1</code></pre>
<ul>
<li>“ndiffs” sugiere una <strong>diferenciación (d = 1) para estabilizar tendencia y variabilidad</strong>.</li>
</ul>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="Preprocesamiento.html#cb47-1" tabindex="-1"></a>serie_diff <span class="ot">&lt;-</span> <span class="cf">if</span> (d_sugerido <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">diff</span>(serie_vec, <span class="at">differences =</span> d_sugerido) <span class="cf">else</span> serie_vec</span>
<span id="cb47-2"><a href="Preprocesamiento.html#cb47-2" tabindex="-1"></a></span>
<span id="cb47-3"><a href="Preprocesamiento.html#cb47-3" tabindex="-1"></a>df_diff <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb47-4"><a href="Preprocesamiento.html#cb47-4" tabindex="-1"></a><span class="at">time =</span> <span class="fu">as.POSIXct</span>(df_impu[[time_col]])[<span class="fu">seq_along</span>(serie_vec)],</span>
<span id="cb47-5"><a href="Preprocesamiento.html#cb47-5" tabindex="-1"></a><span class="at">Original =</span> <span class="fu">as.numeric</span>(serie_vec),</span>
<span id="cb47-6"><a href="Preprocesamiento.html#cb47-6" tabindex="-1"></a><span class="at">Diferenciada =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, d_sugerido), <span class="fu">as.numeric</span>(serie_diff))</span>
<span id="cb47-7"><a href="Preprocesamiento.html#cb47-7" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb47-8"><a href="Preprocesamiento.html#cb47-8" tabindex="-1"></a>tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(Original, Diferenciada), <span class="at">names_to =</span> <span class="st">&quot;Serie&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;Valor&quot;</span>)</span>
<span id="cb47-9"><a href="Preprocesamiento.html#cb47-9" tabindex="-1"></a></span>
<span id="cb47-10"><a href="Preprocesamiento.html#cb47-10" tabindex="-1"></a><span class="fu">ggplot</span>(df_diff, <span class="fu">aes</span>(time, Valor, <span class="at">color =</span> Serie)) <span class="sc">+</span></span>
<span id="cb47-11"><a href="Preprocesamiento.html#cb47-11" tabindex="-1"></a><span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">0.6</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb47-12"><a href="Preprocesamiento.html#cb47-12" tabindex="-1"></a><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="at">Original =</span> <span class="st">&quot;#6B7280&quot;</span>, <span class="at">Diferenciada =</span> <span class="st">&quot;#1F77B4&quot;</span>)) <span class="sc">+</span></span>
<span id="cb47-13"><a href="Preprocesamiento.html#cb47-13" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Serie original vs. diferenciada&quot;</span>,</span>
<span id="cb47-14"><a href="Preprocesamiento.html#cb47-14" tabindex="-1"></a><span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia / ΔPotencia&quot;</span>, <span class="at">color =</span> <span class="st">&quot;Serie&quot;</span>) <span class="sc">+</span></span>
<span id="cb47-15"><a href="Preprocesamiento.html#cb47-15" tabindex="-1"></a><span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-20-1.png" width="960" /></p>
<ul>
<li><p>La serie original presenta tendencia ascendente y picos altos.</p></li>
<li><p>La serie diferenciada elimina la tendencia de la serie original, centrando la media alrededor de cero y reduciendo varianza.</p></li>
</ul>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="Preprocesamiento.html#cb48-1" tabindex="-1"></a><span class="co"># ADF nuevamente si se diferenció</span></span>
<span id="cb48-2"><a href="Preprocesamiento.html#cb48-2" tabindex="-1"></a></span>
<span id="cb48-3"><a href="Preprocesamiento.html#cb48-3" tabindex="-1"></a><span class="cf">if</span> (d_sugerido <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb48-4"><a href="Preprocesamiento.html#cb48-4" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Re-prueba ADF en la serie diferenciada (d =&quot;</span>, d_sugerido, <span class="st">&quot;):</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb48-5"><a href="Preprocesamiento.html#cb48-5" tabindex="-1"></a><span class="fu">print</span>(tseries<span class="sc">::</span><span class="fu">adf.test</span>(serie_diff, <span class="at">k =</span> <span class="dv">24</span>))</span>
<span id="cb48-6"><a href="Preprocesamiento.html#cb48-6" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## 
## Re-prueba ADF en la serie diferenciada (d = 1 ):</code></pre>
<pre><code>## 
##  Augmented Dickey-Fuller Test
## 
## data:  serie_diff
## Dickey-Fuller = -91.566, Lag order = 24, p-value = 0.01
## alternative hypothesis: stationary</code></pre>
<ul>
<li><p>El resultado de la <strong>Prueba ADF (Dickey-Fuller aumentada)</strong> para la serie diferenciada indica que p-value = 0.01 &lt; 0.05, indicando que es una <strong>serie estacionaria</strong>.</p></li>
<li><p>En modelos ARIMA se necesita estacionariedad. La diferenciación controla la no estacionariedad estructural sin alterar la forma estacional de corto plazo.</p></li>
</ul>
</div>
<div id="acf-y-pacf-original-y-diferenciada" class="section level2 hasAnchor" number="4.5">
<h2><span class="header-section-number">4.5</span> ACF y PACF (original y diferenciada)<a href="Preprocesamiento.html#acf-y-pacf-original-y-diferenciada" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="Preprocesamiento.html#cb51-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb51-2"><a href="Preprocesamiento.html#cb51-2" tabindex="-1"></a><span class="co"># 6. ACF y PACF (original y diferenciada)</span></span>
<span id="cb51-3"><a href="Preprocesamiento.html#cb51-3" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb51-4"><a href="Preprocesamiento.html#cb51-4" tabindex="-1"></a></span>
<span id="cb51-5"><a href="Preprocesamiento.html#cb51-5" tabindex="-1"></a><span class="co"># --- Calcular ACF/PACF de la serie original ---</span></span>
<span id="cb51-6"><a href="Preprocesamiento.html#cb51-6" tabindex="-1"></a>t0 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb51-7"><a href="Preprocesamiento.html#cb51-7" tabindex="-1"></a>acf_obj  <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">acf</span>(serie_vec, <span class="at">lag.max =</span> lag_max, <span class="at">plot =</span> <span class="cn">FALSE</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb51-8"><a href="Preprocesamiento.html#cb51-8" tabindex="-1"></a>pacf_obj <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">pacf</span>(serie_vec, <span class="at">lag.max =</span> lag_max, <span class="at">plot =</span> <span class="cn">FALSE</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb51-9"><a href="Preprocesamiento.html#cb51-9" tabindex="-1"></a>.timing[[<span class="st">&quot;ACF/PACF (original)&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">seconds =</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(<span class="fu">Sys.time</span>(), t0, <span class="at">units =</span> <span class="st">&quot;secs&quot;</span>)),</span>
<span id="cb51-10"><a href="Preprocesamiento.html#cb51-10" tabindex="-1"></a>                                         <span class="at">status =</span> <span class="cf">if</span> (<span class="fu">inherits</span>(acf_obj, <span class="st">&quot;try-error&quot;</span>)) <span class="st">&quot;ERROR&quot;</span> <span class="cf">else</span> <span class="st">&quot;OK&quot;</span>,</span>
<span id="cb51-11"><a href="Preprocesamiento.html#cb51-11" tabindex="-1"></a>                                         <span class="at">message =</span> <span class="cn">NA_character_</span>)</span>
<span id="cb51-12"><a href="Preprocesamiento.html#cb51-12" tabindex="-1"></a></span>
<span id="cb51-13"><a href="Preprocesamiento.html#cb51-13" tabindex="-1"></a><span class="co"># --- Graficar ACF/PACF de la serie original  ---</span></span>
<span id="cb51-14"><a href="Preprocesamiento.html#cb51-14" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(acf_obj, <span class="st">&quot;try-error&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">inherits</span>(pacf_obj, <span class="st">&quot;try-error&quot;</span>)) {</span>
<span id="cb51-15"><a href="Preprocesamiento.html#cb51-15" tabindex="-1"></a>  acf_df  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">lag =</span> <span class="fu">as.numeric</span>(acf_obj<span class="sc">$</span>lag),  <span class="at">acf  =</span> <span class="fu">as.numeric</span>(acf_obj<span class="sc">$</span>acf))</span>
<span id="cb51-16"><a href="Preprocesamiento.html#cb51-16" tabindex="-1"></a>  pacf_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">lag =</span> <span class="fu">as.numeric</span>(pacf_obj<span class="sc">$</span>lag), <span class="at">pacf =</span> <span class="fu">as.numeric</span>(pacf_obj<span class="sc">$</span>acf))</span>
<span id="cb51-17"><a href="Preprocesamiento.html#cb51-17" tabindex="-1"></a>  ci <span class="ot">&lt;-</span> <span class="fl">1.96</span> <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(serie_vec))</span>
<span id="cb51-18"><a href="Preprocesamiento.html#cb51-18" tabindex="-1"></a>  </span>
<span id="cb51-19"><a href="Preprocesamiento.html#cb51-19" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(acf_df, <span class="fu">aes</span>(lag, acf)) <span class="sc">+</span></span>
<span id="cb51-20"><a href="Preprocesamiento.html#cb51-20" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">&quot;#1f77b4&quot;</span>) <span class="sc">+</span></span>
<span id="cb51-21"><a href="Preprocesamiento.html#cb51-21" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>ci, ci), <span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>, <span class="at">color=</span><span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb51-22"><a href="Preprocesamiento.html#cb51-22" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;ACF (serie original)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Rezago (horas)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;ACF&quot;</span>) <span class="sc">+</span></span>
<span id="cb51-23"><a href="Preprocesamiento.html#cb51-23" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb51-24"><a href="Preprocesamiento.html#cb51-24" tabindex="-1"></a>  </span>
<span id="cb51-25"><a href="Preprocesamiento.html#cb51-25" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pacf_df, <span class="fu">aes</span>(lag, pacf)) <span class="sc">+</span></span>
<span id="cb51-26"><a href="Preprocesamiento.html#cb51-26" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">&quot;#ff7f0e&quot;</span>) <span class="sc">+</span></span>
<span id="cb51-27"><a href="Preprocesamiento.html#cb51-27" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>ci, ci), <span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>, <span class="at">color=</span><span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb51-28"><a href="Preprocesamiento.html#cb51-28" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;PACF (serie original)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Rezago (horas)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;PACF&quot;</span>) <span class="sc">+</span></span>
<span id="cb51-29"><a href="Preprocesamiento.html#cb51-29" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb51-30"><a href="Preprocesamiento.html#cb51-30" tabindex="-1"></a>  </span>
<span id="cb51-31"><a href="Preprocesamiento.html#cb51-31" tabindex="-1"></a>  <span class="fu">print</span>(p1); <span class="fu">print</span>(p2)</span>
<span id="cb51-32"><a href="Preprocesamiento.html#cb51-32" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb51-33"><a href="Preprocesamiento.html#cb51-33" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Error al calcular ACF/PACF de la serie original.</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb51-34"><a href="Preprocesamiento.html#cb51-34" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/acf-pacf-1.png" width="960" /><img src="propuesta-pronostico-subestacion_files/figure-html/acf-pacf-2.png" width="960" /></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="Preprocesamiento.html#cb52-1" tabindex="-1"></a><span class="co"># --- Serie diferenciada ---</span></span>
<span id="cb52-2"><a href="Preprocesamiento.html#cb52-2" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;serie_diff&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(serie_diff) <span class="sc">&gt;</span> <span class="dv">10</span> <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">identical</span>(serie_diff, serie_vec)) {</span>
<span id="cb52-3"><a href="Preprocesamiento.html#cb52-3" tabindex="-1"></a>  t0 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb52-4"><a href="Preprocesamiento.html#cb52-4" tabindex="-1"></a>  acf_d  <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">acf</span>(serie_diff, <span class="at">lag.max =</span> lag_max, <span class="at">plot =</span> <span class="cn">FALSE</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-5"><a href="Preprocesamiento.html#cb52-5" tabindex="-1"></a>  pacf_d <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">pacf</span>(serie_diff, <span class="at">lag.max =</span> lag_max, <span class="at">plot =</span> <span class="cn">FALSE</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-6"><a href="Preprocesamiento.html#cb52-6" tabindex="-1"></a>  .timing[[<span class="st">&quot;ACF/PACF (diferenciada)&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">seconds =</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(<span class="fu">Sys.time</span>(), t0, <span class="at">units =</span> <span class="st">&quot;secs&quot;</span>)),</span>
<span id="cb52-7"><a href="Preprocesamiento.html#cb52-7" tabindex="-1"></a>                                               <span class="at">status =</span> <span class="cf">if</span> (<span class="fu">inherits</span>(acf_d, <span class="st">&quot;try-error&quot;</span>)) <span class="st">&quot;ERROR&quot;</span> <span class="cf">else</span> <span class="st">&quot;OK&quot;</span>,</span>
<span id="cb52-8"><a href="Preprocesamiento.html#cb52-8" tabindex="-1"></a>                                               <span class="at">message =</span> <span class="cn">NA_character_</span>)</span>
<span id="cb52-9"><a href="Preprocesamiento.html#cb52-9" tabindex="-1"></a>  </span>
<span id="cb52-10"><a href="Preprocesamiento.html#cb52-10" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(acf_d, <span class="st">&quot;try-error&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">inherits</span>(pacf_d, <span class="st">&quot;try-error&quot;</span>)) {</span>
<span id="cb52-11"><a href="Preprocesamiento.html#cb52-11" tabindex="-1"></a>    acf_df_d  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">lag =</span> <span class="fu">as.numeric</span>(acf_d<span class="sc">$</span>lag),  <span class="at">acf  =</span> <span class="fu">as.numeric</span>(acf_d<span class="sc">$</span>acf))</span>
<span id="cb52-12"><a href="Preprocesamiento.html#cb52-12" tabindex="-1"></a>    pacf_df_d <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">lag =</span> <span class="fu">as.numeric</span>(pacf_d<span class="sc">$</span>lag), <span class="at">pacf =</span> <span class="fu">as.numeric</span>(pacf_d<span class="sc">$</span>acf))</span>
<span id="cb52-13"><a href="Preprocesamiento.html#cb52-13" tabindex="-1"></a>    ci_d <span class="ot">&lt;-</span> <span class="fl">1.96</span> <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(serie_diff))</span>
<span id="cb52-14"><a href="Preprocesamiento.html#cb52-14" tabindex="-1"></a>    </span>
<span id="cb52-15"><a href="Preprocesamiento.html#cb52-15" tabindex="-1"></a>    p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(acf_df_d, <span class="fu">aes</span>(lag, acf)) <span class="sc">+</span></span>
<span id="cb52-16"><a href="Preprocesamiento.html#cb52-16" tabindex="-1"></a>      <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">&quot;#17becf&quot;</span>) <span class="sc">+</span></span>
<span id="cb52-17"><a href="Preprocesamiento.html#cb52-17" tabindex="-1"></a>      <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>ci_d, ci_d), <span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>, <span class="at">color=</span><span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb52-18"><a href="Preprocesamiento.html#cb52-18" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;ACF (serie diferenciada)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Rezago (horas)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;ACF&quot;</span>) <span class="sc">+</span></span>
<span id="cb52-19"><a href="Preprocesamiento.html#cb52-19" tabindex="-1"></a>      <span class="fu">theme_minimal</span>()</span>
<span id="cb52-20"><a href="Preprocesamiento.html#cb52-20" tabindex="-1"></a>    </span>
<span id="cb52-21"><a href="Preprocesamiento.html#cb52-21" tabindex="-1"></a>    p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pacf_df_d, <span class="fu">aes</span>(lag, pacf)) <span class="sc">+</span></span>
<span id="cb52-22"><a href="Preprocesamiento.html#cb52-22" tabindex="-1"></a>      <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">&quot;#2ca02c&quot;</span>) <span class="sc">+</span></span>
<span id="cb52-23"><a href="Preprocesamiento.html#cb52-23" tabindex="-1"></a>      <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>ci_d, ci_d), <span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>, <span class="at">color=</span><span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb52-24"><a href="Preprocesamiento.html#cb52-24" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;PACF (serie diferenciada)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Rezago (horas)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;PACF&quot;</span>) <span class="sc">+</span></span>
<span id="cb52-25"><a href="Preprocesamiento.html#cb52-25" tabindex="-1"></a>      <span class="fu">theme_minimal</span>()</span>
<span id="cb52-26"><a href="Preprocesamiento.html#cb52-26" tabindex="-1"></a>    </span>
<span id="cb52-27"><a href="Preprocesamiento.html#cb52-27" tabindex="-1"></a>    <span class="fu">print</span>(p3); <span class="fu">print</span>(p4)</span>
<span id="cb52-28"><a href="Preprocesamiento.html#cb52-28" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb52-29"><a href="Preprocesamiento.html#cb52-29" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Error al calcular ACF/PACF diferenciada.</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb52-30"><a href="Preprocesamiento.html#cb52-30" tabindex="-1"></a>  }</span>
<span id="cb52-31"><a href="Preprocesamiento.html#cb52-31" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/acf-pacf-3.png" width="960" /><img src="propuesta-pronostico-subestacion_files/figure-html/acf-pacf-4.png" width="960" /></p>
<ul>
<li>La <strong>ACF de la serie original</strong> muestra valores muy altos (cercanos a 1) en los primeros rezagos y una disminución muy lenta a medida que aumenta el lag (hasta aproximadamente 168 horas, es decir, 7 días). La curva no cruza la banda de significancia (líneas rojas), lo cual indica una persistencia fuerte.
<ul>
<li><p>La alta autocorrelación inicial y su decaimiento lento son señales claras de no estacionariedad.</p></li>
<li><p>Este patrón implica que los valores pasados influyen fuertemente en los futuros, y que la serie tiene una tendencia o un ciclo estacional persistente.</p></li>
<li><p>La leve oscilación alrededor de los rezagos 24, 48, 72, etc., sugiere la presencia de una estacionalidad diaria (24 horas).</p></li>
<li><p>En conjunto, la ACF indica que la serie no tiene media constante y no fluctúa alrededor de un equilibrio estable.</p></li>
<li><p>La serie original no es estacionaria y requiere una transformación (diferenciación) para eliminar la tendencia y permitir el uso de modelos ARIMA.</p></li>
</ul></li>
<li>La <strong>PACF de la serie original</strong> presenta un pico muy pronunciado en el lag 1 y luego una rápida caída hacia valores pequeños alrededor de cero.
<ul>
<li><p>El gran valor en el primer rezago indica un componente autoregresivo fuerte de orden 1 (AR(1)).</p></li>
<li><p>La rápida caída posterior confirma que la mayor parte de la dependencia directa se concentra en los primeros rezagos.</p></li>
<li><p>Los valores bajos pero persistentes en rezagos múltiples reflejan todavía efectos indirectos acumulados, producto de la tendencia no estacionaria detectada.</p></li>
<li><p>La PACF confirma un componente autoregresivo significativo en la estructura de la serie original, aunque su interpretación precisa se distorsiona por la presencia de tendencia y estacionalidad.</p></li>
</ul></li>
<li>La <strong>ACF de la serie diferenciada</strong> muestra una autocorrelación fuerte únicamente en el rezago 1, pero el resto de las barras caen rápidamente dentro del intervalo de confianza (líneas rojas).
<ul>
<li><p>La diferenciación ha eliminado con éxito la tendencia y la dependencia a largo plazo.</p></li>
<li><p>Los valores cercanos a cero en los rezagos mayores indican que la serie ya no tiene memoria prolongada, es decir, es estacionaria en media.</p></li>
<li><p>El ligero pico negativo en los primeros rezagos podría sugerir un componente MA (Media Móvil) de bajo orden.</p></li>
<li><p>Tras la diferenciación, la ACF evidencia una serie estacionaria y más estable, con correlación significativa sólo a corto plazo.</p></li>
</ul></li>
<li>En la <strong>PACF de la serie diferenciada</strong> se observa un primer pico negativo (ligeramente pronunciado) y luego valores pequeños oscilando alrededor de cero, sin superar el umbral de significancia.
<ul>
<li>Este patrón es típico de una serie con componente MA (q) después de la diferenciación.</li>
<li>La ausencia de picos claros más allá del primer rezago indica que no existen dependencias autoregresivas persistentes.</li>
<li>La PACF de la serie diferenciada confirma que el proceso se estabilizó tras la diferenciación, y que la estructura autoregresiva se redujo sustancialmente, favoreciendo modelos ARIMA sencillos con un componente de media móvil dominante.</li>
</ul></li>
</ul>
</div>
<div id="descomposición-stl-seasonal-trend-decomposition-using-loess-y-mstl-multiple-seasonal-trend-decomposition-using-loess" class="section level2 hasAnchor" number="4.6">
<h2><span class="header-section-number">4.6</span> Descomposición STL (Seasonal-Trend decomposition using Loess) y MSTL (Multiple Seasonal-Trend decomposition using Loess)<a href="Preprocesamiento.html#descomposici%C3%B3n-stl-seasonal-trend-decomposition-using-loess-y-mstl-multiple-seasonal-trend-decomposition-using-loess" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="Preprocesamiento.html#cb53-1" tabindex="-1"></a>val_col <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="st">&quot;val_impu&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_impu)) <span class="st">&quot;val_impu&quot;</span> <span class="cf">else</span></span>
<span id="cb53-2"><a href="Preprocesamiento.html#cb53-2" tabindex="-1"></a>           <span class="cf">if</span> (<span class="st">&quot;VALOR_IMPUTADO&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_impu)) <span class="st">&quot;VALOR_IMPUTADO&quot;</span> <span class="cf">else</span></span>
<span id="cb53-3"><a href="Preprocesamiento.html#cb53-3" tabindex="-1"></a>           <span class="fu">stop</span>(<span class="st">&quot;No encuentro columna de valores: usa &#39;val_impu&#39; o &#39;VALOR_IMPUTADO&#39;.&quot;</span>)</span>
<span id="cb53-4"><a href="Preprocesamiento.html#cb53-4" tabindex="-1"></a></span>
<span id="cb53-5"><a href="Preprocesamiento.html#cb53-5" tabindex="-1"></a><span class="co"># Utilidad para detectar columna estacional por periodo (acepta &#39;Seasonal-24&#39;, &#39;Seasonal 24&#39;, etc.)</span></span>
<span id="cb53-6"><a href="Preprocesamiento.html#cb53-6" tabindex="-1"></a>find_seasonal_col <span class="ot">&lt;-</span> <span class="cf">function</span>(df_comp, target_period) {</span>
<span id="cb53-7"><a href="Preprocesamiento.html#cb53-7" tabindex="-1"></a>  nm <span class="ot">&lt;-</span> <span class="fu">names</span>(df_comp)</span>
<span id="cb53-8"><a href="Preprocesamiento.html#cb53-8" tabindex="-1"></a>  is_seas <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">&quot;^Seasonal&quot;</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-9"><a href="Preprocesamiento.html#cb53-9" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(is_seas)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb53-10"><a href="Preprocesamiento.html#cb53-10" tabindex="-1"></a>  seas_nm <span class="ot">&lt;-</span> nm[is_seas]</span>
<span id="cb53-11"><a href="Preprocesamiento.html#cb53-11" tabindex="-1"></a>  getp <span class="ot">&lt;-</span> <span class="cf">function</span>(s) { p <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;[^0-9]&quot;</span>, <span class="st">&quot;&quot;</span>, s); <span class="cf">if</span> (<span class="fu">nzchar</span>(p)) <span class="fu">as.integer</span>(p) <span class="cf">else</span> <span class="cn">NA_integer_</span> }</span>
<span id="cb53-12"><a href="Preprocesamiento.html#cb53-12" tabindex="-1"></a>  periods <span class="ot">&lt;-</span> <span class="fu">vapply</span>(seas_nm, getp, <span class="fu">integer</span>(<span class="dv">1</span>))</span>
<span id="cb53-13"><a href="Preprocesamiento.html#cb53-13" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which</span>(periods <span class="sc">==</span> target_period)</span>
<span id="cb53-14"><a href="Preprocesamiento.html#cb53-14" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(idx)) seas_nm[idx[<span class="dv">1</span>]] <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb53-15"><a href="Preprocesamiento.html#cb53-15" tabindex="-1"></a>}</span>
<span id="cb53-16"><a href="Preprocesamiento.html#cb53-16" tabindex="-1"></a></span>
<span id="cb53-17"><a href="Preprocesamiento.html#cb53-17" tabindex="-1"></a><span class="co"># ========== A) df_seas24: Estacionalidad diaria (24h) desde SERIE HORARIA ==========</span></span>
<span id="cb53-18"><a href="Preprocesamiento.html#cb53-18" tabindex="-1"></a>x_hour  <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(df_impu[[val_col]])</span>
<span id="cb53-19"><a href="Preprocesamiento.html#cb53-19" tabindex="-1"></a>time_hr <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(df_impu[[time_col]])</span>
<span id="cb53-20"><a href="Preprocesamiento.html#cb53-20" tabindex="-1"></a></span>
<span id="cb53-21"><a href="Preprocesamiento.html#cb53-21" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">length</span>(x_hour) <span class="sc">&gt;=</span> <span class="dv">24</span><span class="sc">*</span><span class="dv">14</span>)  <span class="co"># al menos ~2 semanas</span></span>
<span id="cb53-22"><a href="Preprocesamiento.html#cb53-22" tabindex="-1"></a>ts_hour     <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">msts</span>(x_hour, <span class="at">seasonal.periods =</span> <span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">168</span>))</span>
<span id="cb53-23"><a href="Preprocesamiento.html#cb53-23" tabindex="-1"></a>fit_m_hour  <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">mstl</span>(ts_hour, <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-24"><a href="Preprocesamiento.html#cb53-24" tabindex="-1"></a>comp_h      <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_m_hour)</span>
<span id="cb53-25"><a href="Preprocesamiento.html#cb53-25" tabindex="-1"></a>col_s24     <span class="ot">&lt;-</span> <span class="fu">find_seasonal_col</span>(comp_h, <span class="dv">24</span>)</span>
<span id="cb53-26"><a href="Preprocesamiento.html#cb53-26" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(col_s24)) {</span>
<span id="cb53-27"><a href="Preprocesamiento.html#cb53-27" tabindex="-1"></a>  <span class="co"># fallback: primera &#39;Seasonal&#39; si no se pudo detectar 24 específicamente</span></span>
<span id="cb53-28"><a href="Preprocesamiento.html#cb53-28" tabindex="-1"></a>  cand <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">&quot;^Seasonal&quot;</span>, <span class="fu">names</span>(comp_h), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-29"><a href="Preprocesamiento.html#cb53-29" tabindex="-1"></a>  col_s24 <span class="ot">&lt;-</span> cand[<span class="dv">1</span>]</span>
<span id="cb53-30"><a href="Preprocesamiento.html#cb53-30" tabindex="-1"></a>}</span>
<span id="cb53-31"><a href="Preprocesamiento.html#cb53-31" tabindex="-1"></a>df_seas24 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb53-32"><a href="Preprocesamiento.html#cb53-32" tabindex="-1"></a>  <span class="at">time =</span> time_hr,</span>
<span id="cb53-33"><a href="Preprocesamiento.html#cb53-33" tabindex="-1"></a>  <span class="at">Componente =</span> <span class="st">&quot;Estacionalidad diaria (24h)&quot;</span>,</span>
<span id="cb53-34"><a href="Preprocesamiento.html#cb53-34" tabindex="-1"></a>  <span class="at">Valor =</span> comp_h[[col_s24]]</span>
<span id="cb53-35"><a href="Preprocesamiento.html#cb53-35" tabindex="-1"></a>)</span>
<span id="cb53-36"><a href="Preprocesamiento.html#cb53-36" tabindex="-1"></a></span>
<span id="cb53-37"><a href="Preprocesamiento.html#cb53-37" tabindex="-1"></a><span class="co"># ========== B) df_seas12: Estacionalidad mensual (12) desde SERIE MENSUAL ==========</span></span>
<span id="cb53-38"><a href="Preprocesamiento.html#cb53-38" tabindex="-1"></a>monthly <span class="ot">&lt;-</span> df_impu <span class="sc">%&gt;%</span></span>
<span id="cb53-39"><a href="Preprocesamiento.html#cb53-39" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mes =</span> <span class="fu">floor_date</span>(.data[[time_col]], <span class="st">&quot;month&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb53-40"><a href="Preprocesamiento.html#cb53-40" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.by =</span> mes, <span class="at">y =</span> <span class="fu">mean</span>(.data[[val_col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb53-41"><a href="Preprocesamiento.html#cb53-41" tabindex="-1"></a>  <span class="fu">arrange</span>(mes)</span>
<span id="cb53-42"><a href="Preprocesamiento.html#cb53-42" tabindex="-1"></a></span>
<span id="cb53-43"><a href="Preprocesamiento.html#cb53-43" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">nrow</span>(monthly) <span class="sc">&gt;=</span> <span class="dv">24</span>)</span>
<span id="cb53-44"><a href="Preprocesamiento.html#cb53-44" tabindex="-1"></a>ts_month <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">ts</span>(</span>
<span id="cb53-45"><a href="Preprocesamiento.html#cb53-45" tabindex="-1"></a>  monthly<span class="sc">$</span>y, <span class="at">frequency =</span> <span class="dv">12</span>,</span>
<span id="cb53-46"><a href="Preprocesamiento.html#cb53-46" tabindex="-1"></a>  <span class="at">start =</span> <span class="fu">c</span>(<span class="fu">year</span>(<span class="fu">min</span>(monthly<span class="sc">$</span>mes)), <span class="fu">month</span>(<span class="fu">min</span>(monthly<span class="sc">$</span>mes)))</span>
<span id="cb53-47"><a href="Preprocesamiento.html#cb53-47" tabindex="-1"></a>)</span>
<span id="cb53-48"><a href="Preprocesamiento.html#cb53-48" tabindex="-1"></a>fit_stl_m <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">stl</span>(ts_month, <span class="at">s.window =</span> <span class="st">&quot;periodic&quot;</span>, <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-49"><a href="Preprocesamiento.html#cb53-49" tabindex="-1"></a>comp_m <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_stl_m<span class="sc">$</span>time.series)</span>
<span id="cb53-50"><a href="Preprocesamiento.html#cb53-50" tabindex="-1"></a><span class="co"># detectar columna estacional (nombre puede ser &quot;seasonal&quot;/&quot;Seasonal&quot;)</span></span>
<span id="cb53-51"><a href="Preprocesamiento.html#cb53-51" tabindex="-1"></a>seas_col_m <span class="ot">&lt;-</span> <span class="fu">names</span>(comp_m)[<span class="fu">grepl</span>(<span class="st">&quot;season&quot;</span>, <span class="fu">names</span>(comp_m), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)][<span class="dv">1</span>]</span>
<span id="cb53-52"><a href="Preprocesamiento.html#cb53-52" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.na</span>(seas_col_m)) <span class="fu">stop</span>(<span class="st">&quot;No se encontró columna estacional en STL mensual.&quot;</span>)</span>
<span id="cb53-53"><a href="Preprocesamiento.html#cb53-53" tabindex="-1"></a>df_seas12 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb53-54"><a href="Preprocesamiento.html#cb53-54" tabindex="-1"></a>  <span class="at">time =</span> <span class="fu">as.POSIXct</span>(monthly<span class="sc">$</span>mes),     <span class="co"># unificamos a POSIXct</span></span>
<span id="cb53-55"><a href="Preprocesamiento.html#cb53-55" tabindex="-1"></a>  <span class="at">Componente =</span> <span class="st">&quot;Estacionalidad mensual (12)&quot;</span>,</span>
<span id="cb53-56"><a href="Preprocesamiento.html#cb53-56" tabindex="-1"></a>  <span class="at">Valor =</span> comp_m[[seas_col_m]]</span>
<span id="cb53-57"><a href="Preprocesamiento.html#cb53-57" tabindex="-1"></a>)</span>
<span id="cb53-58"><a href="Preprocesamiento.html#cb53-58" tabindex="-1"></a></span>
<span id="cb53-59"><a href="Preprocesamiento.html#cb53-59" tabindex="-1"></a><span class="co"># ========== C) df_day_panel: Observada, Tendencia, Semanal(7d), Anual(365d), Residuo (SERIE DIARIA) ==========</span></span>
<span id="cb53-60"><a href="Preprocesamiento.html#cb53-60" tabindex="-1"></a>daily <span class="ot">&lt;-</span> df_impu <span class="sc">%&gt;%</span></span>
<span id="cb53-61"><a href="Preprocesamiento.html#cb53-61" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">day =</span> <span class="fu">floor_date</span>(.data[[time_col]], <span class="st">&quot;day&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb53-62"><a href="Preprocesamiento.html#cb53-62" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.by =</span> day, <span class="at">y =</span> <span class="fu">mean</span>(.data[[val_col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb53-63"><a href="Preprocesamiento.html#cb53-63" tabindex="-1"></a>  <span class="fu">arrange</span>(day)</span>
<span id="cb53-64"><a href="Preprocesamiento.html#cb53-64" tabindex="-1"></a></span>
<span id="cb53-65"><a href="Preprocesamiento.html#cb53-65" tabindex="-1"></a>ts_day    <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">msts</span>(daily<span class="sc">$</span>y, <span class="at">seasonal.periods =</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">365</span>))</span>
<span id="cb53-66"><a href="Preprocesamiento.html#cb53-66" tabindex="-1"></a>fit_m_day <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">mstl</span>(ts_day, <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-67"><a href="Preprocesamiento.html#cb53-67" tabindex="-1"></a>comp_d    <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_m_day)</span>
<span id="cb53-68"><a href="Preprocesamiento.html#cb53-68" tabindex="-1"></a></span>
<span id="cb53-69"><a href="Preprocesamiento.html#cb53-69" tabindex="-1"></a><span class="co"># Normalizamos nombres para &#39;Trend&#39; y &#39;Remainder&#39;</span></span>
<span id="cb53-70"><a href="Preprocesamiento.html#cb53-70" tabindex="-1"></a>nmd <span class="ot">&lt;-</span> <span class="fu">names</span>(comp_d)</span>
<span id="cb53-71"><a href="Preprocesamiento.html#cb53-71" tabindex="-1"></a>nmd <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">&quot;^trend$&quot;</span>, <span class="st">&quot;Trend&quot;</span>, nmd, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-72"><a href="Preprocesamiento.html#cb53-72" tabindex="-1"></a>nmd <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">&quot;^remainder$&quot;</span>, <span class="st">&quot;Remainder&quot;</span>, nmd, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-73"><a href="Preprocesamiento.html#cb53-73" tabindex="-1"></a><span class="fu">names</span>(comp_d) <span class="ot">&lt;-</span> nmd</span>
<span id="cb53-74"><a href="Preprocesamiento.html#cb53-74" tabindex="-1"></a></span>
<span id="cb53-75"><a href="Preprocesamiento.html#cb53-75" tabindex="-1"></a><span class="co"># Detectar columnas estacionales 7 y 365</span></span>
<span id="cb53-76"><a href="Preprocesamiento.html#cb53-76" tabindex="-1"></a>is_seas  <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">&quot;^Seasonal&quot;</span>, <span class="fu">names</span>(comp_d), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-77"><a href="Preprocesamiento.html#cb53-77" tabindex="-1"></a>seas_nms <span class="ot">&lt;-</span> <span class="fu">names</span>(comp_d)[is_seas]</span>
<span id="cb53-78"><a href="Preprocesamiento.html#cb53-78" tabindex="-1"></a>getp <span class="ot">&lt;-</span> <span class="cf">function</span>(s) { p <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;[^0-9]&quot;</span>, <span class="st">&quot;&quot;</span>, s); <span class="cf">if</span> (<span class="fu">nzchar</span>(p)) <span class="fu">as.integer</span>(p) <span class="cf">else</span> <span class="cn">NA_integer_</span> }</span>
<span id="cb53-79"><a href="Preprocesamiento.html#cb53-79" tabindex="-1"></a>seas_p <span class="ot">&lt;-</span> <span class="fu">vapply</span>(seas_nms, getp, <span class="fu">integer</span>(<span class="dv">1</span>))</span>
<span id="cb53-80"><a href="Preprocesamiento.html#cb53-80" tabindex="-1"></a>idx7   <span class="ot">&lt;-</span> <span class="fu">which</span>(seas_p <span class="sc">==</span> <span class="dv">7</span>)</span>
<span id="cb53-81"><a href="Preprocesamiento.html#cb53-81" tabindex="-1"></a>idx365 <span class="ot">&lt;-</span> <span class="fu">which</span>(seas_p <span class="sc">==</span> <span class="dv">365</span>)</span>
<span id="cb53-82"><a href="Preprocesamiento.html#cb53-82" tabindex="-1"></a>seas7   <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(idx7))   comp_d[[seas_nms[idx7[<span class="dv">1</span>]]]]   <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb53-83"><a href="Preprocesamiento.html#cb53-83" tabindex="-1"></a>seas365 <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(idx365)) comp_d[[seas_nms[idx365[<span class="dv">1</span>]]]] <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb53-84"><a href="Preprocesamiento.html#cb53-84" tabindex="-1"></a></span>
<span id="cb53-85"><a href="Preprocesamiento.html#cb53-85" tabindex="-1"></a>df_day_panel <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb53-86"><a href="Preprocesamiento.html#cb53-86" tabindex="-1"></a>  <span class="at">time       =</span> <span class="fu">as.POSIXct</span>(daily<span class="sc">$</span>day),</span>
<span id="cb53-87"><a href="Preprocesamiento.html#cb53-87" tabindex="-1"></a>  <span class="at">Observada  =</span> daily<span class="sc">$</span>y,</span>
<span id="cb53-88"><a href="Preprocesamiento.html#cb53-88" tabindex="-1"></a>  <span class="at">Tendencia  =</span> <span class="cf">if</span> (<span class="st">&quot;Trend&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(comp_d)) comp_d<span class="sc">$</span>Trend <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb53-89"><a href="Preprocesamiento.html#cb53-89" tabindex="-1"></a>  <span class="at">Residuo    =</span> <span class="cf">if</span> (<span class="st">&quot;Remainder&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(comp_d)) comp_d<span class="sc">$</span>Remainder <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb53-90"><a href="Preprocesamiento.html#cb53-90" tabindex="-1"></a>)</span>
<span id="cb53-91"><a href="Preprocesamiento.html#cb53-91" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seas7))   df_day_panel[[<span class="st">&quot;Estacionalidad semanal (7d)&quot;</span>]]  <span class="ot">&lt;-</span> seas7</span>
<span id="cb53-92"><a href="Preprocesamiento.html#cb53-92" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seas365)) df_day_panel[[<span class="st">&quot;Estacionalidad anual (365d)&quot;</span>]] <span class="ot">&lt;-</span> seas365</span>
<span id="cb53-93"><a href="Preprocesamiento.html#cb53-93" tabindex="-1"></a></span>
<span id="cb53-94"><a href="Preprocesamiento.html#cb53-94" tabindex="-1"></a>df_day_panel <span class="ot">&lt;-</span> df_day_panel <span class="sc">|&gt;</span></span>
<span id="cb53-95"><a href="Preprocesamiento.html#cb53-95" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">&quot;Componente&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;Valor&quot;</span>)</span>
<span id="cb53-96"><a href="Preprocesamiento.html#cb53-96" tabindex="-1"></a></span>
<span id="cb53-97"><a href="Preprocesamiento.html#cb53-97" tabindex="-1"></a><span class="co"># ========== D) Panel combinado ==========</span></span>
<span id="cb53-98"><a href="Preprocesamiento.html#cb53-98" tabindex="-1"></a>panel_all <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb53-99"><a href="Preprocesamiento.html#cb53-99" tabindex="-1"></a>  df_day_panel,  <span class="co"># Observada/Tendencia/Residuo + 7d/365d si existen</span></span>
<span id="cb53-100"><a href="Preprocesamiento.html#cb53-100" tabindex="-1"></a>  df_seas24,     <span class="co"># Estacionalidad diaria (24h) desde HORAS</span></span>
<span id="cb53-101"><a href="Preprocesamiento.html#cb53-101" tabindex="-1"></a>  df_seas12      <span class="co"># Estacionalidad mensual (12) desde MESES</span></span>
<span id="cb53-102"><a href="Preprocesamiento.html#cb53-102" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb53-103"><a href="Preprocesamiento.html#cb53-103" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb53-104"><a href="Preprocesamiento.html#cb53-104" tabindex="-1"></a>    <span class="at">Componente =</span> <span class="fu">factor</span>(</span>
<span id="cb53-105"><a href="Preprocesamiento.html#cb53-105" tabindex="-1"></a>      Componente,</span>
<span id="cb53-106"><a href="Preprocesamiento.html#cb53-106" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;Observada&quot;</span>, <span class="st">&quot;Tendencia&quot;</span>,</span>
<span id="cb53-107"><a href="Preprocesamiento.html#cb53-107" tabindex="-1"></a>                 <span class="st">&quot;Estacionalidad diaria (24h)&quot;</span>,</span>
<span id="cb53-108"><a href="Preprocesamiento.html#cb53-108" tabindex="-1"></a>                 <span class="st">&quot;Estacionalidad semanal (7d)&quot;</span>,</span>
<span id="cb53-109"><a href="Preprocesamiento.html#cb53-109" tabindex="-1"></a>                 <span class="st">&quot;Estacionalidad mensual (12)&quot;</span>,</span>
<span id="cb53-110"><a href="Preprocesamiento.html#cb53-110" tabindex="-1"></a>                 <span class="st">&quot;Estacionalidad anual (365d)&quot;</span>,</span>
<span id="cb53-111"><a href="Preprocesamiento.html#cb53-111" tabindex="-1"></a>                 <span class="st">&quot;Residuo&quot;</span>)</span>
<span id="cb53-112"><a href="Preprocesamiento.html#cb53-112" tabindex="-1"></a>    )</span>
<span id="cb53-113"><a href="Preprocesamiento.html#cb53-113" tabindex="-1"></a>  )</span>
<span id="cb53-114"><a href="Preprocesamiento.html#cb53-114" tabindex="-1"></a></span>
<span id="cb53-115"><a href="Preprocesamiento.html#cb53-115" tabindex="-1"></a><span class="co"># ========== E) Gráfico ==========</span></span>
<span id="cb53-116"><a href="Preprocesamiento.html#cb53-116" tabindex="-1"></a><span class="fu">ggplot</span>(panel_all, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> Valor)) <span class="sc">+</span></span>
<span id="cb53-117"><a href="Preprocesamiento.html#cb53-117" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">0.45</span>, <span class="at">alpha =</span> <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb53-118"><a href="Preprocesamiento.html#cb53-118" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Componente, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>, <span class="at">drop =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb53-119"><a href="Preprocesamiento.html#cb53-119" tabindex="-1"></a>  <span class="fu">scale_x_datetime</span>(<span class="at">date_breaks =</span> <span class="st">&quot;6 months&quot;</span>, <span class="at">date_labels =</span> <span class="st">&quot;%b-%Y&quot;</span>) <span class="sc">+</span></span>
<span id="cb53-120"><a href="Preprocesamiento.html#cb53-120" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">x =</span> <span class="fu">guide_axis</span>(<span class="at">n.dodge =</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb53-121"><a href="Preprocesamiento.html#cb53-121" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb53-122"><a href="Preprocesamiento.html#cb53-122" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Descomposición combinada de la serie completa&quot;</span>,</span>
<span id="cb53-123"><a href="Preprocesamiento.html#cb53-123" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Tendencia + Estacionalidades diaria (24h), semanal (7d), mensual (12) y anual (365d) + Residuo&quot;</span>,</span>
<span id="cb53-124"><a href="Preprocesamiento.html#cb53-124" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Valor&quot;</span></span>
<span id="cb53-125"><a href="Preprocesamiento.html#cb53-125" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb53-126"><a href="Preprocesamiento.html#cb53-126" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb53-127"><a href="Preprocesamiento.html#cb53-127" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb53-128"><a href="Preprocesamiento.html#cb53-128" tabindex="-1"></a>        <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-22-1.png" width="1152" /></p>
<div id="descomposición-de-la-serie-por-estacionalidades" class="section level3 hasAnchor" number="4.6.1">
<h3><span class="header-section-number">4.6.1</span> Descomposición de la serie por estacionalidades<a href="Preprocesamiento.html#descomposici%C3%B3n-de-la-serie-por-estacionalidades" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="Preprocesamiento.html#cb54-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb54-2"><a href="Preprocesamiento.html#cb54-2" tabindex="-1"></a><span class="co"># Descomposición óptima de la serie:</span></span>
<span id="cb54-3"><a href="Preprocesamiento.html#cb54-3" tabindex="-1"></a><span class="co">#  - Diaria (24h)      → serie horaria  (MSTL, seasonal.periods=24)</span></span>
<span id="cb54-4"><a href="Preprocesamiento.html#cb54-4" tabindex="-1"></a><span class="co">#  - Semanal (7d)      → serie horaria  (MSTL, seasonal.periods=168)</span></span>
<span id="cb54-5"><a href="Preprocesamiento.html#cb54-5" tabindex="-1"></a><span class="co">#  - Mensual (12)      → serie mensual  (STL,  frequency=12)</span></span>
<span id="cb54-6"><a href="Preprocesamiento.html#cb54-6" tabindex="-1"></a><span class="co">#  - Anual (365d)      → serie diaria   (STL,  frequency=365)</span></span>
<span id="cb54-7"><a href="Preprocesamiento.html#cb54-7" tabindex="-1"></a><span class="co"># Gráficos en orden: Observada → Tendencia → Estacionalidad → Residuo</span></span>
<span id="cb54-8"><a href="Preprocesamiento.html#cb54-8" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb54-9"><a href="Preprocesamiento.html#cb54-9" tabindex="-1"></a></span>
<span id="cb54-10"><a href="Preprocesamiento.html#cb54-10" tabindex="-1"></a><span class="co"># ==== 0) Utilidades ====</span></span>
<span id="cb54-11"><a href="Preprocesamiento.html#cb54-11" tabindex="-1"></a>val_col <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="st">&quot;val_impu&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_impu)) <span class="st">&quot;val_impu&quot;</span> <span class="cf">else</span> <span class="st">&quot;VALOR_IMPUTADO&quot;</span></span>
<span id="cb54-12"><a href="Preprocesamiento.html#cb54-12" tabindex="-1"></a></span>
<span id="cb54-13"><a href="Preprocesamiento.html#cb54-13" tabindex="-1"></a><span class="co"># Detecta, dentro de un data.frame de mstl/stl, la columna estacional de un periodo dado</span></span>
<span id="cb54-14"><a href="Preprocesamiento.html#cb54-14" tabindex="-1"></a>find_seasonal_col <span class="ot">&lt;-</span> <span class="cf">function</span>(df_comp, target_period) {</span>
<span id="cb54-15"><a href="Preprocesamiento.html#cb54-15" tabindex="-1"></a>  nm <span class="ot">&lt;-</span> <span class="fu">names</span>(df_comp)</span>
<span id="cb54-16"><a href="Preprocesamiento.html#cb54-16" tabindex="-1"></a>  <span class="co"># posibles nombres: &quot;Seasonal-24&quot;, &quot;Seasonal 24&quot;, &quot;seasonal24&quot;, etc.</span></span>
<span id="cb54-17"><a href="Preprocesamiento.html#cb54-17" tabindex="-1"></a>  is_seas <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">&quot;^Seasonal&quot;</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-18"><a href="Preprocesamiento.html#cb54-18" tabindex="-1"></a>  seas_nm <span class="ot">&lt;-</span> nm[is_seas]</span>
<span id="cb54-19"><a href="Preprocesamiento.html#cb54-19" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(seas_nm)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb54-20"><a href="Preprocesamiento.html#cb54-20" tabindex="-1"></a>  getp <span class="ot">&lt;-</span> <span class="cf">function</span>(s) { p <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;[^0-9]&quot;</span>, <span class="st">&quot;&quot;</span>, s); <span class="cf">if</span> (<span class="fu">nzchar</span>(p)) <span class="fu">as.integer</span>(p) <span class="cf">else</span> <span class="cn">NA_integer_</span> }</span>
<span id="cb54-21"><a href="Preprocesamiento.html#cb54-21" tabindex="-1"></a>  periods <span class="ot">&lt;-</span> <span class="fu">vapply</span>(seas_nm, getp, <span class="fu">integer</span>(<span class="dv">1</span>))</span>
<span id="cb54-22"><a href="Preprocesamiento.html#cb54-22" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which</span>(periods <span class="sc">==</span> target_period)</span>
<span id="cb54-23"><a href="Preprocesamiento.html#cb54-23" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(idx)) seas_nm[idx[<span class="dv">1</span>]] <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb54-24"><a href="Preprocesamiento.html#cb54-24" tabindex="-1"></a>}</span>
<span id="cb54-25"><a href="Preprocesamiento.html#cb54-25" tabindex="-1"></a></span>
<span id="cb54-26"><a href="Preprocesamiento.html#cb54-26" tabindex="-1"></a><span class="co"># Devuelve nombres (o NA) para Trend y Remainder segun el objeto mstl/stl</span></span>
<span id="cb54-27"><a href="Preprocesamiento.html#cb54-27" tabindex="-1"></a>find_trend_remainder <span class="ot">&lt;-</span> <span class="cf">function</span>(df_comp) {</span>
<span id="cb54-28"><a href="Preprocesamiento.html#cb54-28" tabindex="-1"></a>  nm <span class="ot">&lt;-</span> <span class="fu">names</span>(df_comp)</span>
<span id="cb54-29"><a href="Preprocesamiento.html#cb54-29" tabindex="-1"></a>  trend <span class="ot">&lt;-</span> nm[<span class="fu">grepl</span>(<span class="st">&quot;^Trend$&quot;</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb54-30"><a href="Preprocesamiento.html#cb54-30" tabindex="-1"></a>  remainder <span class="ot">&lt;-</span> nm[<span class="fu">grepl</span>(<span class="st">&quot;^Remainder$&quot;</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb54-31"><a href="Preprocesamiento.html#cb54-31" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">trend =</span> <span class="cf">if</span> (<span class="fu">length</span>(trend)) trend[<span class="dv">1</span>] <span class="cf">else</span> <span class="cn">NA_character_</span>,</span>
<span id="cb54-32"><a href="Preprocesamiento.html#cb54-32" tabindex="-1"></a>       <span class="at">remainder =</span> <span class="cf">if</span> (<span class="fu">length</span>(remainder)) remainder[<span class="dv">1</span>] <span class="cf">else</span> <span class="cn">NA_character_</span>)</span>
<span id="cb54-33"><a href="Preprocesamiento.html#cb54-33" tabindex="-1"></a>}</span>
<span id="cb54-34"><a href="Preprocesamiento.html#cb54-34" tabindex="-1"></a></span>
<span id="cb54-35"><a href="Preprocesamiento.html#cb54-35" tabindex="-1"></a><span class="co"># Constructor genérico de gráfico con orden fijo de facetas</span></span>
<span id="cb54-36"><a href="Preprocesamiento.html#cb54-36" tabindex="-1"></a>plot_decomp <span class="ot">&lt;-</span> <span class="cf">function</span>(df_wide, <span class="at">time_col_name =</span> <span class="st">&quot;time&quot;</span>, <span class="at">title_txt =</span> <span class="st">&quot;&quot;</span>, <span class="at">x_is_date =</span> <span class="cn">FALSE</span>,</span>
<span id="cb54-37"><a href="Preprocesamiento.html#cb54-37" tabindex="-1"></a>                        <span class="at">date_breaks_main =</span> <span class="st">&quot;3 months&quot;</span>) {</span>
<span id="cb54-38"><a href="Preprocesamiento.html#cb54-38" tabindex="-1"></a>  df_long <span class="ot">&lt;-</span> df_wide <span class="sc">|&gt;</span></span>
<span id="cb54-39"><a href="Preprocesamiento.html#cb54-39" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">all_of</span>(time_col_name),</span>
<span id="cb54-40"><a href="Preprocesamiento.html#cb54-40" tabindex="-1"></a>                        <span class="at">names_to =</span> <span class="st">&quot;Componente&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;Valor&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-41"><a href="Preprocesamiento.html#cb54-41" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb54-42"><a href="Preprocesamiento.html#cb54-42" tabindex="-1"></a>      <span class="at">Componente =</span> <span class="fu">factor</span>(</span>
<span id="cb54-43"><a href="Preprocesamiento.html#cb54-43" tabindex="-1"></a>        Componente,</span>
<span id="cb54-44"><a href="Preprocesamiento.html#cb54-44" tabindex="-1"></a>        <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;Observada&quot;</span>,<span class="st">&quot;Tendencia&quot;</span>,<span class="st">&quot;Estacionalidad&quot;</span>,<span class="st">&quot;Residuo&quot;</span>)</span>
<span id="cb54-45"><a href="Preprocesamiento.html#cb54-45" tabindex="-1"></a>      )</span>
<span id="cb54-46"><a href="Preprocesamiento.html#cb54-46" tabindex="-1"></a>    )</span>
<span id="cb54-47"><a href="Preprocesamiento.html#cb54-47" tabindex="-1"></a></span>
<span id="cb54-48"><a href="Preprocesamiento.html#cb54-48" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_long, <span class="fu">aes</span>(<span class="at">x =</span> .data[[time_col_name]], <span class="at">y =</span> Valor)) <span class="sc">+</span></span>
<span id="cb54-49"><a href="Preprocesamiento.html#cb54-49" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">0.6</span>, <span class="at">alpha =</span> <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb54-50"><a href="Preprocesamiento.html#cb54-50" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> Componente, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="sc">+</span></span>
<span id="cb54-51"><a href="Preprocesamiento.html#cb54-51" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> title_txt, <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Valor&quot;</span>) <span class="sc">+</span></span>
<span id="cb54-52"><a href="Preprocesamiento.html#cb54-52" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb54-53"><a href="Preprocesamiento.html#cb54-53" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb54-54"><a href="Preprocesamiento.html#cb54-54" tabindex="-1"></a>          <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span>
<span id="cb54-55"><a href="Preprocesamiento.html#cb54-55" tabindex="-1"></a></span>
<span id="cb54-56"><a href="Preprocesamiento.html#cb54-56" tabindex="-1"></a>  <span class="cf">if</span> (x_is_date) {</span>
<span id="cb54-57"><a href="Preprocesamiento.html#cb54-57" tabindex="-1"></a>    p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb54-58"><a href="Preprocesamiento.html#cb54-58" tabindex="-1"></a>      <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> date_breaks_main, <span class="at">date_labels =</span> <span class="st">&quot;%b-%Y&quot;</span>) <span class="sc">+</span></span>
<span id="cb54-59"><a href="Preprocesamiento.html#cb54-59" tabindex="-1"></a>      <span class="fu">guides</span>(<span class="at">x =</span> <span class="fu">guide_axis</span>(<span class="at">n.dodge =</span> <span class="dv">2</span>))</span>
<span id="cb54-60"><a href="Preprocesamiento.html#cb54-60" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb54-61"><a href="Preprocesamiento.html#cb54-61" tabindex="-1"></a>    p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb54-62"><a href="Preprocesamiento.html#cb54-62" tabindex="-1"></a>      <span class="fu">scale_x_datetime</span>(<span class="at">date_breaks =</span> date_breaks_main, <span class="at">date_labels =</span> <span class="st">&quot;%b-%Y&quot;</span>) <span class="sc">+</span></span>
<span id="cb54-63"><a href="Preprocesamiento.html#cb54-63" tabindex="-1"></a>      <span class="fu">guides</span>(<span class="at">x =</span> <span class="fu">guide_axis</span>(<span class="at">n.dodge =</span> <span class="dv">2</span>))</span>
<span id="cb54-64"><a href="Preprocesamiento.html#cb54-64" tabindex="-1"></a>  }</span>
<span id="cb54-65"><a href="Preprocesamiento.html#cb54-65" tabindex="-1"></a>  p</span>
<span id="cb54-66"><a href="Preprocesamiento.html#cb54-66" tabindex="-1"></a>}</span>
<span id="cb54-67"><a href="Preprocesamiento.html#cb54-67" tabindex="-1"></a></span>
<span id="cb54-68"><a href="Preprocesamiento.html#cb54-68" tabindex="-1"></a><span class="co"># ==== 1) Serie HORARIA → diaria(24h) y semanal(168h) con MSTL ====</span></span>
<span id="cb54-69"><a href="Preprocesamiento.html#cb54-69" tabindex="-1"></a>x_hour  <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(df_impu[[val_col]])</span>
<span id="cb54-70"><a href="Preprocesamiento.html#cb54-70" tabindex="-1"></a>time_hr <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(df_impu[[time_col]])</span>
<span id="cb54-71"><a href="Preprocesamiento.html#cb54-71" tabindex="-1"></a></span>
<span id="cb54-72"><a href="Preprocesamiento.html#cb54-72" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">length</span>(x_hour) <span class="sc">&gt;=</span> <span class="dv">24</span><span class="sc">*</span><span class="dv">14</span>)  <span class="co"># al menos ~2 semanas</span></span>
<span id="cb54-73"><a href="Preprocesamiento.html#cb54-73" tabindex="-1"></a></span>
<span id="cb54-74"><a href="Preprocesamiento.html#cb54-74" tabindex="-1"></a>ts_hour <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">msts</span>(x_hour, <span class="at">seasonal.periods =</span> <span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">168</span>))</span>
<span id="cb54-75"><a href="Preprocesamiento.html#cb54-75" tabindex="-1"></a>fit_mstl_hr <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">mstl</span>(ts_hour, <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-76"><a href="Preprocesamiento.html#cb54-76" tabindex="-1"></a>comp_hr <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_mstl_hr)</span>
<span id="cb54-77"><a href="Preprocesamiento.html#cb54-77" tabindex="-1"></a></span>
<span id="cb54-78"><a href="Preprocesamiento.html#cb54-78" tabindex="-1"></a><span class="co"># columnas clave</span></span>
<span id="cb54-79"><a href="Preprocesamiento.html#cb54-79" tabindex="-1"></a>cols_hr <span class="ot">&lt;-</span> <span class="fu">find_trend_remainder</span>(comp_hr)</span>
<span id="cb54-80"><a href="Preprocesamiento.html#cb54-80" tabindex="-1"></a>col_trend_hr <span class="ot">&lt;-</span> cols_hr<span class="sc">$</span>trend</span>
<span id="cb54-81"><a href="Preprocesamiento.html#cb54-81" tabindex="-1"></a>col_rem_hr   <span class="ot">&lt;-</span> cols_hr<span class="sc">$</span>remainder</span>
<span id="cb54-82"><a href="Preprocesamiento.html#cb54-82" tabindex="-1"></a>col_s24      <span class="ot">&lt;-</span> <span class="fu">find_seasonal_col</span>(comp_hr, <span class="dv">24</span>)</span>
<span id="cb54-83"><a href="Preprocesamiento.html#cb54-83" tabindex="-1"></a>col_s168     <span class="ot">&lt;-</span> <span class="fu">find_seasonal_col</span>(comp_hr, <span class="dv">168</span>)</span>
<span id="cb54-84"><a href="Preprocesamiento.html#cb54-84" tabindex="-1"></a></span>
<span id="cb54-85"><a href="Preprocesamiento.html#cb54-85" tabindex="-1"></a><span class="co"># --- A) Diaria (24h) sobre la serie horaria ---</span></span>
<span id="cb54-86"><a href="Preprocesamiento.html#cb54-86" tabindex="-1"></a>df_day24 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb54-87"><a href="Preprocesamiento.html#cb54-87" tabindex="-1"></a>  <span class="at">time        =</span> time_hr,</span>
<span id="cb54-88"><a href="Preprocesamiento.html#cb54-88" tabindex="-1"></a>  <span class="at">Observada   =</span> x_hour,</span>
<span id="cb54-89"><a href="Preprocesamiento.html#cb54-89" tabindex="-1"></a>  <span class="at">Tendencia   =</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(col_trend_hr)) comp_hr[[col_trend_hr]] <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb54-90"><a href="Preprocesamiento.html#cb54-90" tabindex="-1"></a>  <span class="at">Estacionalidad =</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(col_s24)) comp_hr[[col_s24]] <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb54-91"><a href="Preprocesamiento.html#cb54-91" tabindex="-1"></a>  <span class="at">Residuo     =</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(col_rem_hr))   comp_hr[[col_rem_hr]]   <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb54-92"><a href="Preprocesamiento.html#cb54-92" tabindex="-1"></a>)</span>
<span id="cb54-93"><a href="Preprocesamiento.html#cb54-93" tabindex="-1"></a>p_day24 <span class="ot">&lt;-</span> <span class="fu">plot_decomp</span>(df_day24, <span class="at">time_col_name =</span> <span class="st">&quot;time&quot;</span>,</span>
<span id="cb54-94"><a href="Preprocesamiento.html#cb54-94" tabindex="-1"></a>                       <span class="at">title_txt =</span> <span class="st">&quot;Descomposición DIARIA (24h) — serie horaria&quot;</span>,</span>
<span id="cb54-95"><a href="Preprocesamiento.html#cb54-95" tabindex="-1"></a>                       <span class="at">x_is_date =</span> <span class="cn">FALSE</span>, <span class="at">date_breaks_main =</span> <span class="st">&quot;3 months&quot;</span>)</span>
<span id="cb54-96"><a href="Preprocesamiento.html#cb54-96" tabindex="-1"></a></span>
<span id="cb54-97"><a href="Preprocesamiento.html#cb54-97" tabindex="-1"></a><span class="co"># --- B) Semanal (7d=168h) sobre la serie horaria ---</span></span>
<span id="cb54-98"><a href="Preprocesamiento.html#cb54-98" tabindex="-1"></a>df_week168 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb54-99"><a href="Preprocesamiento.html#cb54-99" tabindex="-1"></a>  <span class="at">time        =</span> time_hr,</span>
<span id="cb54-100"><a href="Preprocesamiento.html#cb54-100" tabindex="-1"></a>  <span class="at">Observada   =</span> x_hour,</span>
<span id="cb54-101"><a href="Preprocesamiento.html#cb54-101" tabindex="-1"></a>  <span class="at">Tendencia   =</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(col_trend_hr)) comp_hr[[col_trend_hr]] <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb54-102"><a href="Preprocesamiento.html#cb54-102" tabindex="-1"></a>  <span class="at">Estacionalidad =</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(col_s168)) comp_hr[[col_s168]] <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb54-103"><a href="Preprocesamiento.html#cb54-103" tabindex="-1"></a>  <span class="at">Residuo     =</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(col_rem_hr))   comp_hr[[col_rem_hr]]   <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb54-104"><a href="Preprocesamiento.html#cb54-104" tabindex="-1"></a>)</span>
<span id="cb54-105"><a href="Preprocesamiento.html#cb54-105" tabindex="-1"></a>p_week168 <span class="ot">&lt;-</span> <span class="fu">plot_decomp</span>(df_week168, <span class="at">time_col_name =</span> <span class="st">&quot;time&quot;</span>,</span>
<span id="cb54-106"><a href="Preprocesamiento.html#cb54-106" tabindex="-1"></a>                         <span class="at">title_txt =</span> <span class="st">&quot;Descomposición SEMANAL (7d = 168h) — serie horaria&quot;</span>,</span>
<span id="cb54-107"><a href="Preprocesamiento.html#cb54-107" tabindex="-1"></a>                         <span class="at">x_is_date =</span> <span class="cn">FALSE</span>, <span class="at">date_breaks_main =</span> <span class="st">&quot;6 months&quot;</span>)</span>
<span id="cb54-108"><a href="Preprocesamiento.html#cb54-108" tabindex="-1"></a></span>
<span id="cb54-109"><a href="Preprocesamiento.html#cb54-109" tabindex="-1"></a><span class="co"># ==== 2) Serie MENSUAL → mensual(12) con STL ====</span></span>
<span id="cb54-110"><a href="Preprocesamiento.html#cb54-110" tabindex="-1"></a>monthly <span class="ot">&lt;-</span> df_impu <span class="sc">|&gt;</span></span>
<span id="cb54-111"><a href="Preprocesamiento.html#cb54-111" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">mes =</span> lubridate<span class="sc">::</span><span class="fu">floor_date</span>(.data[[time_col]], <span class="st">&quot;month&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb54-112"><a href="Preprocesamiento.html#cb54-112" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(mes) <span class="sc">|&gt;</span></span>
<span id="cb54-113"><a href="Preprocesamiento.html#cb54-113" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">y =</span> <span class="fu">mean</span>(.data[[val_col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>)</span>
<span id="cb54-114"><a href="Preprocesamiento.html#cb54-114" tabindex="-1"></a></span>
<span id="cb54-115"><a href="Preprocesamiento.html#cb54-115" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">nrow</span>(monthly) <span class="sc">&gt;=</span> <span class="dv">24</span>)</span>
<span id="cb54-116"><a href="Preprocesamiento.html#cb54-116" tabindex="-1"></a></span>
<span id="cb54-117"><a href="Preprocesamiento.html#cb54-117" tabindex="-1"></a>ts_month <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">ts</span>(</span>
<span id="cb54-118"><a href="Preprocesamiento.html#cb54-118" tabindex="-1"></a>  monthly<span class="sc">$</span>y,</span>
<span id="cb54-119"><a href="Preprocesamiento.html#cb54-119" tabindex="-1"></a>  <span class="at">frequency =</span> <span class="dv">12</span>,</span>
<span id="cb54-120"><a href="Preprocesamiento.html#cb54-120" tabindex="-1"></a>  <span class="at">start =</span> <span class="fu">c</span>(lubridate<span class="sc">::</span><span class="fu">year</span>(<span class="fu">min</span>(monthly<span class="sc">$</span>mes)),</span>
<span id="cb54-121"><a href="Preprocesamiento.html#cb54-121" tabindex="-1"></a>            lubridate<span class="sc">::</span><span class="fu">month</span>(<span class="fu">min</span>(monthly<span class="sc">$</span>mes)))</span>
<span id="cb54-122"><a href="Preprocesamiento.html#cb54-122" tabindex="-1"></a>)</span>
<span id="cb54-123"><a href="Preprocesamiento.html#cb54-123" tabindex="-1"></a>fit_stl_m <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">stl</span>(ts_month, <span class="at">s.window =</span> <span class="st">&quot;periodic&quot;</span>, <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-124"><a href="Preprocesamiento.html#cb54-124" tabindex="-1"></a>comp_m <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_stl_m<span class="sc">$</span>time.series)  <span class="co"># seasonal, trend, remainder</span></span>
<span id="cb54-125"><a href="Preprocesamiento.html#cb54-125" tabindex="-1"></a><span class="co"># nombres estandar</span></span>
<span id="cb54-126"><a href="Preprocesamiento.html#cb54-126" tabindex="-1"></a><span class="fu">names</span>(comp_m) <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">names</span>(comp_m))</span>
<span id="cb54-127"><a href="Preprocesamiento.html#cb54-127" tabindex="-1"></a>df_month12 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb54-128"><a href="Preprocesamiento.html#cb54-128" tabindex="-1"></a>  <span class="at">time          =</span> <span class="fu">as.Date</span>(monthly<span class="sc">$</span>mes),</span>
<span id="cb54-129"><a href="Preprocesamiento.html#cb54-129" tabindex="-1"></a>  <span class="at">Observada     =</span> <span class="fu">as.numeric</span>(ts_month),</span>
<span id="cb54-130"><a href="Preprocesamiento.html#cb54-130" tabindex="-1"></a>  <span class="at">Tendencia     =</span> comp_m<span class="sc">$</span>trend,</span>
<span id="cb54-131"><a href="Preprocesamiento.html#cb54-131" tabindex="-1"></a>  <span class="at">Estacionalidad=</span> comp_m<span class="sc">$</span>seasonal,</span>
<span id="cb54-132"><a href="Preprocesamiento.html#cb54-132" tabindex="-1"></a>  <span class="at">Residuo       =</span> comp_m<span class="sc">$</span>remainder</span>
<span id="cb54-133"><a href="Preprocesamiento.html#cb54-133" tabindex="-1"></a>)</span>
<span id="cb54-134"><a href="Preprocesamiento.html#cb54-134" tabindex="-1"></a>p_month12 <span class="ot">&lt;-</span> <span class="fu">plot_decomp</span>(df_month12, <span class="at">time_col_name =</span> <span class="st">&quot;time&quot;</span>,</span>
<span id="cb54-135"><a href="Preprocesamiento.html#cb54-135" tabindex="-1"></a>                         <span class="at">title_txt =</span> <span class="st">&quot;Descomposición MENSUAL (12) — serie mensual&quot;</span>,</span>
<span id="cb54-136"><a href="Preprocesamiento.html#cb54-136" tabindex="-1"></a>                         <span class="at">x_is_date =</span> <span class="cn">TRUE</span>, <span class="at">date_breaks_main =</span> <span class="st">&quot;6 months&quot;</span>)</span>
<span id="cb54-137"><a href="Preprocesamiento.html#cb54-137" tabindex="-1"></a></span>
<span id="cb54-138"><a href="Preprocesamiento.html#cb54-138" tabindex="-1"></a><span class="co"># ==== 3) Serie DIARIA → anual(365) con STL ====</span></span>
<span id="cb54-139"><a href="Preprocesamiento.html#cb54-139" tabindex="-1"></a>daily <span class="ot">&lt;-</span> df_impu <span class="sc">|&gt;</span></span>
<span id="cb54-140"><a href="Preprocesamiento.html#cb54-140" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">day =</span> lubridate<span class="sc">::</span><span class="fu">floor_date</span>(.data[[time_col]], <span class="st">&quot;day&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb54-141"><a href="Preprocesamiento.html#cb54-141" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(day) <span class="sc">|&gt;</span></span>
<span id="cb54-142"><a href="Preprocesamiento.html#cb54-142" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">y =</span> <span class="fu">mean</span>(.data[[val_col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>)</span>
<span id="cb54-143"><a href="Preprocesamiento.html#cb54-143" tabindex="-1"></a></span>
<span id="cb54-144"><a href="Preprocesamiento.html#cb54-144" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">nrow</span>(daily) <span class="sc">&gt;=</span> <span class="dv">365</span>)  <span class="co"># ideal ≥ 2*365 para patrón robusto</span></span>
<span id="cb54-145"><a href="Preprocesamiento.html#cb54-145" tabindex="-1"></a></span>
<span id="cb54-146"><a href="Preprocesamiento.html#cb54-146" tabindex="-1"></a>ts_year <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">ts</span>(</span>
<span id="cb54-147"><a href="Preprocesamiento.html#cb54-147" tabindex="-1"></a>  daily<span class="sc">$</span>y,</span>
<span id="cb54-148"><a href="Preprocesamiento.html#cb54-148" tabindex="-1"></a>  <span class="at">frequency =</span> <span class="dv">365</span>,</span>
<span id="cb54-149"><a href="Preprocesamiento.html#cb54-149" tabindex="-1"></a>  <span class="at">start =</span> <span class="fu">c</span>(lubridate<span class="sc">::</span><span class="fu">year</span>(<span class="fu">min</span>(daily<span class="sc">$</span>day)),</span>
<span id="cb54-150"><a href="Preprocesamiento.html#cb54-150" tabindex="-1"></a>            <span class="fu">as.integer</span>(<span class="fu">format</span>(<span class="fu">min</span>(daily<span class="sc">$</span>day), <span class="st">&quot;%j&quot;</span>)))</span>
<span id="cb54-151"><a href="Preprocesamiento.html#cb54-151" tabindex="-1"></a>)</span>
<span id="cb54-152"><a href="Preprocesamiento.html#cb54-152" tabindex="-1"></a>fit_stl_y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">stl</span>(ts_year, <span class="at">s.window =</span> <span class="st">&quot;periodic&quot;</span>, <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-153"><a href="Preprocesamiento.html#cb54-153" tabindex="-1"></a>comp_y <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_stl_y<span class="sc">$</span>time.series)</span>
<span id="cb54-154"><a href="Preprocesamiento.html#cb54-154" tabindex="-1"></a><span class="fu">names</span>(comp_y) <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">names</span>(comp_y))</span>
<span id="cb54-155"><a href="Preprocesamiento.html#cb54-155" tabindex="-1"></a></span>
<span id="cb54-156"><a href="Preprocesamiento.html#cb54-156" tabindex="-1"></a>df_year365 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb54-157"><a href="Preprocesamiento.html#cb54-157" tabindex="-1"></a>  <span class="at">time          =</span> <span class="fu">as.POSIXct</span>(daily<span class="sc">$</span>day),</span>
<span id="cb54-158"><a href="Preprocesamiento.html#cb54-158" tabindex="-1"></a>  <span class="at">Observada     =</span> <span class="fu">as.numeric</span>(ts_year),</span>
<span id="cb54-159"><a href="Preprocesamiento.html#cb54-159" tabindex="-1"></a>  <span class="at">Tendencia     =</span> comp_y<span class="sc">$</span>trend,</span>
<span id="cb54-160"><a href="Preprocesamiento.html#cb54-160" tabindex="-1"></a>  <span class="at">Estacionalidad=</span> comp_y<span class="sc">$</span>seasonal,</span>
<span id="cb54-161"><a href="Preprocesamiento.html#cb54-161" tabindex="-1"></a>  <span class="at">Residuo       =</span> comp_y<span class="sc">$</span>remainder</span>
<span id="cb54-162"><a href="Preprocesamiento.html#cb54-162" tabindex="-1"></a>)</span>
<span id="cb54-163"><a href="Preprocesamiento.html#cb54-163" tabindex="-1"></a>p_year365 <span class="ot">&lt;-</span> <span class="fu">plot_decomp</span>(df_year365, <span class="at">time_col_name =</span> <span class="st">&quot;time&quot;</span>,</span>
<span id="cb54-164"><a href="Preprocesamiento.html#cb54-164" tabindex="-1"></a>                         <span class="at">title_txt =</span> <span class="st">&quot;Descomposición ANUAL (365d) — serie diaria&quot;</span>,</span>
<span id="cb54-165"><a href="Preprocesamiento.html#cb54-165" tabindex="-1"></a>                         <span class="at">x_is_date =</span> <span class="cn">FALSE</span>, <span class="at">date_breaks_main =</span> <span class="st">&quot;1 year&quot;</span>)</span>
<span id="cb54-166"><a href="Preprocesamiento.html#cb54-166" tabindex="-1"></a></span>
<span id="cb54-167"><a href="Preprocesamiento.html#cb54-167" tabindex="-1"></a><span class="co"># ==== 4) Mostrar los 4 gráficos ====</span></span>
<span id="cb54-168"><a href="Preprocesamiento.html#cb54-168" tabindex="-1"></a>p_day24</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-23-1.png" width="960" /></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="Preprocesamiento.html#cb55-1" tabindex="-1"></a>p_week168</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-23-2.png" width="960" /></p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="Preprocesamiento.html#cb56-1" tabindex="-1"></a>p_month12</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-23-3.png" width="960" /></p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="Preprocesamiento.html#cb57-1" tabindex="-1"></a>p_year365</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-23-4.png" width="960" /></p>
<ul>
<li><p><strong>Tendencia</strong>: suaviza el comportamiento global; muestra una evolución sostenida de la potencia en el tiempo.</p></li>
<li><p><strong>Estacionalidades</strong>:</p>
<ul>
<li><strong>24 h</strong>: patrón diario con repeticiones claras (potencia eléctrica según horas).</li>
<li><strong>7 d</strong>: variación semanal con máximos en ciertos días.</li>
<li><strong>12 m</strong>: ciclo anual ligado a estaciones o periodos de consumo.</li>
<li><strong>365 d</strong>: refina oscilaciones de largo plazo.</li>
</ul></li>
<li><p><strong>Residuo</strong>: oscilaciones aleatorias sin patrón sistemático.</p></li>
<li><p>La descomposición MSTL permite aislar múltiples estacionalidades y verificar si cada componente explica variaciones específicas. No requiere transformaciones adicionales al trabajar sobre serie imputada y diferenciada.</p></li>
</ul>
</div>
<div id="descomposición-de-la-serie-en-una-ventana-de-4-semanas" class="section level3 hasAnchor" number="4.6.2">
<h3><span class="header-section-number">4.6.2</span> Descomposición de la serie en una ventana de 4 semanas<a href="Preprocesamiento.html#descomposici%C3%B3n-de-la-serie-en-una-ventana-de-4-semanas" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="Preprocesamiento.html#cb58-1" tabindex="-1"></a>t0 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb58-2"><a href="Preprocesamiento.html#cb58-2" tabindex="-1"></a></span>
<span id="cb58-3"><a href="Preprocesamiento.html#cb58-3" tabindex="-1"></a>ini_zoom <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(<span class="st">&quot;2021-02-01&quot;</span>, <span class="at">tz =</span> TZ)</span>
<span id="cb58-4"><a href="Preprocesamiento.html#cb58-4" tabindex="-1"></a>fin_zoom <span class="ot">&lt;-</span> ini_zoom <span class="sc">+</span> lubridate<span class="sc">::</span><span class="fu">weeks</span>(<span class="dv">4</span>)</span>
<span id="cb58-5"><a href="Preprocesamiento.html#cb58-5" tabindex="-1"></a></span>
<span id="cb58-6"><a href="Preprocesamiento.html#cb58-6" tabindex="-1"></a>seg_4w <span class="ot">&lt;-</span> df_impu <span class="sc">%&gt;%</span></span>
<span id="cb58-7"><a href="Preprocesamiento.html#cb58-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(.data[[time_col]] <span class="sc">&gt;=</span> ini_zoom,</span>
<span id="cb58-8"><a href="Preprocesamiento.html#cb58-8" tabindex="-1"></a>                .data[[time_col]] <span class="sc">&lt;</span>  fin_zoom)</span>
<span id="cb58-9"><a href="Preprocesamiento.html#cb58-9" tabindex="-1"></a></span>
<span id="cb58-10"><a href="Preprocesamiento.html#cb58-10" tabindex="-1"></a>ts24_zoom <span class="ot">&lt;-</span> <span class="fu">ts</span>(<span class="fu">as.numeric</span>(seg_4w<span class="sc">$</span>val_impu), <span class="at">frequency =</span> <span class="dv">24</span>)</span>
<span id="cb58-11"><a href="Preprocesamiento.html#cb58-11" tabindex="-1"></a></span>
<span id="cb58-12"><a href="Preprocesamiento.html#cb58-12" tabindex="-1"></a>fit_stl <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">stl</span>(ts24_zoom, <span class="at">s.window =</span> <span class="st">&quot;periodic&quot;</span>, <span class="at">robust =</span> <span class="cn">TRUE</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb58-13"><a href="Preprocesamiento.html#cb58-13" tabindex="-1"></a></span>
<span id="cb58-14"><a href="Preprocesamiento.html#cb58-14" tabindex="-1"></a>.timing[[<span class="st">&quot;STL (ventana 4 semanas)&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb58-15"><a href="Preprocesamiento.html#cb58-15" tabindex="-1"></a>  <span class="at">seconds =</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(<span class="fu">Sys.time</span>(), t0, <span class="at">units =</span> <span class="st">&quot;secs&quot;</span>)),</span>
<span id="cb58-16"><a href="Preprocesamiento.html#cb58-16" tabindex="-1"></a>  <span class="at">status  =</span> <span class="cf">if</span> (<span class="fu">inherits</span>(fit_stl, <span class="st">&quot;try-error&quot;</span>)) <span class="st">&quot;ERROR&quot;</span> <span class="cf">else</span> <span class="st">&quot;OK&quot;</span>,</span>
<span id="cb58-17"><a href="Preprocesamiento.html#cb58-17" tabindex="-1"></a>  <span class="at">message =</span> <span class="cf">if</span> (<span class="fu">inherits</span>(fit_stl, <span class="st">&quot;try-error&quot;</span>)) <span class="fu">as.character</span>(fit_stl) <span class="cf">else</span> <span class="st">&quot;&quot;</span></span>
<span id="cb58-18"><a href="Preprocesamiento.html#cb58-18" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="Preprocesamiento.html#cb59-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(fit_stl, <span class="st">&quot;try-error&quot;</span>)) {</span>
<span id="cb59-2"><a href="Preprocesamiento.html#cb59-2" tabindex="-1"></a>  <span class="fu">plot</span>(fit_stl, <span class="at">range.bars =</span> <span class="cn">FALSE</span>, <span class="at">main =</span> <span class="st">&quot;STL (ventana de 4 semanas)&quot;</span>)</span>
<span id="cb59-3"><a href="Preprocesamiento.html#cb59-3" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb59-4"><a href="Preprocesamiento.html#cb59-4" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;No se pudo calcular STL (ver mensaje en la tabla de tiempos).</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb59-5"><a href="Preprocesamiento.html#cb59-5" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/stl-plot-1.png" width="960" /></p>
<ul>
<li><p>Muestra el detalle de la estructura estacional de corto plazo: ciclos diarios consistentes.</p></li>
<li><p>Permite comprobar estabilidad local de la tendencia y detectar posibles cambios abruptos.</p></li>
<li><p>Analizar ventanas cortas sirve para validar la homogeneidad de los patrones estacionales dentro del año.</p></li>
</ul>
</div>
</div>
<div id="selección-del-modelo-eficiente-auto.arima-y-pronóstico" class="section level2 hasAnchor" number="4.7">
<h2><span class="header-section-number">4.7</span> Selección del modelo eficiente (auto.arima) y Pronóstico<a href="Preprocesamiento.html#selecci%C3%B3n-del-modelo-eficiente-auto.arima-y-pron%C3%B3stico" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="Preprocesamiento.html#cb60-1" tabindex="-1"></a><span class="fu">tm</span>(<span class="st">&quot;Ajuste SARIMA + Pronóstico&quot;</span>, {</span>
<span id="cb60-2"><a href="Preprocesamiento.html#cb60-2" tabindex="-1"></a>y_fit <span class="ot">&lt;&lt;-</span> <span class="fu">ts</span>(serie_vec, <span class="at">frequency =</span> <span class="dv">24</span>)</span>
<span id="cb60-3"><a href="Preprocesamiento.html#cb60-3" tabindex="-1"></a></span>
<span id="cb60-4"><a href="Preprocesamiento.html#cb60-4" tabindex="-1"></a>m_auto <span class="ot">&lt;&lt;-</span> forecast<span class="sc">::</span><span class="fu">auto.arima</span>(</span>
<span id="cb60-5"><a href="Preprocesamiento.html#cb60-5" tabindex="-1"></a>y_fit,</span>
<span id="cb60-6"><a href="Preprocesamiento.html#cb60-6" tabindex="-1"></a><span class="at">d =</span> d_sugerido,</span>
<span id="cb60-7"><a href="Preprocesamiento.html#cb60-7" tabindex="-1"></a><span class="at">seasonal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb60-8"><a href="Preprocesamiento.html#cb60-8" tabindex="-1"></a><span class="at">stepwise =</span> <span class="cn">TRUE</span>,</span>
<span id="cb60-9"><a href="Preprocesamiento.html#cb60-9" tabindex="-1"></a><span class="at">approximation =</span> arima_approx,</span>
<span id="cb60-10"><a href="Preprocesamiento.html#cb60-10" tabindex="-1"></a><span class="at">max.p =</span> <span class="dv">5</span>, <span class="at">max.q =</span> <span class="dv">5</span>, <span class="at">max.P =</span> <span class="dv">2</span>, <span class="at">max.Q =</span> <span class="dv">2</span></span>
<span id="cb60-11"><a href="Preprocesamiento.html#cb60-11" tabindex="-1"></a>)</span>
<span id="cb60-12"><a href="Preprocesamiento.html#cb60-12" tabindex="-1"></a><span class="fu">print</span>(m_auto)</span>
<span id="cb60-13"><a href="Preprocesamiento.html#cb60-13" tabindex="-1"></a></span>
<span id="cb60-14"><a href="Preprocesamiento.html#cb60-14" tabindex="-1"></a>h_days <span class="ot">&lt;&lt;-</span> horizon_days</span>
<span id="cb60-15"><a href="Preprocesamiento.html#cb60-15" tabindex="-1"></a>h <span class="ot">&lt;&lt;-</span> <span class="dv">24</span> <span class="sc">*</span> h_days</span>
<span id="cb60-16"><a href="Preprocesamiento.html#cb60-16" tabindex="-1"></a></span>
<span id="cb60-17"><a href="Preprocesamiento.html#cb60-17" tabindex="-1"></a>fc <span class="ot">&lt;&lt;-</span> forecast<span class="sc">::</span><span class="fu">forecast</span>(m_auto, <span class="at">h =</span> h)</span>
<span id="cb60-18"><a href="Preprocesamiento.html#cb60-18" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">autoplot</span>(fc) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Pronóstico SARIMA (&quot;</span>, h_days, <span class="st">&quot; días)&quot;</span>),</span>
<span id="cb60-19"><a href="Preprocesamiento.html#cb60-19" tabindex="-1"></a><span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia&quot;</span>))</span>
<span id="cb60-20"><a href="Preprocesamiento.html#cb60-20" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Series: y_fit 
## ARIMA(1,1,1)(0,0,2)[24] 
## 
## Coefficients:
##           ar1     ma1    sma1    sma2
##       -0.8940  0.9736  0.0222  0.0110
## s.e.   0.0023  0.0012  0.0029  0.0028
## 
## sigma^2 = 249612:  log likelihood = -905595.9
## AIC=1811202   AICc=1811202   BIC=1811250</code></pre>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-24-1.png" width="960" /></p>
<ul>
<li><p><strong>auto.arima</strong> selecciona automáticamente (p, d, q) y (P, D, Q)[s]</p>
<ul>
<li>d = 1 (diferenciación no estacional) para eliminar tendencia.</li>
<li>[24] como periodicidad diaria.</li>
<li>MA/AR estacionales que capturan los picos en ACF/PACF.</li>
</ul></li>
<li><p>El modelo incluye diferenciación (d = 1) y componente estacional de 24 h; por tanto, controla la tendencia y la variabilidad residual detectadas en etapas anteriores.</p></li>
<li><p>SARIMA es apropiado cuando existe estructura autoregresiva + estacionalidad fija. La diferenciación previa y la evidencia ACF/PACF respaldan esta elección.</p></li>
</ul>
<div id="zoom-al-pronóstico" class="section level3 hasAnchor" number="4.7.1">
<h3><span class="header-section-number">4.7.1</span> Zoom al Pronóstico<a href="Preprocesamiento.html#zoom-al-pron%C3%B3stico" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="Preprocesamiento.html#cb62-1" tabindex="-1"></a><span class="co"># ==== ZOOM FINAL AL PRONÓSTICO ====</span></span>
<span id="cb62-2"><a href="Preprocesamiento.html#cb62-2" tabindex="-1"></a></span>
<span id="cb62-3"><a href="Preprocesamiento.html#cb62-3" tabindex="-1"></a>history_days <span class="ot">&lt;-</span> <span class="dv">21</span></span>
<span id="cb62-4"><a href="Preprocesamiento.html#cb62-4" tabindex="-1"></a>h_days       <span class="ot">&lt;-</span> horizon_days <span class="sc">%||%</span> <span class="dv">7</span></span>
<span id="cb62-5"><a href="Preprocesamiento.html#cb62-5" tabindex="-1"></a></span>
<span id="cb62-6"><a href="Preprocesamiento.html#cb62-6" tabindex="-1"></a>hist_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb62-7"><a href="Preprocesamiento.html#cb62-7" tabindex="-1"></a>  <span class="at">time =</span> <span class="fu">as.POSIXct</span>(df_impu[[time_col]], <span class="at">tz =</span> TZ),</span>
<span id="cb62-8"><a href="Preprocesamiento.html#cb62-8" tabindex="-1"></a>  <span class="at">y    =</span> <span class="fu">as.numeric</span>(df_impu<span class="sc">$</span>val_impu)</span>
<span id="cb62-9"><a href="Preprocesamiento.html#cb62-9" tabindex="-1"></a>)</span>
<span id="cb62-10"><a href="Preprocesamiento.html#cb62-10" tabindex="-1"></a>t_max <span class="ot">&lt;-</span> <span class="fu">max</span>(hist_df<span class="sc">$</span>time, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb62-11"><a href="Preprocesamiento.html#cb62-11" tabindex="-1"></a></span>
<span id="cb62-12"><a href="Preprocesamiento.html#cb62-12" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="fu">length</span>(fc<span class="sc">$</span>mean)</span>
<span id="cb62-13"><a href="Preprocesamiento.html#cb62-13" tabindex="-1"></a>f_times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> t_max <span class="sc">+</span> <span class="fu">hours</span>(<span class="dv">1</span>), <span class="at">by =</span> <span class="st">&quot;1 hour&quot;</span>, <span class="at">length.out =</span> h)</span>
<span id="cb62-14"><a href="Preprocesamiento.html#cb62-14" tabindex="-1"></a></span>
<span id="cb62-15"><a href="Preprocesamiento.html#cb62-15" tabindex="-1"></a>fc_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb62-16"><a href="Preprocesamiento.html#cb62-16" tabindex="-1"></a>  <span class="at">time  =</span> f_times,</span>
<span id="cb62-17"><a href="Preprocesamiento.html#cb62-17" tabindex="-1"></a>  <span class="at">mean  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>mean),</span>
<span id="cb62-18"><a href="Preprocesamiento.html#cb62-18" tabindex="-1"></a>  <span class="at">lo80  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>lower[,<span class="st">&quot;80%&quot;</span>]),</span>
<span id="cb62-19"><a href="Preprocesamiento.html#cb62-19" tabindex="-1"></a>  <span class="at">hi80  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>upper[,<span class="st">&quot;80%&quot;</span>]),</span>
<span id="cb62-20"><a href="Preprocesamiento.html#cb62-20" tabindex="-1"></a>  <span class="at">lo95  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>lower[,<span class="st">&quot;95%&quot;</span>]),</span>
<span id="cb62-21"><a href="Preprocesamiento.html#cb62-21" tabindex="-1"></a>  <span class="at">hi95  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>upper[,<span class="st">&quot;95%&quot;</span>])</span>
<span id="cb62-22"><a href="Preprocesamiento.html#cb62-22" tabindex="-1"></a>)</span>
<span id="cb62-23"><a href="Preprocesamiento.html#cb62-23" tabindex="-1"></a></span>
<span id="cb62-24"><a href="Preprocesamiento.html#cb62-24" tabindex="-1"></a>t_ini <span class="ot">&lt;-</span> t_max <span class="sc">-</span> <span class="fu">days</span>(history_days)</span>
<span id="cb62-25"><a href="Preprocesamiento.html#cb62-25" tabindex="-1"></a>t_fin <span class="ot">&lt;-</span> <span class="fu">max</span>(fc_df<span class="sc">$</span>time)</span>
<span id="cb62-26"><a href="Preprocesamiento.html#cb62-26" tabindex="-1"></a></span>
<span id="cb62-27"><a href="Preprocesamiento.html#cb62-27" tabindex="-1"></a>hist_zoom <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(hist_df, time <span class="sc">&gt;=</span> t_ini)</span>
<span id="cb62-28"><a href="Preprocesamiento.html#cb62-28" tabindex="-1"></a></span>
<span id="cb62-29"><a href="Preprocesamiento.html#cb62-29" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb62-30"><a href="Preprocesamiento.html#cb62-30" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> fc_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">ymin =</span> lo95, <span class="at">ymax =</span> hi95),</span>
<span id="cb62-31"><a href="Preprocesamiento.html#cb62-31" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.15</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb62-32"><a href="Preprocesamiento.html#cb62-32" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> fc_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">ymin =</span> lo80, <span class="at">ymax =</span> hi80),</span>
<span id="cb62-33"><a href="Preprocesamiento.html#cb62-33" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb62-34"><a href="Preprocesamiento.html#cb62-34" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> fc_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mean),</span>
<span id="cb62-35"><a href="Preprocesamiento.html#cb62-35" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">linewidth =</span> <span class="fl">1.0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb62-36"><a href="Preprocesamiento.html#cb62-36" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> hist_zoom, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> y),</span>
<span id="cb62-37"><a href="Preprocesamiento.html#cb62-37" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&quot;grey40&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.4</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb62-38"><a href="Preprocesamiento.html#cb62-38" tabindex="-1"></a>  <span class="fu">scale_x_datetime</span>(<span class="at">limits =</span> <span class="fu">c</span>(t_ini, t_fin),</span>
<span id="cb62-39"><a href="Preprocesamiento.html#cb62-39" tabindex="-1"></a>                   <span class="at">date_breaks =</span> <span class="st">&quot;3 days&quot;</span>,  <span class="co"># ← espaciado más grande</span></span>
<span id="cb62-40"><a href="Preprocesamiento.html#cb62-40" tabindex="-1"></a>                   <span class="at">date_labels =</span> <span class="st">&quot;%d-%b&quot;</span>) <span class="sc">+</span>  <span class="co"># ← formato sin hora</span></span>
<span id="cb62-41"><a href="Preprocesamiento.html#cb62-41" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10000</span>)) <span class="sc">+</span>  <span class="co"># recorta sin descartar filas</span></span>
<span id="cb62-42"><a href="Preprocesamiento.html#cb62-42" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Zoom final del Pronóstico SARIMA (&quot;</span>, h_days, <span class="st">&quot; días)&quot;</span>),</span>
<span id="cb62-43"><a href="Preprocesamiento.html#cb62-43" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Últimos &quot;</span>, history_days, <span class="st">&quot; días de historia + predicción&quot;</span>),</span>
<span id="cb62-44"><a href="Preprocesamiento.html#cb62-44" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia&quot;</span>) <span class="sc">+</span></span>
<span id="cb62-45"><a href="Preprocesamiento.html#cb62-45" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb62-46"><a href="Preprocesamiento.html#cb62-46" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb62-47"><a href="Preprocesamiento.html#cb62-47" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb62-48"><a href="Preprocesamiento.html#cb62-48" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb62-49"><a href="Preprocesamiento.html#cb62-49" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)  <span class="co"># ← evita solapamiento</span></span>
<span id="cb62-50"><a href="Preprocesamiento.html#cb62-50" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-25-1.png" width="960" /></p>
<ul>
<li><p><strong>Línea negra</strong>: representa los últimos 21 días de la serie observada, durante este período, la potencia muestra una variabilidad marcada con picos altos (entre 7000 y 10000 unidades) y caídas bruscas hacia valores bajos.</p></li>
<li><p><strong>Línea azul</strong>: corresponde a la predicción puntual generada por el modelo SARIMA para los siguientes 7 días. Esta predicción se mantiene estable y suavizada en comparación con la serie observada, lo que indica que el modelo estima que la potencia tenderá a estabilizarse alrededor de un valor medio cercano a los 4500–5000 unidades.</p></li>
<li><p><strong>Franjas azules (bandas de confianza)</strong>: La franja más oscura representa el intervalo de confianza al 80 % y la franja más clara, el intervalo al 95 %. Estas bandas muestran la incertidumbre asociada a la predicción: a medida que el horizonte temporal avanza, las bandas se ensanchan, lo que significa que el modelo tiene menos certeza sobre los valores futuros. El ensanchamiento pronunciado indica que la volatilidad pasada influye fuertemente en la incertidumbre del pronóstico.</p></li>
<li><p>El modelo sugiere una tendencia de estabilización en los valores de potencia para la semana siguiente. No se anticipan picos extremos ni caídas abruptas.</p></li>
<li><p>Dado que las bandas de confianza se mantienen dentro del rango esperado (0 – 10000), el ajuste es razonable y coherente con la magnitud de los datos históricos.</p></li>
<li><p>Las bandas amplias implican que, aunque el modelo capta bien la tendencia general, la precisión puntual es limitada. Esto es común en series con ruido y estacionalidades múltiples.</p></li>
</ul>
</div>
</div>
<div id="puntos-de-cambio-y-visualización" class="section level2 hasAnchor" number="4.8">
<h2><span class="header-section-number">4.8</span> Puntos de cambio y visualización<a href="Preprocesamiento.html#puntos-de-cambio-y-visualizaci%C3%B3n" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="Preprocesamiento.html#cb63-1" tabindex="-1"></a>daily <span class="ot">&lt;-</span> df_impu <span class="sc">%&gt;%</span></span>
<span id="cb63-2"><a href="Preprocesamiento.html#cb63-2" tabindex="-1"></a><span class="fu">mutate</span>(<span class="at">day =</span> <span class="fu">floor_date</span>(.data[[time_col]], <span class="st">&quot;day&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb63-3"><a href="Preprocesamiento.html#cb63-3" tabindex="-1"></a><span class="fu">group_by</span>(day) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">y =</span> <span class="fu">mean</span>(val_impu), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>)</span>
<span id="cb63-4"><a href="Preprocesamiento.html#cb63-4" tabindex="-1"></a></span>
<span id="cb63-5"><a href="Preprocesamiento.html#cb63-5" tabindex="-1"></a><span class="fu">tm</span>(<span class="st">&quot;Changepoint (media diaria, PELT)&quot;</span>, {</span>
<span id="cb63-6"><a href="Preprocesamiento.html#cb63-6" tabindex="-1"></a>cp <span class="ot">&lt;&lt;-</span> <span class="fu">cpt.mean</span>(daily<span class="sc">$</span>y, <span class="at">method =</span> <span class="st">&quot;PELT&quot;</span>, <span class="at">penalty =</span> <span class="st">&quot;SIC&quot;</span>)</span>
<span id="cb63-7"><a href="Preprocesamiento.html#cb63-7" tabindex="-1"></a>})</span>
<span id="cb63-8"><a href="Preprocesamiento.html#cb63-8" tabindex="-1"></a><span class="fu">head</span> (cp<span class="sc">@</span>cpts,<span class="dv">100</span>)  <span class="co"># índices de cambio</span></span></code></pre></div>
<pre><code>##   [1]  29  30  31  33  34  35  36  37  38  39  40  41  42  43  44  45  46  47
##  [19]  48  49  50  51  52  53  54  55  56  57  58  59  60  61  62  63  64  66
##  [37]  67  68  69  70  71  72  73  74  75  76  77  78  79  80  81  82  83  84
##  [55]  85  86  87  88  89  90  91  92  93  94  95  96  97  98  99 100 101 102
##  [73] 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120
##  [91] 121 123 124 125 126 127 128 129 130 131</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="Preprocesamiento.html#cb65-1" tabindex="-1"></a><span class="co"># Overlay en la curva diaria</span></span>
<span id="cb65-2"><a href="Preprocesamiento.html#cb65-2" tabindex="-1"></a></span>
<span id="cb65-3"><a href="Preprocesamiento.html#cb65-3" tabindex="-1"></a><span class="fu">ggplot</span>(daily, <span class="fu">aes</span>(day, y)) <span class="sc">+</span></span>
<span id="cb65-4"><a href="Preprocesamiento.html#cb65-4" tabindex="-1"></a><span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb65-5"><a href="Preprocesamiento.html#cb65-5" tabindex="-1"></a><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> daily<span class="sc">$</span>day[cp<span class="sc">@</span>cpts], <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb65-6"><a href="Preprocesamiento.html#cb65-6" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Media diaria con puntos de cambio (cpt.mean)&quot;</span>,</span>
<span id="cb65-7"><a href="Preprocesamiento.html#cb65-7" tabindex="-1"></a><span class="at">x =</span> <span class="st">&quot;Día&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia media diaria&quot;</span>) <span class="sc">+</span></span>
<span id="cb65-8"><a href="Preprocesamiento.html#cb65-8" tabindex="-1"></a><span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-26-1.png" width="960" /></p>
<ul>
<li><p>El método utilizado (cpt.mean del paquete changepoint) permite identificar momentos en el tiempo donde la media del proceso cambia significativamente, lo cual es muy útil para detectar rupturas, transiciones o alteraciones del régimen de la serie.</p></li>
<li><p>Líneas negras, corresponden a la serie diaria suavizada. Es decir, los valores promedio por día de la potencia, eliminando la variación horaria interna.</p></li>
<li><p>Líneas horizontales rojas (puntos de cambio), indican los momentos en que el algoritmo PELT (Pruned Exact Linear Time) identificó cambios estadísticamente significativos en la media. Cada línea roja marca una ruptura: un punto donde el nivel promedio de la serie cambia de forma abrupta o sostenida.</p></li>
<li><p>La gran cantidad de líneas rojas indica múltiples cambios en la media a lo largo de la serie. Esto sugiere que la potencia no sigue un comportamiento estacionario estable, sino que ha tenido varios periodos con medias distintas —lo cual puede corresponder a modificaciones en la demanda, mantenimiento de equipos, cambios operativos o condiciones externas.</p></li>
<li><p>Periodo 2018–2020: Los valores son relativamente bajos y estables, con algunos incrementos graduales. Los puntos de cambio aquí podrían asociarse a una transición hacia niveles más altos de consumo o potencia.</p></li>
<li><p>Periodo 2020–2021: Se observa una mayor volatilidad, con picos y caídas pronunciadas. Es probable que los puntos de cambio detecten episodios transitorios de aumento o reducción drástica.</p></li>
<li><p>2022 en adelante: La serie aumenta en nivel medio y muestra mayor dispersión, con valores que alcanzan niveles altos de potencia (&gt;6000). Las múltiples líneas rojas en esta etapa indican fluctuaciones más frecuentes, reflejando un sistema con variabilidad estructural más alta o cambios en los patrones de uso.</p></li>
<li><p>La serie de potencia no es homogénea en el tiempo: exhibe múltiples cambios estructurales en su comportamiento medio.</p></li>
<li><p>Estos cambios pueden ser interpretados como etapas operativas o periodos de régimen distinto, lo que justifica la necesidad de aplicar modelos con parámetros variables o segmentados..</p></li>
<li><p>La alta frecuencia de cambios después de 2022 podría indicar mayor inestabilidad del sistema o sensibilidad a factores externos, lo cual también se relaciona con la amplia incertidumbre observada en las bandas del pronóstico SARIMA.</p></li>
</ul>
</div>
<div id="outliers-y-verificación-de-supuestos-del-arima" class="section level2 hasAnchor" number="4.9">
<h2><span class="header-section-number">4.9</span> Outliers y verificación de supuestos del ARIMA<a href="Preprocesamiento.html#outliers-y-verificaci%C3%B3n-de-supuestos-del-arima" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="Preprocesamiento.html#cb66-1" tabindex="-1"></a><span class="co"># Outliers</span></span>
<span id="cb66-2"><a href="Preprocesamiento.html#cb66-2" tabindex="-1"></a></span>
<span id="cb66-3"><a href="Preprocesamiento.html#cb66-3" tabindex="-1"></a>to <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(forecast<span class="sc">::</span><span class="fu">tsoutliers</span>(<span class="fu">ts</span>(serie_vec, <span class="at">frequency =</span> <span class="dv">24</span>)), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb66-4"><a href="Preprocesamiento.html#cb66-4" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(to)) {</span>
<span id="cb66-5"><a href="Preprocesamiento.html#cb66-5" tabindex="-1"></a><span class="co">#print(to)</span></span>
<span id="cb66-6"><a href="Preprocesamiento.html#cb66-6" tabindex="-1"></a>idx <span class="ot">&lt;-</span> to<span class="sc">$</span>index</span>
<span id="cb66-7"><a href="Preprocesamiento.html#cb66-7" tabindex="-1"></a>df_ol <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">time =</span> <span class="fu">as.POSIXct</span>(df_impu[[time_col]])[idx],</span>
<span id="cb66-8"><a href="Preprocesamiento.html#cb66-8" tabindex="-1"></a><span class="at">y =</span> serie_vec[idx])</span>
<span id="cb66-9"><a href="Preprocesamiento.html#cb66-9" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">time =</span> <span class="fu">as.POSIXct</span>(df_impu[[time_col]]), <span class="at">y =</span> serie_vec), <span class="fu">aes</span>(time, y)) <span class="sc">+</span></span>
<span id="cb66-10"><a href="Preprocesamiento.html#cb66-10" tabindex="-1"></a><span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb66-11"><a href="Preprocesamiento.html#cb66-11" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="at">data =</span> df_ol, <span class="fu">aes</span>(time, y), <span class="at">color =</span> <span class="st">&quot;red&quot;</span>, <span class="at">size =</span> <span class="fl">1.4</span>) <span class="sc">+</span></span>
<span id="cb66-12"><a href="Preprocesamiento.html#cb66-12" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Outliers detectados (forecast::tsoutliers)&quot;</span>,</span>
<span id="cb66-13"><a href="Preprocesamiento.html#cb66-13" tabindex="-1"></a><span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia&quot;</span>) <span class="sc">+</span></span>
<span id="cb66-14"><a href="Preprocesamiento.html#cb66-14" tabindex="-1"></a><span class="fu">theme_minimal</span>()</span>
<span id="cb66-15"><a href="Preprocesamiento.html#cb66-15" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-27-1.png" width="960" /></p>
<ul>
<li><p>El análisis de valores atípicos (outliers) identifica puntos que se desvían significativamente del patrón esperado de la serie, considerando su tendencia, estacionalidad y variabilidad histórica.</p></li>
<li><p>Línea gris: Muestra la serie temporal original de potencia, donde se pueden observar los patrones de oscilación, los aumentos progresivos y los periodos de mayor variabilidad.</p></li>
<li><p>Puntos rojos: Señalan los outliers detectados automáticamente por el algoritmo de tsoutliers.Estos puntos representan valores que el modelo considera anómalos, es decir, que se alejan más de lo esperado de acuerdo con la estructura de tendencia y estacionalidad estimada.</p></li>
<li><p>2018–2019: Pocos outliers, mayormente en valores bajos, lo que sugiere una etapa relativamente estable.</p></li>
<li><p>2020–2021: Aumenta la cantidad de outliers tanto por exceso como por defecto (picos y caídas abruptas).Esto puede estar asociado con eventos externos (fallos eléctricos, cambios en la demanda o mantenimiento del sistema) o ajustes en la infraestructura que alteraron momentáneamente los registros.</p></li>
<li><p>2022–2025: Se observa una alta concentración de outliers en la parte superior de la serie, especialmente en los valores más altos de potencia (por encima de 7500). Esto indica un incremento de la variabilidad o posiblemente una saturación del sistema, donde las mediciones superan los niveles esperados con frecuencia.También podría sugerir la presencia de nuevas condiciones operativas no captadas por el modelo (por ejemplo, aumento de la capacidad instalada o un cambio en los hábitos de consumo).</p></li>
<li><p>Los outliers más extremos se presentan en valores cercanos a 0 y por encima de 9000, indicando errores o comportamientos anómalos graves.</p></li>
<li><p>En los periodos intermedios (2019–2020 y 2023–2024), los picos son muy frecuentes, lo que puede afectar la estimación de parámetros del modelo si no se tratan adecuadamente.</p></li>
<li><p>La presencia de tantos outliers sugiere que la serie presenta eventos atípicos recurrentes, los cuales rompen la suposición de normalidad y homocedasticidad requerida por muchos modelos de series temporales.</p></li>
<li><p>Es recomendable tratar o ajustar estos valores antes del modelado.</p></li>
</ul>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="Preprocesamiento.html#cb67-1" tabindex="-1"></a><span class="co"># Supuestos del modelo ARIMA (residuales)</span></span>
<span id="cb67-2"><a href="Preprocesamiento.html#cb67-2" tabindex="-1"></a></span>
<span id="cb67-3"><a href="Preprocesamiento.html#cb67-3" tabindex="-1"></a><span class="fu">checkresiduals</span>(m_auto)   <span class="co"># ACF de residuales, Ljung-Box, histograma, qq-plot</span></span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-28-1.png" width="960" /></p>
<pre><code>## 
##  Ljung-Box test
## 
## data:  Residuals from ARIMA(1,1,1)(0,0,2)[24]
## Q* = 3889, df = 44, p-value &lt; 2.2e-16
## 
## Model df: 4.   Total lags used: 48</code></pre>
<p><strong><em>Ljung-Box test</em></strong></p>
<ul>
<li><p>La prueba de Ljung–Box aplicada a los residuales del modelo ARIMA(1,1,1)(0,0,2)[24], se realiza para evaluar la independencia (no autocorrelación) de los residuos en un modelo de series temporales.</p></li>
<li><p>El valor p-value &lt; 2.2e-16, se rechaza la hipótesis nula H₀, por lo tanto, los residuos presentan autocorrelación, el modelo no explica completamente la dependencia temporal.</p></li>
<li><p>Los residuos NO son ruido blanco, es decir, conservan autocorrelación significativa a lo largo del tiempo.</p></li>
</ul>
<p><strong><em>Diagnósticos residuales del modelo ARIMA(1,1,1)(0,0,2)[24]</em></strong></p>
<ul>
<li><p>Estas tres gráficas es evaluar si los residuos del modelo cumplen los supuestos de un buen ajuste estadístico: independencia, homocedasticidad y normalidad.</p></li>
<li><p>La primera gráfica representa los <strong>residuos en el tiempo</strong> (diferencia entre los valores observados y los predichos por el modelo ARIMA). Cada punto corresponde al error de predicción en una hora.</p>
<ul>
<li>Los residuos oscilan alrededor de 0, lo cual es un signo deseable. Sin embargo, la amplitud de las oscilaciones aumenta considerablemente con el tiempo (desde 2020 en adelante). Esto evidencia <strong>heterocedasticidad</strong>, la varianza de los errores no es constante a lo largo del tiempo.</li>
<li>Hay picos extremos, tanto positivos como negativos (superiores a ±10.000), lo que sugiere la presencia de outliers o errores sistemáticos del modelo en determinados periodos.</li>
<li>Las secciones con mayor densidad de oscilaciones indican que el modelo no logra seguir bien los cambios de nivel o tendencia en esas etapas (por ejemplo, entre 2022 y 2025, coincidiendo con tus resultados de cambio estructural).</li>
<li>Los residuos no son homogéneos ni estacionarios en varianza. Esto implica que el modelo ARIMA(1,1,1)(0,0,2)[24] no captura completamente la dinámica temporal ni la variabilidad creciente de la serie.</li>
</ul></li>
<li><p><strong>ACF (Función de Autocorrelación de los residuos)</strong>, mide la dependencia serial entre los residuos en diferentes rezagos (lags). Las líneas azules representan los límites de confianza (±1.96/√n), dentro de los cuales las autocorrelaciones deberían estar si los residuos fueran puro ruido blanco.</p>
<ul>
<li>En los primeros rezagos (1–10), se aprecian barras que superan los límites de confianza, indicando autocorrelación significativa.</li>
<li>A partir del lag 24 (una periodicidad diaria), todavía se observa un patrón repetitivo leve, lo que sugiere persistencia estacional no explicada.</li>
<li>El resto de los lags muestran valores cercanos a 0, pero el exceso inicial es suficiente para rechazar la hipótesis de independencia.</li>
<li>Los residuos no son completamente independientes, existen dependencias a corto plazo (y posiblemente estacionales) que el modelo no eliminó. Esto coincide con el resultado del test de Ljung–Box, que arrojó un p-valor &lt; 2.2e-16, confirmando la autocorrelación residual.</li>
</ul></li>
<li><p><strong>Histograma y densidad de los residuos</strong>, muestra la distribución de los errores del modelo comparada con una curva normal teórica (línea roja).</p>
<ul>
<li>La distribución está altamente concentrada en torno a 0, pero con colas muy largas y picos extremos. Es decir, los residuos no siguen una distribución normal (hay asimetría y curtosis alta).</li>
<li>Existen muchos valores extremos tanto positivos como negativos, coherentes con los outliers detectados.</li>
<li>La curva teórica normal (en rojo) es mucho más estrecha que la real, lo que confirma la no normalidad de los residuos.</li>
<li>Los residuos no son normales, presentando colas pesadas y picos excesivos.Esto sugiere que el modelo no solo deja autocorrelación, sino también errores estructurados y variabilidad anómala.</li>
</ul></li>
<li><p>Las tres gráficas indican que el modelo ARIMA(1,1,1)(0,0,2)[24] no logra capturar completamente la estructura de la serie temporal. Los residuos conservan autocorrelación, varianza no constante y outliers, por lo que no pueden considerarse ruido blanco.</p></li>
</ul>
<div id="qq-plot-de-los-residuos-del-modelo-arima" class="section level3 hasAnchor" number="4.9.1">
<h3><span class="header-section-number">4.9.1</span> Q–Q Plot de los residuos del modelo ARIMA<a href="Preprocesamiento.html#qq-plot-de-los-residuos-del-modelo-arima" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="Preprocesamiento.html#cb69-1" tabindex="-1"></a><span class="co"># 1) Extraer residuos del modelo ajustado</span></span>
<span id="cb69-2"><a href="Preprocesamiento.html#cb69-2" tabindex="-1"></a>residuales <span class="ot">&lt;-</span> <span class="fu">residuals</span>(m_auto)</span>
<span id="cb69-3"><a href="Preprocesamiento.html#cb69-3" tabindex="-1"></a></span>
<span id="cb69-4"><a href="Preprocesamiento.html#cb69-4" tabindex="-1"></a><span class="co"># 2) Q-Q Plot base (comparación con distribución normal)</span></span>
<span id="cb69-5"><a href="Preprocesamiento.html#cb69-5" tabindex="-1"></a><span class="fu">qqnorm</span>(residuales,</span>
<span id="cb69-6"><a href="Preprocesamiento.html#cb69-6" tabindex="-1"></a>       <span class="at">main =</span> <span class="st">&quot;Q–Q Plot de los residuos del modelo ARIMA(1,1,1)(0,0,2)[24]&quot;</span>,</span>
<span id="cb69-7"><a href="Preprocesamiento.html#cb69-7" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">&quot;Cuantiles teóricos (Normal)&quot;</span>,</span>
<span id="cb69-8"><a href="Preprocesamiento.html#cb69-8" tabindex="-1"></a>       <span class="at">ylab =</span> <span class="st">&quot;Cuantiles de los residuos&quot;</span>,</span>
<span id="cb69-9"><a href="Preprocesamiento.html#cb69-9" tabindex="-1"></a>       <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb69-10"><a href="Preprocesamiento.html#cb69-10" tabindex="-1"></a><span class="fu">qqline</span>(residuales, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-29-1.png" width="960" /></p>
<ul>
<li><p>El Q–Q Plot (Quantile–Quantile Plot) de los residuos del modelo ARIMA(1,1,1)(0,0,2)[24], una herramienta fundamental para evaluar la normalidad de los errores del modelo.</p></li>
<li><p>En el eje X (horizontal) se representan los cuantiles teóricos de una distribución normal estándar.</p></li>
<li><p>En el eje Y (vertical) se muestran los cuantiles observados de los residuos del modelo.</p></li>
<li><p>La línea roja representa la situación ideal, si los residuos fueran perfectamente normales, los puntos azules se alinearían a lo largo de esa línea.</p></li>
<li><p>Los puntos se desvían fuertemente de la línea roja, formando una curva escalonada y asimétrica.</p></li>
<li><p>En las colas (extremos izquierdo y derecho) se observan valores alejados de la recta, indicando colas pesadas o valores extremos.</p></li>
<li><p>En la zona central (cercana a 0), los puntos permanecen relativamente agrupados, pero el patrón general muestra una marcada asimetría vertical, con una diferencia notable entre los residuos negativos (abajo) y positivos (arriba).</p></li>
<li><p>La forma escalonada del gráfico indica que los residuos no siguen una distribución normal.</p></li>
<li><p>Los valores extremos (outliers) son responsables de la curvatura al inicio y al final del gráfico.</p></li>
</ul>
</div>
</div>
<div id="transformación-logarítmica-para-estabilizar-la-varianza" class="section level2 hasAnchor" number="4.10">
<h2><span class="header-section-number">4.10</span> Transformación logarítmica para estabilizar la varianza<a href="Preprocesamiento.html#transformaci%C3%B3n-logar%C3%ADtmica-para-estabilizar-la-varianza" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="Preprocesamiento.html#cb70-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb70-2"><a href="Preprocesamiento.html#cb70-2" tabindex="-1"></a><span class="co"># Transformación logarítmica de la serie de potencia</span></span>
<span id="cb70-3"><a href="Preprocesamiento.html#cb70-3" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb70-4"><a href="Preprocesamiento.html#cb70-4" tabindex="-1"></a></span>
<span id="cb70-5"><a href="Preprocesamiento.html#cb70-5" tabindex="-1"></a><span class="co"># Evitar log(0) o negativos</span></span>
<span id="cb70-6"><a href="Preprocesamiento.html#cb70-6" tabindex="-1"></a>df_log <span class="ot">&lt;-</span> df_impu <span class="sc">%&gt;%</span></span>
<span id="cb70-7"><a href="Preprocesamiento.html#cb70-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">val_log =</span> <span class="fu">log1p</span>(val_impu))  <span class="co"># log(1 + x) evita infinitos</span></span>
<span id="cb70-8"><a href="Preprocesamiento.html#cb70-8" tabindex="-1"></a></span>
<span id="cb70-9"><a href="Preprocesamiento.html#cb70-9" tabindex="-1"></a><span class="co"># Crear serie temporal log-transformada</span></span>
<span id="cb70-10"><a href="Preprocesamiento.html#cb70-10" tabindex="-1"></a>ts_log <span class="ot">&lt;-</span> <span class="fu">ts</span>(df_log<span class="sc">$</span>val_log, <span class="at">frequency =</span> <span class="dv">24</span>)  <span class="co"># frecuencia diaria (24 horas)</span></span>
<span id="cb70-11"><a href="Preprocesamiento.html#cb70-11" tabindex="-1"></a></span>
<span id="cb70-12"><a href="Preprocesamiento.html#cb70-12" tabindex="-1"></a><span class="co"># Visualización básica</span></span>
<span id="cb70-13"><a href="Preprocesamiento.html#cb70-13" tabindex="-1"></a><span class="fu">autoplot</span>(ts_log) <span class="sc">+</span></span>
<span id="cb70-14"><a href="Preprocesamiento.html#cb70-14" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Serie transformada logarítmicamente (log1p)&quot;</span>,</span>
<span id="cb70-15"><a href="Preprocesamiento.html#cb70-15" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;log(1 + Potencia)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>) <span class="sc">+</span></span>
<span id="cb70-16"><a href="Preprocesamiento.html#cb70-16" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-30-1.png" width="960" /></p>
<ul>
<li><p>La transformación logarítmica se aplicó para <strong>reducir la heterocedasticidad</strong> (variabilidad creciente con el nivel de la serie), <strong>atenuar los valores extremos (outliers)</strong>, especialmente los picos de alta potencia y <strong>aproximar la distribución de los datos a la normalidad</strong>, facilitando la aplicación del modelo ARIMA. En otras palabras, se busca <strong>estabilizar la varianza y mejorar el cumplimiento de los supuestos del modelo</strong>.</p></li>
<li><p>En la gráfica se observa un comportamiento estructural similar al de la serie original, pero con amplitud comprimida; los picos muy altos (de más de 10.000 en escala original) se reducen a valores entre 7 y 9 en log(1+x); las fluctuaciones bruscas entre periodos de alta y baja potencia se suavizan notablemente; aun cuando existen saltos entre periodos (régimenes distintos), la variabilidad interna dentro de cada tramo es mucho más homogénea.</p></li>
<li><p>La serie transformada conserva la estructura temporal fundamental (tendencia y estacionalidad) pero elimina gran parte del ruido que dificulta el modelado.</p></li>
</ul>
</div>
<div id="ajuste-del-modelo-arima-en-escala-logarítmica" class="section level2 hasAnchor" number="4.11">
<h2><span class="header-section-number">4.11</span> Ajuste del modelo ARIMA en escala logarítmica<a href="Preprocesamiento.html#ajuste-del-modelo-arima-en-escala-logar%C3%ADtmica" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="Preprocesamiento.html#cb71-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb71-2"><a href="Preprocesamiento.html#cb71-2" tabindex="-1"></a><span class="co"># Ajuste automático ARIMA sobre serie log-transformada</span></span>
<span id="cb71-3"><a href="Preprocesamiento.html#cb71-3" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb71-4"><a href="Preprocesamiento.html#cb71-4" tabindex="-1"></a><span class="fu">tm</span>(<span class="st">&quot;Ajuste SARIMA TS log-transformada&quot;</span>, {</span>
<span id="cb71-5"><a href="Preprocesamiento.html#cb71-5" tabindex="-1"></a></span>
<span id="cb71-6"><a href="Preprocesamiento.html#cb71-6" tabindex="-1"></a>m_log <span class="ot">&lt;&lt;-</span> <span class="fu">auto.arima</span>(ts_log,</span>
<span id="cb71-7"><a href="Preprocesamiento.html#cb71-7" tabindex="-1"></a>                    <span class="at">seasonal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb71-8"><a href="Preprocesamiento.html#cb71-8" tabindex="-1"></a>                    <span class="at">stepwise =</span> <span class="cn">FALSE</span>,</span>
<span id="cb71-9"><a href="Preprocesamiento.html#cb71-9" tabindex="-1"></a>                    <span class="at">approximation =</span> arima_approx,</span>
<span id="cb71-10"><a href="Preprocesamiento.html#cb71-10" tabindex="-1"></a>                    <span class="at">trace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb71-11"><a href="Preprocesamiento.html#cb71-11" tabindex="-1"></a><span class="fu">summary</span>(m_log)</span>
<span id="cb71-12"><a href="Preprocesamiento.html#cb71-12" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## 
##  Fitting models using approximations to speed things up...
## 
##  ARIMA(0,1,0)                               : 114852.4
##  ARIMA(0,1,0)            with drift         : 114854.4
##  ARIMA(0,1,0)(0,0,1)[24]                    : 114854.4
##  ARIMA(0,1,0)(0,0,1)[24] with drift         : 114856.4
##  ARIMA(0,1,0)(0,0,2)[24]                    : 114855.9
##  ARIMA(0,1,0)(0,0,2)[24] with drift         : 114857.9
##  ARIMA(0,1,0)(1,0,0)[24]                    : 114878.2
##  ARIMA(0,1,0)(1,0,0)[24] with drift         : 114880.2
##  ARIMA(0,1,0)(1,0,1)[24]                    : Inf
##  ARIMA(0,1,0)(1,0,1)[24] with drift         : Inf
##  ARIMA(0,1,0)(1,0,2)[24]                    : Inf
##  ARIMA(0,1,0)(1,0,2)[24] with drift         : Inf
##  ARIMA(0,1,0)(2,0,0)[24]                    : 114903.7
##  ARIMA(0,1,0)(2,0,0)[24] with drift         : 114905.7
##  ARIMA(0,1,0)(2,0,1)[24]                    : Inf
##  ARIMA(0,1,0)(2,0,1)[24] with drift         : Inf
##  ARIMA(0,1,0)(2,0,2)[24]                    : 114907.7
##  ARIMA(0,1,0)(2,0,2)[24] with drift         : 114909.7
##  ARIMA(0,1,1)                               : 114849.4
##  ARIMA(0,1,1)            with drift         : 114851.4
##  ARIMA(0,1,1)(0,0,1)[24]                    : 114851.4
##  ARIMA(0,1,1)(0,0,1)[24] with drift         : 114853.4
##  ARIMA(0,1,1)(0,0,2)[24]                    : 114853
##  ARIMA(0,1,1)(0,0,2)[24] with drift         : 114854.9
##  ARIMA(0,1,1)(1,0,0)[24]                    : 114875.2
##  ARIMA(0,1,1)(1,0,0)[24] with drift         : 114877.2
##  ARIMA(0,1,1)(1,0,1)[24]                    : Inf
##  ARIMA(0,1,1)(1,0,1)[24] with drift         : Inf
##  ARIMA(0,1,1)(1,0,2)[24]                    : Inf
##  ARIMA(0,1,1)(1,0,2)[24] with drift         : Inf
##  ARIMA(0,1,1)(2,0,0)[24]                    : 114900.7
##  ARIMA(0,1,1)(2,0,0)[24] with drift         : 114902.7
##  ARIMA(0,1,1)(2,0,1)[24]                    : Inf
##  ARIMA(0,1,1)(2,0,1)[24] with drift         : Inf
##  ARIMA(0,1,1)(2,0,2)[24]                    : 114904.7
##  ARIMA(0,1,1)(2,0,2)[24] with drift         : 114906.7
##  ARIMA(0,1,2)                               : 114534.4
##  ARIMA(0,1,2)            with drift         : 114536.4
##  ARIMA(0,1,2)(0,0,1)[24]                    : 114536.2
##  ARIMA(0,1,2)(0,0,1)[24] with drift         : 114538.2
##  ARIMA(0,1,2)(0,0,2)[24]                    : 114537.7
##  ARIMA(0,1,2)(0,0,2)[24] with drift         : 114539.7
##  ARIMA(0,1,2)(1,0,0)[24]                    : 114560.1
##  ARIMA(0,1,2)(1,0,0)[24] with drift         : 114562.1
##  ARIMA(0,1,2)(1,0,1)[24]                    : Inf
##  ARIMA(0,1,2)(1,0,1)[24] with drift         : Inf
##  ARIMA(0,1,2)(1,0,2)[24]                    : Inf
##  ARIMA(0,1,2)(1,0,2)[24] with drift         : Inf
##  ARIMA(0,1,2)(2,0,0)[24]                    : 114585.5
##  ARIMA(0,1,2)(2,0,0)[24] with drift         : 114587.5
##  ARIMA(0,1,2)(2,0,1)[24]                    : Inf
##  ARIMA(0,1,2)(2,0,1)[24] with drift         : Inf
##  ARIMA(0,1,3)                               : 114522.7
##  ARIMA(0,1,3)            with drift         : 114524.6
##  ARIMA(0,1,3)(0,0,1)[24]                    : 114524.4
##  ARIMA(0,1,3)(0,0,1)[24] with drift         : 114526.4
##  ARIMA(0,1,3)(0,0,2)[24]                    : 114526
##  ARIMA(0,1,3)(0,0,2)[24] with drift         : 114528
##  ARIMA(0,1,3)(1,0,0)[24]                    : 114548.3
##  ARIMA(0,1,3)(1,0,0)[24] with drift         : 114550.3
##  ARIMA(0,1,3)(1,0,1)[24]                    : Inf
##  ARIMA(0,1,3)(1,0,1)[24] with drift         : Inf
##  ARIMA(0,1,3)(2,0,0)[24]                    : 114573.7
##  ARIMA(0,1,3)(2,0,0)[24] with drift         : 114575.7
##  ARIMA(0,1,4)                               : 104511.7
##  ARIMA(0,1,4)            with drift         : 104513.7
##  ARIMA(0,1,4)(0,0,1)[24]                    : 104481.2
##  ARIMA(0,1,4)(0,0,1)[24] with drift         : 104483.2
##  ARIMA(0,1,4)(1,0,0)[24]                    : 104504.9
##  ARIMA(0,1,4)(1,0,0)[24] with drift         : 104506.9
##  ARIMA(0,1,5)                               : 104454.2
##  ARIMA(0,1,5)            with drift         : 104456.2
##  ARIMA(1,1,0)                               : 114850.7
##  ARIMA(1,1,0)            with drift         : 114852.7
##  ARIMA(1,1,0)(0,0,1)[24]                    : 114852.7
##  ARIMA(1,1,0)(0,0,1)[24] with drift         : 114854.7
##  ARIMA(1,1,0)(0,0,2)[24]                    : 114854.3
##  ARIMA(1,1,0)(0,0,2)[24] with drift         : 114856.3
##  ARIMA(1,1,0)(1,0,0)[24]                    : 114876.6
##  ARIMA(1,1,0)(1,0,0)[24] with drift         : 114878.6
##  ARIMA(1,1,0)(1,0,1)[24]                    : Inf
##  ARIMA(1,1,0)(1,0,1)[24] with drift         : Inf
##  ARIMA(1,1,0)(1,0,2)[24]                    : Inf
##  ARIMA(1,1,0)(1,0,2)[24] with drift         : Inf
##  ARIMA(1,1,0)(2,0,0)[24]                    : 114902.1
##  ARIMA(1,1,0)(2,0,0)[24] with drift         : 114904.1
##  ARIMA(1,1,0)(2,0,1)[24]                    : Inf
##  ARIMA(1,1,0)(2,0,1)[24] with drift         : Inf
##  ARIMA(1,1,0)(2,0,2)[24]                    : 114906.1
##  ARIMA(1,1,0)(2,0,2)[24] with drift         : 114908.1
##  ARIMA(1,1,1)                               : 111225.1
##  ARIMA(1,1,1)            with drift         : 111227.1
##  ARIMA(1,1,1)(0,0,1)[24]                    : 111226.3
##  ARIMA(1,1,1)(0,0,1)[24] with drift         : 111228.3
##  ARIMA(1,1,1)(0,0,2)[24]                    : 111226.8
##  ARIMA(1,1,1)(0,0,2)[24] with drift         : 111228.8
##  ARIMA(1,1,1)(1,0,0)[24]                    : 111250.2
##  ARIMA(1,1,1)(1,0,0)[24] with drift         : 111252.2
##  ARIMA(1,1,1)(1,0,1)[24]                    : 111252.2
##  ARIMA(1,1,1)(1,0,1)[24] with drift         : 111254.2
##  ARIMA(1,1,1)(1,0,2)[24]                    : Inf
##  ARIMA(1,1,1)(1,0,2)[24] with drift         : Inf
##  ARIMA(1,1,1)(2,0,0)[24]                    : 111274.5
##  ARIMA(1,1,1)(2,0,0)[24] with drift         : 111276.5
##  ARIMA(1,1,1)(2,0,1)[24]                    : Inf
##  ARIMA(1,1,1)(2,0,1)[24] with drift         : Inf
##  ARIMA(1,1,2)                               : 107610.3
##  ARIMA(1,1,2)            with drift         : 107612
##  ARIMA(1,1,2)(0,0,1)[24]                    : 107611.4
##  ARIMA(1,1,2)(0,0,1)[24] with drift         : 107613.1
##  ARIMA(1,1,2)(0,0,2)[24]                    : 107612.9
##  ARIMA(1,1,2)(0,0,2)[24] with drift         : 107614.5
##  ARIMA(1,1,2)(1,0,0)[24]                    : 107635.3
##  ARIMA(1,1,2)(1,0,0)[24] with drift         : 107637
##  ARIMA(1,1,2)(1,0,1)[24]                    : 107637.3
##  ARIMA(1,1,2)(1,0,1)[24] with drift         : 107639
##  ARIMA(1,1,2)(2,0,0)[24]                    : 107660.6
##  ARIMA(1,1,2)(2,0,0)[24] with drift         : 107662.3
##  ARIMA(1,1,3)                               : 107440.7
##  ARIMA(1,1,3)            with drift         : 107442.4
##  ARIMA(1,1,3)(0,0,1)[24]                    : 107442.1
##  ARIMA(1,1,3)(0,0,1)[24] with drift         : 107443.7
##  ARIMA(1,1,3)(1,0,0)[24]                    : 107466
##  ARIMA(1,1,3)(1,0,0)[24] with drift         : 107467.7
##  ARIMA(1,1,4)                               : 104357.1
##  ARIMA(1,1,4)            with drift         : 104359.1
##  ARIMA(2,1,0)                               : 114693.2
##  ARIMA(2,1,0)            with drift         : 114695.2
##  ARIMA(2,1,0)(0,0,1)[24]                    : 114695.1
##  ARIMA(2,1,0)(0,0,1)[24] with drift         : 114697.1
##  ARIMA(2,1,0)(0,0,2)[24]                    : 114696.6
##  ARIMA(2,1,0)(0,0,2)[24] with drift         : 114698.6
##  ARIMA(2,1,0)(1,0,0)[24]                    : 114718.9
##  ARIMA(2,1,0)(1,0,0)[24] with drift         : 114720.9
##  ARIMA(2,1,0)(1,0,1)[24]                    : Inf
##  ARIMA(2,1,0)(1,0,1)[24] with drift         : Inf
##  ARIMA(2,1,0)(1,0,2)[24]                    : Inf
##  ARIMA(2,1,0)(1,0,2)[24] with drift         : Inf
##  ARIMA(2,1,0)(2,0,0)[24]                    : 114744.4
##  ARIMA(2,1,0)(2,0,0)[24] with drift         : 114746.4
##  ARIMA(2,1,0)(2,0,1)[24]                    : Inf
##  ARIMA(2,1,0)(2,0,1)[24] with drift         : Inf
##  ARIMA(2,1,1)                               : 107556.5
##  ARIMA(2,1,1)            with drift         : 107558.1
##  ARIMA(2,1,1)(0,0,1)[24]                    : 107557.7
##  ARIMA(2,1,1)(0,0,1)[24] with drift         : 107559.4
##  ARIMA(2,1,1)(0,0,2)[24]                    : 107559.3
##  ARIMA(2,1,1)(0,0,2)[24] with drift         : 107561
##  ARIMA(2,1,1)(1,0,0)[24]                    : 107581.6
##  ARIMA(2,1,1)(1,0,0)[24] with drift         : 107583.2
##  ARIMA(2,1,1)(1,0,1)[24]                    : 107583.6
##  ARIMA(2,1,1)(1,0,1)[24] with drift         : 107585.2
##  ARIMA(2,1,1)(2,0,0)[24]                    : 107606.9
##  ARIMA(2,1,1)(2,0,0)[24] with drift         : 107608.6
##  ARIMA(2,1,2)                               : 104088.8
##  ARIMA(2,1,2)            with drift         : 104090.5
##  ARIMA(2,1,2)(0,0,1)[24]                    : 104087.4
##  ARIMA(2,1,2)(0,0,1)[24] with drift         : 104089
##  ARIMA(2,1,2)(1,0,0)[24]                    : 104111.2
##  ARIMA(2,1,2)(1,0,0)[24] with drift         : 104112.9
##  ARIMA(2,1,3)                               : 104080.4
##  ARIMA(2,1,3)            with drift         : 104082.1
##  ARIMA(3,1,0)                               : 114683
##  ARIMA(3,1,0)            with drift         : 114685
##  ARIMA(3,1,0)(0,0,1)[24]                    : 114684.9
##  ARIMA(3,1,0)(0,0,1)[24] with drift         : 114686.9
##  ARIMA(3,1,0)(0,0,2)[24]                    : 114686.5
##  ARIMA(3,1,0)(0,0,2)[24] with drift         : 114688.5
##  ARIMA(3,1,0)(1,0,0)[24]                    : 114708.8
##  ARIMA(3,1,0)(1,0,0)[24] with drift         : 114710.8
##  ARIMA(3,1,0)(1,0,1)[24]                    : Inf
##  ARIMA(3,1,0)(1,0,1)[24] with drift         : Inf
##  ARIMA(3,1,0)(2,0,0)[24]                    : 114734.2
##  ARIMA(3,1,0)(2,0,0)[24] with drift         : 114736.2
##  ARIMA(3,1,1)                               : 107367.9
##  ARIMA(3,1,1)            with drift         : 107369.6
##  ARIMA(3,1,1)(0,0,1)[24]                    : 107369.6
##  ARIMA(3,1,1)(0,0,1)[24] with drift         : 107371.3
##  ARIMA(3,1,1)(1,0,0)[24]                    : 107393.5
##  ARIMA(3,1,1)(1,0,0)[24] with drift         : 107395.2
##  ARIMA(3,1,2)                               : 104077.9
##  ARIMA(3,1,2)            with drift         : 104079.5
##  ARIMA(4,1,0)                               : 107261.2
##  ARIMA(4,1,0)            with drift         : 107263.2
##  ARIMA(4,1,0)(0,0,1)[24]                    : 107260.4
##  ARIMA(4,1,0)(0,0,1)[24] with drift         : 107262.4
##  ARIMA(4,1,0)(1,0,0)[24]                    : 107284.3
##  ARIMA(4,1,0)(1,0,0)[24] with drift         : 107286.3
##  ARIMA(4,1,1)                               : 107262.6
##  ARIMA(4,1,1)            with drift         : 107264.6
##  ARIMA(5,1,0)                               : 107263.9
##  ARIMA(5,1,0)            with drift         : 107265.9
## 
##  Now re-fitting the best model(s) without approximations...
## 
## 
## 
## 
##  Best model: ARIMA(3,1,2)</code></pre>
<ul>
<li>El mejor modelo ARIMA(3,1,2) tiene:
<ul>
<li>Tres términos autorregresivos (AR), la serie depende de los tres valores anteriores de sí misma.</li>
<li>Diferenciación (d=1), se toma la primera diferencia para estabilizar la tendencia.</li>
<li>Dos términos de media móvil (MA) presentaron el menor AICc (Akaike Information Criterion corregido), por tanto, el mejor equilibrio entre ajuste y simplicidad.</li>
</ul></li>
<li>ARIMA(3,1,2) describe una dinámica compleja pero estable, donde tanto la inercia de los valores pasados como los errores anteriores influyen en la predicción actual.</li>
</ul>
</div>
<div id="verificación-de-supuestos-del-nuevo-modelo" class="section level2 hasAnchor" number="4.12">
<h2><span class="header-section-number">4.12</span> Verificación de supuestos del nuevo modelo<a href="Preprocesamiento.html#verificaci%C3%B3n-de-supuestos-del-nuevo-modelo" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="Preprocesamiento.html#cb73-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb73-2"><a href="Preprocesamiento.html#cb73-2" tabindex="-1"></a><span class="co"># Diagnóstico de los residuos del modelo ARIMA (log)</span></span>
<span id="cb73-3"><a href="Preprocesamiento.html#cb73-3" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb73-4"><a href="Preprocesamiento.html#cb73-4" tabindex="-1"></a></span>
<span id="cb73-5"><a href="Preprocesamiento.html#cb73-5" tabindex="-1"></a><span class="fu">checkresiduals</span>(m_log)</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-32-1.png" width="960" /></p>
<pre><code>## 
##  Ljung-Box test
## 
## data:  Residuals from ARIMA(3,1,2)
## Q* = 3151.5, df = 43, p-value &lt; 2.2e-16
## 
## Model df: 5.   Total lags used: 48</code></pre>
<p><strong><em>Ljung-Box test</em></strong></p>
<ul>
<li><p>El valor p-value &lt; 2.2e-16, se rechaza la hipótesis nula H₀, por lo tanto, existe autocorrelación significativa en los errores a ciertos rezagos.</p></li>
<li><p>El modelo ARIMA(3,1,2), aunque mejora respecto al anterior, no captura toda la estructura dependiente de la serie.</p></li>
</ul>
<p><strong><em>Diagnósticos residuales del modelo ARIMA(3,1,2)</em></strong></p>
<ul>
<li><p>Los residuos son en general estacionarios, pero aún presentan fluctuaciones en la varianza y algunos picos pronunciados que podrían afectar la normalidad.</p></li>
<li><p>El modelo logra reducir significativamente la autocorrelación, aunque persisten correlaciones menores en rezagos cortos, coherentes con el resultado del test de Ljung–Box</p></li>
<li><p>La distribución de los residuos se aproxima a la normalidad, aunque no perfectamente. La transformación logarítmica ayudó a estabilizar la varianza, pero persisten valores extremos.</p></li>
</ul>
</div>
<div id="pronóstico-con-el-modelo-mejorado-escala-logarítmica" class="section level2 hasAnchor" number="4.13">
<h2><span class="header-section-number">4.13</span> Pronóstico con el modelo mejorado (escala logarítmica)<a href="Preprocesamiento.html#pron%C3%B3stico-con-el-modelo-mejorado-escala-logar%C3%ADtmica" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="Preprocesamiento.html#cb75-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb75-2"><a href="Preprocesamiento.html#cb75-2" tabindex="-1"></a><span class="co"># Pronóstico en escala logarítmica</span></span>
<span id="cb75-3"><a href="Preprocesamiento.html#cb75-3" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb75-4"><a href="Preprocesamiento.html#cb75-4" tabindex="-1"></a></span>
<span id="cb75-5"><a href="Preprocesamiento.html#cb75-5" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">24</span> <span class="sc">*</span> horizon_days  <span class="co"># pronóstico a 7 días (horas)</span></span>
<span id="cb75-6"><a href="Preprocesamiento.html#cb75-6" tabindex="-1"></a></span>
<span id="cb75-7"><a href="Preprocesamiento.html#cb75-7" tabindex="-1"></a>fc_log <span class="ot">&lt;-</span> <span class="fu">forecast</span>(m_log, <span class="at">h =</span> h)</span>
<span id="cb75-8"><a href="Preprocesamiento.html#cb75-8" tabindex="-1"></a></span>
<span id="cb75-9"><a href="Preprocesamiento.html#cb75-9" tabindex="-1"></a><span class="fu">autoplot</span>(fc_log) <span class="sc">+</span></span>
<span id="cb75-10"><a href="Preprocesamiento.html#cb75-10" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Pronóstico log-transformado con ARIMA (&quot;</span>, horizon_days, <span class="st">&quot; días)&quot;</span>),</span>
<span id="cb75-11"><a href="Preprocesamiento.html#cb75-11" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;log(1 + Potencia)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>) <span class="sc">+</span></span>
<span id="cb75-12"><a href="Preprocesamiento.html#cb75-12" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-33-1.png" width="960" /></p>
<div id="reconversión-a-escala-original-exponencial-inversa" class="section level3 hasAnchor" number="4.13.1">
<h3><span class="header-section-number">4.13.1</span> Reconversión a escala original (exponencial inversa)<a href="Preprocesamiento.html#reconversi%C3%B3n-a-escala-original-exponencial-inversa" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="Preprocesamiento.html#cb76-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb76-2"><a href="Preprocesamiento.html#cb76-2" tabindex="-1"></a><span class="co"># Transformar el pronóstico a escala original</span></span>
<span id="cb76-3"><a href="Preprocesamiento.html#cb76-3" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb76-4"><a href="Preprocesamiento.html#cb76-4" tabindex="-1"></a></span>
<span id="cb76-5"><a href="Preprocesamiento.html#cb76-5" tabindex="-1"></a>fc_exp <span class="ot">&lt;-</span> <span class="fu">expm1</span>(fc_log<span class="sc">$</span>mean)  <span class="co"># inversa de log1p</span></span>
<span id="cb76-6"><a href="Preprocesamiento.html#cb76-6" tabindex="-1"></a>fc_exp80 <span class="ot">&lt;-</span> <span class="fu">expm1</span>(fc_log<span class="sc">$</span>lower[,<span class="st">&quot;80%&quot;</span>])</span>
<span id="cb76-7"><a href="Preprocesamiento.html#cb76-7" tabindex="-1"></a>fc_exp95 <span class="ot">&lt;-</span> <span class="fu">expm1</span>(fc_log<span class="sc">$</span>upper[,<span class="st">&quot;95%&quot;</span>])</span>
<span id="cb76-8"><a href="Preprocesamiento.html#cb76-8" tabindex="-1"></a></span>
<span id="cb76-9"><a href="Preprocesamiento.html#cb76-9" tabindex="-1"></a><span class="co"># Crear data frame para visualización</span></span>
<span id="cb76-10"><a href="Preprocesamiento.html#cb76-10" tabindex="-1"></a>f_times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">max</span>(df_impu[[time_col]]) <span class="sc">+</span> lubridate<span class="sc">::</span><span class="fu">hours</span>(<span class="dv">1</span>),</span>
<span id="cb76-11"><a href="Preprocesamiento.html#cb76-11" tabindex="-1"></a>               <span class="at">by =</span> <span class="st">&quot;1 hour&quot;</span>, <span class="at">length.out =</span> h)</span>
<span id="cb76-12"><a href="Preprocesamiento.html#cb76-12" tabindex="-1"></a></span>
<span id="cb76-13"><a href="Preprocesamiento.html#cb76-13" tabindex="-1"></a>fc_plot <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb76-14"><a href="Preprocesamiento.html#cb76-14" tabindex="-1"></a>  <span class="at">time =</span> f_times,</span>
<span id="cb76-15"><a href="Preprocesamiento.html#cb76-15" tabindex="-1"></a>  <span class="at">mean =</span> fc_exp,</span>
<span id="cb76-16"><a href="Preprocesamiento.html#cb76-16" tabindex="-1"></a>  <span class="at">lo80 =</span> fc_exp80,</span>
<span id="cb76-17"><a href="Preprocesamiento.html#cb76-17" tabindex="-1"></a>  <span class="at">hi80 =</span> fc_exp95</span>
<span id="cb76-18"><a href="Preprocesamiento.html#cb76-18" tabindex="-1"></a>)</span>
<span id="cb76-19"><a href="Preprocesamiento.html#cb76-19" tabindex="-1"></a></span>
<span id="cb76-20"><a href="Preprocesamiento.html#cb76-20" tabindex="-1"></a><span class="co"># Graficar pronóstico en escala original</span></span>
<span id="cb76-21"><a href="Preprocesamiento.html#cb76-21" tabindex="-1"></a><span class="fu">ggplot</span>(fc_plot, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb76-22"><a href="Preprocesamiento.html#cb76-22" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lo80, <span class="at">ymax =</span> hi80),</span>
<span id="cb76-23"><a href="Preprocesamiento.html#cb76-23" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb76-24"><a href="Preprocesamiento.html#cb76-24" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">linewidth =</span> <span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb76-25"><a href="Preprocesamiento.html#cb76-25" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Pronóstico ARIMA (log-transformado, 7 días)&quot;</span>,</span>
<span id="cb76-26"><a href="Preprocesamiento.html#cb76-26" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;Transformación log(1 + x) revertida a escala original&quot;</span>,</span>
<span id="cb76-27"><a href="Preprocesamiento.html#cb76-27" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia estimada&quot;</span>) <span class="sc">+</span></span>
<span id="cb76-28"><a href="Preprocesamiento.html#cb76-28" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-34-1.png" width="960" /></p>
<ul>
<li><p>El modelo proyecta una potencia promedio estable a lo largo del horizonte de 7 días, con un leve crecimiento progresivo.</p></li>
<li><p>Este patrón indica que no se esperan cambios abruptos ni tendencia marcada en el corto plazo, lo cual concuerda con una serie que, tras la transformación y diferenciación, se comporta de manera estacionaria.</p></li>
<li><p>Las bandas de confianza se ensanchán conforme avanza el tiempo, lo que es normal en modelos ARIMA: la incertidumbre aumenta al alejarnos de la última observación disponible.</p></li>
<li><p>La transformación log1p() redujo la asimetría de la serie, estabilizó la varianza y permitió que el modelo ARIMA se ajustara mejor.</p></li>
<li><p>Al revertir la transformación (exp(x) - 1), los valores pronosticados se amplifican exponencialmente, por lo que incluso pequeñas variaciones en los residuos logarítmicos se traducen en grandes rangos de incertidumbre en la escala original.</p></li>
</ul>
</div>
</div>
<div id="conclusiones-1" class="section level2 hasAnchor" number="4.14">
<h2><span class="header-section-number">4.14</span> Conclusiones<a href="Preprocesamiento.html#conclusiones-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>El análisis realizado sobre la serie temporal de potencia permitió evaluar y comparar el desempeño del modelo ARIMA bajo dos enfoques: primero, utilizando la serie en su escala original, y posteriormente aplicando una transformación logarítmica (log1p) para estabilizar la varianza y mejorar la capacidad predictiva del modelo.</p>
<p><strong><em>Modelo con la serie original</em></strong></p>
<p>El ajuste inicial con el modelo ARIMA(1,1,1)(0,0,2)[24] mostró limitaciones en los residuos:</p>
<ul>
<li><p>El test de Ljung–Box (Q = 3889, p &lt; 0.05)* reveló autocorrelación significativa, indicando que el modelo no capturó completamente la estructura temporal de los datos.</p></li>
<li><p>Los gráficos diagnósticos evidenciaron heterocedasticidad y valores atípicos, lo cual afectó la normalidad de los residuos.</p></li>
<li><p>En consecuencia, aunque el modelo reprodujo la tendencia general, su precisión predictiva fue limitada y las bandas de confianza del pronóstico resultaron amplias e inestables.</p></li>
</ul>
<p><strong><em>Modelo con la serie log-transformada</em></strong></p>
<p>Para mejorar el comportamiento del modelo, se aplicó una transformación logarítmica que redujo la variabilidad extrema y permitió una distribución más simétrica.</p>
<ul>
<li><p>El modelo seleccionado automáticamente fue ARIMA(3,1,2), que presentó un AIC significativamente menor (≈ 104 080 frente a &gt;111 000 en la serie original), reflejando un mejor ajuste global.</p></li>
<li><p>Los residuos del modelo se centraron alrededor de cero, con autocorrelación mínima y distribución casi normal.</p></li>
<li><p>El test de Ljung–Box (Q = 3151, p &lt; 0.05)* indicó todavía cierta dependencia remanente, aunque en menor grado que el modelo previo.</p></li>
<li><p>El pronóstico a 7 días, una vez revertida la transformación (exp(x) - 1), mostró una tendencia estable y coherente con el comportamiento reciente de la serie, con bandas de confianza más razonables que en el caso anterior, aunque naturalmente amplias por la incertidumbre acumulada.</p></li>
</ul>
<p>En conclusión, el modelo ARIMA aplicado sobre la serie original permitió identificar la tendencia general, pero su desempeño predictivo se vio afectado por la alta varianza y la presencia de valores atípicos. En contraste, la aplicación de la transformación logarítmica mejoró la calidad del ajuste, redujo la dispersión y generó un modelo ARIMA(3,1,2) más parsimonioso y estable, con predicciones más coherentes y bandas de confianza razonables.</p>
<p>En términos prácticos, se evidencia que la transformación logarítmica es una estrategia efectiva para estabilizar la varianza y mejorar la capacidad de predicción de modelos ARIMA en series con gran amplitud y comportamiento no estacionario.</p>
<p>Por tanto, se recomienda utilizar la versión log-transformada para futuras predicciones y análisis, dado que ofrece un mejor equilibrio entre ajuste, estabilidad y capacidad interpretativa, reflejando de manera más realista la evolución de la potencia en el tiempo.</p>
<p><strong>Se recomienda analizar los valores de potencia de la serie de tiempo de forma independiente para cada uno de los tres circuitos eléctricos que conforman la potencia de salida de la subestación. Asimismo, se sugiere generar predicciones individuales por circuito y consolidarlas posteriormente. Esta estrategia permite evitar problemas de valores faltantes y atípicos, además de reducir la variabilidad de los datos</strong>.</p>
<div id="resumen-de-tiempos-de-ejecución-del-código" class="section level3 hasAnchor" number="4.14.1">
<h3><span class="header-section-number">4.14.1</span> Resumen de tiempos de ejecución del código<a href="Preprocesamiento.html#resumen-de-tiempos-de-ejecuci%C3%B3n-del-c%C3%B3digo" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="Preprocesamiento.html#cb77-1" tabindex="-1"></a>tabla_tiempos <span class="ot">&lt;-</span> <span class="fu">report_timing_table</span>()</span>
<span id="cb77-2"><a href="Preprocesamiento.html#cb77-2" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(tabla_tiempos)) {</span>
<span id="cb77-3"><a href="Preprocesamiento.html#cb77-3" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(tabla_tiempos, <span class="at">caption =</span> <span class="st">&quot;Resumen de tiempos por bloque&quot;</span>)</span>
<span id="cb77-4"><a href="Preprocesamiento.html#cb77-4" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb77-5"><a href="Preprocesamiento.html#cb77-5" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;No se registraron bloques cronometrados.</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb77-6"><a href="Preprocesamiento.html#cb77-6" tabindex="-1"></a>}</span></code></pre></div>
<table>
<caption><span id="tab:timing-report">Table 4.1: </span>Resumen de tiempos por bloque</caption>
<thead>
<tr class="header">
<th align="left">Bloque</th>
<th align="right">Tiempo</th>
<th align="left">Unidad</th>
<th align="left">Estado</th>
<th align="left">Mensaje</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Imputación (na.interp)</td>
<td align="right">0.016</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">ACF/PACF (original)</td>
<td align="right">0.113</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">ACF/PACF (diferenciada)</td>
<td align="right">0.105</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">STL (ventana 4 semanas)</td>
<td align="right">0.018</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Ajuste SARIMA + Pronóstico</td>
<td align="right">181.854</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">Changepoint (media diaria, PELT)</td>
<td align="right">0.026</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Ajuste SARIMA TS log-transformada</td>
<td align="right">337.818</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": false,
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["propuesta-pronostico-subestacion.pdf", "propuesta-pronostico-subestacion.epub"],
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection",
    "toc_depth": 2
  }
});
});
</script>

</body>

</html>
