<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 Modelos de pronóstico - Metodología Holt – Winter | Propuesta de serie de tiempo: Predicción de demanda eléctrica a corto plazo</title>
  <meta name="description" content="5 Modelos de pronóstico - Metodología Holt – Winter | Propuesta de serie de tiempo: Predicción de demanda eléctrica a corto plazo" />
  <meta name="generator" content="bookdown 0.45 and GitBook 2.6.7" />

  <meta property="og:title" content="5 Modelos de pronóstico - Metodología Holt – Winter | Propuesta de serie de tiempo: Predicción de demanda eléctrica a corto plazo" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 Modelos de pronóstico - Metodología Holt – Winter | Propuesta de serie de tiempo: Predicción de demanda eléctrica a corto plazo" />
  
  
  

<meta name="author" content="Fredy A. Ordoñez · Oscar F. Velásquez · José L. Sánchez" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="Preprocesamiento.html"/>
<link rel="next" href="Modelos_estacionarios_1.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Presentación del Bookdown</a></li>
<li class="chapter" data-level="2" data-path="propuesta.html"><a href="propuesta.html"><i class="fa fa-check"></i><b>2</b> Propuesta de serie de tiempo: Predicción de demanda eléctrica a corto plazo</a>
<ul>
<li class="chapter" data-level="2.1" data-path="propuesta.html"><a href="propuesta.html#qu%C3%A9-voy-a-pronosticar"><i class="fa fa-check"></i><b>2.1</b> ¿Qué voy a pronosticar?</a></li>
<li class="chapter" data-level="2.2" data-path="propuesta.html"><a href="propuesta.html#por-qu%C3%A9-es-importante"><i class="fa fa-check"></i><b>2.2</b> ¿Por qué es importante?</a></li>
<li class="chapter" data-level="2.3" data-path="propuesta.html"><a href="propuesta.html#fuente-de-datos-y-permisos"><i class="fa fa-check"></i><b>2.3</b> Fuente de datos y permisos</a></li>
<li class="chapter" data-level="2.4" data-path="propuesta.html"><a href="propuesta.html#impacto-esperado"><i class="fa fa-check"></i><b>2.4</b> Impacto esperado</a></li>
<li class="chapter" data-level="2.5" data-path="propuesta.html"><a href="propuesta.html#referencias"><i class="fa fa-check"></i><b>2.5</b> Referencias</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><i class="fa fa-check"></i><b>3</b> Análisis de Serie de Tiempo: Potencia Eléctrica Horaria</a>
<ul>
<li class="chapter" data-level="3.1" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#contexto-y-objetivos"><i class="fa fa-check"></i><b>3.1</b> Contexto y objetivos</a></li>
<li class="chapter" data-level="3.2" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#cargue-de-librer%C3%ADas"><i class="fa fa-check"></i><b>3.2</b> Cargue de Librerías</a></li>
<li class="chapter" data-level="3.3" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#lectura-y-preparaci%C3%B3n-de-los-datos"><i class="fa fa-check"></i><b>3.3</b> Lectura y preparación de los datos</a></li>
<li class="chapter" data-level="3.4" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#funciones-auxiliares-de-visualizaci%C3%B3n-de-la-serie-de-tiempo"><i class="fa fa-check"></i><b>3.4</b> Funciones auxiliares de visualización de la serie de tiempo</a></li>
<li class="chapter" data-level="3.5" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#vista-general-del-comportamiento-de-la-potencia-el%C3%A9ctrica-por-escalas-diaria-semanal-mensual-anual"><i class="fa fa-check"></i><b>3.5</b> Vista general del comportamiento de la potencia eléctrica por escalas (diaria, semanal, mensual, anual)</a></li>
<li class="chapter" data-level="3.6" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#curvas-de-potencia-el%C3%A9ctrica-por-periodo-d%C3%ADa-semana-mes-a%C3%B1o"><i class="fa fa-check"></i><b>3.6</b> Curvas de potencia eléctrica por periodo (día, semana, mes, año)</a></li>
<li class="chapter" data-level="3.7" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#promedios-m%C3%B3viles"><i class="fa fa-check"></i><b>3.7</b> Promedios móviles</a></li>
<li class="chapter" data-level="3.8" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#rezagos-lags-y-autocorrelaci%C3%B3n"><i class="fa fa-check"></i><b>3.8</b> Rezagos (lags) y autocorrelación</a></li>
<li class="chapter" data-level="3.9" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#estacionalidad-gr%C3%A1ficos-y-descomposici%C3%B3n"><i class="fa fa-check"></i><b>3.9</b> Estacionalidad (gráficos y descomposición)</a></li>
<li class="chapter" data-level="3.10" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#indicadores-resumidos"><i class="fa fa-check"></i><b>3.10</b> Indicadores resumidos</a></li>
<li class="chapter" data-level="3.11" data-path="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html"><a href="análisis-de-serie-de-tiempo-potencia-eléctrica-horaria.html#conclusiones"><i class="fa fa-check"></i><b>3.11</b> Conclusiones</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html"><i class="fa fa-check"></i><b>4</b> Preprocesamiento y visualización - Estacionariedad, ACF/PACF, STL, ARIMA, Puntos de cambio y Pronóstico</a>
<ul>
<li class="chapter" data-level="4.1" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#resumen"><i class="fa fa-check"></i><b>4.1</b> Resumen</a></li>
<li class="chapter" data-level="4.2" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#carga-de-librer%C3%ADas"><i class="fa fa-check"></i><b>4.2</b> Carga de librerías</a></li>
<li class="chapter" data-level="4.3" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#carga-de-datos-y-visualizaci%C3%B3n"><i class="fa fa-check"></i><b>4.3</b> Carga de datos y visualización</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#bandas-para-huecos-na-y-vistas-multiescala"><i class="fa fa-check"></i><b>4.3.1</b> Bandas para huecos (NA) y vistas multiescala</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#estacionariedad-prueba-adf-augmented-dickey-fuller-test-y-diferenciaci%C3%B3n"><i class="fa fa-check"></i><b>4.4</b> Estacionariedad: prueba ADF (Augmented Dickey-Fuller Test) y diferenciación</a></li>
<li class="chapter" data-level="4.5" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#acf-y-pacf-original-y-diferenciada"><i class="fa fa-check"></i><b>4.5</b> ACF y PACF (original y diferenciada)</a></li>
<li class="chapter" data-level="4.6" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#descomposici%C3%B3n-stl-seasonal-trend-decomposition-using-loess-y-mstl-multiple-seasonal-trend-decomposition-using-loess"><i class="fa fa-check"></i><b>4.6</b> Descomposición STL (Seasonal-Trend decomposition using Loess) y MSTL (Multiple Seasonal-Trend decomposition using Loess)</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#descomposici%C3%B3n-de-la-serie-por-estacionalidades"><i class="fa fa-check"></i><b>4.6.1</b> Descomposición de la serie por estacionalidades</a></li>
<li class="chapter" data-level="4.6.2" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#descomposici%C3%B3n-de-la-serie-en-una-ventana-de-4-semanas"><i class="fa fa-check"></i><b>4.6.2</b> Descomposición de la serie en una ventana de 4 semanas</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#selecci%C3%B3n-del-modelo-eficiente-auto.arima-y-pron%C3%B3stico"><i class="fa fa-check"></i><b>4.7</b> Selección del modelo eficiente (auto.arima) y Pronóstico</a>
<ul>
<li class="chapter" data-level="4.7.1" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#zoom-al-pron%C3%B3stico"><i class="fa fa-check"></i><b>4.7.1</b> Zoom al Pronóstico</a></li>
</ul></li>
<li class="chapter" data-level="4.8" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#puntos-de-cambio-y-visualizaci%C3%B3n"><i class="fa fa-check"></i><b>4.8</b> Puntos de cambio y visualización</a></li>
<li class="chapter" data-level="4.9" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#outliers-y-verificaci%C3%B3n-de-supuestos-del-arima"><i class="fa fa-check"></i><b>4.9</b> Outliers y verificación de supuestos del ARIMA</a>
<ul>
<li class="chapter" data-level="4.9.1" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#qq-plot-de-los-residuos-del-modelo-arima"><i class="fa fa-check"></i><b>4.9.1</b> Q–Q Plot de los residuos del modelo ARIMA</a></li>
</ul></li>
<li class="chapter" data-level="4.10" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#transformaci%C3%B3n-logar%C3%ADtmica-para-estabilizar-la-varianza"><i class="fa fa-check"></i><b>4.10</b> Transformación logarítmica para estabilizar la varianza</a></li>
<li class="chapter" data-level="4.11" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#ajuste-del-modelo-arima-en-escala-logar%C3%ADtmica"><i class="fa fa-check"></i><b>4.11</b> Ajuste del modelo ARIMA en escala logarítmica</a></li>
<li class="chapter" data-level="4.12" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#verificaci%C3%B3n-de-supuestos-del-nuevo-modelo"><i class="fa fa-check"></i><b>4.12</b> Verificación de supuestos del nuevo modelo</a></li>
<li class="chapter" data-level="4.13" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#pron%C3%B3stico-con-el-modelo-mejorado-escala-logar%C3%ADtmica"><i class="fa fa-check"></i><b>4.13</b> Pronóstico con el modelo mejorado (escala logarítmica)</a>
<ul>
<li class="chapter" data-level="4.13.1" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#reconversi%C3%B3n-a-escala-original-exponencial-inversa"><i class="fa fa-check"></i><b>4.13.1</b> Reconversión a escala original (exponencial inversa)</a></li>
</ul></li>
<li class="chapter" data-level="4.14" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#conclusiones-1"><i class="fa fa-check"></i><b>4.14</b> Conclusiones</a>
<ul>
<li class="chapter" data-level="4.14.1" data-path="Preprocesamiento.html"><a href="Preprocesamiento.html#resumen-de-tiempos-de-ejecuci%C3%B3n-del-c%C3%B3digo"><i class="fa fa-check"></i><b>4.14.1</b> Resumen de tiempos de ejecución del código</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="Modelización.html"><a href="Modelización.html"><i class="fa fa-check"></i><b>5</b> Modelos de pronóstico - Metodología Holt – Winter</a>
<ul>
<li class="chapter" data-level="5.1" data-path="Modelización.html"><a href="Modelización.html#resumen-1"><i class="fa fa-check"></i><b>5.1</b> Resumen</a></li>
<li class="chapter" data-level="5.2" data-path="Modelización.html"><a href="Modelización.html#cambio-de-la-serie-de-tiempo-a-circuito-de-potencia---preprocesamiento-y-visualizaci%C3%B3n"><i class="fa fa-check"></i><b>5.2</b> Cambio de la serie de tiempo a circuito de potencia - Preprocesamiento y visualización</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="Modelización.html"><a href="Modelización.html#carga-de-librer%C3%ADas-1"><i class="fa fa-check"></i><b>5.2.1</b> Carga de librerías</a></li>
<li class="chapter" data-level="5.2.2" data-path="Modelización.html"><a href="Modelización.html#carga-de-datos-y-visualizaci%C3%B3n-1"><i class="fa fa-check"></i><b>5.2.2</b> Carga de datos y visualización</a></li>
<li class="chapter" data-level="5.2.3" data-path="Modelización.html"><a href="Modelización.html#estacionariedad-prueba-adf-augmented-dickey-fuller-test-y-diferenciaci%C3%B3n-1"><i class="fa fa-check"></i><b>5.2.3</b> Estacionariedad: prueba ADF (Augmented Dickey-Fuller Test) y diferenciación</a></li>
<li class="chapter" data-level="5.2.4" data-path="Modelización.html"><a href="Modelización.html#acf-y-pacf-original-y-diferenciada-1"><i class="fa fa-check"></i><b>5.2.4</b> ACF y PACF (original y diferenciada)</a></li>
<li class="chapter" data-level="5.2.5" data-path="Modelización.html"><a href="Modelización.html#descomposici%C3%B3n-stl-seasonal-trend-decomposition-using-loess-y-mstl-multiple-seasonal-trend-decomposition-using-loess-1"><i class="fa fa-check"></i><b>5.2.5</b> Descomposición STL (Seasonal-Trend decomposition using Loess) y MSTL (Multiple Seasonal-Trend decomposition using Loess)</a></li>
<li class="chapter" data-level="5.2.6" data-path="Modelización.html"><a href="Modelización.html#promedios-m%C3%B3viles-24h-168h-720h"><i class="fa fa-check"></i><b>5.2.6</b> Promedios móviles (24h, 168h, 720h)</a></li>
<li class="chapter" data-level="5.2.7" data-path="Modelización.html"><a href="Modelización.html#selecci%C3%B3n-del-modelo-eficiente-auto.arima-y-pron%C3%B3stico-1"><i class="fa fa-check"></i><b>5.2.7</b> Selección del modelo eficiente (auto.arima) y Pronóstico</a></li>
<li class="chapter" data-level="5.2.8" data-path="Modelización.html"><a href="Modelización.html#puntos-de-cambio-y-visualizaci%C3%B3n-1"><i class="fa fa-check"></i><b>5.2.8</b> Puntos de cambio y visualización</a></li>
<li class="chapter" data-level="5.2.9" data-path="Modelización.html"><a href="Modelización.html#outliers-y-verificaci%C3%B3n-de-supuestos-del-arima-1"><i class="fa fa-check"></i><b>5.2.9</b> Outliers y verificación de supuestos del ARIMA</a></li>
<li class="chapter" data-level="5.2.10" data-path="Modelización.html"><a href="Modelización.html#transformaci%C3%B3n-logar%C3%ADtmica-para-estabilizar-la-varianza-1"><i class="fa fa-check"></i><b>5.2.10</b> Transformación logarítmica para estabilizar la varianza</a></li>
<li class="chapter" data-level="5.2.11" data-path="Modelización.html"><a href="Modelización.html#ajuste-del-modelo-arima-en-escala-logar%C3%ADtmica-1"><i class="fa fa-check"></i><b>5.2.11</b> Ajuste del modelo ARIMA en escala logarítmica</a></li>
<li class="chapter" data-level="5.2.12" data-path="Modelización.html"><a href="Modelización.html#verificaci%C3%B3n-de-supuestos-del-nuevo-modelo-arima-en-escala-logar%C3%ADtmica"><i class="fa fa-check"></i><b>5.2.12</b> Verificación de supuestos del nuevo modelo ARIMA en escala logarítmica</a></li>
<li class="chapter" data-level="5.2.13" data-path="Modelización.html"><a href="Modelización.html#pron%C3%B3stico-con-el-modelo-mejorado-escala-logar%C3%ADtmica-1"><i class="fa fa-check"></i><b>5.2.13</b> Pronóstico con el modelo mejorado (escala logarítmica)</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="Modelización.html"><a href="Modelización.html#preprocesamiento-de-la-serie-de-datos-para-holtwinters"><i class="fa fa-check"></i><b>5.3</b> Preprocesamiento de la serie de datos para Holt–Winters</a></li>
<li class="chapter" data-level="5.4" data-path="Modelización.html"><a href="Modelización.html#divisi%C3%B3n-de-los-datos-entre-traintest"><i class="fa fa-check"></i><b>5.4</b> División de los datos entre TRAIN/TEST</a></li>
<li class="chapter" data-level="5.5" data-path="Modelización.html"><a href="Modelización.html#ajuste-holtwinters-aditivo-y-multiplicativo-usando-train-y-h-definidos"><i class="fa fa-check"></i><b>5.5</b> Ajuste Holt–Winters aditivo y multiplicativo (usando TRAIN y h definidos)</a></li>
<li class="chapter" data-level="5.6" data-path="Modelización.html"><a href="Modelización.html#gr%C3%A1fica-comparativa-traintest-pron%C3%B3sticos-hw-aditivo-vs.-multiplicativo"><i class="fa fa-check"></i><b>5.6</b> Gráfica comparativa: TRAIN/TEST + pronósticos HW (aditivo vs. multiplicativo)</a></li>
<li class="chapter" data-level="5.7" data-path="Modelización.html"><a href="Modelización.html#evaluaci%C3%B3n-en-test-mape-y-rmse"><i class="fa fa-check"></i><b>5.7</b> Evaluación en TEST (MAPE y RMSE)</a></li>
<li class="chapter" data-level="5.8" data-path="Modelización.html"><a href="Modelización.html#comparaci%C3%B3n-con-un-arima-simple"><i class="fa fa-check"></i><b>5.8</b> Comparación con un ARIMA simple</a></li>
<li class="chapter" data-level="5.9" data-path="Modelización.html"><a href="Modelización.html#holt-winter-en-boxcox-ajuste-pron%C3%B3stico-en-bc-reconversi%C3%B3n-a-escala-original"><i class="fa fa-check"></i><b>5.9</b> Holt Winter en Box–Cox (ajuste + pronóstico en BC + reconversión a escala original)</a></li>
<li class="chapter" data-level="5.10" data-path="Modelización.html"><a href="Modelización.html#gr%C3%A1fica-comparativa-traintest-en-original-hw-boxcox-reconvertido"><i class="fa fa-check"></i><b>5.10</b> Gráfica comparativa (TRAIN/TEST en original) + HW Box–Cox reconvertido</a></li>
<li class="chapter" data-level="5.11" data-path="Modelización.html"><a href="Modelización.html#zoom-al-pron%C3%B3stico-holt-winter-boxcox-en-original"><i class="fa fa-check"></i><b>5.11</b> Zoom al pronóstico Holt Winter Box–Cox en original</a></li>
<li class="chapter" data-level="5.12" data-path="Modelización.html"><a href="Modelización.html#m%C3%A9tricas-en-test-comparando-en-escala-original-holt-winter-y-boxcox"><i class="fa fa-check"></i><b>5.12</b> Métricas en TEST comparando en <strong>escala original</strong> (Holt Winter y Box–Cox)</a></li>
<li class="chapter" data-level="5.13" data-path="Modelización.html"><a href="Modelización.html#resumen-final-de-m%C3%A9tricas-rmse-mape"><i class="fa fa-check"></i><b>5.13</b> Resumen final de métricas (RMSE / MAPE)</a></li>
<li class="chapter" data-level="5.14" data-path="Modelización.html"><a href="Modelización.html#gr%C3%A1ficas-de-predicci%C3%B3n-por-modelo"><i class="fa fa-check"></i><b>5.14</b> Gráficas de predicción por modelo</a></li>
<li class="chapter" data-level="5.15" data-path="Modelización.html"><a href="Modelización.html#resumen-de-tiempos-de-ejecuci%C3%B3n-del-c%C3%B3digo-1"><i class="fa fa-check"></i><b>5.15</b> Resumen de tiempos de ejecución del código</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html"><i class="fa fa-check"></i><b>6</b> Modelos estacionarios - Metodología Box-Jenkins</a>
<ul>
<li class="chapter" data-level="6.1" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html#introducci%C3%B3n"><i class="fa fa-check"></i><b>6.1</b> Introducción</a></li>
<li class="chapter" data-level="6.2" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html#carga-de-datos"><i class="fa fa-check"></i><b>6.2</b> Carga de datos</a></li>
<li class="chapter" data-level="6.3" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html#limpieza-e-imputaci%C3%B3n-de-faltantes"><i class="fa fa-check"></i><b>6.3</b> Limpieza e imputación de faltantes</a></li>
<li class="chapter" data-level="6.4" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html#creaci%C3%B3n-de-la-serie-de-tiempo"><i class="fa fa-check"></i><b>6.4</b> Creación de la serie de tiempo</a></li>
<li class="chapter" data-level="6.5" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html#exploraci%C3%B3n-inicial"><i class="fa fa-check"></i><b>6.5</b> Exploración inicial</a></li>
<li class="chapter" data-level="6.6" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html#estacionariedad-adf-y-acfpacf"><i class="fa fa-check"></i><b>6.6</b> Estacionariedad (ADF) y ACF/PACF</a></li>
<li class="chapter" data-level="6.7" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html#modelo-arima-boxjenkins"><i class="fa fa-check"></i><b>6.7</b> Modelo ARIMA (Box–Jenkins)</a></li>
<li class="chapter" data-level="6.8" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html#comparaci%C3%B3n-de-modelos-aicbic"><i class="fa fa-check"></i><b>6.8</b> Comparación de modelos (AIC/BIC)</a></li>
<li class="chapter" data-level="6.9" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html#diagn%C3%B3stico"><i class="fa fa-check"></i><b>6.9</b> Diagnóstico</a></li>
<li class="chapter" data-level="6.10" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html#pron%C3%B3stico"><i class="fa fa-check"></i><b>6.10</b> Pronóstico</a>
<ul>
<li class="chapter" data-level="6.10.1" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html#zoom-%C3%BAltimos-7-d%C3%ADas-pron%C3%B3stico"><i class="fa fa-check"></i><b>6.10.1</b> Zoom: últimos 7 días + pronóstico</a></li>
<li class="chapter" data-level="6.10.2" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html#zoom-%C3%BAltimos-21-d%C3%ADas-7-d%C3%ADas-de-pron%C3%B3stico"><i class="fa fa-check"></i><b>6.10.2</b> Zoom: últimos 21 días + 7 días de pronóstico</a></li>
<li class="chapter" data-level="6.10.3" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html#zoom-%C3%BAltimos-6-meses-3-meses-de-pron%C3%B3stico"><i class="fa fa-check"></i><b>6.10.3</b> Zoom: últimos 6 meses + 3 meses de pronóstico</a></li>
</ul></li>
<li class="chapter" data-level="6.11" data-path="Modelos_estacionarios_1.html"><a href="Modelos_estacionarios_1.html#conclusiones-2"><i class="fa fa-check"></i><b>6.11</b> Conclusiones</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Propuesta de serie de tiempo: Predicción de demanda eléctrica a corto plazo</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="Modelización" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">5</span> Modelos de pronóstico - Metodología Holt – Winter<a href="Modelización.html#Modelizaci%C3%B3n" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="resumen-1" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Resumen<a href="Modelización.html#resumen-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Los métodos de suavizamiento desempeñan un papel fundamental, ya que permiten reducir el ruido en los datos, resaltando la estructura subyacente de la serie. Entre ellos, destacan el promedio móvil, el suavizamiento exponencial simple y el modelo de Holt-Winters, que constituye una extensión más completa capaz de captar tanto la tendencia como la estacionalidad.</p>
<p>En este capítulo se aplica el método de Holt-Winters como herramienta de predicción para series con comportamiento no estacionario.</p>
<p>Sin embargo, la serie de datos analizada en el capitulo anterior presenta alta variabilidad en los datos debido a que corresponde a la sumatoria de tres series de datos asociados a los circuitos de salida de la subestación eléctrica, de las cuales, una serie presenta faltantes aproximadamente en el 50% del horizonte de tiempo, objeto de este estudio; otra serie presente aproximadamente un 25% de faltantes, sumada a una alta variabilidad en las media de la potencia, generando un gran porcentaje de outliers probablemente incorrectos. Razón por la cual, para continuar con el análisis de la serie de tiempo, seleccionamos solo un circuito de salida que tiene la tendencia más estable con un bajo porcentaje de datos faltantes.</p>
</div>
<div id="cambio-de-la-serie-de-tiempo-a-circuito-de-potencia---preprocesamiento-y-visualización" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Cambio de la serie de tiempo a circuito de potencia - Preprocesamiento y visualización<a href="Modelización.html#cambio-de-la-serie-de-tiempo-a-circuito-de-potencia---preprocesamiento-y-visualizaci%C3%B3n" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="carga-de-librerías-1" class="section level3 hasAnchor" number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> Carga de librerías<a href="Modelización.html#carga-de-librer%C3%ADas-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="Modelización.html#cb78-1" tabindex="-1"></a><span class="fu">library</span>(readr) </span>
<span id="cb78-2"><a href="Modelización.html#cb78-2" tabindex="-1"></a><span class="fu">library</span>(dplyr) </span>
<span id="cb78-3"><a href="Modelización.html#cb78-3" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb78-4"><a href="Modelización.html#cb78-4" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb78-5"><a href="Modelización.html#cb78-5" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb78-6"><a href="Modelización.html#cb78-6" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb78-7"><a href="Modelización.html#cb78-7" tabindex="-1"></a><span class="fu">library</span>(zoo)</span>
<span id="cb78-8"><a href="Modelización.html#cb78-8" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb78-9"><a href="Modelización.html#cb78-9" tabindex="-1"></a><span class="fu">library</span>(tseries)</span>
<span id="cb78-10"><a href="Modelización.html#cb78-10" tabindex="-1"></a><span class="fu">library</span>(changepoint)</span></code></pre></div>
</div>
<div id="carga-de-datos-y-visualización-1" class="section level3 hasAnchor" number="5.2.2">
<h3><span class="header-section-number">5.2.2</span> Carga de datos y visualización<a href="Modelización.html#carga-de-datos-y-visualizaci%C3%B3n-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="Modelización.html#cb79-1" tabindex="-1"></a>csv_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(csv_dir, csv_name)</span>
<span id="cb79-2"><a href="Modelización.html#cb79-2" tabindex="-1"></a>time_col <span class="ot">&lt;-</span> <span class="st">&quot;FECHA&quot;</span>; y_col <span class="ot">&lt;-</span> <span class="st">&quot;VALOR_IMPUTADO&quot;</span></span>
<span id="cb79-3"><a href="Modelización.html#cb79-3" tabindex="-1"></a></span>
<span id="cb79-4"><a href="Modelización.html#cb79-4" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(readr<span class="sc">::</span><span class="fu">read_csv</span>(csv_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>),</span>
<span id="cb79-5"><a href="Modelización.html#cb79-5" tabindex="-1"></a><span class="at">error =</span> <span class="cf">function</span>(e) readr<span class="sc">::</span><span class="fu">read_csv2</span>(csv_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb79-6"><a href="Modelización.html#cb79-6" tabindex="-1"></a></span>
<span id="cb79-7"><a href="Modelización.html#cb79-7" tabindex="-1"></a><span class="co"># Parseo robusto de fecha-hora y valor</span></span>
<span id="cb79-8"><a href="Modelización.html#cb79-8" tabindex="-1"></a></span>
<span id="cb79-9"><a href="Modelización.html#cb79-9" tabindex="-1"></a>df[[time_col]] <span class="ot">&lt;-</span> <span class="fu">parse_date_time</span>(df[[time_col]],</span>
<span id="cb79-10"><a href="Modelización.html#cb79-10" tabindex="-1"></a><span class="at">orders =</span> <span class="fu">c</span>(<span class="st">&quot;ymd HMS&quot;</span>,<span class="st">&quot;ymd HM&quot;</span>,<span class="st">&quot;dmy HMS&quot;</span>,<span class="st">&quot;dmy HM&quot;</span>,<span class="st">&quot;ymd&quot;</span>,<span class="st">&quot;dmy&quot;</span>),</span>
<span id="cb79-11"><a href="Modelización.html#cb79-11" tabindex="-1"></a><span class="at">tz =</span> TZ)</span>
<span id="cb79-12"><a href="Modelización.html#cb79-12" tabindex="-1"></a>df[[y_col]] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(df[[y_col]]))</span>
<span id="cb79-13"><a href="Modelización.html#cb79-13" tabindex="-1"></a></span>
<span id="cb79-14"><a href="Modelización.html#cb79-14" tabindex="-1"></a><span class="co"># Malla horaria completa para marcar NA (sin imputar)</span></span>
<span id="cb79-15"><a href="Modelización.html#cb79-15" tabindex="-1"></a></span>
<span id="cb79-16"><a href="Modelización.html#cb79-16" tabindex="-1"></a>df0 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(.data[[time_col]])) <span class="sc">%&gt;%</span></span>
<span id="cb79-17"><a href="Modelización.html#cb79-17" tabindex="-1"></a><span class="fu">arrange</span>(.data[[time_col]]) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">!!</span>time_col, <span class="sc">!!</span>y_col)</span>
<span id="cb79-18"><a href="Modelización.html#cb79-18" tabindex="-1"></a></span>
<span id="cb79-19"><a href="Modelización.html#cb79-19" tabindex="-1"></a>full_time <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="sc">!!</span><span class="at">time_col :=</span> <span class="fu">seq</span>(<span class="fu">min</span>(df0[[time_col]]), <span class="fu">max</span>(df0[[time_col]]), <span class="at">by =</span> <span class="st">&quot;1 hour&quot;</span>))</span>
<span id="cb79-20"><a href="Modelización.html#cb79-20" tabindex="-1"></a></span>
<span id="cb79-21"><a href="Modelización.html#cb79-21" tabindex="-1"></a>df_full <span class="ot">&lt;-</span> full_time <span class="sc">%&gt;%</span></span>
<span id="cb79-22"><a href="Modelización.html#cb79-22" tabindex="-1"></a><span class="fu">left_join</span>(df0, <span class="at">by =</span> time_col) <span class="sc">%&gt;%</span></span>
<span id="cb79-23"><a href="Modelización.html#cb79-23" tabindex="-1"></a><span class="fu">mutate</span>(<span class="at">is_na =</span> <span class="fu">is.na</span>(.data[[y_col]])) <span class="sc">%&gt;%</span></span>
<span id="cb79-24"><a href="Modelización.html#cb79-24" tabindex="-1"></a><span class="fu">arrange</span>(.data[[time_col]])</span>
<span id="cb79-25"><a href="Modelización.html#cb79-25" tabindex="-1"></a></span>
<span id="cb79-26"><a href="Modelización.html#cb79-26" tabindex="-1"></a><span class="co"># Serie imputada (para métodos que exigen regularidad)</span></span>
<span id="cb79-27"><a href="Modelización.html#cb79-27" tabindex="-1"></a></span>
<span id="cb79-28"><a href="Modelización.html#cb79-28" tabindex="-1"></a><span class="fu">tm</span>(<span class="st">&quot;Imputación (na.interp)&quot;</span>, {</span>
<span id="cb79-29"><a href="Modelización.html#cb79-29" tabindex="-1"></a>df_impu <span class="ot">&lt;&lt;-</span> df_full <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">val_impu =</span> forecast<span class="sc">::</span><span class="fu">na.interp</span>(.data[[y_col]]))</span>
<span id="cb79-30"><a href="Modelización.html#cb79-30" tabindex="-1"></a>})</span>
<span id="cb79-31"><a href="Modelización.html#cb79-31" tabindex="-1"></a></span>
<span id="cb79-32"><a href="Modelización.html#cb79-32" tabindex="-1"></a><span class="co"># Vista rápida</span></span>
<span id="cb79-33"><a href="Modelización.html#cb79-33" tabindex="-1"></a></span>
<span id="cb79-34"><a href="Modelización.html#cb79-34" tabindex="-1"></a><span class="co"># ggplot(df_full, aes(x = .data[[time_col]], y = .data[[y_col]])) +</span></span>
<span id="cb79-35"><a href="Modelización.html#cb79-35" tabindex="-1"></a><span class="co"># geom_line(na.rm = TRUE) +</span></span>
<span id="cb79-36"><a href="Modelización.html#cb79-36" tabindex="-1"></a><span class="co"># labs(title = &quot;Serie horaria de potencia (con huecos)&quot;, x = &quot;Tiempo&quot;, y = &quot;Potencia&quot;) +</span></span>
<span id="cb79-37"><a href="Modelización.html#cb79-37" tabindex="-1"></a><span class="co"># theme_minimal()</span></span></code></pre></div>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="Modelización.html#cb80-1" tabindex="-1"></a>na_spans_runs <span class="ot">&lt;-</span> <span class="cf">function</span>(x_time, is_na_logical) {</span>
<span id="cb80-2"><a href="Modelización.html#cb80-2" tabindex="-1"></a>r  <span class="ot">&lt;-</span> <span class="fu">rle</span>(is_na_logical)</span>
<span id="cb80-3"><a href="Modelización.html#cb80-3" tabindex="-1"></a>ed <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(r<span class="sc">$</span>lengths); st <span class="ot">&lt;-</span> ed <span class="sc">-</span> r<span class="sc">$</span>lengths <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb80-4"><a href="Modelización.html#cb80-4" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">is_na =</span> r<span class="sc">$</span>values, <span class="at">i_start =</span> st, <span class="at">i_end =</span> ed) <span class="sc">%&gt;%</span></span>
<span id="cb80-5"><a href="Modelización.html#cb80-5" tabindex="-1"></a><span class="fu">filter</span>(is_na) <span class="sc">%&gt;%</span></span>
<span id="cb80-6"><a href="Modelización.html#cb80-6" tabindex="-1"></a><span class="fu">transmute</span>(<span class="at">xmin =</span> x_time[i_start], <span class="at">xmax =</span> x_time[i_end] <span class="sc">+</span> <span class="fu">hours</span>(<span class="dv">1</span>))</span>
<span id="cb80-7"><a href="Modelización.html#cb80-7" tabindex="-1"></a>}</span>
<span id="cb80-8"><a href="Modelización.html#cb80-8" tabindex="-1"></a></span>
<span id="cb80-9"><a href="Modelización.html#cb80-9" tabindex="-1"></a>agg_by <span class="ot">&lt;-</span> <span class="cf">function</span>(data, unit, label, time_col, y_col) {</span>
<span id="cb80-10"><a href="Modelización.html#cb80-10" tabindex="-1"></a>data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">period =</span> <span class="fu">floor_date</span>(.data[[time_col]], unit)) <span class="sc">%&gt;%</span></span>
<span id="cb80-11"><a href="Modelización.html#cb80-11" tabindex="-1"></a><span class="fu">group_by</span>(period) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">value =</span> <span class="fu">mean</span>(.data[[y_col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb80-12"><a href="Modelización.html#cb80-12" tabindex="-1"></a><span class="fu">mutate</span>(<span class="at">freq =</span> label)</span>
<span id="cb80-13"><a href="Modelización.html#cb80-13" tabindex="-1"></a>}</span>
<span id="cb80-14"><a href="Modelización.html#cb80-14" tabindex="-1"></a></span>
<span id="cb80-15"><a href="Modelización.html#cb80-15" tabindex="-1"></a>na_runs <span class="ot">&lt;-</span> <span class="fu">na_spans_runs</span>(df_full[[time_col]], df_full<span class="sc">$</span>is_na)</span>
<span id="cb80-16"><a href="Modelización.html#cb80-16" tabindex="-1"></a></span>
<span id="cb80-17"><a href="Modelización.html#cb80-17" tabindex="-1"></a>diaria  <span class="ot">&lt;-</span> <span class="fu">agg_by</span>(df_full, <span class="st">&quot;day&quot;</span>,   <span class="st">&quot;Diaria&quot;</span>,  time_col, y_col)</span>
<span id="cb80-18"><a href="Modelización.html#cb80-18" tabindex="-1"></a>semanal <span class="ot">&lt;-</span> <span class="fu">agg_by</span>(df_full, <span class="st">&quot;week&quot;</span>,  <span class="st">&quot;Semanal&quot;</span>, time_col, y_col)</span>
<span id="cb80-19"><a href="Modelización.html#cb80-19" tabindex="-1"></a>mensual <span class="ot">&lt;-</span> <span class="fu">agg_by</span>(df_full, <span class="st">&quot;month&quot;</span>, <span class="st">&quot;Mensual&quot;</span>, time_col, y_col)</span>
<span id="cb80-20"><a href="Modelización.html#cb80-20" tabindex="-1"></a>anual   <span class="ot">&lt;-</span> <span class="fu">agg_by</span>(df_full, <span class="st">&quot;year&quot;</span>,  <span class="st">&quot;Anual&quot;</span>,   time_col, y_col)</span>
<span id="cb80-21"><a href="Modelización.html#cb80-21" tabindex="-1"></a></span>
<span id="cb80-22"><a href="Modelización.html#cb80-22" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(diaria, semanal, mensual, anual) <span class="sc">%&gt;%</span></span>
<span id="cb80-23"><a href="Modelización.html#cb80-23" tabindex="-1"></a><span class="fu">mutate</span>(<span class="at">freq =</span> <span class="fu">factor</span>(freq, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;Diaria&quot;</span>, <span class="st">&quot;Semanal&quot;</span>, <span class="st">&quot;Mensual&quot;</span>, <span class="st">&quot;Anual&quot;</span>)))</span></code></pre></div>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="Modelización.html#cb81-1" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb81-2"><a href="Modelización.html#cb81-2" tabindex="-1"></a><span class="fu">geom_rect</span>(<span class="at">data =</span> na_runs, <span class="fu">aes</span>(<span class="at">xmin =</span> xmin, <span class="at">xmax =</span> xmax, <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>),</span>
<span id="cb81-3"><a href="Modelización.html#cb81-3" tabindex="-1"></a><span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb81-4"><a href="Modelización.html#cb81-4" tabindex="-1"></a><span class="fu">geom_line</span>(<span class="at">data =</span> plot_df, <span class="fu">aes</span>(<span class="at">x =</span> period, <span class="at">y =</span> value), <span class="at">linewidth =</span> <span class="fl">0.6</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb81-5"><a href="Modelización.html#cb81-5" tabindex="-1"></a><span class="fu">facet_wrap</span>(<span class="sc">~</span> freq, <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb81-6"><a href="Modelización.html#cb81-6" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Potencia — vistas diaria, semanal, mensual y anual&quot;</span>,</span>
<span id="cb81-7"><a href="Modelización.html#cb81-7" tabindex="-1"></a><span class="at">subtitle =</span> <span class="st">&quot;Bandas rojas: periodos con NA en la serie original&quot;</span>,</span>
<span id="cb81-8"><a href="Modelización.html#cb81-8" tabindex="-1"></a><span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia&quot;</span>) <span class="sc">+</span></span>
<span id="cb81-9"><a href="Modelización.html#cb81-9" tabindex="-1"></a><span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>)</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-39-1.png" width="960" /></p>
<ul>
<li><p>La serie presenta coherencia temporal y crecimiento moderado en todas las escalas.</p></li>
<li><p>Existen períodos con datos faltantes y posible ruido o outliers en la frecuencia diaria, que en las gráficas semanal, mensual y anual se atenúan.</p></li>
<li><p>Esta exploración multiescala sugiere que la serie es adecuada para modelar con métodos como Holt–Winters o ARIMA, siempre y cuando antes se aplique imputación de valores faltantes, detección y corrección de outliers, y estabilización de la varianza.</p></li>
</ul>
</div>
<div id="estacionariedad-prueba-adf-augmented-dickey-fuller-test-y-diferenciación-1" class="section level3 hasAnchor" number="5.2.3">
<h3><span class="header-section-number">5.2.3</span> Estacionariedad: prueba ADF (Augmented Dickey-Fuller Test) y diferenciación<a href="Modelización.html#estacionariedad-prueba-adf-augmented-dickey-fuller-test-y-diferenciaci%C3%B3n-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="Modelización.html#cb82-1" tabindex="-1"></a><span class="co"># Vector numérico imputado</span></span>
<span id="cb82-2"><a href="Modelización.html#cb82-2" tabindex="-1"></a></span>
<span id="cb82-3"><a href="Modelización.html#cb82-3" tabindex="-1"></a>serie_vec <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(df_impu<span class="sc">$</span>val_impu)</span>
<span id="cb82-4"><a href="Modelización.html#cb82-4" tabindex="-1"></a></span>
<span id="cb82-5"><a href="Modelización.html#cb82-5" tabindex="-1"></a><span class="co"># ADF en serie original</span></span>
<span id="cb82-6"><a href="Modelización.html#cb82-6" tabindex="-1"></a></span>
<span id="cb82-7"><a href="Modelización.html#cb82-7" tabindex="-1"></a>adf_raw <span class="ot">&lt;-</span> tseries<span class="sc">::</span><span class="fu">adf.test</span>(serie_vec, <span class="at">k =</span> <span class="dv">24</span>)</span>
<span id="cb82-8"><a href="Modelización.html#cb82-8" tabindex="-1"></a>adf_raw</span></code></pre></div>
<pre><code>## 
##  Augmented Dickey-Fuller Test
## 
## data:  serie_vec
## Dickey-Fuller = -37.721, Lag order = 24, p-value = 0.01
## alternative hypothesis: stationary</code></pre>
<ul>
<li>El resultado de la <strong>Prueba ADF (Dickey-Fuller aumentada)</strong> indica que p-value = 0.01 &lt; 0.05, indicando que es una <strong>serie estacionaria en media</strong>.</li>
</ul>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="Modelización.html#cb84-1" tabindex="-1"></a><span class="co"># Diferenciación sugerida y gráfico</span></span>
<span id="cb84-2"><a href="Modelización.html#cb84-2" tabindex="-1"></a></span>
<span id="cb84-3"><a href="Modelización.html#cb84-3" tabindex="-1"></a>d_sugerido <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">ndiffs</span>(serie_vec)</span>
<span id="cb84-4"><a href="Modelización.html#cb84-4" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Diferenciaciones sugeridas por ndiffs:&quot;</span>, d_sugerido, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Diferenciaciones sugeridas por ndiffs: 1</code></pre>
<ul>
<li>“ndiffs” sugiere una <strong>diferenciación (d = 1) para estabilizar tendencia y variabilidad</strong>.</li>
</ul>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="Modelización.html#cb86-1" tabindex="-1"></a>serie_diff <span class="ot">&lt;-</span> <span class="cf">if</span> (d_sugerido <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">diff</span>(serie_vec, <span class="at">differences =</span> d_sugerido) <span class="cf">else</span> serie_vec</span>
<span id="cb86-2"><a href="Modelización.html#cb86-2" tabindex="-1"></a></span>
<span id="cb86-3"><a href="Modelización.html#cb86-3" tabindex="-1"></a>df_diff <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb86-4"><a href="Modelización.html#cb86-4" tabindex="-1"></a><span class="at">time =</span> <span class="fu">as.POSIXct</span>(df_impu[[time_col]])[<span class="fu">seq_along</span>(serie_vec)],</span>
<span id="cb86-5"><a href="Modelización.html#cb86-5" tabindex="-1"></a><span class="at">Original =</span> <span class="fu">as.numeric</span>(serie_vec),</span>
<span id="cb86-6"><a href="Modelización.html#cb86-6" tabindex="-1"></a><span class="at">Diferenciada =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, d_sugerido), <span class="fu">as.numeric</span>(serie_diff))</span>
<span id="cb86-7"><a href="Modelización.html#cb86-7" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb86-8"><a href="Modelización.html#cb86-8" tabindex="-1"></a>tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(Original, Diferenciada), <span class="at">names_to =</span> <span class="st">&quot;Serie&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;Valor&quot;</span>)</span>
<span id="cb86-9"><a href="Modelización.html#cb86-9" tabindex="-1"></a></span>
<span id="cb86-10"><a href="Modelización.html#cb86-10" tabindex="-1"></a><span class="fu">ggplot</span>(df_diff, <span class="fu">aes</span>(time, Valor, <span class="at">color =</span> Serie)) <span class="sc">+</span></span>
<span id="cb86-11"><a href="Modelización.html#cb86-11" tabindex="-1"></a><span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">0.6</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb86-12"><a href="Modelización.html#cb86-12" tabindex="-1"></a><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="at">Original =</span> <span class="st">&quot;#6B7280&quot;</span>, <span class="at">Diferenciada =</span> <span class="st">&quot;#1F77B4&quot;</span>)) <span class="sc">+</span></span>
<span id="cb86-13"><a href="Modelización.html#cb86-13" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Serie original vs. diferenciada&quot;</span>,</span>
<span id="cb86-14"><a href="Modelización.html#cb86-14" tabindex="-1"></a><span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia / ΔPotencia&quot;</span>, <span class="at">color =</span> <span class="st">&quot;Serie&quot;</span>) <span class="sc">+</span></span>
<span id="cb86-15"><a href="Modelización.html#cb86-15" tabindex="-1"></a><span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-42-1.png" width="960" /></p>
<ul>
<li><p>La serie diferenciada muestra valores centrados alrededor de cero, eliminando la tendencia de largo plazo.</p></li>
<li><p>La dispersión es más estable y simétrica, lo que indica que la varianza se ha homogenizado.</p></li>
<li><p>La diferenciación logró transformar la serie en estacionaria, condición necesaria para aplicar modelos como ARIMA.</p></li>
<li><p>Aún se observan algunos picos esporádicos (outliers) que podrían representar eventos atípicos o ruido extremo.</p></li>
</ul>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="Modelización.html#cb87-1" tabindex="-1"></a><span class="co"># ADF nuevamente si se diferenció</span></span>
<span id="cb87-2"><a href="Modelización.html#cb87-2" tabindex="-1"></a></span>
<span id="cb87-3"><a href="Modelización.html#cb87-3" tabindex="-1"></a><span class="cf">if</span> (d_sugerido <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb87-4"><a href="Modelización.html#cb87-4" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Re-prueba ADF en la serie diferenciada (d =&quot;</span>, d_sugerido, <span class="st">&quot;):</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb87-5"><a href="Modelización.html#cb87-5" tabindex="-1"></a><span class="fu">print</span>(tseries<span class="sc">::</span><span class="fu">adf.test</span>(serie_diff, <span class="at">k =</span> <span class="dv">24</span>))</span>
<span id="cb87-6"><a href="Modelización.html#cb87-6" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## 
## Re-prueba ADF en la serie diferenciada (d = 1 ):</code></pre>
<pre><code>## 
##  Augmented Dickey-Fuller Test
## 
## data:  serie_diff
## Dickey-Fuller = -91.466, Lag order = 24, p-value = 0.01
## alternative hypothesis: stationary</code></pre>
<ul>
<li><p>El resultado de la <strong>Prueba ADF (Dickey-Fuller aumentada)</strong> para la serie diferenciada indica que p-value = 0.01 &lt; 0.05, indicando que es una <strong>serie estacionaria</strong>.</p></li>
<li><p>La serie diferenciada (d = 1) cumple con el requisito de estacionariedad, condición indispensable para la modelación ARIMA.</p></li>
<li><p>No se requieren más diferenciaciones.</p></li>
</ul>
</div>
<div id="acf-y-pacf-original-y-diferenciada-1" class="section level3 hasAnchor" number="5.2.4">
<h3><span class="header-section-number">5.2.4</span> ACF y PACF (original y diferenciada)<a href="Modelización.html#acf-y-pacf-original-y-diferenciada-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="Modelización.html#cb90-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb90-2"><a href="Modelización.html#cb90-2" tabindex="-1"></a><span class="co"># 6. ACF y PACF (original y diferenciada)</span></span>
<span id="cb90-3"><a href="Modelización.html#cb90-3" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb90-4"><a href="Modelización.html#cb90-4" tabindex="-1"></a></span>
<span id="cb90-5"><a href="Modelización.html#cb90-5" tabindex="-1"></a><span class="co"># --- Calcular ACF/PACF de la serie original ---</span></span>
<span id="cb90-6"><a href="Modelización.html#cb90-6" tabindex="-1"></a>t0 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb90-7"><a href="Modelización.html#cb90-7" tabindex="-1"></a>acf_obj  <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">acf</span>(serie_vec, <span class="at">lag.max =</span> lag_max, <span class="at">plot =</span> <span class="cn">FALSE</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb90-8"><a href="Modelización.html#cb90-8" tabindex="-1"></a>pacf_obj <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">pacf</span>(serie_vec, <span class="at">lag.max =</span> lag_max, <span class="at">plot =</span> <span class="cn">FALSE</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb90-9"><a href="Modelización.html#cb90-9" tabindex="-1"></a>.timing[[<span class="st">&quot;ACF/PACF (original)&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">seconds =</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(<span class="fu">Sys.time</span>(), t0, <span class="at">units =</span> <span class="st">&quot;secs&quot;</span>)),</span>
<span id="cb90-10"><a href="Modelización.html#cb90-10" tabindex="-1"></a>                                         <span class="at">status =</span> <span class="cf">if</span> (<span class="fu">inherits</span>(acf_obj, <span class="st">&quot;try-error&quot;</span>)) <span class="st">&quot;ERROR&quot;</span> <span class="cf">else</span> <span class="st">&quot;OK&quot;</span>,</span>
<span id="cb90-11"><a href="Modelización.html#cb90-11" tabindex="-1"></a>                                         <span class="at">message =</span> <span class="cn">NA_character_</span>)</span>
<span id="cb90-12"><a href="Modelización.html#cb90-12" tabindex="-1"></a></span>
<span id="cb90-13"><a href="Modelización.html#cb90-13" tabindex="-1"></a><span class="co"># --- Graficar ACF/PACF de la serie original  ---</span></span>
<span id="cb90-14"><a href="Modelización.html#cb90-14" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(acf_obj, <span class="st">&quot;try-error&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">inherits</span>(pacf_obj, <span class="st">&quot;try-error&quot;</span>)) {</span>
<span id="cb90-15"><a href="Modelización.html#cb90-15" tabindex="-1"></a>  acf_df  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">lag =</span> <span class="fu">as.numeric</span>(acf_obj<span class="sc">$</span>lag),  <span class="at">acf  =</span> <span class="fu">as.numeric</span>(acf_obj<span class="sc">$</span>acf))</span>
<span id="cb90-16"><a href="Modelización.html#cb90-16" tabindex="-1"></a>  pacf_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">lag =</span> <span class="fu">as.numeric</span>(pacf_obj<span class="sc">$</span>lag), <span class="at">pacf =</span> <span class="fu">as.numeric</span>(pacf_obj<span class="sc">$</span>acf))</span>
<span id="cb90-17"><a href="Modelización.html#cb90-17" tabindex="-1"></a>  ci <span class="ot">&lt;-</span> <span class="fl">1.96</span> <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(serie_vec))</span>
<span id="cb90-18"><a href="Modelización.html#cb90-18" tabindex="-1"></a>  </span>
<span id="cb90-19"><a href="Modelización.html#cb90-19" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(acf_df, <span class="fu">aes</span>(lag, acf)) <span class="sc">+</span></span>
<span id="cb90-20"><a href="Modelización.html#cb90-20" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">&quot;#1f77b4&quot;</span>) <span class="sc">+</span></span>
<span id="cb90-21"><a href="Modelización.html#cb90-21" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>ci, ci), <span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>, <span class="at">color=</span><span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb90-22"><a href="Modelización.html#cb90-22" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;ACF (serie original)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Rezago (horas)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;ACF&quot;</span>) <span class="sc">+</span></span>
<span id="cb90-23"><a href="Modelización.html#cb90-23" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb90-24"><a href="Modelización.html#cb90-24" tabindex="-1"></a>  </span>
<span id="cb90-25"><a href="Modelización.html#cb90-25" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pacf_df, <span class="fu">aes</span>(lag, pacf)) <span class="sc">+</span></span>
<span id="cb90-26"><a href="Modelización.html#cb90-26" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">&quot;#ff7f0e&quot;</span>) <span class="sc">+</span></span>
<span id="cb90-27"><a href="Modelización.html#cb90-27" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>ci, ci), <span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>, <span class="at">color=</span><span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb90-28"><a href="Modelización.html#cb90-28" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;PACF (serie original)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Rezago (horas)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;PACF&quot;</span>) <span class="sc">+</span></span>
<span id="cb90-29"><a href="Modelización.html#cb90-29" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb90-30"><a href="Modelización.html#cb90-30" tabindex="-1"></a>  </span>
<span id="cb90-31"><a href="Modelización.html#cb90-31" tabindex="-1"></a>  <span class="fu">print</span>(p1); <span class="fu">print</span>(p2)</span>
<span id="cb90-32"><a href="Modelización.html#cb90-32" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb90-33"><a href="Modelización.html#cb90-33" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Error al calcular ACF/PACF de la serie original.</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb90-34"><a href="Modelización.html#cb90-34" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/acf-pacf1-1.png" width="960" /><img src="propuesta-pronostico-subestacion_files/figure-html/acf-pacf1-2.png" width="960" /></p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="Modelización.html#cb91-1" tabindex="-1"></a><span class="co"># --- Serie diferenciada ---</span></span>
<span id="cb91-2"><a href="Modelización.html#cb91-2" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;serie_diff&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(serie_diff) <span class="sc">&gt;</span> <span class="dv">10</span> <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">identical</span>(serie_diff, serie_vec)) {</span>
<span id="cb91-3"><a href="Modelización.html#cb91-3" tabindex="-1"></a>  t0 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb91-4"><a href="Modelización.html#cb91-4" tabindex="-1"></a>  acf_d  <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">acf</span>(serie_diff, <span class="at">lag.max =</span> lag_max, <span class="at">plot =</span> <span class="cn">FALSE</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb91-5"><a href="Modelización.html#cb91-5" tabindex="-1"></a>  pacf_d <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">pacf</span>(serie_diff, <span class="at">lag.max =</span> lag_max, <span class="at">plot =</span> <span class="cn">FALSE</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb91-6"><a href="Modelización.html#cb91-6" tabindex="-1"></a>  .timing[[<span class="st">&quot;ACF/PACF (diferenciada)&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">seconds =</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(<span class="fu">Sys.time</span>(), t0, <span class="at">units =</span> <span class="st">&quot;secs&quot;</span>)),</span>
<span id="cb91-7"><a href="Modelización.html#cb91-7" tabindex="-1"></a>                                               <span class="at">status =</span> <span class="cf">if</span> (<span class="fu">inherits</span>(acf_d, <span class="st">&quot;try-error&quot;</span>)) <span class="st">&quot;ERROR&quot;</span> <span class="cf">else</span> <span class="st">&quot;OK&quot;</span>,</span>
<span id="cb91-8"><a href="Modelización.html#cb91-8" tabindex="-1"></a>                                               <span class="at">message =</span> <span class="cn">NA_character_</span>)</span>
<span id="cb91-9"><a href="Modelización.html#cb91-9" tabindex="-1"></a>  </span>
<span id="cb91-10"><a href="Modelización.html#cb91-10" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(acf_d, <span class="st">&quot;try-error&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">inherits</span>(pacf_d, <span class="st">&quot;try-error&quot;</span>)) {</span>
<span id="cb91-11"><a href="Modelización.html#cb91-11" tabindex="-1"></a>    acf_df_d  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">lag =</span> <span class="fu">as.numeric</span>(acf_d<span class="sc">$</span>lag),  <span class="at">acf  =</span> <span class="fu">as.numeric</span>(acf_d<span class="sc">$</span>acf))</span>
<span id="cb91-12"><a href="Modelización.html#cb91-12" tabindex="-1"></a>    pacf_df_d <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">lag =</span> <span class="fu">as.numeric</span>(pacf_d<span class="sc">$</span>lag), <span class="at">pacf =</span> <span class="fu">as.numeric</span>(pacf_d<span class="sc">$</span>acf))</span>
<span id="cb91-13"><a href="Modelización.html#cb91-13" tabindex="-1"></a>    ci_d <span class="ot">&lt;-</span> <span class="fl">1.96</span> <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(serie_diff))</span>
<span id="cb91-14"><a href="Modelización.html#cb91-14" tabindex="-1"></a>    </span>
<span id="cb91-15"><a href="Modelización.html#cb91-15" tabindex="-1"></a>    p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(acf_df_d, <span class="fu">aes</span>(lag, acf)) <span class="sc">+</span></span>
<span id="cb91-16"><a href="Modelización.html#cb91-16" tabindex="-1"></a>      <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">&quot;#17becf&quot;</span>) <span class="sc">+</span></span>
<span id="cb91-17"><a href="Modelización.html#cb91-17" tabindex="-1"></a>      <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>ci_d, ci_d), <span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>, <span class="at">color=</span><span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb91-18"><a href="Modelización.html#cb91-18" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;ACF (serie diferenciada)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Rezago (horas)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;ACF&quot;</span>) <span class="sc">+</span></span>
<span id="cb91-19"><a href="Modelización.html#cb91-19" tabindex="-1"></a>      <span class="fu">theme_minimal</span>()</span>
<span id="cb91-20"><a href="Modelización.html#cb91-20" tabindex="-1"></a>    </span>
<span id="cb91-21"><a href="Modelización.html#cb91-21" tabindex="-1"></a>    p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pacf_df_d, <span class="fu">aes</span>(lag, pacf)) <span class="sc">+</span></span>
<span id="cb91-22"><a href="Modelización.html#cb91-22" tabindex="-1"></a>      <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">&quot;#2ca02c&quot;</span>) <span class="sc">+</span></span>
<span id="cb91-23"><a href="Modelización.html#cb91-23" tabindex="-1"></a>      <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>ci_d, ci_d), <span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>, <span class="at">color=</span><span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb91-24"><a href="Modelización.html#cb91-24" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;PACF (serie diferenciada)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Rezago (horas)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;PACF&quot;</span>) <span class="sc">+</span></span>
<span id="cb91-25"><a href="Modelización.html#cb91-25" tabindex="-1"></a>      <span class="fu">theme_minimal</span>()</span>
<span id="cb91-26"><a href="Modelización.html#cb91-26" tabindex="-1"></a>    </span>
<span id="cb91-27"><a href="Modelización.html#cb91-27" tabindex="-1"></a>    <span class="fu">print</span>(p3); <span class="fu">print</span>(p4)</span>
<span id="cb91-28"><a href="Modelización.html#cb91-28" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb91-29"><a href="Modelización.html#cb91-29" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Error al calcular ACF/PACF diferenciada.</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb91-30"><a href="Modelización.html#cb91-30" tabindex="-1"></a>  }</span>
<span id="cb91-31"><a href="Modelización.html#cb91-31" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/acf-pacf1-3.png" width="960" /><img src="propuesta-pronostico-subestacion_files/figure-html/acf-pacf1-4.png" width="960" /></p>
<ul>
<li><p>La <strong>ACF de la serie original</strong> presenta una decadencia lenta y oscilante, sin cortar bruscamente, lo que indica que la serie no es estacionaria. Se observan picos significativos en rezagos cercanos a 24, 48, 72, 96 y 120 horas (múltiplos de 24), lo cual sugiere una estacionalidad diaria (ciclos de 24 h). El patrón sinusoidal de la ACF evidencia repetición de ciclos de comportamiento, probablemente relacionados con el uso o generación de potencia a lo largo del día.</p></li>
<li><p>La <strong>PACF de la serie original</strong> muestra un pico muy fuerte en el primer rezago (lag 1) y luego decae rápidamente a valores cercanos a cer, esto indica alta autocorrelación inmediata, es decir, el valor actual depende fuertemente del valor anterior. El resto de los rezagos no son significativos, lo que refuerza la presencia de una tendencia o componente autorregresiva dominante.</p></li>
<li><p>La serie original no es estacionaria, presenta tendencia y una fuerte estacionalidad diaria. Esto confirma la necesidad de diferenciar la serie antes del modelado ARIMA.</p></li>
<li><p>La <strong>ACF de la serie diferenciada</strong> muestra que los valores caen a cero rápidamente, salvo en algunos rezagos aislados. La pérdida de la estructura oscilante confirma que la tendencia fue eliminada y que la serie se ha vuelto más estacionaria. Persisten algunos picos moderados en múltiplos de 24 horas, indicando que aún hay componente estacional residual (ciclo diario).</p></li>
<li><p>En la <strong>PACF de la serie diferenciada</strong> muestra solo unos pocos rezagos significativos (lag 1 y algunos alrededor de 24), suguiriendo que podría haber un componente AR de bajo orden (p ≈ 1) y posiblemente un componente estacional AR o MA en los múltiplos de 24.</p></li>
<li><p>La diferenciación logró estacionarizar la serie, eliminando la tendencia.</p></li>
</ul>
</div>
<div id="descomposición-stl-seasonal-trend-decomposition-using-loess-y-mstl-multiple-seasonal-trend-decomposition-using-loess-1" class="section level3 hasAnchor" number="5.2.5">
<h3><span class="header-section-number">5.2.5</span> Descomposición STL (Seasonal-Trend decomposition using Loess) y MSTL (Multiple Seasonal-Trend decomposition using Loess)<a href="Modelización.html#descomposici%C3%B3n-stl-seasonal-trend-decomposition-using-loess-y-mstl-multiple-seasonal-trend-decomposition-using-loess-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="Modelización.html#cb92-1" tabindex="-1"></a>val_col <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="st">&quot;val_impu&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_impu)) <span class="st">&quot;val_impu&quot;</span> <span class="cf">else</span></span>
<span id="cb92-2"><a href="Modelización.html#cb92-2" tabindex="-1"></a>           <span class="cf">if</span> (<span class="st">&quot;VALOR_IMPUTADO&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_impu)) <span class="st">&quot;VALOR_IMPUTADO&quot;</span> <span class="cf">else</span></span>
<span id="cb92-3"><a href="Modelización.html#cb92-3" tabindex="-1"></a>           <span class="fu">stop</span>(<span class="st">&quot;No encuentro columna de valores: usa &#39;val_impu&#39; o &#39;VALOR_IMPUTADO&#39;.&quot;</span>)</span>
<span id="cb92-4"><a href="Modelización.html#cb92-4" tabindex="-1"></a></span>
<span id="cb92-5"><a href="Modelización.html#cb92-5" tabindex="-1"></a><span class="co"># Utilidad para detectar columna estacional por periodo (acepta &#39;Seasonal-24&#39;, &#39;Seasonal 24&#39;, etc.)</span></span>
<span id="cb92-6"><a href="Modelización.html#cb92-6" tabindex="-1"></a>find_seasonal_col <span class="ot">&lt;-</span> <span class="cf">function</span>(df_comp, target_period) {</span>
<span id="cb92-7"><a href="Modelización.html#cb92-7" tabindex="-1"></a>  nm <span class="ot">&lt;-</span> <span class="fu">names</span>(df_comp)</span>
<span id="cb92-8"><a href="Modelización.html#cb92-8" tabindex="-1"></a>  is_seas <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">&quot;^Seasonal&quot;</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-9"><a href="Modelización.html#cb92-9" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(is_seas)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb92-10"><a href="Modelización.html#cb92-10" tabindex="-1"></a>  seas_nm <span class="ot">&lt;-</span> nm[is_seas]</span>
<span id="cb92-11"><a href="Modelización.html#cb92-11" tabindex="-1"></a>  getp <span class="ot">&lt;-</span> <span class="cf">function</span>(s) { p <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;[^0-9]&quot;</span>, <span class="st">&quot;&quot;</span>, s); <span class="cf">if</span> (<span class="fu">nzchar</span>(p)) <span class="fu">as.integer</span>(p) <span class="cf">else</span> <span class="cn">NA_integer_</span> }</span>
<span id="cb92-12"><a href="Modelización.html#cb92-12" tabindex="-1"></a>  periods <span class="ot">&lt;-</span> <span class="fu">vapply</span>(seas_nm, getp, <span class="fu">integer</span>(<span class="dv">1</span>))</span>
<span id="cb92-13"><a href="Modelización.html#cb92-13" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which</span>(periods <span class="sc">==</span> target_period)</span>
<span id="cb92-14"><a href="Modelización.html#cb92-14" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(idx)) seas_nm[idx[<span class="dv">1</span>]] <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb92-15"><a href="Modelización.html#cb92-15" tabindex="-1"></a>}</span>
<span id="cb92-16"><a href="Modelización.html#cb92-16" tabindex="-1"></a></span>
<span id="cb92-17"><a href="Modelización.html#cb92-17" tabindex="-1"></a><span class="co"># ========== A) df_seas24: Estacionalidad diaria (24h) desde SERIE HORARIA ==========</span></span>
<span id="cb92-18"><a href="Modelización.html#cb92-18" tabindex="-1"></a>x_hour  <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(df_impu[[val_col]])</span>
<span id="cb92-19"><a href="Modelización.html#cb92-19" tabindex="-1"></a>time_hr <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(df_impu[[time_col]])</span>
<span id="cb92-20"><a href="Modelización.html#cb92-20" tabindex="-1"></a></span>
<span id="cb92-21"><a href="Modelización.html#cb92-21" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">length</span>(x_hour) <span class="sc">&gt;=</span> <span class="dv">24</span><span class="sc">*</span><span class="dv">14</span>)  <span class="co"># al menos ~2 semanas</span></span>
<span id="cb92-22"><a href="Modelización.html#cb92-22" tabindex="-1"></a>ts_hour     <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">msts</span>(x_hour, <span class="at">seasonal.periods =</span> <span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">168</span>))</span>
<span id="cb92-23"><a href="Modelización.html#cb92-23" tabindex="-1"></a>fit_m_hour  <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">mstl</span>(ts_hour, <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-24"><a href="Modelización.html#cb92-24" tabindex="-1"></a>comp_h      <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_m_hour)</span>
<span id="cb92-25"><a href="Modelización.html#cb92-25" tabindex="-1"></a>col_s24     <span class="ot">&lt;-</span> <span class="fu">find_seasonal_col</span>(comp_h, <span class="dv">24</span>)</span>
<span id="cb92-26"><a href="Modelización.html#cb92-26" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(col_s24)) {</span>
<span id="cb92-27"><a href="Modelización.html#cb92-27" tabindex="-1"></a>  <span class="co"># fallback: primera &#39;Seasonal&#39; si no se pudo detectar 24 específicamente</span></span>
<span id="cb92-28"><a href="Modelización.html#cb92-28" tabindex="-1"></a>  cand <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">&quot;^Seasonal&quot;</span>, <span class="fu">names</span>(comp_h), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-29"><a href="Modelización.html#cb92-29" tabindex="-1"></a>  col_s24 <span class="ot">&lt;-</span> cand[<span class="dv">1</span>]</span>
<span id="cb92-30"><a href="Modelización.html#cb92-30" tabindex="-1"></a>}</span>
<span id="cb92-31"><a href="Modelización.html#cb92-31" tabindex="-1"></a>df_seas24 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb92-32"><a href="Modelización.html#cb92-32" tabindex="-1"></a>  <span class="at">time =</span> time_hr,</span>
<span id="cb92-33"><a href="Modelización.html#cb92-33" tabindex="-1"></a>  <span class="at">Componente =</span> <span class="st">&quot;Estacionalidad diaria (24h)&quot;</span>,</span>
<span id="cb92-34"><a href="Modelización.html#cb92-34" tabindex="-1"></a>  <span class="at">Valor =</span> comp_h[[col_s24]]</span>
<span id="cb92-35"><a href="Modelización.html#cb92-35" tabindex="-1"></a>)</span>
<span id="cb92-36"><a href="Modelización.html#cb92-36" tabindex="-1"></a></span>
<span id="cb92-37"><a href="Modelización.html#cb92-37" tabindex="-1"></a><span class="co"># ========== B) df_seas12: Estacionalidad mensual (12) desde SERIE MENSUAL ==========</span></span>
<span id="cb92-38"><a href="Modelización.html#cb92-38" tabindex="-1"></a>monthly <span class="ot">&lt;-</span> df_impu <span class="sc">%&gt;%</span></span>
<span id="cb92-39"><a href="Modelización.html#cb92-39" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mes =</span> <span class="fu">floor_date</span>(.data[[time_col]], <span class="st">&quot;month&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb92-40"><a href="Modelización.html#cb92-40" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.by =</span> mes, <span class="at">y =</span> <span class="fu">mean</span>(.data[[val_col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb92-41"><a href="Modelización.html#cb92-41" tabindex="-1"></a>  <span class="fu">arrange</span>(mes)</span>
<span id="cb92-42"><a href="Modelización.html#cb92-42" tabindex="-1"></a></span>
<span id="cb92-43"><a href="Modelización.html#cb92-43" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">nrow</span>(monthly) <span class="sc">&gt;=</span> <span class="dv">24</span>)</span>
<span id="cb92-44"><a href="Modelización.html#cb92-44" tabindex="-1"></a>ts_month <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">ts</span>(</span>
<span id="cb92-45"><a href="Modelización.html#cb92-45" tabindex="-1"></a>  monthly<span class="sc">$</span>y, <span class="at">frequency =</span> <span class="dv">12</span>,</span>
<span id="cb92-46"><a href="Modelización.html#cb92-46" tabindex="-1"></a>  <span class="at">start =</span> <span class="fu">c</span>(<span class="fu">year</span>(<span class="fu">min</span>(monthly<span class="sc">$</span>mes)), <span class="fu">month</span>(<span class="fu">min</span>(monthly<span class="sc">$</span>mes)))</span>
<span id="cb92-47"><a href="Modelización.html#cb92-47" tabindex="-1"></a>)</span>
<span id="cb92-48"><a href="Modelización.html#cb92-48" tabindex="-1"></a>fit_stl_m <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">stl</span>(ts_month, <span class="at">s.window =</span> <span class="st">&quot;periodic&quot;</span>, <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-49"><a href="Modelización.html#cb92-49" tabindex="-1"></a>comp_m <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_stl_m<span class="sc">$</span>time.series)</span>
<span id="cb92-50"><a href="Modelización.html#cb92-50" tabindex="-1"></a><span class="co"># detectar columna estacional (nombre puede ser &quot;seasonal&quot;/&quot;Seasonal&quot;)</span></span>
<span id="cb92-51"><a href="Modelización.html#cb92-51" tabindex="-1"></a>seas_col_m <span class="ot">&lt;-</span> <span class="fu">names</span>(comp_m)[<span class="fu">grepl</span>(<span class="st">&quot;season&quot;</span>, <span class="fu">names</span>(comp_m), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)][<span class="dv">1</span>]</span>
<span id="cb92-52"><a href="Modelización.html#cb92-52" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.na</span>(seas_col_m)) <span class="fu">stop</span>(<span class="st">&quot;No se encontró columna estacional en STL mensual.&quot;</span>)</span>
<span id="cb92-53"><a href="Modelización.html#cb92-53" tabindex="-1"></a>df_seas12 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb92-54"><a href="Modelización.html#cb92-54" tabindex="-1"></a>  <span class="at">time =</span> <span class="fu">as.POSIXct</span>(monthly<span class="sc">$</span>mes),     <span class="co"># unificamos a POSIXct</span></span>
<span id="cb92-55"><a href="Modelización.html#cb92-55" tabindex="-1"></a>  <span class="at">Componente =</span> <span class="st">&quot;Estacionalidad mensual (12)&quot;</span>,</span>
<span id="cb92-56"><a href="Modelización.html#cb92-56" tabindex="-1"></a>  <span class="at">Valor =</span> comp_m[[seas_col_m]]</span>
<span id="cb92-57"><a href="Modelización.html#cb92-57" tabindex="-1"></a>)</span>
<span id="cb92-58"><a href="Modelización.html#cb92-58" tabindex="-1"></a></span>
<span id="cb92-59"><a href="Modelización.html#cb92-59" tabindex="-1"></a><span class="co"># ========== C) df_day_panel: Observada, Tendencia, Semanal(7d), Anual(365d), Residuo (SERIE DIARIA) ==========</span></span>
<span id="cb92-60"><a href="Modelización.html#cb92-60" tabindex="-1"></a>daily <span class="ot">&lt;-</span> df_impu <span class="sc">%&gt;%</span></span>
<span id="cb92-61"><a href="Modelización.html#cb92-61" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">day =</span> <span class="fu">floor_date</span>(.data[[time_col]], <span class="st">&quot;day&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb92-62"><a href="Modelización.html#cb92-62" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.by =</span> day, <span class="at">y =</span> <span class="fu">mean</span>(.data[[val_col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb92-63"><a href="Modelización.html#cb92-63" tabindex="-1"></a>  <span class="fu">arrange</span>(day)</span>
<span id="cb92-64"><a href="Modelización.html#cb92-64" tabindex="-1"></a></span>
<span id="cb92-65"><a href="Modelización.html#cb92-65" tabindex="-1"></a>ts_day    <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">msts</span>(daily<span class="sc">$</span>y, <span class="at">seasonal.periods =</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">365</span>))</span>
<span id="cb92-66"><a href="Modelización.html#cb92-66" tabindex="-1"></a>fit_m_day <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">mstl</span>(ts_day, <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-67"><a href="Modelización.html#cb92-67" tabindex="-1"></a>comp_d    <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_m_day)</span>
<span id="cb92-68"><a href="Modelización.html#cb92-68" tabindex="-1"></a></span>
<span id="cb92-69"><a href="Modelización.html#cb92-69" tabindex="-1"></a><span class="co"># Normalizamos nombres para &#39;Trend&#39; y &#39;Remainder&#39;</span></span>
<span id="cb92-70"><a href="Modelización.html#cb92-70" tabindex="-1"></a>nmd <span class="ot">&lt;-</span> <span class="fu">names</span>(comp_d)</span>
<span id="cb92-71"><a href="Modelización.html#cb92-71" tabindex="-1"></a>nmd <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">&quot;^trend$&quot;</span>, <span class="st">&quot;Trend&quot;</span>, nmd, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-72"><a href="Modelización.html#cb92-72" tabindex="-1"></a>nmd <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">&quot;^remainder$&quot;</span>, <span class="st">&quot;Remainder&quot;</span>, nmd, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-73"><a href="Modelización.html#cb92-73" tabindex="-1"></a><span class="fu">names</span>(comp_d) <span class="ot">&lt;-</span> nmd</span>
<span id="cb92-74"><a href="Modelización.html#cb92-74" tabindex="-1"></a></span>
<span id="cb92-75"><a href="Modelización.html#cb92-75" tabindex="-1"></a><span class="co"># Detectar columnas estacionales 7 y 365</span></span>
<span id="cb92-76"><a href="Modelización.html#cb92-76" tabindex="-1"></a>is_seas  <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">&quot;^Seasonal&quot;</span>, <span class="fu">names</span>(comp_d), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-77"><a href="Modelización.html#cb92-77" tabindex="-1"></a>seas_nms <span class="ot">&lt;-</span> <span class="fu">names</span>(comp_d)[is_seas]</span>
<span id="cb92-78"><a href="Modelización.html#cb92-78" tabindex="-1"></a>getp <span class="ot">&lt;-</span> <span class="cf">function</span>(s) { p <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;[^0-9]&quot;</span>, <span class="st">&quot;&quot;</span>, s); <span class="cf">if</span> (<span class="fu">nzchar</span>(p)) <span class="fu">as.integer</span>(p) <span class="cf">else</span> <span class="cn">NA_integer_</span> }</span>
<span id="cb92-79"><a href="Modelización.html#cb92-79" tabindex="-1"></a>seas_p <span class="ot">&lt;-</span> <span class="fu">vapply</span>(seas_nms, getp, <span class="fu">integer</span>(<span class="dv">1</span>))</span>
<span id="cb92-80"><a href="Modelización.html#cb92-80" tabindex="-1"></a>idx7   <span class="ot">&lt;-</span> <span class="fu">which</span>(seas_p <span class="sc">==</span> <span class="dv">7</span>)</span>
<span id="cb92-81"><a href="Modelización.html#cb92-81" tabindex="-1"></a>idx365 <span class="ot">&lt;-</span> <span class="fu">which</span>(seas_p <span class="sc">==</span> <span class="dv">365</span>)</span>
<span id="cb92-82"><a href="Modelización.html#cb92-82" tabindex="-1"></a>seas7   <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(idx7))   comp_d[[seas_nms[idx7[<span class="dv">1</span>]]]]   <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb92-83"><a href="Modelización.html#cb92-83" tabindex="-1"></a>seas365 <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(idx365)) comp_d[[seas_nms[idx365[<span class="dv">1</span>]]]] <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb92-84"><a href="Modelización.html#cb92-84" tabindex="-1"></a></span>
<span id="cb92-85"><a href="Modelización.html#cb92-85" tabindex="-1"></a>df_day_panel <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb92-86"><a href="Modelización.html#cb92-86" tabindex="-1"></a>  <span class="at">time       =</span> <span class="fu">as.POSIXct</span>(daily<span class="sc">$</span>day),</span>
<span id="cb92-87"><a href="Modelización.html#cb92-87" tabindex="-1"></a>  <span class="at">Observada  =</span> daily<span class="sc">$</span>y,</span>
<span id="cb92-88"><a href="Modelización.html#cb92-88" tabindex="-1"></a>  <span class="at">Tendencia  =</span> <span class="cf">if</span> (<span class="st">&quot;Trend&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(comp_d)) comp_d<span class="sc">$</span>Trend <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb92-89"><a href="Modelización.html#cb92-89" tabindex="-1"></a>  <span class="at">Residuo    =</span> <span class="cf">if</span> (<span class="st">&quot;Remainder&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(comp_d)) comp_d<span class="sc">$</span>Remainder <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb92-90"><a href="Modelización.html#cb92-90" tabindex="-1"></a>)</span>
<span id="cb92-91"><a href="Modelización.html#cb92-91" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seas7))   df_day_panel[[<span class="st">&quot;Estacionalidad semanal (7d)&quot;</span>]]  <span class="ot">&lt;-</span> seas7</span>
<span id="cb92-92"><a href="Modelización.html#cb92-92" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seas365)) df_day_panel[[<span class="st">&quot;Estacionalidad anual (365d)&quot;</span>]] <span class="ot">&lt;-</span> seas365</span>
<span id="cb92-93"><a href="Modelización.html#cb92-93" tabindex="-1"></a></span>
<span id="cb92-94"><a href="Modelización.html#cb92-94" tabindex="-1"></a>df_day_panel <span class="ot">&lt;-</span> df_day_panel <span class="sc">|&gt;</span></span>
<span id="cb92-95"><a href="Modelización.html#cb92-95" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">&quot;Componente&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;Valor&quot;</span>)</span>
<span id="cb92-96"><a href="Modelización.html#cb92-96" tabindex="-1"></a></span>
<span id="cb92-97"><a href="Modelización.html#cb92-97" tabindex="-1"></a><span class="co"># ========== D) Panel combinado ==========</span></span>
<span id="cb92-98"><a href="Modelización.html#cb92-98" tabindex="-1"></a>panel_all <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb92-99"><a href="Modelización.html#cb92-99" tabindex="-1"></a>  df_day_panel,  <span class="co"># Observada/Tendencia/Residuo + 7d/365d si existen</span></span>
<span id="cb92-100"><a href="Modelización.html#cb92-100" tabindex="-1"></a>  df_seas24,     <span class="co"># Estacionalidad diaria (24h) desde HORAS</span></span>
<span id="cb92-101"><a href="Modelización.html#cb92-101" tabindex="-1"></a>  df_seas12      <span class="co"># Estacionalidad mensual (12) desde MESES</span></span>
<span id="cb92-102"><a href="Modelización.html#cb92-102" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb92-103"><a href="Modelización.html#cb92-103" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-104"><a href="Modelización.html#cb92-104" tabindex="-1"></a>    <span class="at">Componente =</span> <span class="fu">factor</span>(</span>
<span id="cb92-105"><a href="Modelización.html#cb92-105" tabindex="-1"></a>      Componente,</span>
<span id="cb92-106"><a href="Modelización.html#cb92-106" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;Observada&quot;</span>, <span class="st">&quot;Tendencia&quot;</span>,</span>
<span id="cb92-107"><a href="Modelización.html#cb92-107" tabindex="-1"></a>                 <span class="st">&quot;Estacionalidad diaria (24h)&quot;</span>,</span>
<span id="cb92-108"><a href="Modelización.html#cb92-108" tabindex="-1"></a>                 <span class="st">&quot;Estacionalidad semanal (7d)&quot;</span>,</span>
<span id="cb92-109"><a href="Modelización.html#cb92-109" tabindex="-1"></a>                 <span class="st">&quot;Estacionalidad mensual (12)&quot;</span>,</span>
<span id="cb92-110"><a href="Modelización.html#cb92-110" tabindex="-1"></a>                 <span class="st">&quot;Estacionalidad anual (365d)&quot;</span>,</span>
<span id="cb92-111"><a href="Modelización.html#cb92-111" tabindex="-1"></a>                 <span class="st">&quot;Residuo&quot;</span>)</span>
<span id="cb92-112"><a href="Modelización.html#cb92-112" tabindex="-1"></a>    )</span>
<span id="cb92-113"><a href="Modelización.html#cb92-113" tabindex="-1"></a>  )</span>
<span id="cb92-114"><a href="Modelización.html#cb92-114" tabindex="-1"></a></span>
<span id="cb92-115"><a href="Modelización.html#cb92-115" tabindex="-1"></a><span class="co"># ========== E) Gráfico ==========</span></span>
<span id="cb92-116"><a href="Modelización.html#cb92-116" tabindex="-1"></a><span class="fu">ggplot</span>(panel_all, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> Valor)) <span class="sc">+</span></span>
<span id="cb92-117"><a href="Modelización.html#cb92-117" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">0.45</span>, <span class="at">alpha =</span> <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb92-118"><a href="Modelización.html#cb92-118" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Componente, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>, <span class="at">drop =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb92-119"><a href="Modelización.html#cb92-119" tabindex="-1"></a>  <span class="fu">scale_x_datetime</span>(<span class="at">date_breaks =</span> <span class="st">&quot;6 months&quot;</span>, <span class="at">date_labels =</span> <span class="st">&quot;%b-%Y&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-120"><a href="Modelización.html#cb92-120" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">x =</span> <span class="fu">guide_axis</span>(<span class="at">n.dodge =</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb92-121"><a href="Modelización.html#cb92-121" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb92-122"><a href="Modelización.html#cb92-122" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Descomposición combinada de la serie completa&quot;</span>,</span>
<span id="cb92-123"><a href="Modelización.html#cb92-123" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Tendencia + Estacionalidades diaria (24h), semanal (7d), mensual (12) y anual (365d) + Residuo&quot;</span>,</span>
<span id="cb92-124"><a href="Modelización.html#cb92-124" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Valor&quot;</span></span>
<span id="cb92-125"><a href="Modelización.html#cb92-125" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb92-126"><a href="Modelización.html#cb92-126" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb92-127"><a href="Modelización.html#cb92-127" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb92-128"><a href="Modelización.html#cb92-128" tabindex="-1"></a>        <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-44-1.png" width="1152" /></p>
<ul>
<li>La descomposición evidencia que la serie de potencia es altamente estructurada, con una tendencia creciente de largo plazo, ciclos estacionales fuertes en las escalas diaria y semanal, modulaciones mensuales y anuales de menor intensidad y un residuo controlado, con algunos eventos atípicos aislados.</li>
</ul>
</div>
<div id="promedios-móviles-24h-168h-720h" class="section level3 hasAnchor" number="5.2.6">
<h3><span class="header-section-number">5.2.6</span> Promedios móviles (24h, 168h, 720h)<a href="Modelización.html#promedios-m%C3%B3viles-24h-168h-720h" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="Modelización.html#cb93-1" tabindex="-1"></a>df_ma <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb93-2"><a href="Modelización.html#cb93-2" tabindex="-1"></a>  <span class="at">time     =</span> <span class="fu">as.POSIXct</span>(df_impu[[time_col]]),</span>
<span id="cb93-3"><a href="Modelización.html#cb93-3" tabindex="-1"></a>  <span class="at">Original =</span> <span class="fu">as.numeric</span>(df_impu<span class="sc">$</span>val_impu),</span>
<span id="cb93-4"><a href="Modelización.html#cb93-4" tabindex="-1"></a>  <span class="at">MA_24    =</span> <span class="fu">as.numeric</span>(zoo<span class="sc">::</span><span class="fu">rollmean</span>(df_impu<span class="sc">$</span>val_impu, <span class="dv">24</span>,  <span class="at">align =</span> <span class="st">&quot;right&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>)),</span>
<span id="cb93-5"><a href="Modelización.html#cb93-5" tabindex="-1"></a>  <span class="at">MA_168   =</span> <span class="fu">as.numeric</span>(zoo<span class="sc">::</span><span class="fu">rollmean</span>(df_impu<span class="sc">$</span>val_impu, <span class="dv">168</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>)),</span>
<span id="cb93-6"><a href="Modelización.html#cb93-6" tabindex="-1"></a>  <span class="at">MA_720   =</span> <span class="fu">as.numeric</span>(zoo<span class="sc">::</span><span class="fu">rollmean</span>(df_impu<span class="sc">$</span>val_impu, <span class="dv">720</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>))</span>
<span id="cb93-7"><a href="Modelización.html#cb93-7" tabindex="-1"></a>)</span>
<span id="cb93-8"><a href="Modelización.html#cb93-8" tabindex="-1"></a></span>
<span id="cb93-9"><a href="Modelización.html#cb93-9" tabindex="-1"></a><span class="fu">ggplot</span>(df_ma, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb93-10"><a href="Modelización.html#cb93-10" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Original), <span class="at">color =</span> <span class="st">&quot;grey70&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb93-11"><a href="Modelización.html#cb93-11" tabindex="-1"></a>  <span class="co"># Halo para la verde</span></span>
<span id="cb93-12"><a href="Modelización.html#cb93-12" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> MA_168), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">linewidth =</span> <span class="fl">1.8</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb93-13"><a href="Modelización.html#cb93-13" tabindex="-1"></a>  <span class="co"># Mapear color con etiquetas literales -&gt; leyenda</span></span>
<span id="cb93-14"><a href="Modelización.html#cb93-14" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> MA_24,  <span class="at">color =</span> <span class="st">&quot;MA 24h&quot;</span>),  <span class="at">linewidth =</span> <span class="fl">1.0</span>, <span class="at">alpha =</span> <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb93-15"><a href="Modelización.html#cb93-15" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> MA_168, <span class="at">color =</span> <span class="st">&quot;MA 168h&quot;</span>), <span class="at">linewidth =</span> <span class="fl">1.0</span>, <span class="at">alpha =</span> <span class="fl">1.00</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb93-16"><a href="Modelización.html#cb93-16" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> MA_720, <span class="at">color =</span> <span class="st">&quot;MA 720h&quot;</span>), <span class="at">linewidth =</span> <span class="fl">1.0</span>, <span class="at">alpha =</span> <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb93-17"><a href="Modelización.html#cb93-17" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb93-18"><a href="Modelización.html#cb93-18" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;MA 24h&quot;</span>  <span class="ot">=</span> <span class="st">&quot;#1f77b4&quot;</span>,</span>
<span id="cb93-19"><a href="Modelización.html#cb93-19" tabindex="-1"></a>               <span class="st">&quot;MA 168h&quot;</span> <span class="ot">=</span> <span class="st">&quot;#00B050&quot;</span>,</span>
<span id="cb93-20"><a href="Modelización.html#cb93-20" tabindex="-1"></a>               <span class="st">&quot;MA 720h&quot;</span> <span class="ot">=</span> <span class="st">&quot;#D62728&quot;</span>),</span>
<span id="cb93-21"><a href="Modelización.html#cb93-21" tabindex="-1"></a>    <span class="at">name   =</span> <span class="st">&quot;Serie&quot;</span>,</span>
<span id="cb93-22"><a href="Modelización.html#cb93-22" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">&quot;MA 24h&quot;</span>, <span class="st">&quot;MA 168h&quot;</span>, <span class="st">&quot;MA 720h&quot;</span>),</span>
<span id="cb93-23"><a href="Modelización.html#cb93-23" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;MA 24h (1 día)&quot;</span>, <span class="st">&quot;MA 168h (1 semana)&quot;</span>, <span class="st">&quot;MA 720h (1 mes)&quot;</span>)</span>
<span id="cb93-24"><a href="Modelización.html#cb93-24" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb93-25"><a href="Modelización.html#cb93-25" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Promedios móviles (24h, 168h, 720h)&quot;</span>,</span>
<span id="cb93-26"><a href="Modelización.html#cb93-26" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia&quot;</span>) <span class="sc">+</span></span>
<span id="cb93-27"><a href="Modelización.html#cb93-27" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb93-28"><a href="Modelización.html#cb93-28" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb93-29"><a href="Modelización.html#cb93-29" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>,</span>
<span id="cb93-30"><a href="Modelización.html#cb93-30" tabindex="-1"></a>        <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-45-1.png" width="960" /></p>
<ul>
<li><p>Las tres curvas muestran consistencia ascendente: la serie tiende a crecer lentamente con el tiempo.</p></li>
<li><p>Las diferencias de amplitud entre los promedios móviles demuestran que la serie presenta alta volatilidad horaria, pero un comportamiento más estable a mediano y largo plazo.</p></li>
<li><p>Los picos muy marcados, especialmente entre 2019 y 2024, pueden deberse a eventos excepcionales o registros atípicos, sin afectar la tendencia general.</p></li>
<li><p>El análisis de promedios móviles evidencia una serie con fuerte variabilidad de corto plazo, pero con una tendencia creciente sostenida en el largo plazo.</p></li>
</ul>
</div>
<div id="selección-del-modelo-eficiente-auto.arima-y-pronóstico-1" class="section level3 hasAnchor" number="5.2.7">
<h3><span class="header-section-number">5.2.7</span> Selección del modelo eficiente (auto.arima) y Pronóstico<a href="Modelización.html#selecci%C3%B3n-del-modelo-eficiente-auto.arima-y-pron%C3%B3stico-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="Modelización.html#cb94-1" tabindex="-1"></a><span class="fu">tm</span>(<span class="st">&quot;Ajuste SARIMA + Pronóstico&quot;</span>, {</span>
<span id="cb94-2"><a href="Modelización.html#cb94-2" tabindex="-1"></a>y_fit <span class="ot">&lt;&lt;-</span> <span class="fu">ts</span>(serie_vec, <span class="at">frequency =</span> <span class="dv">24</span>)</span>
<span id="cb94-3"><a href="Modelización.html#cb94-3" tabindex="-1"></a></span>
<span id="cb94-4"><a href="Modelización.html#cb94-4" tabindex="-1"></a>m_auto <span class="ot">&lt;&lt;-</span> forecast<span class="sc">::</span><span class="fu">auto.arima</span>(</span>
<span id="cb94-5"><a href="Modelización.html#cb94-5" tabindex="-1"></a>y_fit,</span>
<span id="cb94-6"><a href="Modelización.html#cb94-6" tabindex="-1"></a><span class="at">d =</span> d_sugerido,</span>
<span id="cb94-7"><a href="Modelización.html#cb94-7" tabindex="-1"></a><span class="at">seasonal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb94-8"><a href="Modelización.html#cb94-8" tabindex="-1"></a><span class="at">stepwise =</span> <span class="cn">TRUE</span>,</span>
<span id="cb94-9"><a href="Modelización.html#cb94-9" tabindex="-1"></a><span class="at">approximation =</span> arima_approx,</span>
<span id="cb94-10"><a href="Modelización.html#cb94-10" tabindex="-1"></a><span class="at">max.p =</span> <span class="dv">5</span>, <span class="at">max.q =</span> <span class="dv">5</span>, <span class="at">max.P =</span> <span class="dv">2</span>, <span class="at">max.Q =</span> <span class="dv">2</span></span>
<span id="cb94-11"><a href="Modelización.html#cb94-11" tabindex="-1"></a>)</span>
<span id="cb94-12"><a href="Modelización.html#cb94-12" tabindex="-1"></a><span class="fu">print</span>(m_auto)</span>
<span id="cb94-13"><a href="Modelización.html#cb94-13" tabindex="-1"></a></span>
<span id="cb94-14"><a href="Modelización.html#cb94-14" tabindex="-1"></a>h_days <span class="ot">&lt;&lt;-</span> horizon_days</span>
<span id="cb94-15"><a href="Modelización.html#cb94-15" tabindex="-1"></a>h <span class="ot">&lt;&lt;-</span> <span class="dv">24</span> <span class="sc">*</span> h_days</span>
<span id="cb94-16"><a href="Modelización.html#cb94-16" tabindex="-1"></a></span>
<span id="cb94-17"><a href="Modelización.html#cb94-17" tabindex="-1"></a>fc <span class="ot">&lt;&lt;-</span> forecast<span class="sc">::</span><span class="fu">forecast</span>(m_auto, <span class="at">h =</span> h)</span>
<span id="cb94-18"><a href="Modelización.html#cb94-18" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">autoplot</span>(fc) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Pronóstico SARIMA (&quot;</span>, h_days, <span class="st">&quot; días)&quot;</span>),</span>
<span id="cb94-19"><a href="Modelización.html#cb94-19" tabindex="-1"></a><span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia&quot;</span>))</span>
<span id="cb94-20"><a href="Modelización.html#cb94-20" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Series: y_fit 
## ARIMA(1,1,1)(2,0,1)[24] with drift 
## 
## Coefficients:
##          ar1      ma1    sar1    sar2     sma1   drift
##       0.3106  -0.2732  0.5660  0.1735  -0.5697  0.0069
## s.e.  0.0315   0.0319  0.0197  0.0047   0.0205  0.2816
## 
## sigma^2 = 3105:  log likelihood = -645389
## AIC=1290792   AICc=1290792   BIC=1290860</code></pre>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-46-1.png" width="960" /></p>
<div id="zoom-al-pronóstico-del-modelo-eficiente-auto.arima" class="section level4 hasAnchor" number="5.2.7.1">
<h4><span class="header-section-number">5.2.7.1</span> Zoom al pronóstico del modelo eficiente (auto.arima)<a href="Modelización.html#zoom-al-pron%C3%B3stico-del-modelo-eficiente-auto.arima" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="Modelización.html#cb96-1" tabindex="-1"></a><span class="co"># ==== ZOOM FINAL AL PRONÓSTICO ====</span></span>
<span id="cb96-2"><a href="Modelización.html#cb96-2" tabindex="-1"></a></span>
<span id="cb96-3"><a href="Modelización.html#cb96-3" tabindex="-1"></a>history_days <span class="ot">&lt;-</span> <span class="dv">21</span></span>
<span id="cb96-4"><a href="Modelización.html#cb96-4" tabindex="-1"></a>h_days       <span class="ot">&lt;-</span> horizon_days <span class="sc">%||%</span> <span class="dv">7</span></span>
<span id="cb96-5"><a href="Modelización.html#cb96-5" tabindex="-1"></a></span>
<span id="cb96-6"><a href="Modelización.html#cb96-6" tabindex="-1"></a>hist_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb96-7"><a href="Modelización.html#cb96-7" tabindex="-1"></a>  <span class="at">time =</span> <span class="fu">as.POSIXct</span>(df_impu[[time_col]], <span class="at">tz =</span> TZ),</span>
<span id="cb96-8"><a href="Modelización.html#cb96-8" tabindex="-1"></a>  <span class="at">y    =</span> <span class="fu">as.numeric</span>(df_impu<span class="sc">$</span>val_impu)</span>
<span id="cb96-9"><a href="Modelización.html#cb96-9" tabindex="-1"></a>)</span>
<span id="cb96-10"><a href="Modelización.html#cb96-10" tabindex="-1"></a>t_max <span class="ot">&lt;-</span> <span class="fu">max</span>(hist_df<span class="sc">$</span>time, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb96-11"><a href="Modelización.html#cb96-11" tabindex="-1"></a></span>
<span id="cb96-12"><a href="Modelización.html#cb96-12" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="fu">length</span>(fc<span class="sc">$</span>mean)</span>
<span id="cb96-13"><a href="Modelización.html#cb96-13" tabindex="-1"></a>f_times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> t_max <span class="sc">+</span> <span class="fu">hours</span>(<span class="dv">1</span>), <span class="at">by =</span> <span class="st">&quot;1 hour&quot;</span>, <span class="at">length.out =</span> h)</span>
<span id="cb96-14"><a href="Modelización.html#cb96-14" tabindex="-1"></a></span>
<span id="cb96-15"><a href="Modelización.html#cb96-15" tabindex="-1"></a>fc_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb96-16"><a href="Modelización.html#cb96-16" tabindex="-1"></a>  <span class="at">time  =</span> f_times,</span>
<span id="cb96-17"><a href="Modelización.html#cb96-17" tabindex="-1"></a>  <span class="at">mean  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>mean),</span>
<span id="cb96-18"><a href="Modelización.html#cb96-18" tabindex="-1"></a>  <span class="at">lo80  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>lower[,<span class="st">&quot;80%&quot;</span>]),</span>
<span id="cb96-19"><a href="Modelización.html#cb96-19" tabindex="-1"></a>  <span class="at">hi80  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>upper[,<span class="st">&quot;80%&quot;</span>]),</span>
<span id="cb96-20"><a href="Modelización.html#cb96-20" tabindex="-1"></a>  <span class="at">lo95  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>lower[,<span class="st">&quot;95%&quot;</span>]),</span>
<span id="cb96-21"><a href="Modelización.html#cb96-21" tabindex="-1"></a>  <span class="at">hi95  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>upper[,<span class="st">&quot;95%&quot;</span>])</span>
<span id="cb96-22"><a href="Modelización.html#cb96-22" tabindex="-1"></a>)</span>
<span id="cb96-23"><a href="Modelización.html#cb96-23" tabindex="-1"></a></span>
<span id="cb96-24"><a href="Modelización.html#cb96-24" tabindex="-1"></a>t_ini <span class="ot">&lt;-</span> t_max <span class="sc">-</span> <span class="fu">days</span>(history_days)</span>
<span id="cb96-25"><a href="Modelización.html#cb96-25" tabindex="-1"></a>t_fin <span class="ot">&lt;-</span> <span class="fu">max</span>(fc_df<span class="sc">$</span>time)</span>
<span id="cb96-26"><a href="Modelización.html#cb96-26" tabindex="-1"></a></span>
<span id="cb96-27"><a href="Modelización.html#cb96-27" tabindex="-1"></a>hist_zoom <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(hist_df, time <span class="sc">&gt;=</span> t_ini)</span>
<span id="cb96-28"><a href="Modelización.html#cb96-28" tabindex="-1"></a></span>
<span id="cb96-29"><a href="Modelización.html#cb96-29" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb96-30"><a href="Modelización.html#cb96-30" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> fc_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">ymin =</span> lo95, <span class="at">ymax =</span> hi95),</span>
<span id="cb96-31"><a href="Modelización.html#cb96-31" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.15</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb96-32"><a href="Modelización.html#cb96-32" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> fc_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">ymin =</span> lo80, <span class="at">ymax =</span> hi80),</span>
<span id="cb96-33"><a href="Modelización.html#cb96-33" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb96-34"><a href="Modelización.html#cb96-34" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> fc_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mean),</span>
<span id="cb96-35"><a href="Modelización.html#cb96-35" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">linewidth =</span> <span class="fl">1.0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb96-36"><a href="Modelización.html#cb96-36" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> hist_zoom, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> y),</span>
<span id="cb96-37"><a href="Modelización.html#cb96-37" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&quot;grey40&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.4</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb96-38"><a href="Modelización.html#cb96-38" tabindex="-1"></a>  <span class="fu">scale_x_datetime</span>(<span class="at">limits =</span> <span class="fu">c</span>(t_ini, t_fin),</span>
<span id="cb96-39"><a href="Modelización.html#cb96-39" tabindex="-1"></a>                   <span class="at">date_breaks =</span> <span class="st">&quot;3 days&quot;</span>,  <span class="co"># ← espaciado más grande</span></span>
<span id="cb96-40"><a href="Modelización.html#cb96-40" tabindex="-1"></a>                   <span class="at">date_labels =</span> <span class="st">&quot;%d-%b&quot;</span>) <span class="sc">+</span>  <span class="co"># ← formato sin hora</span></span>
<span id="cb96-41"><a href="Modelización.html#cb96-41" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2000</span>)) <span class="sc">+</span>  <span class="co"># recorta sin descartar filas</span></span>
<span id="cb96-42"><a href="Modelización.html#cb96-42" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Pronóstico SARIMA (&quot;</span>, h_days, <span class="st">&quot; días)&quot;</span>),</span>
<span id="cb96-43"><a href="Modelización.html#cb96-43" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Últimos &quot;</span>, history_days, <span class="st">&quot; días de historia + predicción&quot;</span>),</span>
<span id="cb96-44"><a href="Modelización.html#cb96-44" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia&quot;</span>) <span class="sc">+</span></span>
<span id="cb96-45"><a href="Modelización.html#cb96-45" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb96-46"><a href="Modelización.html#cb96-46" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb96-47"><a href="Modelización.html#cb96-47" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb96-48"><a href="Modelización.html#cb96-48" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb96-49"><a href="Modelización.html#cb96-49" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)  <span class="co"># ← evita solapamiento</span></span>
<span id="cb96-50"><a href="Modelización.html#cb96-50" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-47-1.png" width="960" /></p>
<ul>
<li><p>El modelo captura una estructura diaria muy fuerte y una persistencia corta; la tendencia ya fue removida con d = 1; el “drift” es irrelevante.</p></li>
<li><p>En la gráfica general el pronóstico es casi invisible por el rango y la alta variabilidad histórica (picos/outliers).</p></li>
<li><p>En la gráfica de pronóstico, la línea azul se mantiene alrededor de 850–950 (un nivel cercano al observado justo antes del corte), con ondulación diaria y ciclos de 24 h.</p></li>
<li><p>El SARIMA escogido capta el patrón diario y da una proyección estable a 7 días, pero la incertidumbre es alta por la variabilidad de la serie.</p></li>
<li><p>Las bandas amplias avisan que, en escala original, la serie es muy heterocedástica y contiene outliers.</p></li>
</ul>
</div>
</div>
<div id="puntos-de-cambio-y-visualización-1" class="section level3 hasAnchor" number="5.2.8">
<h3><span class="header-section-number">5.2.8</span> Puntos de cambio y visualización<a href="Modelización.html#puntos-de-cambio-y-visualizaci%C3%B3n-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="Modelización.html#cb97-1" tabindex="-1"></a>daily <span class="ot">&lt;-</span> df_impu <span class="sc">%&gt;%</span></span>
<span id="cb97-2"><a href="Modelización.html#cb97-2" tabindex="-1"></a><span class="fu">mutate</span>(<span class="at">day =</span> <span class="fu">floor_date</span>(.data[[time_col]], <span class="st">&quot;day&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb97-3"><a href="Modelización.html#cb97-3" tabindex="-1"></a><span class="fu">group_by</span>(day) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">y =</span> <span class="fu">mean</span>(val_impu), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>)</span>
<span id="cb97-4"><a href="Modelización.html#cb97-4" tabindex="-1"></a></span>
<span id="cb97-5"><a href="Modelización.html#cb97-5" tabindex="-1"></a><span class="fu">tm</span>(<span class="st">&quot;Changepoint&quot;</span>, {</span>
<span id="cb97-6"><a href="Modelización.html#cb97-6" tabindex="-1"></a>cp <span class="ot">&lt;&lt;-</span> <span class="fu">cpt.mean</span>(daily<span class="sc">$</span>y, <span class="at">method =</span> <span class="st">&quot;PELT&quot;</span>, <span class="at">penalty =</span> <span class="st">&quot;SIC&quot;</span>)</span>
<span id="cb97-7"><a href="Modelización.html#cb97-7" tabindex="-1"></a>})</span>
<span id="cb97-8"><a href="Modelización.html#cb97-8" tabindex="-1"></a><span class="fu">head</span> (cp<span class="sc">@</span>cpts,<span class="dv">100</span>)  <span class="co"># índices de cambio</span></span></code></pre></div>
<pre><code>##   [1]  29  30  31  33  34  35  36  37  38  39  40  41  42  43  44  45  46  47
##  [19]  48  49  50  51  52  53  54  55  57  58  59  60  61  62  63  64  66  67
##  [37]  68  69  70  71  72  73  74  75  76  77  79  80  81  82  83  84  85  86
##  [55]  87  88  89  90  91  92  93  94  95  97  98  99 100 101 102 103 104 105
##  [73] 106 107 109 110 111 112 113 114 115 116 117 118 119 120 121 123 124 125
##  [91] 126 127 128 129 130 131 132 134 136 137</code></pre>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="Modelización.html#cb99-1" tabindex="-1"></a><span class="co"># Overlay en la curva diaria</span></span>
<span id="cb99-2"><a href="Modelización.html#cb99-2" tabindex="-1"></a></span>
<span id="cb99-3"><a href="Modelización.html#cb99-3" tabindex="-1"></a><span class="fu">ggplot</span>(daily, <span class="fu">aes</span>(day, y)) <span class="sc">+</span></span>
<span id="cb99-4"><a href="Modelización.html#cb99-4" tabindex="-1"></a><span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb99-5"><a href="Modelización.html#cb99-5" tabindex="-1"></a><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> daily<span class="sc">$</span>day[cp<span class="sc">@</span>cpts], <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb99-6"><a href="Modelización.html#cb99-6" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Media diaria con puntos de cambio (cpt.mean)&quot;</span>,</span>
<span id="cb99-7"><a href="Modelización.html#cb99-7" tabindex="-1"></a><span class="at">x =</span> <span class="st">&quot;Día&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia media diaria&quot;</span>) <span class="sc">+</span></span>
<span id="cb99-8"><a href="Modelización.html#cb99-8" tabindex="-1"></a><span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-48-1.png" width="960" /></p>
<ul>
<li><p>Líneas rojas horizontales indican los puntos de cambio detectados en la media de la serie. Cada uno de ellos marca un momento en el que el nivel promedio de la potencia cambió de manera estadísticamente significativa.</p></li>
<li><p>Se observa en la gráfica:</p>
<ul>
<li><p>Alta frecuencia de puntos de cambio (bandas rojas), sugiriendo que la serie es altamente inestable o no estacionaria a lo largo del tiempo.</p></li>
<li><p>Cambios localizados por períodos, entre 2018 y 2020, la serie muestra mayor variabilidad y frecuentes saltos reflejando volátilidad o errores de registro. Entre 2021 y 2024, los cambios son menos abruptos, aunque todavía se observan alteraciones cíclicas en los promedios diarios. Entre 2024–2025, la media parece estabilizarse en un rango más constante, pero aún con picos esporádicos (outliers).</p></li>
<li><p>La media diaria parece mostrar una tendencia leve al alza, con algunos descensos temporales; los puntos de cambio ayudan a identificar momentos clave donde la serie cambió de nivel promedio.</p></li>
</ul></li>
<li><p>La gráfica evidencia que la potencia media diaria ha experimentado múltiples rupturas estructurales en su comportamiento a lo largo de los años. Estas discontinuidades confirman que la serie no es estacionaria en media y requiere preprocesamiento o modelado segmentado.</p></li>
</ul>
</div>
<div id="outliers-y-verificación-de-supuestos-del-arima-1" class="section level3 hasAnchor" number="5.2.9">
<h3><span class="header-section-number">5.2.9</span> Outliers y verificación de supuestos del ARIMA<a href="Modelización.html#outliers-y-verificaci%C3%B3n-de-supuestos-del-arima-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="Modelización.html#cb100-1" tabindex="-1"></a><span class="co"># Outliers</span></span>
<span id="cb100-2"><a href="Modelización.html#cb100-2" tabindex="-1"></a></span>
<span id="cb100-3"><a href="Modelización.html#cb100-3" tabindex="-1"></a>to <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(forecast<span class="sc">::</span><span class="fu">tsoutliers</span>(<span class="fu">ts</span>(serie_vec, <span class="at">frequency =</span> <span class="dv">24</span>)), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb100-4"><a href="Modelización.html#cb100-4" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(to)) {</span>
<span id="cb100-5"><a href="Modelización.html#cb100-5" tabindex="-1"></a><span class="co">#print(to)</span></span>
<span id="cb100-6"><a href="Modelización.html#cb100-6" tabindex="-1"></a>idx <span class="ot">&lt;-</span> to<span class="sc">$</span>index</span>
<span id="cb100-7"><a href="Modelización.html#cb100-7" tabindex="-1"></a>df_ol <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">time =</span> <span class="fu">as.POSIXct</span>(df_impu[[time_col]])[idx],</span>
<span id="cb100-8"><a href="Modelización.html#cb100-8" tabindex="-1"></a><span class="at">y =</span> serie_vec[idx])</span>
<span id="cb100-9"><a href="Modelización.html#cb100-9" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">time =</span> <span class="fu">as.POSIXct</span>(df_impu[[time_col]]), <span class="at">y =</span> serie_vec), <span class="fu">aes</span>(time, y)) <span class="sc">+</span></span>
<span id="cb100-10"><a href="Modelización.html#cb100-10" tabindex="-1"></a><span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb100-11"><a href="Modelización.html#cb100-11" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="at">data =</span> df_ol, <span class="fu">aes</span>(time, y), <span class="at">color =</span> <span class="st">&quot;red&quot;</span>, <span class="at">size =</span> <span class="fl">1.4</span>) <span class="sc">+</span></span>
<span id="cb100-12"><a href="Modelización.html#cb100-12" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Outliers detectados (forecast::tsoutliers)&quot;</span>,</span>
<span id="cb100-13"><a href="Modelización.html#cb100-13" tabindex="-1"></a><span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia&quot;</span>) <span class="sc">+</span></span>
<span id="cb100-14"><a href="Modelización.html#cb100-14" tabindex="-1"></a><span class="fu">theme_minimal</span>()</span>
<span id="cb100-15"><a href="Modelización.html#cb100-15" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-49-1.png" width="960" /></p>
<ul>
<li>La gráfica revela que la serie de potencia presenta numerosos valores atípicos, distribuidos a lo largo de todo el periodo y de ambos signos. Esto confirma que la serie es altamente irregular y heterocedástica, por lo que requiere una etapa robusta de limpieza y preprocesamiento antes de aplicar cualquier modelo predictivo.</li>
</ul>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="Modelización.html#cb101-1" tabindex="-1"></a><span class="co"># Supuestos del modelo ARIMA (residuales)</span></span>
<span id="cb101-2"><a href="Modelización.html#cb101-2" tabindex="-1"></a></span>
<span id="cb101-3"><a href="Modelización.html#cb101-3" tabindex="-1"></a><span class="fu">checkresiduals</span>(m_auto)   <span class="co"># ACF de residuales, Ljung-Box, histograma, qq-plot</span></span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-50-1.png" width="960" /></p>
<pre><code>## 
##  Ljung-Box test
## 
## data:  Residuals from ARIMA(1,1,1)(2,0,1)[24] with drift
## Q* = 4269.1, df = 43, p-value &lt; 2.2e-16
## 
## Model df: 5.   Total lags used: 48</code></pre>
<p><strong><em>Ljung-Box test</em></strong></p>
<ul>
<li>p-value &lt; 2.2e-16, se rechaza H₀ (los residuos son ruido blanco), los residuos aún tienen correlación significativa.</li>
</ul>
<p><strong><em>Diagnósticos residuales del modelo ARIMA</em></strong></p>
<p>Los residuos oscilan alrededor de 0, sin embargo, hay picos grandes (±2000), lo que sugiere valores atípicos o episodios de alta volatilidad no explicados por el modelo. La amplitud es variable (heterocedasticidad leve).</p>
<ul>
<li><p><strong>ACF (Función de Autocorrelación de los residuos)</strong>, los residuos aún presentan correlación, el modelo no captura por completo la estructura temporal. Las barras deben estar dentro de las bandas azules.</p></li>
<li><p><strong>Histograma y densidad de los residuos</strong>, es muy concentrado en torno a 0, pero con colas largas y picos extremos, indicando distribución leptocúrtica (no normal).</p></li>
<li><p>Los residuos no son normales, lo que afecta la validez de los intervalos de predicción si se asume normalidad.</p></li>
<li><p>El modelo no cumple totalmente los supuestos de ruido blanco, aunque capta bien la tendencia general, persisten correlaciones estacionales y algunos outliers o periodos anómalos.</p></li>
</ul>
</div>
<div id="transformación-logarítmica-para-estabilizar-la-varianza-1" class="section level3 hasAnchor" number="5.2.10">
<h3><span class="header-section-number">5.2.10</span> Transformación logarítmica para estabilizar la varianza<a href="Modelización.html#transformaci%C3%B3n-logar%C3%ADtmica-para-estabilizar-la-varianza-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="Modelización.html#cb103-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb103-2"><a href="Modelización.html#cb103-2" tabindex="-1"></a><span class="co"># Transformación logarítmica de la serie de potencia</span></span>
<span id="cb103-3"><a href="Modelización.html#cb103-3" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb103-4"><a href="Modelización.html#cb103-4" tabindex="-1"></a></span>
<span id="cb103-5"><a href="Modelización.html#cb103-5" tabindex="-1"></a><span class="co"># Evitar log(0) o negativos</span></span>
<span id="cb103-6"><a href="Modelización.html#cb103-6" tabindex="-1"></a>df_log <span class="ot">&lt;-</span> df_impu <span class="sc">%&gt;%</span></span>
<span id="cb103-7"><a href="Modelización.html#cb103-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">val_log =</span> <span class="fu">log1p</span>(val_impu))  <span class="co"># log(1 + x) evita infinitos</span></span>
<span id="cb103-8"><a href="Modelización.html#cb103-8" tabindex="-1"></a></span>
<span id="cb103-9"><a href="Modelización.html#cb103-9" tabindex="-1"></a><span class="co"># Crear serie temporal log-transformada</span></span>
<span id="cb103-10"><a href="Modelización.html#cb103-10" tabindex="-1"></a>ts_log <span class="ot">&lt;-</span> <span class="fu">ts</span>(df_log<span class="sc">$</span>val_log, <span class="at">frequency =</span> <span class="dv">24</span>)  <span class="co"># frecuencia diaria (24 horas)</span></span>
<span id="cb103-11"><a href="Modelización.html#cb103-11" tabindex="-1"></a></span>
<span id="cb103-12"><a href="Modelización.html#cb103-12" tabindex="-1"></a><span class="co"># Visualización básica</span></span>
<span id="cb103-13"><a href="Modelización.html#cb103-13" tabindex="-1"></a><span class="fu">autoplot</span>(ts_log) <span class="sc">+</span></span>
<span id="cb103-14"><a href="Modelización.html#cb103-14" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Serie transformada logarítmicamente (log1p)&quot;</span>,</span>
<span id="cb103-15"><a href="Modelización.html#cb103-15" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;log(1 + Potencia)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>) <span class="sc">+</span></span>
<span id="cb103-16"><a href="Modelización.html#cb103-16" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-51-1.png" width="960" /></p>
<ul>
<li><p>La transformación logarítmica logró reducir la variabilidad y estabilizar la escala de la serie, mejorando su comportamiento estadístico. Sin embargo, persisten caídas bruscas que deben tratarse (por imputación o filtrado).</p></li>
<li><p>La serie transformada es más regular y apta para modelado estadístico, pero sigue reflejando irregularidades de medición o interrupciones que conviene revisar antes de la predicción final.</p></li>
<li><p>La serie log-transformada presenta una varianza más controlada, conserva la estructura temporal esencial y mitiga la influencia de outliers.</p></li>
</ul>
</div>
<div id="ajuste-del-modelo-arima-en-escala-logarítmica-1" class="section level3 hasAnchor" number="5.2.11">
<h3><span class="header-section-number">5.2.11</span> Ajuste del modelo ARIMA en escala logarítmica<a href="Modelización.html#ajuste-del-modelo-arima-en-escala-logar%C3%ADtmica-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="Modelización.html#cb104-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb104-2"><a href="Modelización.html#cb104-2" tabindex="-1"></a><span class="co"># Ajuste automático ARIMA sobre serie log-transformada</span></span>
<span id="cb104-3"><a href="Modelización.html#cb104-3" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb104-4"><a href="Modelización.html#cb104-4" tabindex="-1"></a><span class="fu">tm</span>(<span class="st">&quot;Ajuste SARIMA TS log-transformada&quot;</span>, {</span>
<span id="cb104-5"><a href="Modelización.html#cb104-5" tabindex="-1"></a></span>
<span id="cb104-6"><a href="Modelización.html#cb104-6" tabindex="-1"></a>m_log <span class="ot">&lt;&lt;-</span> <span class="fu">auto.arima</span>(ts_log,</span>
<span id="cb104-7"><a href="Modelización.html#cb104-7" tabindex="-1"></a>                    <span class="at">seasonal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb104-8"><a href="Modelización.html#cb104-8" tabindex="-1"></a>                    <span class="at">stepwise =</span> <span class="cn">FALSE</span>,</span>
<span id="cb104-9"><a href="Modelización.html#cb104-9" tabindex="-1"></a>                    <span class="at">approximation =</span> arima_approx,</span>
<span id="cb104-10"><a href="Modelización.html#cb104-10" tabindex="-1"></a>                    <span class="at">trace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb104-11"><a href="Modelización.html#cb104-11" tabindex="-1"></a><span class="fu">summary</span>(m_log)</span>
<span id="cb104-12"><a href="Modelización.html#cb104-12" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## 
##  Fitting models using approximations to speed things up...
## 
##  ARIMA(0,1,0)                               : -24007.62
##  ARIMA(0,1,0)            with drift         : -24005.63
##  ARIMA(0,1,0)(0,0,1)[24]                    : -24049.82
##  ARIMA(0,1,0)(0,0,1)[24] with drift         : -24047.82
##  ARIMA(0,1,0)(0,0,2)[24]                    : -24115.74
##  ARIMA(0,1,0)(0,0,2)[24] with drift         : -24113.74
##  ARIMA(0,1,0)(1,0,0)[24]                    : -24027.94
##  ARIMA(0,1,0)(1,0,0)[24] with drift         : -24025.95
##  ARIMA(0,1,0)(1,0,1)[24]                    : Inf
##  ARIMA(0,1,0)(1,0,1)[24] with drift         : Inf
##  ARIMA(0,1,0)(1,0,2)[24]                    : Inf
##  ARIMA(0,1,0)(1,0,2)[24] with drift         : Inf
##  ARIMA(0,1,0)(2,0,0)[24]                    : -24068.68
##  ARIMA(0,1,0)(2,0,0)[24] with drift         : -24066.69
##  ARIMA(0,1,0)(2,0,1)[24]                    : Inf
##  ARIMA(0,1,0)(2,0,1)[24] with drift         : Inf
##  ARIMA(0,1,0)(2,0,2)[24]                    : Inf
##  ARIMA(0,1,0)(2,0,2)[24] with drift         : Inf
##  ARIMA(0,1,1)                               : -24077
##  ARIMA(0,1,1)            with drift         : -24075.01
##  ARIMA(0,1,1)(0,0,1)[24]                    : -24120.59
##  ARIMA(0,1,1)(0,0,1)[24] with drift         : -24118.6
##  ARIMA(0,1,1)(0,0,2)[24]                    : -24185.2
##  ARIMA(0,1,1)(0,0,2)[24] with drift         : -24183.21
##  ARIMA(0,1,1)(1,0,0)[24]                    : -24098.76
##  ARIMA(0,1,1)(1,0,0)[24] with drift         : -24096.77
##  ARIMA(0,1,1)(1,0,1)[24]                    : Inf
##  ARIMA(0,1,1)(1,0,1)[24] with drift         : Inf
##  ARIMA(0,1,1)(1,0,2)[24]                    : Inf
##  ARIMA(0,1,1)(1,0,2)[24] with drift         : Inf
##  ARIMA(0,1,1)(2,0,0)[24]                    : -24138.11
##  ARIMA(0,1,1)(2,0,0)[24] with drift         : -24136.12
##  ARIMA(0,1,1)(2,0,1)[24]                    : Inf
##  ARIMA(0,1,1)(2,0,1)[24] with drift         : Inf
##  ARIMA(0,1,1)(2,0,2)[24]                    : Inf
##  ARIMA(0,1,1)(2,0,2)[24] with drift         : Inf
##  ARIMA(0,1,2)                               : -24111
##  ARIMA(0,1,2)            with drift         : -24109
##  ARIMA(0,1,2)(0,0,1)[24]                    : -24157.22
##  ARIMA(0,1,2)(0,0,1)[24] with drift         : -24155.23
##  ARIMA(0,1,2)(0,0,2)[24]                    : -24225.37
##  ARIMA(0,1,2)(0,0,2)[24] with drift         : -24223.37
##  ARIMA(0,1,2)(1,0,0)[24]                    : -24135.58
##  ARIMA(0,1,2)(1,0,0)[24] with drift         : -24133.59
##  ARIMA(0,1,2)(1,0,1)[24]                    : Inf
##  ARIMA(0,1,2)(1,0,1)[24] with drift         : Inf
##  ARIMA(0,1,2)(1,0,2)[24]                    : Inf
##  ARIMA(0,1,2)(1,0,2)[24] with drift         : Inf
##  ARIMA(0,1,2)(2,0,0)[24]                    : -24178.38
##  ARIMA(0,1,2)(2,0,0)[24] with drift         : -24176.39
##  ARIMA(0,1,2)(2,0,1)[24]                    : Inf
##  ARIMA(0,1,2)(2,0,1)[24] with drift         : Inf
##  ARIMA(0,1,3)                               : -24243.98
##  ARIMA(0,1,3)            with drift         : -24241.99
##  ARIMA(0,1,3)(0,0,1)[24]                    : -24290.47
##  ARIMA(0,1,3)(0,0,1)[24] with drift         : -24288.48
##  ARIMA(0,1,3)(0,0,2)[24]                    : -24358.36
##  ARIMA(0,1,3)(0,0,2)[24] with drift         : -24356.37
##  ARIMA(0,1,3)(1,0,0)[24]                    : -24268.83
##  ARIMA(0,1,3)(1,0,0)[24] with drift         : -24266.84
##  ARIMA(0,1,3)(1,0,1)[24]                    : Inf
##  ARIMA(0,1,3)(1,0,1)[24] with drift         : Inf
##  ARIMA(0,1,3)(2,0,0)[24]                    : -24311.37
##  ARIMA(0,1,3)(2,0,0)[24] with drift         : -24309.38
##  ARIMA(0,1,4)                               : -24977.57
##  ARIMA(0,1,4)            with drift         : -24975.58
##  ARIMA(0,1,4)(0,0,1)[24]                    : -25041.9
##  ARIMA(0,1,4)(0,0,1)[24] with drift         : -25039.92
##  ARIMA(0,1,4)(1,0,0)[24]                    : -25021.29
##  ARIMA(0,1,4)(1,0,0)[24] with drift         : -25019.3
##  ARIMA(0,1,5)                               : -25118.13
##  ARIMA(0,1,5)            with drift         : -25116.14
##  ARIMA(1,1,0)                               : -24073.54
##  ARIMA(1,1,0)            with drift         : -24071.55
##  ARIMA(1,1,0)(0,0,1)[24]                    : -24117.01
##  ARIMA(1,1,0)(0,0,1)[24] with drift         : -24115.01
##  ARIMA(1,1,0)(0,0,2)[24]                    : -24181.56
##  ARIMA(1,1,0)(0,0,2)[24] with drift         : -24179.57
##  ARIMA(1,1,0)(1,0,0)[24]                    : -24095.17
##  ARIMA(1,1,0)(1,0,0)[24] with drift         : -24093.18
##  ARIMA(1,1,0)(1,0,1)[24]                    : Inf
##  ARIMA(1,1,0)(1,0,1)[24] with drift         : Inf
##  ARIMA(1,1,0)(1,0,2)[24]                    : Inf
##  ARIMA(1,1,0)(1,0,2)[24] with drift         : Inf
##  ARIMA(1,1,0)(2,0,0)[24]                    : -24134.47
##  ARIMA(1,1,0)(2,0,0)[24] with drift         : -24132.48
##  ARIMA(1,1,0)(2,0,1)[24]                    : Inf
##  ARIMA(1,1,0)(2,0,1)[24] with drift         : Inf
##  ARIMA(1,1,0)(2,0,2)[24]                    : Inf
##  ARIMA(1,1,0)(2,0,2)[24] with drift         : Inf
##  ARIMA(1,1,1)                               : -24087.78
##  ARIMA(1,1,1)            with drift         : -24338.51
##  ARIMA(1,1,1)(0,0,1)[24]                    : -24131.77
##  ARIMA(1,1,1)(0,0,1)[24] with drift         : -24369.11
##  ARIMA(1,1,1)(0,0,2)[24]                    : -24441.8
##  ARIMA(1,1,1)(0,0,2)[24] with drift         : -24439.81
##  ARIMA(1,1,1)(1,0,0)[24]                    : -24348.78
##  ARIMA(1,1,1)(1,0,0)[24] with drift         : -24107.14
##  ARIMA(1,1,1)(1,0,1)[24]                    : Inf
##  ARIMA(1,1,1)(1,0,1)[24] with drift         : Inf
##  ARIMA(1,1,1)(1,0,2)[24]                    : Inf
##  ARIMA(1,1,1)(1,0,2)[24] with drift         : Inf
##  ARIMA(1,1,1)(2,0,0)[24]                    : -24395.2
##  ARIMA(1,1,1)(2,0,0)[24] with drift         : -24393.21
##  ARIMA(1,1,1)(2,0,1)[24]                    : Inf
##  ARIMA(1,1,1)(2,0,1)[24] with drift         : Inf
##  ARIMA(1,1,2)                               : -27833.16
##  ARIMA(1,1,2)            with drift         : -27831.51
##  ARIMA(1,1,2)(0,0,1)[24]                    : -27855.34
##  ARIMA(1,1,2)(0,0,1)[24] with drift         : -27853.67
##  ARIMA(1,1,2)(0,0,2)[24]                    : -27931.72
##  ARIMA(1,1,2)(0,0,2)[24] with drift         : -27930.08
##  ARIMA(1,1,2)(1,0,0)[24]                    : -27832.62
##  ARIMA(1,1,2)(1,0,0)[24] with drift         : -27830.95
##  ARIMA(1,1,2)(1,0,1)[24]                    : Inf
##  ARIMA(1,1,2)(1,0,1)[24] with drift         : Inf
##  ARIMA(1,1,2)(2,0,0)[24]                    : -27885.64
##  ARIMA(1,1,2)(2,0,0)[24] with drift         : -27883.99
##  ARIMA(1,1,3)                               : -27930.89
##  ARIMA(1,1,3)            with drift         : -27929.2
##  ARIMA(1,1,3)(0,0,1)[24]                    : -27951.36
##  ARIMA(1,1,3)(0,0,1)[24] with drift         : -27950.19
##  ARIMA(1,1,3)(1,0,0)[24]                    : -27929.02
##  ARIMA(1,1,3)(1,0,0)[24] with drift         : -27927.34
##  ARIMA(1,1,4)                               : -27971.44
##  ARIMA(1,1,4)            with drift         : -27969.72
##  ARIMA(2,1,0)                               : -24110.19
##  ARIMA(2,1,0)            with drift         : -24108.2
##  ARIMA(2,1,0)(0,0,1)[24]                    : -24156.26
##  ARIMA(2,1,0)(0,0,1)[24] with drift         : -24154.27
##  ARIMA(2,1,0)(0,0,2)[24]                    : -24224.06
##  ARIMA(2,1,0)(0,0,2)[24] with drift         : -24222.07
##  ARIMA(2,1,0)(1,0,0)[24]                    : -24134.6
##  ARIMA(2,1,0)(1,0,0)[24] with drift         : -24132.61
##  ARIMA(2,1,0)(1,0,1)[24]                    : Inf
##  ARIMA(2,1,0)(1,0,1)[24] with drift         : Inf
##  ARIMA(2,1,0)(1,0,2)[24]                    : Inf
##  ARIMA(2,1,0)(1,0,2)[24] with drift         : Inf
##  ARIMA(2,1,0)(2,0,0)[24]                    : -24177.06
##  ARIMA(2,1,0)(2,0,0)[24] with drift         : -24175.07
##  ARIMA(2,1,0)(2,0,1)[24]                    : Inf
##  ARIMA(2,1,0)(2,0,1)[24] with drift         : Inf
##  ARIMA(2,1,1)                               : -27860.19
##  ARIMA(2,1,1)            with drift         : -27858.51
##  ARIMA(2,1,1)(0,0,1)[24]                    : -27882.52
##  ARIMA(2,1,1)(0,0,1)[24] with drift         : -27880.84
##  ARIMA(2,1,1)(0,0,2)[24]                    : -27957.02
##  ARIMA(2,1,1)(0,0,2)[24] with drift         : -27955.35
##  ARIMA(2,1,1)(1,0,0)[24]                    : -27859.79
##  ARIMA(2,1,1)(1,0,0)[24] with drift         : -27858.11
##  ARIMA(2,1,1)(1,0,1)[24]                    : Inf
##  ARIMA(2,1,1)(1,0,1)[24] with drift         : Inf
##  ARIMA(2,1,1)(2,0,0)[24]                    : -27910.86
##  ARIMA(2,1,1)(2,0,0)[24] with drift         : -27909.2
##  ARIMA(2,1,2)                               : Inf
##  ARIMA(2,1,2)            with drift         : Inf
##  ARIMA(2,1,2)(0,0,1)[24]                    : -27959.77
##  ARIMA(2,1,2)(0,0,1)[24] with drift         : -27957.64
##  ARIMA(2,1,2)(1,0,0)[24]                    : -27936.99
##  ARIMA(2,1,2)(1,0,0)[24] with drift         : -27932.55
##  ARIMA(2,1,3)                               : -27941.17
##  ARIMA(2,1,3)            with drift         : -27942.36
##  ARIMA(3,1,0)                               : -24237.58
##  ARIMA(3,1,0)            with drift         : -24235.58
##  ARIMA(3,1,0)(0,0,1)[24]                    : -24283.51
##  ARIMA(3,1,0)(0,0,1)[24] with drift         : -24281.52
##  ARIMA(3,1,0)(0,0,2)[24]                    : -24350.28
##  ARIMA(3,1,0)(0,0,2)[24] with drift         : -24348.29
##  ARIMA(3,1,0)(1,0,0)[24]                    : -24261.83
##  ARIMA(3,1,0)(1,0,0)[24] with drift         : -24259.84
##  ARIMA(3,1,0)(1,0,1)[24]                    : Inf
##  ARIMA(3,1,0)(1,0,1)[24] with drift         : Inf
##  ARIMA(3,1,0)(2,0,0)[24]                    : -24303.26
##  ARIMA(3,1,0)(2,0,0)[24] with drift         : -24301.27
##  ARIMA(3,1,1)                               : -27938.18
##  ARIMA(3,1,1)            with drift         : -27936.48
##  ARIMA(3,1,1)(0,0,1)[24]                    : -27959.55
##  ARIMA(3,1,1)(0,0,1)[24] with drift         : -27957.84
##  ARIMA(3,1,1)(1,0,0)[24]                    : -27936.7
##  ARIMA(3,1,1)(1,0,0)[24] with drift         : -27934.99
##  ARIMA(3,1,2)                               : -27940.85
##  ARIMA(3,1,2)            with drift         : -27936.15
##  ARIMA(4,1,0)                               : -24785.01
##  ARIMA(4,1,0)            with drift         : -24783.02
##  ARIMA(4,1,0)(0,0,1)[24]                    : -24842.02
##  ARIMA(4,1,0)(0,0,1)[24] with drift         : -24840.03
##  ARIMA(4,1,0)(1,0,0)[24]                    : -24820.95
##  ARIMA(4,1,0)(1,0,0)[24] with drift         : -24818.96
##  ARIMA(4,1,1)                               : -27951.79
##  ARIMA(4,1,1)            with drift         : -27950.08
##  ARIMA(5,1,0)                               : -24836.46
##  ARIMA(5,1,0)            with drift         : -24834.47
## 
##  Now re-fitting the best model(s) without approximations...
## 
## 
## 
## 
##  Best model: ARIMA(1,1,4)</code></pre>
</div>
<div id="verificación-de-supuestos-del-nuevo-modelo-arima-en-escala-logarítmica" class="section level3 hasAnchor" number="5.2.12">
<h3><span class="header-section-number">5.2.12</span> Verificación de supuestos del nuevo modelo ARIMA en escala logarítmica<a href="Modelización.html#verificaci%C3%B3n-de-supuestos-del-nuevo-modelo-arima-en-escala-logar%C3%ADtmica" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="Modelización.html#cb106-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb106-2"><a href="Modelización.html#cb106-2" tabindex="-1"></a><span class="co"># Diagnóstico de los residuos del modelo ARIMA (log)</span></span>
<span id="cb106-3"><a href="Modelización.html#cb106-3" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb106-4"><a href="Modelización.html#cb106-4" tabindex="-1"></a></span>
<span id="cb106-5"><a href="Modelización.html#cb106-5" tabindex="-1"></a><span class="fu">checkresiduals</span>(m_log)</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-53-1.png" width="960" /></p>
<pre><code>## 
##  Ljung-Box test
## 
## data:  Residuals from ARIMA(1,1,4)
## Q* = 647.2, df = 43, p-value &lt; 2.2e-16
## 
## Model df: 5.   Total lags used: 48</code></pre>
<p><strong><em>Ljung-Box test</em></strong></p>
<ul>
<li>El p-valor &lt; 0.05, se rechaza la hipótesis nula (los residuos no son completamente ruido blanco). Esto sugiere que el modelo no captura toda la dinámica temporal, aún quedan patrones correlacionados sin explicar.</li>
</ul>
<p><strong><em>Diagnósticos residuales del modelo ARIMA</em></strong></p>
<ul>
<li><p>En el gráfico de residuales los residuos oscilan alrededor de cero, lo que es esperable para un modelo bien ajustado. Sin embargo, se observan picos frecuentes (positivos y negativos) que indican fluctuaciones abruptas en la varianza o la presencia de valores atípicos. Hay periodos donde la variabilidad de los residuos aumenta, lo que sugiere heterocedasticidad (la varianza no es constante en el tiempo).</p></li>
<li><p>El modelo logra eliminar la tendencia, pero no estabiliza completamente la varianza; aún hay ruido estructurado.</p></li>
<li><p>En el gráfico de ACF de los residuos la mayoría de los rezagos se mantienen dentro de las bandas azules de confianza, lo cual indica autocorrelación residual débil o casi nula. Sin embargo, algunos picos (alrededor de los rezagos 24 y 48) exceden ligeramente las bandas, lo que sugiere que todavía puede haber estructura estacional residual leve o dependencias menores no capturadas.</p></li>
<li><p>El modelo ARIMA(1,1,4) mejora la independencia de los residuos respecto a modelos anteriores, pero no elimina completamente la autocorrelación.</p></li>
<li><p>En el gráfico de densidad de residuos la forma general es centrada en cero. Sin embargo, se observan colas delgadas pero extendidas, lo que sugiere no normalidad. El pico muy concentrado en torno a 0 confirma que los errores pequeños son frecuentes, pero los grandes (positivos o negativos) aún aparecen ocasionalmente.</p></li>
<li><p>En general, se cumple parcialmente la normalidad, aunque la serie sigue afectada por outliers o por una distribución más leptocúrtica que la normal.</p></li>
<li><p>El modelo ARIMA(1,1,4) representa una mejora respecto a versiones más simples (captura parcialmente la dinámica temporal), pero aún no cumple plenamente los supuestos de ruido blanco y homocedasticidad.</p></li>
</ul>
</div>
<div id="pronóstico-con-el-modelo-mejorado-escala-logarítmica-1" class="section level3 hasAnchor" number="5.2.13">
<h3><span class="header-section-number">5.2.13</span> Pronóstico con el modelo mejorado (escala logarítmica)<a href="Modelización.html#pron%C3%B3stico-con-el-modelo-mejorado-escala-logar%C3%ADtmica-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="Modelización.html#cb108-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb108-2"><a href="Modelización.html#cb108-2" tabindex="-1"></a><span class="co"># Pronóstico en escala logarítmica</span></span>
<span id="cb108-3"><a href="Modelización.html#cb108-3" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb108-4"><a href="Modelización.html#cb108-4" tabindex="-1"></a></span>
<span id="cb108-5"><a href="Modelización.html#cb108-5" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">24</span> <span class="sc">*</span> horizon_days  <span class="co"># pronóstico a 7 días (horas)</span></span>
<span id="cb108-6"><a href="Modelización.html#cb108-6" tabindex="-1"></a></span>
<span id="cb108-7"><a href="Modelización.html#cb108-7" tabindex="-1"></a>fc_log <span class="ot">&lt;-</span> <span class="fu">forecast</span>(m_log, <span class="at">h =</span> h)</span>
<span id="cb108-8"><a href="Modelización.html#cb108-8" tabindex="-1"></a></span>
<span id="cb108-9"><a href="Modelización.html#cb108-9" tabindex="-1"></a><span class="fu">autoplot</span>(fc_log) <span class="sc">+</span></span>
<span id="cb108-10"><a href="Modelización.html#cb108-10" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Pronóstico log-transformado con ARIMA (&quot;</span>, horizon_days, <span class="st">&quot; días)&quot;</span>),</span>
<span id="cb108-11"><a href="Modelización.html#cb108-11" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;log(1 + Potencia)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>) <span class="sc">+</span></span>
<span id="cb108-12"><a href="Modelización.html#cb108-12" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-54-1.png" width="960" /></p>
<ul>
<li><p>Se observa que la mayor parte de la serie se mantiene entre valores logarítmicos de 6 a 7, pero hay muchas caídas bruscas hacia valores bajos (0–2). Esos saltos representan puntos donde la potencia real cayó casi a cero, y al aplicar la transformación logarítmica, visualmente se reducen las diferencias.</p></li>
<li><p>La serie sigue mostrando alta variabilidad y picos anómalos, aunque en menor medida que en la escala original. Esto sugiere que la varianza aún no está completamente estabilizada o que hay eventos atípicos muy fuertes.</p></li>
</ul>
<div id="reconversión-a-escala-original-exponencial-inversa-1" class="section level4 hasAnchor" number="5.2.13.1">
<h4><span class="header-section-number">5.2.13.1</span> Reconversión a escala original (exponencial inversa)<a href="Modelización.html#reconversi%C3%B3n-a-escala-original-exponencial-inversa-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="Modelización.html#cb109-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb109-2"><a href="Modelización.html#cb109-2" tabindex="-1"></a><span class="co"># Transformar el pronóstico a escala original</span></span>
<span id="cb109-3"><a href="Modelización.html#cb109-3" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb109-4"><a href="Modelización.html#cb109-4" tabindex="-1"></a></span>
<span id="cb109-5"><a href="Modelización.html#cb109-5" tabindex="-1"></a>fc_exp <span class="ot">&lt;-</span> <span class="fu">expm1</span>(fc_log<span class="sc">$</span>mean)  <span class="co"># inversa de log1p</span></span>
<span id="cb109-6"><a href="Modelización.html#cb109-6" tabindex="-1"></a>fc_exp80 <span class="ot">&lt;-</span> <span class="fu">expm1</span>(fc_log<span class="sc">$</span>lower[,<span class="st">&quot;80%&quot;</span>])</span>
<span id="cb109-7"><a href="Modelización.html#cb109-7" tabindex="-1"></a>fc_exp95 <span class="ot">&lt;-</span> <span class="fu">expm1</span>(fc_log<span class="sc">$</span>upper[,<span class="st">&quot;95%&quot;</span>])</span>
<span id="cb109-8"><a href="Modelización.html#cb109-8" tabindex="-1"></a></span>
<span id="cb109-9"><a href="Modelización.html#cb109-9" tabindex="-1"></a><span class="co"># Crear data frame para visualización</span></span>
<span id="cb109-10"><a href="Modelización.html#cb109-10" tabindex="-1"></a>f_times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">max</span>(df_impu[[time_col]]) <span class="sc">+</span> lubridate<span class="sc">::</span><span class="fu">hours</span>(<span class="dv">1</span>),</span>
<span id="cb109-11"><a href="Modelización.html#cb109-11" tabindex="-1"></a>               <span class="at">by =</span> <span class="st">&quot;1 hour&quot;</span>, <span class="at">length.out =</span> h)</span>
<span id="cb109-12"><a href="Modelización.html#cb109-12" tabindex="-1"></a></span>
<span id="cb109-13"><a href="Modelización.html#cb109-13" tabindex="-1"></a>fc_plot <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb109-14"><a href="Modelización.html#cb109-14" tabindex="-1"></a>  <span class="at">time =</span> f_times,</span>
<span id="cb109-15"><a href="Modelización.html#cb109-15" tabindex="-1"></a>  <span class="at">mean =</span> fc_exp,</span>
<span id="cb109-16"><a href="Modelización.html#cb109-16" tabindex="-1"></a>  <span class="at">lo80 =</span> fc_exp80,</span>
<span id="cb109-17"><a href="Modelización.html#cb109-17" tabindex="-1"></a>  <span class="at">hi80 =</span> fc_exp95</span>
<span id="cb109-18"><a href="Modelización.html#cb109-18" tabindex="-1"></a>)</span>
<span id="cb109-19"><a href="Modelización.html#cb109-19" tabindex="-1"></a></span>
<span id="cb109-20"><a href="Modelización.html#cb109-20" tabindex="-1"></a><span class="co"># Graficar pronóstico en escala original</span></span>
<span id="cb109-21"><a href="Modelización.html#cb109-21" tabindex="-1"></a><span class="fu">ggplot</span>(fc_plot, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb109-22"><a href="Modelización.html#cb109-22" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lo80, <span class="at">ymax =</span> hi80),</span>
<span id="cb109-23"><a href="Modelización.html#cb109-23" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb109-24"><a href="Modelización.html#cb109-24" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">linewidth =</span> <span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb109-25"><a href="Modelización.html#cb109-25" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Pronóstico ARIMA (log-transformado, 7 días)&quot;</span>,</span>
<span id="cb109-26"><a href="Modelización.html#cb109-26" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;Transformación log(1 + x) revertida a escala original&quot;</span>,</span>
<span id="cb109-27"><a href="Modelización.html#cb109-27" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia estimada&quot;</span>) <span class="sc">+</span></span>
<span id="cb109-28"><a href="Modelización.html#cb109-28" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/unnamed-chunk-55-1.png" width="960" /></p>
<ul>
<li><p>La línea azul muestra el pronóstico esperado: prácticamente plano y ligeramente creciente. Las bandas de confianza son amplias, lo cual significa alta incertidumbre en las predicciones.</p></li>
<li><p>El modelo ARIMA no logra capturar del todo la estacionalidad o los cambios estructurales. Existen valores extremos en la serie original. En este caso, el modelo está promediando el comportamiento reciente, sin detectar tendencia fuerte ni patrón estacional marcado, por eso proyecta una línea casi recta.</p></li>
<li><p>La transformación logarítmica ayudó a suavizar la serie, pero aún hay alta volatilidad.</p></li>
<li><p>El modelo ARIMA produce pronósticos conservadores (casi planos) cuando no detecta tendencia o ciclo claro.</p></li>
<li><p>Las bandas amplias muestran que el modelo no confía demasiado en su predicción a 7 días, posiblemente por residuos no estacionarios o valores atípicos persistentes.</p></li>
</ul>
</div>
</div>
</div>
<div id="preprocesamiento-de-la-serie-de-datos-para-holtwinters" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Preprocesamiento de la serie de datos para Holt–Winters<a href="Modelización.html#preprocesamiento-de-la-serie-de-datos-para-holtwinters" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Para la aplicación de Holt–Winter se imputa faltantes, detecta/sustituye outliers y estabiliza la varianza (Box–Cox con inversa guardada)</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="Modelización.html#cb110-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb110-2"><a href="Modelización.html#cb110-2" tabindex="-1"></a><span class="co"># Preprocesamiento para Holt–Winters:</span></span>
<span id="cb110-3"><a href="Modelización.html#cb110-3" tabindex="-1"></a><span class="co"># - Regulariza a malla horaria (si no existe)</span></span>
<span id="cb110-4"><a href="Modelización.html#cb110-4" tabindex="-1"></a><span class="co"># - Imputa NAs</span></span>
<span id="cb110-5"><a href="Modelización.html#cb110-5" tabindex="-1"></a><span class="co"># - Detecta y sustituye outliers</span></span>
<span id="cb110-6"><a href="Modelización.html#cb110-6" tabindex="-1"></a><span class="co"># - Estabiliza varianza con Box–Cox (guarda lambda e inversa)</span></span>
<span id="cb110-7"><a href="Modelización.html#cb110-7" tabindex="-1"></a><span class="co"># Expone: ts_hw_full (limpia, positiva), y_hw_bc, lambda_hw, inv_boxcox()</span></span>
<span id="cb110-8"><a href="Modelización.html#cb110-8" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb110-9"><a href="Modelización.html#cb110-9" tabindex="-1"></a></span>
<span id="cb110-10"><a href="Modelización.html#cb110-10" tabindex="-1"></a><span class="co"># 0) Cronometría</span></span>
<span id="cb110-11"><a href="Modelización.html#cb110-11" tabindex="-1"></a>t0 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb110-12"><a href="Modelización.html#cb110-12" tabindex="-1"></a></span>
<span id="cb110-13"><a href="Modelización.html#cb110-13" tabindex="-1"></a><span class="co"># 1) Asegurar malla horaria y ordenar</span></span>
<span id="cb110-14"><a href="Modelización.html#cb110-14" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">exists</span>(<span class="st">&quot;df_full&quot;</span>), <span class="fu">exists</span>(<span class="st">&quot;time_col&quot;</span>), <span class="fu">exists</span>(<span class="st">&quot;y_col&quot;</span>))</span>
<span id="cb110-15"><a href="Modelización.html#cb110-15" tabindex="-1"></a>df_hw <span class="ot">&lt;-</span> df_full <span class="sc">%&gt;%</span></span>
<span id="cb110-16"><a href="Modelización.html#cb110-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(.data[[time_col]]) <span class="sc">%&gt;%</span></span>
<span id="cb110-17"><a href="Modelización.html#cb110-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!!</span>time_col, <span class="sc">!!</span>y_col)</span>
<span id="cb110-18"><a href="Modelización.html#cb110-18" tabindex="-1"></a></span>
<span id="cb110-19"><a href="Modelización.html#cb110-19" tabindex="-1"></a><span class="co"># 2) Asegurar positividad mínima (HW multiplicativo exige &gt; 0)</span></span>
<span id="cb110-20"><a href="Modelización.html#cb110-20" tabindex="-1"></a><span class="co">#    Si hay valores &lt;= 0, desplazamos toda la serie por un epsilon.</span></span>
<span id="cb110-21"><a href="Modelización.html#cb110-21" tabindex="-1"></a>y_raw <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(df_hw[[y_col]]))</span>
<span id="cb110-22"><a href="Modelización.html#cb110-22" tabindex="-1"></a>eps   <span class="ot">&lt;-</span> <span class="fl">1e-6</span></span>
<span id="cb110-23"><a href="Modelización.html#cb110-23" tabindex="-1"></a>shift <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.finite</span>(<span class="fu">min</span>(y_raw, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">&amp;&amp;</span> <span class="fu">min</span>(y_raw, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&lt;=</span> <span class="dv">0</span>,</span>
<span id="cb110-24"><a href="Modelización.html#cb110-24" tabindex="-1"></a>                <span class="fu">abs</span>(<span class="fu">min</span>(y_raw, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span> eps, <span class="dv">0</span>)</span>
<span id="cb110-25"><a href="Modelización.html#cb110-25" tabindex="-1"></a>y_pos <span class="ot">&lt;-</span> y_raw <span class="sc">+</span> shift</span>
<span id="cb110-26"><a href="Modelización.html#cb110-26" tabindex="-1"></a></span>
<span id="cb110-27"><a href="Modelización.html#cb110-27" tabindex="-1"></a><span class="co"># 3) Construir ts horaria (freq = 24) con el rango completo</span></span>
<span id="cb110-28"><a href="Modelización.html#cb110-28" tabindex="-1"></a>t_min <span class="ot">&lt;-</span> <span class="fu">min</span>(df_hw[[time_col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb110-29"><a href="Modelización.html#cb110-29" tabindex="-1"></a>t_max <span class="ot">&lt;-</span> <span class="fu">max</span>(df_hw[[time_col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb110-30"><a href="Modelización.html#cb110-30" tabindex="-1"></a>n_obs <span class="ot">&lt;-</span> <span class="fu">length</span>(y_pos)</span>
<span id="cb110-31"><a href="Modelización.html#cb110-31" tabindex="-1"></a>ts_hw <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">ts</span>(y_pos, <span class="at">frequency =</span> <span class="dv">24</span>)  <span class="co"># asume datos ya a paso horario</span></span>
<span id="cb110-32"><a href="Modelización.html#cb110-32" tabindex="-1"></a></span>
<span id="cb110-33"><a href="Modelización.html#cb110-33" tabindex="-1"></a><span class="co"># 4) Conteo de NAs antes</span></span>
<span id="cb110-34"><a href="Modelización.html#cb110-34" tabindex="-1"></a>n_na_before <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(y_pos))</span>
<span id="cb110-35"><a href="Modelización.html#cb110-35" tabindex="-1"></a></span>
<span id="cb110-36"><a href="Modelización.html#cb110-36" tabindex="-1"></a><span class="co"># 5) Limpieza integrada: imputación + sustitución de outliers</span></span>
<span id="cb110-37"><a href="Modelización.html#cb110-37" tabindex="-1"></a><span class="co">#    tsclean usa STL internamente para suavizar y reemplazar</span></span>
<span id="cb110-38"><a href="Modelización.html#cb110-38" tabindex="-1"></a>ts_clean <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">tsclean</span>(ts_hw, <span class="at">replace.missing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb110-39"><a href="Modelización.html#cb110-39" tabindex="-1"></a>ts_clean[ts_clean <span class="sc">&lt;</span> <span class="dv">10</span>] <span class="ot">&lt;-</span> <span class="fu">median</span>(ts_clean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="do">#############!!!!!!!!</span></span>
<span id="cb110-40"><a href="Modelización.html#cb110-40" tabindex="-1"></a></span>
<span id="cb110-41"><a href="Modelización.html#cb110-41" tabindex="-1"></a><span class="co"># 6) Detección explícita de outliers (solo para reporte)</span></span>
<span id="cb110-42"><a href="Modelización.html#cb110-42" tabindex="-1"></a>to_hw <span class="ot">&lt;-</span> <span class="fu">try</span>(forecast<span class="sc">::</span><span class="fu">tsoutliers</span>(ts_hw), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb110-43"><a href="Modelización.html#cb110-43" tabindex="-1"></a>n_out <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">inherits</span>(to_hw, <span class="st">&quot;try-error&quot;</span>)) <span class="cn">NA_integer_</span> <span class="cf">else</span> <span class="fu">length</span>(to_hw<span class="sc">$</span>index)</span>
<span id="cb110-44"><a href="Modelización.html#cb110-44" tabindex="-1"></a></span>
<span id="cb110-45"><a href="Modelización.html#cb110-45" tabindex="-1"></a><span class="co"># 7) Serie definitiva para HW (positiva, sin NA/outliers)</span></span>
<span id="cb110-46"><a href="Modelización.html#cb110-46" tabindex="-1"></a>ts_hw_full <span class="ot">&lt;-</span> ts_clean</span>
<span id="cb110-47"><a href="Modelización.html#cb110-47" tabindex="-1"></a></span>
<span id="cb110-48"><a href="Modelización.html#cb110-48" tabindex="-1"></a><span class="co"># 8) Estabilización de varianza (Box–Cox de Guerrero recomendado para estacionalidad)</span></span>
<span id="cb110-49"><a href="Modelización.html#cb110-49" tabindex="-1"></a><span class="co">#    Requiere positividad: ya garantizada por y_pos + tsclean</span></span>
<span id="cb110-50"><a href="Modelización.html#cb110-50" tabindex="-1"></a>lambda_hw <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">BoxCox.lambda</span>(ts_hw_full, <span class="at">method =</span> <span class="st">&quot;guerrero&quot;</span>)</span>
<span id="cb110-51"><a href="Modelización.html#cb110-51" tabindex="-1"></a>y_hw_bc   <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">BoxCox</span>(ts_hw_full, lambda_hw)</span>
<span id="cb110-52"><a href="Modelización.html#cb110-52" tabindex="-1"></a></span>
<span id="cb110-53"><a href="Modelización.html#cb110-53" tabindex="-1"></a><span class="co"># Inversa de Box–Cox</span></span>
<span id="cb110-54"><a href="Modelización.html#cb110-54" tabindex="-1"></a>inv_boxcox <span class="ot">&lt;-</span> <span class="cf">function</span>(z, lambda) {</span>
<span id="cb110-55"><a href="Modelización.html#cb110-55" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isTRUE</span>(<span class="fu">all.equal</span>(lambda, <span class="dv">0</span>))) <span class="fu">exp</span>(z) <span class="cf">else</span> (lambda <span class="sc">*</span> z <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>lambda)</span>
<span id="cb110-56"><a href="Modelización.html#cb110-56" tabindex="-1"></a>}</span>
<span id="cb110-57"><a href="Modelización.html#cb110-57" tabindex="-1"></a></span>
<span id="cb110-58"><a href="Modelización.html#cb110-58" tabindex="-1"></a><span class="co"># 9) Resumen y diagnóstico</span></span>
<span id="cb110-59"><a href="Modelización.html#cb110-59" tabindex="-1"></a>n_na_after <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(<span class="fu">as.numeric</span>(ts_hw_full)))</span>
<span id="cb110-60"><a href="Modelización.html#cb110-60" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Preprocesamiento HW — resumen</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb110-61"><a href="Modelización.html#cb110-61" tabindex="-1"></a>    <span class="st">&quot;- Observaciones: &quot;</span>, <span class="fu">length</span>(ts_hw_full), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb110-62"><a href="Modelización.html#cb110-62" tabindex="-1"></a>    <span class="st">&quot;- NAs antes:     &quot;</span>, n_na_before, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb110-63"><a href="Modelización.html#cb110-63" tabindex="-1"></a>    <span class="st">&quot;- NAs después:   &quot;</span>, n_na_after, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb110-64"><a href="Modelización.html#cb110-64" tabindex="-1"></a>    <span class="st">&quot;- Outliers (det.):&quot;</span>, <span class="fu">ifelse</span>(<span class="fu">is.na</span>(n_out), <span class="st">&quot;no evaluado&quot;</span>, n_out), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb110-65"><a href="Modelización.html#cb110-65" tabindex="-1"></a>    <span class="st">&quot;- Shift aplicado: &quot;</span>, <span class="fu">signif</span>(shift, <span class="dv">6</span>), <span class="st">&quot; (para asegurar positividad)</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb110-66"><a href="Modelización.html#cb110-66" tabindex="-1"></a>    <span class="st">&quot;- Box–Cox lambda: &quot;</span>, <span class="fu">round</span>(lambda_hw, <span class="dv">4</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span></code></pre></div>
<pre><code>## Preprocesamiento HW — resumen
## - Observaciones: 118653
## - NAs antes:     620
## - NAs después:   0
## - Outliers (det.):2485
## - Shift aplicado: 1e-06 (para asegurar positividad)
## - Box–Cox lambda: 0.9455</code></pre>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="Modelización.html#cb112-1" tabindex="-1"></a><span class="co"># 10) Gráfico diagnóstico: Original vs Limpia (+ Box–Cox en panel)</span></span>
<span id="cb112-2"><a href="Modelización.html#cb112-2" tabindex="-1"></a>df_diag_wide <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb112-3"><a href="Modelización.html#cb112-3" tabindex="-1"></a>  <span class="at">time     =</span> <span class="fu">as.POSIXct</span>(df_hw[[time_col]], <span class="at">tz =</span> TZ)[<span class="fu">seq_along</span>(ts_hw_full)],</span>
<span id="cb112-4"><a href="Modelización.html#cb112-4" tabindex="-1"></a>  <span class="at">Original =</span> y_pos[<span class="fu">seq_along</span>(ts_hw_full)],</span>
<span id="cb112-5"><a href="Modelización.html#cb112-5" tabindex="-1"></a>  <span class="at">BoxCox   =</span> <span class="fu">as.numeric</span>(y_hw_bc),</span>
<span id="cb112-6"><a href="Modelización.html#cb112-6" tabindex="-1"></a>  <span class="at">Limpia   =</span> <span class="fu">as.numeric</span>(ts_hw_full)</span>
<span id="cb112-7"><a href="Modelización.html#cb112-7" tabindex="-1"></a>)</span>
<span id="cb112-8"><a href="Modelización.html#cb112-8" tabindex="-1"></a></span>
<span id="cb112-9"><a href="Modelización.html#cb112-9" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb112-10"><a href="Modelización.html#cb112-10" tabindex="-1"></a>  <span class="co"># Fondo: serie original (gris, delgada y transparente)</span></span>
<span id="cb112-11"><a href="Modelización.html#cb112-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data =</span> df_diag_wide,</span>
<span id="cb112-12"><a href="Modelización.html#cb112-12" tabindex="-1"></a>                     ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y =</span> Original, <span class="at">color =</span> <span class="st">&quot;Original&quot;</span>),</span>
<span id="cb112-13"><a href="Modelización.html#cb112-13" tabindex="-1"></a>                     <span class="at">linewidth =</span> <span class="fl">0.35</span>, <span class="at">alpha =</span> <span class="fl">0.45</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb112-14"><a href="Modelización.html#cb112-14" tabindex="-1"></a>  <span class="co"># Medio: Box-Cox (naranja, grosor medio)</span></span>
<span id="cb112-15"><a href="Modelización.html#cb112-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data =</span> df_diag_wide,</span>
<span id="cb112-16"><a href="Modelización.html#cb112-16" tabindex="-1"></a>                     ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y =</span> BoxCox, <span class="at">color =</span> <span class="st">&quot;BoxCox&quot;</span>),</span>
<span id="cb112-17"><a href="Modelización.html#cb112-17" tabindex="-1"></a>                     <span class="at">linewidth =</span> <span class="fl">0.6</span>, <span class="at">alpha =</span> <span class="fl">0.85</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb112-18"><a href="Modelización.html#cb112-18" tabindex="-1"></a>  <span class="co"># Frente: serie limpia (azul, más gruesa)</span></span>
<span id="cb112-19"><a href="Modelización.html#cb112-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data =</span> df_diag_wide,</span>
<span id="cb112-20"><a href="Modelización.html#cb112-20" tabindex="-1"></a>                     ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y =</span> Limpia, <span class="at">color =</span> <span class="st">&quot;Limpia&quot;</span>),</span>
<span id="cb112-21"><a href="Modelización.html#cb112-21" tabindex="-1"></a>                     <span class="at">linewidth =</span> <span class="fl">0.9</span>, <span class="at">alpha =</span> <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb112-22"><a href="Modelización.html#cb112-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(</span>
<span id="cb112-23"><a href="Modelización.html#cb112-23" tabindex="-1"></a>    <span class="at">name   =</span> <span class="st">&quot;Serie&quot;</span>,</span>
<span id="cb112-24"><a href="Modelización.html#cb112-24" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">&quot;Original&quot;</span>,<span class="st">&quot;BoxCox&quot;</span>,<span class="st">&quot;Limpia&quot;</span>),</span>
<span id="cb112-25"><a href="Modelización.html#cb112-25" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Original (fondo)&quot;</span>,<span class="st">&quot;Box–Cox&quot;</span>,<span class="st">&quot;Limpia (frente)&quot;</span>),</span>
<span id="cb112-26"><a href="Modelización.html#cb112-26" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="at">Original =</span> <span class="st">&quot;#9CA3AF&quot;</span>, <span class="at">BoxCox =</span> <span class="st">&quot;#ff7f0e&quot;</span>, <span class="at">Limpia =</span> <span class="st">&quot;#1f77b4&quot;</span>)</span>
<span id="cb112-27"><a href="Modelización.html#cb112-27" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb112-28"><a href="Modelización.html#cb112-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb112-29"><a href="Modelización.html#cb112-29" tabindex="-1"></a>    <span class="at">title    =</span> <span class="st">&quot;Preprocesamiento para Holt–Winters&quot;</span>,</span>
<span id="cb112-30"><a href="Modelización.html#cb112-30" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Fondo: Original | Medio: Box–Cox | Frente: Serie limpia (imputación + outliers)&quot;</span>,</span>
<span id="cb112-31"><a href="Modelización.html#cb112-31" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Valor&quot;</span></span>
<span id="cb112-32"><a href="Modelización.html#cb112-32" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb112-33"><a href="Modelización.html#cb112-33" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb112-34"><a href="Modelización.html#cb112-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb112-35"><a href="Modelización.html#cb112-35" tabindex="-1"></a>    <span class="at">plot.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb112-36"><a href="Modelización.html#cb112-36" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb112-37"><a href="Modelización.html#cb112-37" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/hw-preprocessing-1.png" width="960" /></p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="Modelización.html#cb113-1" tabindex="-1"></a><span class="co"># 11) Cronometría (si usas el registrador .timing)</span></span>
<span id="cb113-2"><a href="Modelización.html#cb113-2" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;.timing&quot;</span>)) {</span>
<span id="cb113-3"><a href="Modelización.html#cb113-3" tabindex="-1"></a>  .timing[[<span class="st">&quot;HW - Preprocesamiento&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb113-4"><a href="Modelización.html#cb113-4" tabindex="-1"></a>    <span class="at">seconds =</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(<span class="fu">Sys.time</span>(), t0, <span class="at">units =</span> <span class="st">&quot;secs&quot;</span>)),</span>
<span id="cb113-5"><a href="Modelización.html#cb113-5" tabindex="-1"></a>    <span class="at">status  =</span> <span class="st">&quot;OK&quot;</span>,</span>
<span id="cb113-6"><a href="Modelización.html#cb113-6" tabindex="-1"></a>    <span class="at">message =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb113-7"><a href="Modelización.html#cb113-7" tabindex="-1"></a>  )</span>
<span id="cb113-8"><a href="Modelización.html#cb113-8" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li><p>La serie fue limpiada, ya no tiene huecos ni valores extremos, y su escala fue estabilizada para un modelado robusto con Holt–Winters.</p></li>
<li><p>En la gráfica el Gris claro corresponde a la Serie original con ruido, picos y alta dispersión. el Naranja corresponde la serie transformada con varianza más homogénea, suavizando los extremos. y la curva Azul es la serie final tras imputación y reemplazo de outliers; muestra comportamiento más regular y continuo.</p></li>
<li><p>Los picos de potencia extrema (&gt;3000) fueron suavizados; la serie azul es más compacta y uniforme.</p></li>
<li><p>Se mantienen los ciclos anuales y semanales, lo que garantiza que no se perdió información relevante.</p></li>
<li><p>El Box–Cox (naranja) actúa como paso intermedio: reduce la amplitud sin eliminar fluctuaciones naturales.</p></li>
<li><p>La serie limpia (azul) se ajusta mejor a los supuestos del modelo HW, evitando el sesgo causado por valores extremos o huecos.</p></li>
</ul>
</div>
<div id="división-de-los-datos-entre-traintest" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> División de los datos entre TRAIN/TEST<a href="Modelización.html#divisi%C3%B3n-de-los-datos-entre-traintest" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="Modelización.html#cb114-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb114-2"><a href="Modelización.html#cb114-2" tabindex="-1"></a><span class="co"># Split TRAIN/</span><span class="al">TEST</span><span class="co"> para Holt–Winters y ARIMA</span></span>
<span id="cb114-3"><a href="Modelización.html#cb114-3" tabindex="-1"></a><span class="co"># Usa: ts_hw_full (serie limpia/positiva) y y_hw_bc (Box–Cox)</span></span>
<span id="cb114-4"><a href="Modelización.html#cb114-4" tabindex="-1"></a><span class="co"># Expone: h, n_test, y_train, y_test, y_train_bc, y_test_bc,</span></span>
<span id="cb114-5"><a href="Modelización.html#cb114-5" tabindex="-1"></a><span class="co">#         time_train, time_test (para gráficas y métricas)</span></span>
<span id="cb114-6"><a href="Modelización.html#cb114-6" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb114-7"><a href="Modelización.html#cb114-7" tabindex="-1"></a></span>
<span id="cb114-8"><a href="Modelización.html#cb114-8" tabindex="-1"></a><span class="co"># Cronometría</span></span>
<span id="cb114-9"><a href="Modelización.html#cb114-9" tabindex="-1"></a>t0 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb114-10"><a href="Modelización.html#cb114-10" tabindex="-1"></a></span>
<span id="cb114-11"><a href="Modelización.html#cb114-11" tabindex="-1"></a><span class="co"># 0) Utilidades</span></span>
<span id="cb114-12"><a href="Modelización.html#cb114-12" tabindex="-1"></a><span class="st">`</span><span class="at">%||%</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(a)) a <span class="cf">else</span> b</span>
<span id="cb114-13"><a href="Modelización.html#cb114-13" tabindex="-1"></a></span>
<span id="cb114-14"><a href="Modelización.html#cb114-14" tabindex="-1"></a><span class="co"># 1) Horizonte en horas (24 * días)</span></span>
<span id="cb114-15"><a href="Modelización.html#cb114-15" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">24</span> <span class="sc">*</span> (horizon_days <span class="sc">%||%</span> <span class="dv">7</span>)</span>
<span id="cb114-16"><a href="Modelización.html#cb114-16" tabindex="-1"></a></span>
<span id="cb114-17"><a href="Modelización.html#cb114-17" tabindex="-1"></a><span class="co"># 2) Longitudes y validaciones</span></span>
<span id="cb114-18"><a href="Modelización.html#cb114-18" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">exists</span>(<span class="st">&quot;ts_hw_full&quot;</span>))</span>
<span id="cb114-19"><a href="Modelización.html#cb114-19" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(ts_hw_full)</span>
<span id="cb114-20"><a href="Modelización.html#cb114-20" tabindex="-1"></a></span>
<span id="cb114-21"><a href="Modelización.html#cb114-21" tabindex="-1"></a><span class="co"># Si el horizonte es mayor que la serie, lo acotamos y avisamos</span></span>
<span id="cb114-22"><a href="Modelización.html#cb114-22" tabindex="-1"></a><span class="cf">if</span> (h <span class="sc">&gt;=</span> n) {</span>
<span id="cb114-23"><a href="Modelización.html#cb114-23" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Horizonte (%d) &gt;= longitud de la serie (%d). Se ajusta a h = %d.&quot;</span>,</span>
<span id="cb114-24"><a href="Modelización.html#cb114-24" tabindex="-1"></a>                  h, n, <span class="fu">max</span>(<span class="dv">1</span><span class="dt">L</span>, <span class="fu">floor</span>(n<span class="sc">/</span><span class="dv">5</span>))))</span>
<span id="cb114-25"><a href="Modelización.html#cb114-25" tabindex="-1"></a>  h <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span><span class="dt">L</span>, <span class="fu">floor</span>(n<span class="sc">/</span><span class="dv">5</span>))</span>
<span id="cb114-26"><a href="Modelización.html#cb114-26" tabindex="-1"></a>}</span>
<span id="cb114-27"><a href="Modelización.html#cb114-27" tabindex="-1"></a></span>
<span id="cb114-28"><a href="Modelización.html#cb114-28" tabindex="-1"></a><span class="co"># 3) Definimos tamaño de </span><span class="al">TEST</span><span class="co"> como el horizonte (común para evaluación)</span></span>
<span id="cb114-29"><a href="Modelización.html#cb114-29" tabindex="-1"></a>n_test <span class="ot">&lt;-</span> h</span>
<span id="cb114-30"><a href="Modelización.html#cb114-30" tabindex="-1"></a>n_train <span class="ot">&lt;-</span> n <span class="sc">-</span> n_test</span>
<span id="cb114-31"><a href="Modelización.html#cb114-31" tabindex="-1"></a><span class="fu">stopifnot</span>(n_train <span class="sc">&gt;=</span> <span class="dv">24</span> <span class="sc">*</span> <span class="dv">7</span>)  <span class="co"># al menos ~1 semana para estimar estacionalidad</span></span>
<span id="cb114-32"><a href="Modelización.html#cb114-32" tabindex="-1"></a></span>
<span id="cb114-33"><a href="Modelización.html#cb114-33" tabindex="-1"></a><span class="co"># 4) Particiones en escala original (limpia, positiva)</span></span>
<span id="cb114-34"><a href="Modelización.html#cb114-34" tabindex="-1"></a>y_train <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">ts</span>(ts_hw_full[<span class="dv">1</span><span class="sc">:</span>n_train], <span class="at">frequency =</span> <span class="dv">24</span>)</span>
<span id="cb114-35"><a href="Modelización.html#cb114-35" tabindex="-1"></a>y_test  <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">ts</span>(ts_hw_full[(n_train<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n], <span class="at">frequency =</span> <span class="dv">24</span>)</span>
<span id="cb114-36"><a href="Modelización.html#cb114-36" tabindex="-1"></a></span>
<span id="cb114-37"><a href="Modelización.html#cb114-37" tabindex="-1"></a><span class="co"># 5) Particiones en escala Box–Cox (para modelos aditivos en varianza estable)</span></span>
<span id="cb114-38"><a href="Modelización.html#cb114-38" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">exists</span>(<span class="st">&quot;y_hw_bc&quot;</span>))</span>
<span id="cb114-39"><a href="Modelización.html#cb114-39" tabindex="-1"></a>y_train_bc <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">ts</span>(y_hw_bc[<span class="dv">1</span><span class="sc">:</span>n_train], <span class="at">frequency =</span> <span class="dv">24</span>)</span>
<span id="cb114-40"><a href="Modelización.html#cb114-40" tabindex="-1"></a>y_test_bc  <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">ts</span>(y_hw_bc[(n_train<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n], <span class="at">frequency =</span> <span class="dv">24</span>)</span>
<span id="cb114-41"><a href="Modelización.html#cb114-41" tabindex="-1"></a></span>
<span id="cb114-42"><a href="Modelización.html#cb114-42" tabindex="-1"></a><span class="co"># 6) Vectores de tiempo (útil para gráficas de comparación)</span></span>
<span id="cb114-43"><a href="Modelización.html#cb114-43" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">exists</span>(<span class="st">&quot;df_full&quot;</span>), <span class="fu">exists</span>(<span class="st">&quot;time_col&quot;</span>))</span>
<span id="cb114-44"><a href="Modelización.html#cb114-44" tabindex="-1"></a>time_all   <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(df_full[[time_col]])</span>
<span id="cb114-45"><a href="Modelización.html#cb114-45" tabindex="-1"></a>time_train <span class="ot">&lt;-</span> time_all[<span class="dv">1</span><span class="sc">:</span>n_train]</span>
<span id="cb114-46"><a href="Modelización.html#cb114-46" tabindex="-1"></a>time_test  <span class="ot">&lt;-</span> time_all[(n_train<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n]</span>
<span id="cb114-47"><a href="Modelización.html#cb114-47" tabindex="-1"></a></span>
<span id="cb114-48"><a href="Modelización.html#cb114-48" tabindex="-1"></a><span class="co"># 7) Métricas (si no existen)</span></span>
<span id="cb114-49"><a href="Modelización.html#cb114-49" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;rmse&quot;</span>, <span class="at">mode =</span> <span class="st">&quot;function&quot;</span>)) {</span>
<span id="cb114-50"><a href="Modelización.html#cb114-50" tabindex="-1"></a>  rmse <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, pred) <span class="fu">sqrt</span>(<span class="fu">mean</span>((obs <span class="sc">-</span> pred)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb114-51"><a href="Modelización.html#cb114-51" tabindex="-1"></a>}</span>
<span id="cb114-52"><a href="Modelización.html#cb114-52" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;mape&quot;</span>, <span class="at">mode =</span> <span class="st">&quot;function&quot;</span>)) {</span>
<span id="cb114-53"><a href="Modelización.html#cb114-53" tabindex="-1"></a>  mape <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, pred) {</span>
<span id="cb114-54"><a href="Modelización.html#cb114-54" tabindex="-1"></a>    ok <span class="ot">&lt;-</span> obs <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">is.finite</span>(obs) <span class="sc">&amp;</span> <span class="fu">is.finite</span>(pred)</span>
<span id="cb114-55"><a href="Modelización.html#cb114-55" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(ok)) <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb114-56"><a href="Modelización.html#cb114-56" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>((obs[ok] <span class="sc">-</span> pred[ok]) <span class="sc">/</span> obs[ok])) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb114-57"><a href="Modelización.html#cb114-57" tabindex="-1"></a>  }</span>
<span id="cb114-58"><a href="Modelización.html#cb114-58" tabindex="-1"></a>}</span>
<span id="cb114-59"><a href="Modelización.html#cb114-59" tabindex="-1"></a></span>
<span id="cb114-60"><a href="Modelización.html#cb114-60" tabindex="-1"></a><span class="co"># 8) Resumen y chequeo visual rápido</span></span>
<span id="cb114-61"><a href="Modelización.html#cb114-61" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Split TRAIN/TEST</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb114-62"><a href="Modelización.html#cb114-62" tabindex="-1"></a>    <span class="st">&quot;- Observaciones totales: &quot;</span>, n, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb114-63"><a href="Modelización.html#cb114-63" tabindex="-1"></a>    <span class="st">&quot;- TRAIN: &quot;</span>, n_train, <span class="st">&quot;  (&quot;</span>, <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>n_train<span class="sc">/</span>n,<span class="dv">1</span>),<span class="st">&quot;%)</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb114-64"><a href="Modelización.html#cb114-64" tabindex="-1"></a>    <span class="st">&quot;- TEST:  &quot;</span>, n_test,  <span class="st">&quot;  (&quot;</span>, <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>n_test<span class="sc">/</span>n,<span class="dv">1</span>),<span class="st">&quot;%)</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb114-65"><a href="Modelización.html#cb114-65" tabindex="-1"></a>    <span class="st">&quot;- Horizonte h (horas): &quot;</span>, h, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb114-66"><a href="Modelización.html#cb114-66" tabindex="-1"></a>    <span class="st">&quot;- Freq ts: &quot;</span>, <span class="fu">frequency</span>(y_train), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span></code></pre></div>
<pre><code>## Split TRAIN/TEST
## - Observaciones totales: 118653
## - TRAIN: 118485  (99.9%)
## - TEST:  168  (0.1%)
## - Horizonte h (horas): 168
## - Freq ts: 24</code></pre>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="Modelización.html#cb116-1" tabindex="-1"></a><span class="co"># Gráfico base para verificar el split</span></span>
<span id="cb116-2"><a href="Modelización.html#cb116-2" tabindex="-1"></a>df_split <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb116-3"><a href="Modelización.html#cb116-3" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">time =</span> time_train, <span class="at">y =</span> <span class="fu">as.numeric</span>(y_train), <span class="at">conj =</span> <span class="st">&quot;TRAIN&quot;</span>),</span>
<span id="cb116-4"><a href="Modelización.html#cb116-4" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">time =</span> time_test,  <span class="at">y =</span> <span class="fu">as.numeric</span>(y_test),  <span class="at">conj =</span> <span class="st">&quot;TEST&quot;</span>)</span>
<span id="cb116-5"><a href="Modelización.html#cb116-5" tabindex="-1"></a>)</span>
<span id="cb116-6"><a href="Modelización.html#cb116-6" tabindex="-1"></a></span>
<span id="cb116-7"><a href="Modelización.html#cb116-7" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(df_split, ggplot2<span class="sc">::</span><span class="fu">aes</span>(time, y, <span class="at">color =</span> conj)) <span class="sc">+</span></span>
<span id="cb116-8"><a href="Modelización.html#cb116-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb116-9"><a href="Modelización.html#cb116-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="at">TRAIN =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">TEST =</span> <span class="st">&quot;#d62728&quot;</span>)) <span class="sc">+</span></span>
<span id="cb116-10"><a href="Modelización.html#cb116-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Split de la serie: TRAIN vs TEST&quot;</span>,</span>
<span id="cb116-11"><a href="Modelización.html#cb116-11" tabindex="-1"></a>                <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia&quot;</span>, <span class="at">color =</span> <span class="st">&quot;Conjunto&quot;</span>) <span class="sc">+</span></span>
<span id="cb116-12"><a href="Modelización.html#cb116-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb116-13"><a href="Modelización.html#cb116-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">plot.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb116-14"><a href="Modelización.html#cb116-14" tabindex="-1"></a>                 <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/hw-train-test-setup-1.png" width="960" /></p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="Modelización.html#cb117-1" tabindex="-1"></a><span class="co"># 9) Cronometría (si la usas)</span></span>
<span id="cb117-2"><a href="Modelización.html#cb117-2" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;.timing&quot;</span>)) {</span>
<span id="cb117-3"><a href="Modelización.html#cb117-3" tabindex="-1"></a>  .timing[[<span class="st">&quot;HW - Split TRAIN/TEST&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb117-4"><a href="Modelización.html#cb117-4" tabindex="-1"></a>    <span class="at">seconds =</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(<span class="fu">Sys.time</span>(), t0, <span class="at">units =</span> <span class="st">&quot;secs&quot;</span>)), <span class="co"># trivial aquí</span></span>
<span id="cb117-5"><a href="Modelización.html#cb117-5" tabindex="-1"></a>    <span class="at">status  =</span> <span class="st">&quot;OK&quot;</span>,</span>
<span id="cb117-6"><a href="Modelización.html#cb117-6" tabindex="-1"></a>    <span class="at">message =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb117-7"><a href="Modelización.html#cb117-7" tabindex="-1"></a>  )</span>
<span id="cb117-8"><a href="Modelización.html#cb117-8" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li><p>Se dividio la serie de tiempo en dos partes, TRAIN (azul): casi toda la serie, usada para ajustar el modelo y TEST (rojo): los últimos 7 días, usados para evaluar la capacidad predictiva (este tramo es muy corto respecto al conjunto total, lo cual indica que el modelo se entrenará con casi toda la información disponible y se evaluará únicamente en una ventana reciente de 7 días).</p></li>
<li><p>La serie muestra una alta variabilidad en la potencia a lo largo del tiempo, con fluctuaciones intensas dentro de cada año (posible patrón diario/semanal) e incremento gradual de los valores máximos a partir de 2020 (~tendencia leve al alza). Se observa ruido considerable y presencia de picos y caídas abruptas, lo que sugiere procesos operativos irregulares o mediciones con eventos extremos.</p></li>
</ul>
</div>
<div id="ajuste-holtwinters-aditivo-y-multiplicativo-usando-train-y-h-definidos" class="section level2 hasAnchor" number="5.5">
<h2><span class="header-section-number">5.5</span> Ajuste Holt–Winters aditivo y multiplicativo (usando TRAIN y h definidos)<a href="Modelización.html#ajuste-holtwinters-aditivo-y-multiplicativo-usando-train-y-h-definidos" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="Modelización.html#cb118-1" tabindex="-1"></a><span class="co"># =========================================</span></span>
<span id="cb118-2"><a href="Modelización.html#cb118-2" tabindex="-1"></a><span class="co"># Holt–Winters: ajustes aditivo y multiplicativo (consistentes con 0 y 1)</span></span>
<span id="cb118-3"><a href="Modelización.html#cb118-3" tabindex="-1"></a><span class="co"># Usa: y_train (escala original positiva), h</span></span>
<span id="cb118-4"><a href="Modelización.html#cb118-4" tabindex="-1"></a><span class="co"># Deja: fc_hw_add, fc_hw_mul (objetos &#39;forecast&#39;)</span></span>
<span id="cb118-5"><a href="Modelización.html#cb118-5" tabindex="-1"></a><span class="co"># =========================================</span></span>
<span id="cb118-6"><a href="Modelización.html#cb118-6" tabindex="-1"></a></span>
<span id="cb118-7"><a href="Modelización.html#cb118-7" tabindex="-1"></a><span class="co"># Cronometría</span></span>
<span id="cb118-8"><a href="Modelización.html#cb118-8" tabindex="-1"></a>t0 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb118-9"><a href="Modelización.html#cb118-9" tabindex="-1"></a></span>
<span id="cb118-10"><a href="Modelización.html#cb118-10" tabindex="-1"></a><span class="co"># Carga autoplot para objetos &#39;forecast&#39;</span></span>
<span id="cb118-11"><a href="Modelización.html#cb118-11" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="st">&quot;ggfortify&quot;</span> <span class="sc">%in%</span> <span class="fu">.packages</span>()) <span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(ggfortify))</span>
<span id="cb118-12"><a href="Modelización.html#cb118-12" tabindex="-1"></a></span>
<span id="cb118-13"><a href="Modelización.html#cb118-13" tabindex="-1"></a><span class="co"># --- Aditivo (siempre válido en escala original) ---</span></span>
<span id="cb118-14"><a href="Modelización.html#cb118-14" tabindex="-1"></a>fc_hw_add <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">hw</span>(y_train, <span class="at">seasonal =</span> <span class="st">&quot;additive&quot;</span>, <span class="at">h =</span> h)</span>
<span id="cb118-15"><a href="Modelización.html#cb118-15" tabindex="-1"></a></span>
<span id="cb118-16"><a href="Modelización.html#cb118-16" tabindex="-1"></a><span class="co"># --- Multiplicativo (requiere todos &gt; 0) ---</span></span>
<span id="cb118-17"><a href="Modelización.html#cb118-17" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">as.numeric</span>(y_train) <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb118-18"><a href="Modelización.html#cb118-18" tabindex="-1"></a>  fc_hw_mul <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">hw</span>(y_train, <span class="at">seasonal =</span> <span class="st">&quot;multiplicative&quot;</span>, <span class="at">h =</span> h)</span>
<span id="cb118-19"><a href="Modelización.html#cb118-19" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb118-20"><a href="Modelización.html#cb118-20" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;HW multiplicativo omitido: la serie TRAIN contiene ceros o valores ≤ 0.&quot;</span>)</span>
<span id="cb118-21"><a href="Modelización.html#cb118-21" tabindex="-1"></a>  fc_hw_mul <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb118-22"><a href="Modelización.html#cb118-22" tabindex="-1"></a>}</span>
<span id="cb118-23"><a href="Modelización.html#cb118-23" tabindex="-1"></a></span>
<span id="cb118-24"><a href="Modelización.html#cb118-24" tabindex="-1"></a><span class="co"># # Vista rápida </span></span>
<span id="cb118-25"><a href="Modelización.html#cb118-25" tabindex="-1"></a><span class="co"># autoplot(fc_hw_add) +</span></span>
<span id="cb118-26"><a href="Modelización.html#cb118-26" tabindex="-1"></a><span class="co">#   labs(title = &quot;Pronóstico Holt–Winters (Aditivo)&quot;,</span></span>
<span id="cb118-27"><a href="Modelización.html#cb118-27" tabindex="-1"></a><span class="co">#        x = &quot;Tiempo&quot;, y = &quot;Potencia&quot;) +</span></span>
<span id="cb118-28"><a href="Modelización.html#cb118-28" tabindex="-1"></a><span class="co">#   theme_minimal(base_size = 12)</span></span>
<span id="cb118-29"><a href="Modelización.html#cb118-29" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb118-30"><a href="Modelización.html#cb118-30" tabindex="-1"></a><span class="co"># if (!is.null(fc_hw_mul)) {</span></span>
<span id="cb118-31"><a href="Modelización.html#cb118-31" tabindex="-1"></a><span class="co">#   autoplot(fc_hw_mul) +</span></span>
<span id="cb118-32"><a href="Modelización.html#cb118-32" tabindex="-1"></a><span class="co">#     labs(title = &quot;Pronóstico Holt–Winters (Multiplicativo)&quot;,</span></span>
<span id="cb118-33"><a href="Modelización.html#cb118-33" tabindex="-1"></a><span class="co">#          x = &quot;Tiempo&quot;, y = &quot;Potencia&quot;) +</span></span>
<span id="cb118-34"><a href="Modelización.html#cb118-34" tabindex="-1"></a><span class="co">#     theme_minimal(base_size = 12)</span></span>
<span id="cb118-35"><a href="Modelización.html#cb118-35" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb118-36"><a href="Modelización.html#cb118-36" tabindex="-1"></a></span>
<span id="cb118-37"><a href="Modelización.html#cb118-37" tabindex="-1"></a><span class="co"># Cronometría (si usas el registrador .timing)</span></span>
<span id="cb118-38"><a href="Modelización.html#cb118-38" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;.timing&quot;</span>)) {</span>
<span id="cb118-39"><a href="Modelización.html#cb118-39" tabindex="-1"></a>  .timing[[<span class="st">&quot;HW - Aditivo y multiplicativo&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb118-40"><a href="Modelización.html#cb118-40" tabindex="-1"></a>    <span class="at">seconds =</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(<span class="fu">Sys.time</span>(), t0, <span class="at">units =</span> <span class="st">&quot;secs&quot;</span>)),</span>
<span id="cb118-41"><a href="Modelización.html#cb118-41" tabindex="-1"></a>    <span class="at">status  =</span> <span class="st">&quot;OK&quot;</span>,</span>
<span id="cb118-42"><a href="Modelización.html#cb118-42" tabindex="-1"></a>    <span class="at">message =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb118-43"><a href="Modelización.html#cb118-43" tabindex="-1"></a>  )</span>
<span id="cb118-44"><a href="Modelización.html#cb118-44" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="gráfica-comparativa-traintest-pronósticos-hw-aditivo-vs.-multiplicativo" class="section level2 hasAnchor" number="5.6">
<h2><span class="header-section-number">5.6</span> Gráfica comparativa: TRAIN/TEST + pronósticos HW (aditivo vs. multiplicativo)<a href="Modelización.html#gr%C3%A1fica-comparativa-traintest-pron%C3%B3sticos-hw-aditivo-vs.-multiplicativo" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="Modelización.html#cb119-1" tabindex="-1"></a><span class="co"># =========================================</span></span>
<span id="cb119-2"><a href="Modelización.html#cb119-2" tabindex="-1"></a><span class="co"># Gráfica comparativa con eje temporal real</span></span>
<span id="cb119-3"><a href="Modelización.html#cb119-3" tabindex="-1"></a><span class="co"># Usa: time_train, time_test, y_train, y_test, h, fc_hw_add, fc_hw_mul, TZ</span></span>
<span id="cb119-4"><a href="Modelización.html#cb119-4" tabindex="-1"></a><span class="co"># =========================================</span></span>
<span id="cb119-5"><a href="Modelización.html#cb119-5" tabindex="-1"></a></span>
<span id="cb119-6"><a href="Modelización.html#cb119-6" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">exists</span>(<span class="st">&quot;time_train&quot;</span>), <span class="fu">exists</span>(<span class="st">&quot;time_test&quot;</span>))</span>
<span id="cb119-7"><a href="Modelización.html#cb119-7" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">exists</span>(<span class="st">&quot;TZ&quot;</span>))</span>
<span id="cb119-8"><a href="Modelización.html#cb119-8" tabindex="-1"></a></span>
<span id="cb119-9"><a href="Modelización.html#cb119-9" tabindex="-1"></a><span class="co"># DATAFRAME histórico</span></span>
<span id="cb119-10"><a href="Modelización.html#cb119-10" tabindex="-1"></a>df_train <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">time =</span> time_train, <span class="at">y =</span> <span class="fu">as.numeric</span>(y_train), <span class="at">conj =</span> <span class="st">&quot;TRAIN&quot;</span>)</span>
<span id="cb119-11"><a href="Modelización.html#cb119-11" tabindex="-1"></a>df_test  <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">time =</span> time_test,  <span class="at">y =</span> <span class="fu">as.numeric</span>(y_test),  <span class="at">conj =</span> <span class="st">&quot;TEST&quot;</span>)</span>
<span id="cb119-12"><a href="Modelización.html#cb119-12" tabindex="-1"></a></span>
<span id="cb119-13"><a href="Modelización.html#cb119-13" tabindex="-1"></a><span class="co"># Instantes de pronóstico a partir del final de TRAIN</span></span>
<span id="cb119-14"><a href="Modelización.html#cb119-14" tabindex="-1"></a>t_train_end <span class="ot">&lt;-</span> <span class="fu">max</span>(time_train, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb119-15"><a href="Modelización.html#cb119-15" tabindex="-1"></a>f_times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> t_train_end <span class="sc">+</span> lubridate<span class="sc">::</span><span class="fu">hours</span>(<span class="dv">1</span>),</span>
<span id="cb119-16"><a href="Modelización.html#cb119-16" tabindex="-1"></a>               <span class="at">by   =</span> <span class="st">&quot;1 hour&quot;</span>,</span>
<span id="cb119-17"><a href="Modelización.html#cb119-17" tabindex="-1"></a>               <span class="at">length.out =</span> h)</span>
<span id="cb119-18"><a href="Modelización.html#cb119-18" tabindex="-1"></a></span>
<span id="cb119-19"><a href="Modelización.html#cb119-19" tabindex="-1"></a><span class="co"># Pasar objetos forecast a data frame (si existen)</span></span>
<span id="cb119-20"><a href="Modelización.html#cb119-20" tabindex="-1"></a>as_fc_df <span class="ot">&lt;-</span> <span class="cf">function</span>(fc, nombre) {</span>
<span id="cb119-21"><a href="Modelización.html#cb119-21" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(fc)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb119-22"><a href="Modelización.html#cb119-22" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb119-23"><a href="Modelización.html#cb119-23" tabindex="-1"></a>    <span class="at">time =</span> f_times,</span>
<span id="cb119-24"><a href="Modelización.html#cb119-24" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>mean),</span>
<span id="cb119-25"><a href="Modelización.html#cb119-25" tabindex="-1"></a>    <span class="at">lo80 =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>lower[, <span class="st">&quot;80%&quot;</span>]),</span>
<span id="cb119-26"><a href="Modelización.html#cb119-26" tabindex="-1"></a>    <span class="at">hi80 =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>upper[, <span class="st">&quot;80%&quot;</span>]),</span>
<span id="cb119-27"><a href="Modelización.html#cb119-27" tabindex="-1"></a>    <span class="at">lo95 =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>lower[, <span class="st">&quot;95%&quot;</span>]),</span>
<span id="cb119-28"><a href="Modelización.html#cb119-28" tabindex="-1"></a>    <span class="at">hi95 =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>upper[, <span class="st">&quot;95%&quot;</span>]),</span>
<span id="cb119-29"><a href="Modelización.html#cb119-29" tabindex="-1"></a>    <span class="at">modelo =</span> nombre</span>
<span id="cb119-30"><a href="Modelización.html#cb119-30" tabindex="-1"></a>  )</span>
<span id="cb119-31"><a href="Modelización.html#cb119-31" tabindex="-1"></a>}</span>
<span id="cb119-32"><a href="Modelización.html#cb119-32" tabindex="-1"></a></span>
<span id="cb119-33"><a href="Modelización.html#cb119-33" tabindex="-1"></a>df_add <span class="ot">&lt;-</span> <span class="fu">as_fc_df</span>(fc_hw_add, <span class="st">&quot;HW Aditivo&quot;</span>)</span>
<span id="cb119-34"><a href="Modelización.html#cb119-34" tabindex="-1"></a>df_mul <span class="ot">&lt;-</span> <span class="fu">as_fc_df</span>(fc_hw_mul, <span class="st">&quot;HW Multiplicativo&quot;</span>)</span>
<span id="cb119-35"><a href="Modelización.html#cb119-35" tabindex="-1"></a>df_fc  <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(df_add, df_mul)</span>
<span id="cb119-36"><a href="Modelización.html#cb119-36" tabindex="-1"></a></span>
<span id="cb119-37"><a href="Modelización.html#cb119-37" tabindex="-1"></a><span class="co"># # Plot</span></span>
<span id="cb119-38"><a href="Modelización.html#cb119-38" tabindex="-1"></a><span class="co"># ggplot2::ggplot() +</span></span>
<span id="cb119-39"><a href="Modelización.html#cb119-39" tabindex="-1"></a><span class="co">#   ggplot2::geom_line(data = df_train, ggplot2::aes(time, y), color = &quot;grey65&quot;, linewidth = 0.45) +</span></span>
<span id="cb119-40"><a href="Modelización.html#cb119-40" tabindex="-1"></a><span class="co">#   ggplot2::geom_line(data = df_test,  ggplot2::aes(time, y), color = &quot;black&quot;,  linewidth = 0.6)  +</span></span>
<span id="cb119-41"><a href="Modelización.html#cb119-41" tabindex="-1"></a><span class="co">#   ggplot2::geom_ribbon(data = df_fc, ggplot2::aes(x = time, ymin = lo95, ymax = hi95, fill = modelo),</span></span>
<span id="cb119-42"><a href="Modelización.html#cb119-42" tabindex="-1"></a><span class="co">#                        alpha = 0.12, show.legend = FALSE) +</span></span>
<span id="cb119-43"><a href="Modelización.html#cb119-43" tabindex="-1"></a><span class="co">#   ggplot2::geom_ribbon(data = df_fc, ggplot2::aes(x = time, ymin = lo80, ymax = hi80, fill = modelo),</span></span>
<span id="cb119-44"><a href="Modelización.html#cb119-44" tabindex="-1"></a><span class="co">#                        alpha = 0.22, show.legend = FALSE) +</span></span>
<span id="cb119-45"><a href="Modelización.html#cb119-45" tabindex="-1"></a><span class="co">#   ggplot2::geom_line(data = df_fc, ggplot2::aes(x = time, y = mean, color = modelo), linewidth = 1.0) +</span></span>
<span id="cb119-46"><a href="Modelización.html#cb119-46" tabindex="-1"></a><span class="co">#   ggplot2::scale_color_manual(values = c(&quot;HW Aditivo&quot;=&quot;#1f77b4&quot;, &quot;HW Multiplicativo&quot;=&quot;#d62728&quot;)) +</span></span>
<span id="cb119-47"><a href="Modelización.html#cb119-47" tabindex="-1"></a><span class="co">#   ggplot2::scale_fill_manual(values  = c(&quot;HW Aditivo&quot;=&quot;#1f77b4&quot;, &quot;HW Multiplicativo&quot;=&quot;#d62728&quot;)) +</span></span>
<span id="cb119-48"><a href="Modelización.html#cb119-48" tabindex="-1"></a><span class="co">#   ggplot2::labs(title = &quot;Pronóstico Holt–Winters — comparación&quot;,</span></span>
<span id="cb119-49"><a href="Modelización.html#cb119-49" tabindex="-1"></a><span class="co">#                 subtitle = &quot;Gris: TRAIN | Negro: </span><span class="al">TEST</span><span class="co"> | Colores: pronóstico&quot;,</span></span>
<span id="cb119-50"><a href="Modelización.html#cb119-50" tabindex="-1"></a><span class="co">#                 x = &quot;Tiempo&quot;, y = &quot;Potencia&quot;, color = &quot;Modelo&quot;) +</span></span>
<span id="cb119-51"><a href="Modelización.html#cb119-51" tabindex="-1"></a><span class="co">#   ggplot2::theme_minimal(base_size = 12) +</span></span>
<span id="cb119-52"><a href="Modelización.html#cb119-52" tabindex="-1"></a><span class="co">#   ggplot2::theme(plot.title = ggplot2::element_text(face = &quot;bold&quot;),</span></span>
<span id="cb119-53"><a href="Modelización.html#cb119-53" tabindex="-1"></a><span class="co">#                  panel.grid.minor = ggplot2::element_blank())</span></span></code></pre></div>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="Modelización.html#cb120-1" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">exists</span>(<span class="st">&quot;time_train&quot;</span>), <span class="fu">exists</span>(<span class="st">&quot;y_train&quot;</span>), <span class="fu">exists</span>(<span class="st">&quot;h&quot;</span>), <span class="fu">exists</span>(<span class="st">&quot;TZ&quot;</span>))</span>
<span id="cb120-2"><a href="Modelización.html#cb120-2" tabindex="-1"></a></span>
<span id="cb120-3"><a href="Modelización.html#cb120-3" tabindex="-1"></a><span class="co"># =========================================</span></span>
<span id="cb120-4"><a href="Modelización.html#cb120-4" tabindex="-1"></a><span class="co"># ZOOM: últimos 21 días + predicción HW</span></span>
<span id="cb120-5"><a href="Modelización.html#cb120-5" tabindex="-1"></a><span class="co"># Requiere: time_train, y_train, h, fc_hw_add / fc_hw_mul, TZ</span></span>
<span id="cb120-6"><a href="Modelización.html#cb120-6" tabindex="-1"></a><span class="co"># =========================================</span></span>
<span id="cb120-7"><a href="Modelización.html#cb120-7" tabindex="-1"></a></span>
<span id="cb120-8"><a href="Modelización.html#cb120-8" tabindex="-1"></a></span>
<span id="cb120-9"><a href="Modelización.html#cb120-9" tabindex="-1"></a><span class="co"># 1) Instantes clave</span></span>
<span id="cb120-10"><a href="Modelización.html#cb120-10" tabindex="-1"></a>t_train_end <span class="ot">&lt;-</span> <span class="fu">max</span>(time_train, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb120-11"><a href="Modelización.html#cb120-11" tabindex="-1"></a>f_times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> t_train_end <span class="sc">+</span> lubridate<span class="sc">::</span><span class="fu">hours</span>(<span class="dv">1</span>),</span>
<span id="cb120-12"><a href="Modelización.html#cb120-12" tabindex="-1"></a>               <span class="at">by   =</span> <span class="st">&quot;1 hour&quot;</span>,</span>
<span id="cb120-13"><a href="Modelización.html#cb120-13" tabindex="-1"></a>               <span class="at">length.out =</span> h)</span>
<span id="cb120-14"><a href="Modelización.html#cb120-14" tabindex="-1"></a></span>
<span id="cb120-15"><a href="Modelización.html#cb120-15" tabindex="-1"></a><span class="co"># 2) Histórico (solo últimos 21 días de TRAIN)</span></span>
<span id="cb120-16"><a href="Modelización.html#cb120-16" tabindex="-1"></a>history_days <span class="ot">&lt;-</span> <span class="dv">21</span></span>
<span id="cb120-17"><a href="Modelización.html#cb120-17" tabindex="-1"></a>t_zoom_ini   <span class="ot">&lt;-</span> t_train_end <span class="sc">-</span> lubridate<span class="sc">::</span><span class="fu">days</span>(history_days)</span>
<span id="cb120-18"><a href="Modelización.html#cb120-18" tabindex="-1"></a></span>
<span id="cb120-19"><a href="Modelización.html#cb120-19" tabindex="-1"></a>df_hist <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb120-20"><a href="Modelización.html#cb120-20" tabindex="-1"></a>  <span class="at">time =</span> time_train,</span>
<span id="cb120-21"><a href="Modelización.html#cb120-21" tabindex="-1"></a>  <span class="at">y    =</span> <span class="fu">as.numeric</span>(y_train)</span>
<span id="cb120-22"><a href="Modelización.html#cb120-22" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb120-23"><a href="Modelización.html#cb120-23" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(time <span class="sc">&gt;=</span> t_zoom_ini)</span>
<span id="cb120-24"><a href="Modelización.html#cb120-24" tabindex="-1"></a></span>
<span id="cb120-25"><a href="Modelización.html#cb120-25" tabindex="-1"></a><span class="co"># 3) Utilidad para llevar objetos forecast a data frame</span></span>
<span id="cb120-26"><a href="Modelización.html#cb120-26" tabindex="-1"></a>as_fc_df <span class="ot">&lt;-</span> <span class="cf">function</span>(fc, nombre) {</span>
<span id="cb120-27"><a href="Modelización.html#cb120-27" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(fc)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb120-28"><a href="Modelización.html#cb120-28" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb120-29"><a href="Modelización.html#cb120-29" tabindex="-1"></a>    <span class="at">time  =</span> f_times,</span>
<span id="cb120-30"><a href="Modelización.html#cb120-30" tabindex="-1"></a>    <span class="at">mean  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>mean),</span>
<span id="cb120-31"><a href="Modelización.html#cb120-31" tabindex="-1"></a>    <span class="at">lo80  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>lower[, <span class="st">&quot;80%&quot;</span>]),</span>
<span id="cb120-32"><a href="Modelización.html#cb120-32" tabindex="-1"></a>    <span class="at">hi80  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>upper[, <span class="st">&quot;80%&quot;</span>]),</span>
<span id="cb120-33"><a href="Modelización.html#cb120-33" tabindex="-1"></a>    <span class="at">lo95  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>lower[, <span class="st">&quot;95%&quot;</span>]),</span>
<span id="cb120-34"><a href="Modelización.html#cb120-34" tabindex="-1"></a>    <span class="at">hi95  =</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>upper[, <span class="st">&quot;95%&quot;</span>]),</span>
<span id="cb120-35"><a href="Modelización.html#cb120-35" tabindex="-1"></a>    <span class="at">modelo =</span> nombre</span>
<span id="cb120-36"><a href="Modelización.html#cb120-36" tabindex="-1"></a>  )</span>
<span id="cb120-37"><a href="Modelización.html#cb120-37" tabindex="-1"></a>}</span>
<span id="cb120-38"><a href="Modelización.html#cb120-38" tabindex="-1"></a></span>
<span id="cb120-39"><a href="Modelización.html#cb120-39" tabindex="-1"></a>df_add <span class="ot">&lt;-</span> <span class="fu">as_fc_df</span>(<span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_hw_add&quot;</span>)) fc_hw_add <span class="cf">else</span> <span class="cn">NULL</span>, <span class="st">&quot;HW Aditivo&quot;</span>)</span>
<span id="cb120-40"><a href="Modelización.html#cb120-40" tabindex="-1"></a>df_mul <span class="ot">&lt;-</span> <span class="fu">as_fc_df</span>(<span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_hw_mul&quot;</span>)) fc_hw_mul <span class="cf">else</span> <span class="cn">NULL</span>, <span class="st">&quot;HW Multiplicativo&quot;</span>)</span>
<span id="cb120-41"><a href="Modelización.html#cb120-41" tabindex="-1"></a>df_fc  <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(df_add, df_mul)</span>
<span id="cb120-42"><a href="Modelización.html#cb120-42" tabindex="-1"></a></span>
<span id="cb120-43"><a href="Modelización.html#cb120-43" tabindex="-1"></a><span class="co"># 4) Límite superior del eje X hasta el fin de la predicción</span></span>
<span id="cb120-44"><a href="Modelización.html#cb120-44" tabindex="-1"></a>t_fin <span class="ot">&lt;-</span> <span class="fu">max</span>(f_times, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb120-45"><a href="Modelización.html#cb120-45" tabindex="-1"></a></span>
<span id="cb120-46"><a href="Modelización.html#cb120-46" tabindex="-1"></a><span class="co"># 5) Gráfico: historia (21d) + pronóstico</span></span>
<span id="cb120-47"><a href="Modelización.html#cb120-47" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb120-48"><a href="Modelización.html#cb120-48" tabindex="-1"></a>  <span class="co"># Historia (fondo)</span></span>
<span id="cb120-49"><a href="Modelización.html#cb120-49" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data =</span> df_hist,</span>
<span id="cb120-50"><a href="Modelización.html#cb120-50" tabindex="-1"></a>                     ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> y),</span>
<span id="cb120-51"><a href="Modelización.html#cb120-51" tabindex="-1"></a>                     <span class="at">color =</span> <span class="st">&quot;grey40&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb120-52"><a href="Modelización.html#cb120-52" tabindex="-1"></a>  <span class="co"># Bandas 95% y 80%</span></span>
<span id="cb120-53"><a href="Modelización.html#cb120-53" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(<span class="at">data =</span> df_fc,</span>
<span id="cb120-54"><a href="Modelización.html#cb120-54" tabindex="-1"></a>                       ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">ymin =</span> lo95, <span class="at">ymax =</span> hi95, <span class="at">fill =</span> modelo),</span>
<span id="cb120-55"><a href="Modelización.html#cb120-55" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fl">0.12</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb120-56"><a href="Modelización.html#cb120-56" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(<span class="at">data =</span> df_fc,</span>
<span id="cb120-57"><a href="Modelización.html#cb120-57" tabindex="-1"></a>                       ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">ymin =</span> lo80, <span class="at">ymax =</span> hi80, <span class="at">fill =</span> modelo),</span>
<span id="cb120-58"><a href="Modelización.html#cb120-58" tabindex="-1"></a>                       <span class="at">alpha =</span> <span class="fl">0.22</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb120-59"><a href="Modelización.html#cb120-59" tabindex="-1"></a>  <span class="co"># Media pronosticada</span></span>
<span id="cb120-60"><a href="Modelización.html#cb120-60" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data =</span> df_fc,</span>
<span id="cb120-61"><a href="Modelización.html#cb120-61" tabindex="-1"></a>                     ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mean, <span class="at">color =</span> modelo),</span>
<span id="cb120-62"><a href="Modelización.html#cb120-62" tabindex="-1"></a>                     <span class="at">linewidth =</span> <span class="fl">1.0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb120-63"><a href="Modelización.html#cb120-63" tabindex="-1"></a>  <span class="co"># Escalas y estilo</span></span>
<span id="cb120-64"><a href="Modelización.html#cb120-64" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;HW Aditivo&quot;</span><span class="ot">=</span><span class="st">&quot;#1f77b4&quot;</span>, <span class="st">&quot;HW Multiplicativo&quot;</span><span class="ot">=</span><span class="st">&quot;#d62728&quot;</span>)) <span class="sc">+</span></span>
<span id="cb120-65"><a href="Modelización.html#cb120-65" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values  =</span> <span class="fu">c</span>(<span class="st">&quot;HW Aditivo&quot;</span><span class="ot">=</span><span class="st">&quot;#1f77b4&quot;</span>, <span class="st">&quot;HW Multiplicativo&quot;</span><span class="ot">=</span><span class="st">&quot;#d62728&quot;</span>)) <span class="sc">+</span></span>
<span id="cb120-66"><a href="Modelización.html#cb120-66" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_datetime</span>(<span class="at">limits =</span> <span class="fu">c</span>(t_zoom_ini, t_fin),</span>
<span id="cb120-67"><a href="Modelización.html#cb120-67" tabindex="-1"></a>                            <span class="at">date_breaks =</span> <span class="st">&quot;3 days&quot;</span>, <span class="at">date_labels =</span> <span class="st">&quot;%d-%b&quot;</span>) <span class="sc">+</span></span>
<span id="cb120-68"><a href="Modelización.html#cb120-68" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(<span class="at">x =</span> ggplot2<span class="sc">::</span><span class="fu">guide_axis</span>(<span class="at">n.dodge =</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb120-69"><a href="Modelización.html#cb120-69" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb120-70"><a href="Modelización.html#cb120-70" tabindex="-1"></a>    <span class="at">title    =</span> <span class="st">&quot;Últimos 21 días + predicción Holt–Winters&quot;</span>,</span>
<span id="cb120-71"><a href="Modelización.html#cb120-71" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Historia (gris) y media pronosticada con bandas de confianza (80% y 95%)&quot;</span>,</span>
<span id="cb120-72"><a href="Modelización.html#cb120-72" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia&quot;</span>, <span class="at">color =</span> <span class="st">&quot;Modelo&quot;</span></span>
<span id="cb120-73"><a href="Modelización.html#cb120-73" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb120-74"><a href="Modelización.html#cb120-74" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb120-75"><a href="Modelización.html#cb120-75" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb120-76"><a href="Modelización.html#cb120-76" tabindex="-1"></a>    <span class="at">plot.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb120-77"><a href="Modelización.html#cb120-77" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb120-78"><a href="Modelización.html#cb120-78" tabindex="-1"></a>    <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">35</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb120-79"><a href="Modelización.html#cb120-79" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/hw-zoom-21d-1.png" width="1056" /></p>
<ul>
<li><p>En la gráfica el Color gris representa los valores reales de la serie (últimos 21 días antes del pronóstico). Las líneas de color (azul y rojo): media del pronóstico para cada modelo (Azul: Holt–Winters aditivo / Rojo: Holt–Winters multiplicativo). Y las sombras corresponden a las bandas de confianza del 80% (más oscuras) y 95% (más claras), que indican la incertidumbre del pronóstico.</p></li>
<li><p>Se observan oscilaciones regulares y cíclicas con picos diarios, lo cual indica una fuerte estacionalidad intradía (24h).</p></li>
<li><p>La amplitud de los ciclos es relativamente estable, sin tendencia ascendente ni descendente marcada, confirmando que la serie es altamente estacional y estacionaria en media.</p></li>
<li><p>Ambos modelos (aditivo y multiplicativo) mantienen el patrón periódico observado en los datos reales, lo que demuestra una buena captura de la estacionalidad.</p></li>
<li><p>Las predicciones oscilan con amplitudes muy similares a las observadas, tanto el modelo multiplicativo (rojo) como el modelo aditivo (azul) mantienen una amplitud constante en el periodo predicción, sin embargo, el modelo aditivo tiene una mayor amplitud con respecto al modelo multiplicativo.</p></li>
<li><p>Las bandas del 80% y 95% crecen gradualmente hacia el futuro, reflejando el aumento de la incertidumbre a medida que se pronostica más lejos.</p></li>
<li><p>La superposición de las zonas azul y roja indica que ambos modelos ofrecen pronósticos muy próximos, lo cual sugiere que la serie no tiene una varianza fuertemente dependiente del nivel.</p></li>
<li><p>El modelo Holt–Winters reproduce con éxito el comportamiento estacional de la serie en sus últimas semanas.</p></li>
<li><p>Ambas versiones (aditiva y multiplicativa) generan pronósticos coherentes, capturando el patrón de ciclos diarios sin desviaciones abruptas.</p></li>
</ul>
</div>
<div id="evaluación-en-test-mape-y-rmse" class="section level2 hasAnchor" number="5.7">
<h2><span class="header-section-number">5.7</span> Evaluación en TEST (MAPE y RMSE)<a href="Modelización.html#evaluaci%C3%B3n-en-test-mape-y-rmse" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="Modelización.html#cb121-1" tabindex="-1"></a><span class="co"># =========================================</span></span>
<span id="cb121-2"><a href="Modelización.html#cb121-2" tabindex="-1"></a><span class="co"># Evaluación (MAPE y RMSE) sobre </span><span class="al">TEST</span></span>
<span id="cb121-3"><a href="Modelización.html#cb121-3" tabindex="-1"></a><span class="co"># Usa: y_test, h, fc_hw_add, fc_hw_mul, rmse(), mape()</span></span>
<span id="cb121-4"><a href="Modelización.html#cb121-4" tabindex="-1"></a><span class="co"># =========================================</span></span>
<span id="cb121-5"><a href="Modelización.html#cb121-5" tabindex="-1"></a></span>
<span id="cb121-6"><a href="Modelización.html#cb121-6" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">exists</span>(<span class="st">&quot;y_test&quot;</span>), <span class="fu">exists</span>(<span class="st">&quot;h&quot;</span>))</span>
<span id="cb121-7"><a href="Modelización.html#cb121-7" tabindex="-1"></a></span>
<span id="cb121-8"><a href="Modelización.html#cb121-8" tabindex="-1"></a><span class="co"># Longitud efectiva para comparar</span></span>
<span id="cb121-9"><a href="Modelización.html#cb121-9" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(y_test), h)</span>
<span id="cb121-10"><a href="Modelización.html#cb121-10" tabindex="-1"></a></span>
<span id="cb121-11"><a href="Modelización.html#cb121-11" tabindex="-1"></a>y_test_vec <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(y_test)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb121-12"><a href="Modelización.html#cb121-12" tabindex="-1"></a>pred_add   <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fc_hw_add)) <span class="fu">as.numeric</span>(fc_hw_add<span class="sc">$</span>mean)[<span class="fu">seq_len</span>(k)] <span class="cf">else</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, k)</span>
<span id="cb121-13"><a href="Modelización.html#cb121-13" tabindex="-1"></a>pred_mul   <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fc_hw_mul)) <span class="fu">as.numeric</span>(fc_hw_mul<span class="sc">$</span>mean)[<span class="fu">seq_len</span>(k)] <span class="cf">else</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, k)</span>
<span id="cb121-14"><a href="Modelización.html#cb121-14" tabindex="-1"></a></span>
<span id="cb121-15"><a href="Modelización.html#cb121-15" tabindex="-1"></a><span class="co"># Métricas auxiliares (por si no existen)</span></span>
<span id="cb121-16"><a href="Modelización.html#cb121-16" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;rmse&quot;</span>, <span class="at">mode =</span> <span class="st">&quot;function&quot;</span>)) {</span>
<span id="cb121-17"><a href="Modelización.html#cb121-17" tabindex="-1"></a>  rmse <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, pred) <span class="fu">sqrt</span>(<span class="fu">mean</span>((obs <span class="sc">-</span> pred)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb121-18"><a href="Modelización.html#cb121-18" tabindex="-1"></a>}</span>
<span id="cb121-19"><a href="Modelización.html#cb121-19" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;mape&quot;</span>, <span class="at">mode =</span> <span class="st">&quot;function&quot;</span>)) {</span>
<span id="cb121-20"><a href="Modelización.html#cb121-20" tabindex="-1"></a>  mape <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, pred) {</span>
<span id="cb121-21"><a href="Modelización.html#cb121-21" tabindex="-1"></a>    ok <span class="ot">&lt;-</span> obs <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">is.finite</span>(obs) <span class="sc">&amp;</span> <span class="fu">is.finite</span>(pred)</span>
<span id="cb121-22"><a href="Modelización.html#cb121-22" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(ok)) <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb121-23"><a href="Modelización.html#cb121-23" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>((obs[ok] <span class="sc">-</span> pred[ok]) <span class="sc">/</span> obs[ok])) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb121-24"><a href="Modelización.html#cb121-24" tabindex="-1"></a>  }</span>
<span id="cb121-25"><a href="Modelización.html#cb121-25" tabindex="-1"></a>}</span>
<span id="cb121-26"><a href="Modelización.html#cb121-26" tabindex="-1"></a></span>
<span id="cb121-27"><a href="Modelización.html#cb121-27" tabindex="-1"></a>tab_hw <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb121-28"><a href="Modelización.html#cb121-28" tabindex="-1"></a>  <span class="at">Modelo =</span> <span class="fu">c</span>(<span class="st">&quot;HW Aditivo&quot;</span>, <span class="st">&quot;HW Multiplicativo&quot;</span>),</span>
<span id="cb121-29"><a href="Modelización.html#cb121-29" tabindex="-1"></a>  <span class="at">RMSE   =</span> <span class="fu">c</span>(<span class="fu">rmse</span>(y_test_vec, pred_add),</span>
<span id="cb121-30"><a href="Modelización.html#cb121-30" tabindex="-1"></a>             <span class="fu">rmse</span>(y_test_vec, pred_mul)),</span>
<span id="cb121-31"><a href="Modelización.html#cb121-31" tabindex="-1"></a>  <span class="at">MAPE   =</span> <span class="fu">c</span>(<span class="fu">mape</span>(y_test_vec, pred_add),</span>
<span id="cb121-32"><a href="Modelización.html#cb121-32" tabindex="-1"></a>             <span class="fu">mape</span>(y_test_vec, pred_mul))</span>
<span id="cb121-33"><a href="Modelización.html#cb121-33" tabindex="-1"></a>)</span>
<span id="cb121-34"><a href="Modelización.html#cb121-34" tabindex="-1"></a></span>
<span id="cb121-35"><a href="Modelización.html#cb121-35" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(tab_hw, <span class="at">digits =</span> <span class="dv">3</span>, <span class="at">caption =</span> <span class="st">&quot;Evaluación en TEST (MAPE y RMSE) — Holt–Winters&quot;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:hw-test-metrics">Table 5.1: </span>Evaluación en TEST (MAPE y RMSE) — Holt–Winters</caption>
<thead>
<tr class="header">
<th align="left">Modelo</th>
<th align="right">RMSE</th>
<th align="right">MAPE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HW Aditivo</td>
<td align="right">468.700</td>
<td align="right">37.098</td>
</tr>
<tr class="even">
<td align="left">HW Multiplicativo</td>
<td align="right">394.586</td>
<td align="right">31.117</td>
</tr>
</tbody>
</table>
<ul>
<li><p>El modelo multiplicativo tiene un RMSE un 15.8% menor que el aditivo. Esto significa que, en promedio, las desviaciones entre los valores reales y pronosticados son menores en magnitud. El modelo aditivo aún predice bien, pero con mayor dispersión en torno a los valores reales.</p></li>
<li><p>El Holt–Winters multiplicativo reduce los errores absolutos y genera pronósticos más estables.</p></li>
<li><p>El MAPE de 31.1% para el modelo multiplicativo indica que, en promedio, las predicciones se desvían un 31% del valor real. En comparación, el modelo aditivo presenta 37.1%, es decir, un error relativo un poco mayor.</p></li>
<li><p>Aunque ambos valores se ubican en el rango “moderadamente precisos”, el modelo multiplicativo es claramente superior.</p></li>
<li><p>La diferencia entre ambos modelos refleja cómo cada versión maneja la relación entre nivel y variabilidad de la serie, en el modelo aditivo, la amplitud de las fluctuaciones es constante mientras que en el modelo multiplicativo, la amplitud crece o disminuye proporcionalmente al nivel de la serie. Dado que la serie de potencia muestra cierta variación en su amplitud (es decir, cuando la potencia aumenta, las oscilaciones también son mayores), el modelo multiplicativo se adapta mejor a esa estructura heterocedástica.</p></li>
<li><p>El modelo Holt–Winters multiplicativo ofrece mejor precisión (MAPE 31.1%) y menor error absoluto (RMSE 394.6) que el aditivo. Esto confirma que la serie presenta fluctuaciones proporcionales a su nivel, y que el enfoque multiplicativo se ajusta mejor al comportamiento real de la potencia, proporcionando pronósticos más consistentes y confiables.</p></li>
</ul>
</div>
<div id="comparación-con-un-arima-simple" class="section level2 hasAnchor" number="5.8">
<h2><span class="header-section-number">5.8</span> Comparación con un ARIMA simple<a href="Modelización.html#comparaci%C3%B3n-con-un-arima-simple" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="Modelización.html#cb122-1" tabindex="-1"></a><span class="co"># =========================================</span></span>
<span id="cb122-2"><a href="Modelización.html#cb122-2" tabindex="-1"></a><span class="co"># Comparación con ARIMA simple (auto.arima)</span></span>
<span id="cb122-3"><a href="Modelización.html#cb122-3" tabindex="-1"></a><span class="co"># Usa: y_train, y_test, h, arima_approx, rmse(), mape()</span></span>
<span id="cb122-4"><a href="Modelización.html#cb122-4" tabindex="-1"></a><span class="co"># =========================================</span></span>
<span id="cb122-5"><a href="Modelización.html#cb122-5" tabindex="-1"></a></span>
<span id="cb122-6"><a href="Modelización.html#cb122-6" tabindex="-1"></a><span class="co"># Cronometría</span></span>
<span id="cb122-7"><a href="Modelización.html#cb122-7" tabindex="-1"></a>t0 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb122-8"><a href="Modelización.html#cb122-8" tabindex="-1"></a></span>
<span id="cb122-9"><a href="Modelización.html#cb122-9" tabindex="-1"></a>fit_arima_simple <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">auto.arima</span>(</span>
<span id="cb122-10"><a href="Modelización.html#cb122-10" tabindex="-1"></a>  y_train,</span>
<span id="cb122-11"><a href="Modelización.html#cb122-11" tabindex="-1"></a>  <span class="at">seasonal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb122-12"><a href="Modelización.html#cb122-12" tabindex="-1"></a>  <span class="at">stepwise =</span> <span class="cn">TRUE</span>,</span>
<span id="cb122-13"><a href="Modelización.html#cb122-13" tabindex="-1"></a>  <span class="at">approximation =</span> arima_approx</span>
<span id="cb122-14"><a href="Modelización.html#cb122-14" tabindex="-1"></a>)</span>
<span id="cb122-15"><a href="Modelización.html#cb122-15" tabindex="-1"></a></span>
<span id="cb122-16"><a href="Modelización.html#cb122-16" tabindex="-1"></a>fc_arima_simple <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">forecast</span>(fit_arima_simple, <span class="at">h =</span> h)</span>
<span id="cb122-17"><a href="Modelización.html#cb122-17" tabindex="-1"></a></span>
<span id="cb122-18"><a href="Modelización.html#cb122-18" tabindex="-1"></a><span class="co"># Comparar en </span><span class="al">TEST</span></span>
<span id="cb122-19"><a href="Modelización.html#cb122-19" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(y_test), h)</span>
<span id="cb122-20"><a href="Modelización.html#cb122-20" tabindex="-1"></a>pred_arima <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(fc_arima_simple<span class="sc">$</span>mean)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb122-21"><a href="Modelización.html#cb122-21" tabindex="-1"></a>y_test_vec <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(y_test)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb122-22"><a href="Modelización.html#cb122-22" tabindex="-1"></a></span>
<span id="cb122-23"><a href="Modelización.html#cb122-23" tabindex="-1"></a>tab_cmp <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb122-24"><a href="Modelización.html#cb122-24" tabindex="-1"></a>  <span class="at">Modelo =</span> <span class="fu">c</span>(<span class="st">&quot;HW Aditivo&quot;</span>, <span class="st">&quot;HW Multiplicativo&quot;</span>, <span class="st">&quot;ARIMA simple&quot;</span>),</span>
<span id="cb122-25"><a href="Modelización.html#cb122-25" tabindex="-1"></a>  <span class="at">RMSE   =</span> <span class="fu">c</span>(</span>
<span id="cb122-26"><a href="Modelización.html#cb122-26" tabindex="-1"></a>    <span class="fu">rmse</span>(y_test_vec, <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fc_hw_add)) <span class="fu">as.numeric</span>(fc_hw_add<span class="sc">$</span>mean)[<span class="fu">seq_len</span>(k)] <span class="cf">else</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, k)),</span>
<span id="cb122-27"><a href="Modelización.html#cb122-27" tabindex="-1"></a>    <span class="fu">rmse</span>(y_test_vec, <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fc_hw_mul)) <span class="fu">as.numeric</span>(fc_hw_mul<span class="sc">$</span>mean)[<span class="fu">seq_len</span>(k)] <span class="cf">else</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, k)),</span>
<span id="cb122-28"><a href="Modelización.html#cb122-28" tabindex="-1"></a>    <span class="fu">rmse</span>(y_test_vec, pred_arima)</span>
<span id="cb122-29"><a href="Modelización.html#cb122-29" tabindex="-1"></a>  ),</span>
<span id="cb122-30"><a href="Modelización.html#cb122-30" tabindex="-1"></a>  <span class="at">MAPE   =</span> <span class="fu">c</span>(</span>
<span id="cb122-31"><a href="Modelización.html#cb122-31" tabindex="-1"></a>    <span class="fu">mape</span>(y_test_vec, <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fc_hw_add)) <span class="fu">as.numeric</span>(fc_hw_add<span class="sc">$</span>mean)[<span class="fu">seq_len</span>(k)] <span class="cf">else</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, k)),</span>
<span id="cb122-32"><a href="Modelización.html#cb122-32" tabindex="-1"></a>    <span class="fu">mape</span>(y_test_vec, <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fc_hw_mul)) <span class="fu">as.numeric</span>(fc_hw_mul<span class="sc">$</span>mean)[<span class="fu">seq_len</span>(k)] <span class="cf">else</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, k)),</span>
<span id="cb122-33"><a href="Modelización.html#cb122-33" tabindex="-1"></a>    <span class="fu">mape</span>(y_test_vec, pred_arima)</span>
<span id="cb122-34"><a href="Modelización.html#cb122-34" tabindex="-1"></a>  )</span>
<span id="cb122-35"><a href="Modelización.html#cb122-35" tabindex="-1"></a>)</span>
<span id="cb122-36"><a href="Modelización.html#cb122-36" tabindex="-1"></a></span>
<span id="cb122-37"><a href="Modelización.html#cb122-37" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(tab_cmp, <span class="at">digits =</span> <span class="dv">3</span>, <span class="at">caption =</span> <span class="st">&quot;Comparación en TEST — Holt–Winters vs. ARIMA simple&quot;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:hw-vs-arima">Table 5.2: </span>Comparación en TEST — Holt–Winters vs. ARIMA simple</caption>
<thead>
<tr class="header">
<th align="left">Modelo</th>
<th align="right">RMSE</th>
<th align="right">MAPE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HW Aditivo</td>
<td align="right">468.700</td>
<td align="right">37.098</td>
</tr>
<tr class="even">
<td align="left">HW Multiplicativo</td>
<td align="right">394.586</td>
<td align="right">31.117</td>
</tr>
<tr class="odd">
<td align="left">ARIMA simple</td>
<td align="right">325.303</td>
<td align="right">27.377</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="Modelización.html#cb123-1" tabindex="-1"></a><span class="co"># Cronometría (si usas el registrador .timing)</span></span>
<span id="cb123-2"><a href="Modelización.html#cb123-2" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;.timing&quot;</span>)) {</span>
<span id="cb123-3"><a href="Modelización.html#cb123-3" tabindex="-1"></a>  .timing[[<span class="st">&quot;HW - ARIMA simple&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb123-4"><a href="Modelización.html#cb123-4" tabindex="-1"></a>    <span class="at">seconds =</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(<span class="fu">Sys.time</span>(), t0, <span class="at">units =</span> <span class="st">&quot;secs&quot;</span>)),</span>
<span id="cb123-5"><a href="Modelización.html#cb123-5" tabindex="-1"></a>    <span class="at">status  =</span> <span class="st">&quot;OK&quot;</span>,</span>
<span id="cb123-6"><a href="Modelización.html#cb123-6" tabindex="-1"></a>    <span class="at">message =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb123-7"><a href="Modelización.html#cb123-7" tabindex="-1"></a>  )</span>
<span id="cb123-8"><a href="Modelización.html#cb123-8" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li><p>El modelo ARIMA simple logra el mejor desempeño predictivo, con un RMSE de 325.3 y un MAPE de 27.4%, superando significativamente a las versiones de Holt–Winters. Esto indica que la serie presenta autocorrelaciones y fluctuaciones no perfectamente estacionales, las cuales ARIMA logra capturar mejor.</p></li>
<li><p>Los modelos Holt–Winters siguen siendo útiles como referencia y ofrecen pronósticos razonables, pero suponen una estructura estacional más rígida, lo que limita su precisión frente al ARIMA.</p></li>
<li><p>El nivel de error obtenido (MAPE &lt; 30%) es aceptable y operativo, mostrando que los pronósticos pueden emplearse con confianza en planificación o simulación de demanda energética.</p></li>
</ul>
</div>
<div id="holt-winter-en-boxcox-ajuste-pronóstico-en-bc-reconversión-a-escala-original" class="section level2 hasAnchor" number="5.9">
<h2><span class="header-section-number">5.9</span> Holt Winter en Box–Cox (ajuste + pronóstico en BC + reconversión a escala original)<a href="Modelización.html#holt-winter-en-boxcox-ajuste-pron%C3%B3stico-en-bc-reconversi%C3%B3n-a-escala-original" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="Modelización.html#cb124-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb124-2"><a href="Modelización.html#cb124-2" tabindex="-1"></a><span class="co"># Holt–Winters sobre la serie Box–Cox (aditivo en varianza estabilizada)</span></span>
<span id="cb124-3"><a href="Modelización.html#cb124-3" tabindex="-1"></a><span class="co"># Requiere: y_train_bc (ts), y_test_bc (ts), lambda_hw, inv_boxcox(), h</span></span>
<span id="cb124-4"><a href="Modelización.html#cb124-4" tabindex="-1"></a><span class="co"># Expone:   fc_hw_bc (forecast en BC) y df_hw_bc (pronóstico reconvertido)</span></span>
<span id="cb124-5"><a href="Modelización.html#cb124-5" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb124-6"><a href="Modelización.html#cb124-6" tabindex="-1"></a></span>
<span id="cb124-7"><a href="Modelización.html#cb124-7" tabindex="-1"></a><span class="co"># Cronometría</span></span>
<span id="cb124-8"><a href="Modelización.html#cb124-8" tabindex="-1"></a>t0 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb124-9"><a href="Modelización.html#cb124-9" tabindex="-1"></a></span>
<span id="cb124-10"><a href="Modelización.html#cb124-10" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">exists</span>(<span class="st">&quot;y_train_bc&quot;</span>), <span class="fu">exists</span>(<span class="st">&quot;lambda_hw&quot;</span>), <span class="fu">exists</span>(<span class="st">&quot;inv_boxcox&quot;</span>))</span>
<span id="cb124-11"><a href="Modelización.html#cb124-11" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="st">&quot;ggfortify&quot;</span> <span class="sc">%in%</span> <span class="fu">.packages</span>()) <span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(ggfortify))</span>
<span id="cb124-12"><a href="Modelización.html#cb124-12" tabindex="-1"></a></span>
<span id="cb124-13"><a href="Modelización.html#cb124-13" tabindex="-1"></a><span class="co"># Ajuste HW aditivo en la escala Box–Cox</span></span>
<span id="cb124-14"><a href="Modelización.html#cb124-14" tabindex="-1"></a>fc_hw_bc <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">hw</span>(y_train_bc, <span class="at">seasonal =</span> <span class="st">&quot;additive&quot;</span>, <span class="at">h =</span> h)</span>
<span id="cb124-15"><a href="Modelización.html#cb124-15" tabindex="-1"></a></span>
<span id="cb124-16"><a href="Modelización.html#cb124-16" tabindex="-1"></a><span class="co"># Reconversión a escala original (aprox. aplicando inversa a banda y media)</span></span>
<span id="cb124-17"><a href="Modelización.html#cb124-17" tabindex="-1"></a><span class="co"># NOTA: transformar límites por separado no preserva exactamente la cobertura,</span></span>
<span id="cb124-18"><a href="Modelización.html#cb124-18" tabindex="-1"></a><span class="co"># pero es la práctica usual para visualización/comparación.</span></span>
<span id="cb124-19"><a href="Modelización.html#cb124-19" tabindex="-1"></a>bc_to_orig <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">inv_boxcox</span>(x, lambda_hw)</span>
<span id="cb124-20"><a href="Modelización.html#cb124-20" tabindex="-1"></a></span>
<span id="cb124-21"><a href="Modelización.html#cb124-21" tabindex="-1"></a><span class="co"># Tiempos para el pronóstico: siguen el final de TRAIN real</span></span>
<span id="cb124-22"><a href="Modelización.html#cb124-22" tabindex="-1"></a>t_train_end <span class="ot">&lt;-</span> <span class="fu">max</span>(time_train, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb124-23"><a href="Modelización.html#cb124-23" tabindex="-1"></a>f_times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> t_train_end <span class="sc">+</span> lubridate<span class="sc">::</span><span class="fu">hours</span>(<span class="dv">1</span>),</span>
<span id="cb124-24"><a href="Modelización.html#cb124-24" tabindex="-1"></a>               <span class="at">by   =</span> <span class="st">&quot;1 hour&quot;</span>, <span class="at">length.out =</span> h)</span>
<span id="cb124-25"><a href="Modelización.html#cb124-25" tabindex="-1"></a></span>
<span id="cb124-26"><a href="Modelización.html#cb124-26" tabindex="-1"></a>df_hw_bc <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb124-27"><a href="Modelización.html#cb124-27" tabindex="-1"></a>  <span class="at">time =</span> f_times,</span>
<span id="cb124-28"><a href="Modelización.html#cb124-28" tabindex="-1"></a>  <span class="at">mean =</span> <span class="fu">bc_to_orig</span>(<span class="fu">as.numeric</span>(fc_hw_bc<span class="sc">$</span>mean)),</span>
<span id="cb124-29"><a href="Modelización.html#cb124-29" tabindex="-1"></a>  <span class="at">lo80 =</span> <span class="fu">bc_to_orig</span>(<span class="fu">as.numeric</span>(fc_hw_bc<span class="sc">$</span>lower[, <span class="st">&quot;80%&quot;</span>])),</span>
<span id="cb124-30"><a href="Modelización.html#cb124-30" tabindex="-1"></a>  <span class="at">hi80 =</span> <span class="fu">bc_to_orig</span>(<span class="fu">as.numeric</span>(fc_hw_bc<span class="sc">$</span>upper[, <span class="st">&quot;80%&quot;</span>])),</span>
<span id="cb124-31"><a href="Modelización.html#cb124-31" tabindex="-1"></a>  <span class="at">lo95 =</span> <span class="fu">bc_to_orig</span>(<span class="fu">as.numeric</span>(fc_hw_bc<span class="sc">$</span>lower[, <span class="st">&quot;95%&quot;</span>])),</span>
<span id="cb124-32"><a href="Modelización.html#cb124-32" tabindex="-1"></a>  <span class="at">hi95 =</span> <span class="fu">bc_to_orig</span>(<span class="fu">as.numeric</span>(fc_hw_bc<span class="sc">$</span>upper[, <span class="st">&quot;95%&quot;</span>]))</span>
<span id="cb124-33"><a href="Modelización.html#cb124-33" tabindex="-1"></a>)</span>
<span id="cb124-34"><a href="Modelización.html#cb124-34" tabindex="-1"></a></span>
<span id="cb124-35"><a href="Modelización.html#cb124-35" tabindex="-1"></a><span class="co"># # Vista rápida del forecast en BC</span></span>
<span id="cb124-36"><a href="Modelización.html#cb124-36" tabindex="-1"></a><span class="co"># autoplot(fc_hw_bc) +</span></span>
<span id="cb124-37"><a href="Modelización.html#cb124-37" tabindex="-1"></a><span class="co">#   labs(title = &quot;Pronóstico Holt–Winters (Box–Cox, escala BC)&quot;,</span></span>
<span id="cb124-38"><a href="Modelización.html#cb124-38" tabindex="-1"></a><span class="co">#        x = &quot;Tiempo&quot;, y = &quot;Valor (Box–Cox)&quot;) +</span></span>
<span id="cb124-39"><a href="Modelización.html#cb124-39" tabindex="-1"></a><span class="co">#   theme_minimal(base_size = 12)</span></span>
<span id="cb124-40"><a href="Modelización.html#cb124-40" tabindex="-1"></a></span>
<span id="cb124-41"><a href="Modelización.html#cb124-41" tabindex="-1"></a><span class="co"># Cronometría (si usas el registrador .timing)</span></span>
<span id="cb124-42"><a href="Modelización.html#cb124-42" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;.timing&quot;</span>)) {</span>
<span id="cb124-43"><a href="Modelización.html#cb124-43" tabindex="-1"></a>  .timing[[<span class="st">&quot;HW - Box-CoX&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb124-44"><a href="Modelización.html#cb124-44" tabindex="-1"></a>    <span class="at">seconds =</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(<span class="fu">Sys.time</span>(), t0, <span class="at">units =</span> <span class="st">&quot;secs&quot;</span>)),</span>
<span id="cb124-45"><a href="Modelización.html#cb124-45" tabindex="-1"></a>    <span class="at">status  =</span> <span class="st">&quot;OK&quot;</span>,</span>
<span id="cb124-46"><a href="Modelización.html#cb124-46" tabindex="-1"></a>    <span class="at">message =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb124-47"><a href="Modelización.html#cb124-47" tabindex="-1"></a>  )</span>
<span id="cb124-48"><a href="Modelización.html#cb124-48" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="gráfica-comparativa-traintest-en-original-hw-boxcox-reconvertido" class="section level2 hasAnchor" number="5.10">
<h2><span class="header-section-number">5.10</span> Gráfica comparativa (TRAIN/TEST en original) + HW Box–Cox reconvertido<a href="Modelización.html#gr%C3%A1fica-comparativa-traintest-en-original-hw-boxcox-reconvertido" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="Modelización.html#cb125-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb125-2"><a href="Modelización.html#cb125-2" tabindex="-1"></a><span class="co"># Overlay en escala original:</span></span>
<span id="cb125-3"><a href="Modelización.html#cb125-3" tabindex="-1"></a><span class="co">#  - TRAIN (gris) y </span><span class="al">TEST</span><span class="co"> (negro)</span></span>
<span id="cb125-4"><a href="Modelización.html#cb125-4" tabindex="-1"></a><span class="co">#  - Pronóstico HW Box–Cox reconvertido (azul)</span></span>
<span id="cb125-5"><a href="Modelización.html#cb125-5" tabindex="-1"></a><span class="co"># Requiere: time_train, time_test, y_train (original), y_test (original), df_hw_bc</span></span>
<span id="cb125-6"><a href="Modelización.html#cb125-6" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb125-7"><a href="Modelización.html#cb125-7" tabindex="-1"></a></span>
<span id="cb125-8"><a href="Modelización.html#cb125-8" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">exists</span>(<span class="st">&quot;df_hw_bc&quot;</span>))</span>
<span id="cb125-9"><a href="Modelización.html#cb125-9" tabindex="-1"></a></span>
<span id="cb125-10"><a href="Modelización.html#cb125-10" tabindex="-1"></a>df_train <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">time =</span> time_train, <span class="at">y =</span> <span class="fu">as.numeric</span>(y_train), <span class="at">conj =</span> <span class="st">&quot;TRAIN&quot;</span>)</span>
<span id="cb125-11"><a href="Modelización.html#cb125-11" tabindex="-1"></a>df_test  <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">time =</span> time_test,  <span class="at">y =</span> <span class="fu">as.numeric</span>(y_test),  <span class="at">conj =</span> <span class="st">&quot;TEST&quot;</span>)</span>
<span id="cb125-12"><a href="Modelización.html#cb125-12" tabindex="-1"></a></span>
<span id="cb125-13"><a href="Modelización.html#cb125-13" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb125-14"><a href="Modelización.html#cb125-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data =</span> df_train, ggplot2<span class="sc">::</span><span class="fu">aes</span>(time, y), <span class="at">color =</span> <span class="st">&quot;grey65&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.45</span>) <span class="sc">+</span></span>
<span id="cb125-15"><a href="Modelización.html#cb125-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data =</span> df_test,  ggplot2<span class="sc">::</span><span class="fu">aes</span>(time, y), <span class="at">color =</span> <span class="st">&quot;black&quot;</span>,  <span class="at">linewidth =</span> <span class="fl">0.60</span>)  <span class="sc">+</span></span>
<span id="cb125-16"><a href="Modelización.html#cb125-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(<span class="at">data =</span> df_hw_bc, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">ymin =</span> lo95, <span class="at">ymax =</span> hi95),</span>
<span id="cb125-17"><a href="Modelización.html#cb125-17" tabindex="-1"></a>                       <span class="at">fill =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.12</span>) <span class="sc">+</span></span>
<span id="cb125-18"><a href="Modelización.html#cb125-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(<span class="at">data =</span> df_hw_bc, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">ymin =</span> lo80, <span class="at">ymax =</span> hi80),</span>
<span id="cb125-19"><a href="Modelización.html#cb125-19" tabindex="-1"></a>                       <span class="at">fill =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.22</span>) <span class="sc">+</span></span>
<span id="cb125-20"><a href="Modelización.html#cb125-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data =</span> df_hw_bc, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mean),</span>
<span id="cb125-21"><a href="Modelización.html#cb125-21" tabindex="-1"></a>                     <span class="at">color =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">linewidth =</span> <span class="fl">1.0</span>) <span class="sc">+</span></span>
<span id="cb125-22"><a href="Modelización.html#cb125-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Pronóstico Holt–Winters (Box–Cox → escala original)&quot;</span>,</span>
<span id="cb125-23"><a href="Modelización.html#cb125-23" tabindex="-1"></a>                <span class="at">subtitle =</span> <span class="st">&quot;Gris: TRAIN | Negro: TEST | Azul: pronóstico reconvertido&quot;</span>,</span>
<span id="cb125-24"><a href="Modelización.html#cb125-24" tabindex="-1"></a>                <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia&quot;</span>) <span class="sc">+</span></span>
<span id="cb125-25"><a href="Modelización.html#cb125-25" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb125-26"><a href="Modelización.html#cb125-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">plot.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb125-27"><a href="Modelización.html#cb125-27" tabindex="-1"></a>                 <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/hw-bc-plot-1.png" width="960" /></p>
</div>
<div id="zoom-al-pronóstico-holt-winter-boxcox-en-original" class="section level2 hasAnchor" number="5.11">
<h2><span class="header-section-number">5.11</span> Zoom al pronóstico Holt Winter Box–Cox en original<a href="Modelización.html#zoom-al-pron%C3%B3stico-holt-winter-boxcox-en-original" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="Modelización.html#cb126-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb126-2"><a href="Modelización.html#cb126-2" tabindex="-1"></a><span class="co"># Zoom al pronóstico HW Box–Cox reconvertido (últimos N días)</span></span>
<span id="cb126-3"><a href="Modelización.html#cb126-3" tabindex="-1"></a><span class="co"># Requiere: df_hw_bc, df_impu, time_col, TZ</span></span>
<span id="cb126-4"><a href="Modelización.html#cb126-4" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb126-5"><a href="Modelización.html#cb126-5" tabindex="-1"></a></span>
<span id="cb126-6"><a href="Modelización.html#cb126-6" tabindex="-1"></a>history_days <span class="ot">&lt;-</span> <span class="dv">21</span></span>
<span id="cb126-7"><a href="Modelización.html#cb126-7" tabindex="-1"></a></span>
<span id="cb126-8"><a href="Modelización.html#cb126-8" tabindex="-1"></a>hist_df <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb126-9"><a href="Modelización.html#cb126-9" tabindex="-1"></a>  <span class="at">time =</span> <span class="fu">as.POSIXct</span>(df_impu[[time_col]], <span class="at">tz =</span> TZ),</span>
<span id="cb126-10"><a href="Modelización.html#cb126-10" tabindex="-1"></a>  <span class="at">y    =</span> <span class="fu">as.numeric</span>(df_impu<span class="sc">$</span>val_impu)</span>
<span id="cb126-11"><a href="Modelización.html#cb126-11" tabindex="-1"></a>)</span>
<span id="cb126-12"><a href="Modelización.html#cb126-12" tabindex="-1"></a>t_max <span class="ot">&lt;-</span> <span class="fu">max</span>(hist_df<span class="sc">$</span>time, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb126-13"><a href="Modelización.html#cb126-13" tabindex="-1"></a>t_ini <span class="ot">&lt;-</span> t_max <span class="sc">-</span> lubridate<span class="sc">::</span><span class="fu">days</span>(history_days)</span>
<span id="cb126-14"><a href="Modelización.html#cb126-14" tabindex="-1"></a>t_fin <span class="ot">&lt;-</span> <span class="fu">max</span>(df_hw_bc<span class="sc">$</span>time)</span>
<span id="cb126-15"><a href="Modelización.html#cb126-15" tabindex="-1"></a></span>
<span id="cb126-16"><a href="Modelización.html#cb126-16" tabindex="-1"></a>hist_zoom <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(hist_df, time <span class="sc">&gt;=</span> t_ini)</span>
<span id="cb126-17"><a href="Modelización.html#cb126-17" tabindex="-1"></a></span>
<span id="cb126-18"><a href="Modelización.html#cb126-18" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb126-19"><a href="Modelización.html#cb126-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(<span class="at">data =</span> df_hw_bc, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">ymin =</span> lo95, <span class="at">ymax =</span> hi95),</span>
<span id="cb126-20"><a href="Modelización.html#cb126-20" tabindex="-1"></a>                       <span class="at">fill =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.15</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb126-21"><a href="Modelización.html#cb126-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(<span class="at">data =</span> df_hw_bc, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">ymin =</span> lo80, <span class="at">ymax =</span> hi80),</span>
<span id="cb126-22"><a href="Modelización.html#cb126-22" tabindex="-1"></a>                       <span class="at">fill =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb126-23"><a href="Modelización.html#cb126-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data =</span> df_hw_bc, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mean),</span>
<span id="cb126-24"><a href="Modelización.html#cb126-24" tabindex="-1"></a>                     <span class="at">color =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">linewidth =</span> <span class="fl">1.0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb126-25"><a href="Modelización.html#cb126-25" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data =</span> hist_zoom, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> y),</span>
<span id="cb126-26"><a href="Modelización.html#cb126-26" tabindex="-1"></a>                     <span class="at">color =</span> <span class="st">&quot;grey40&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.45</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb126-27"><a href="Modelización.html#cb126-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_datetime</span>(<span class="at">limits =</span> <span class="fu">c</span>(t_ini, t_fin),</span>
<span id="cb126-28"><a href="Modelización.html#cb126-28" tabindex="-1"></a>                            <span class="at">date_breaks =</span> <span class="st">&quot;3 days&quot;</span>, <span class="at">date_labels =</span> <span class="st">&quot;%d-%b&quot;</span>) <span class="sc">+</span></span>
<span id="cb126-29"><a href="Modelización.html#cb126-29" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Holt–Winters Box–Cox (&quot;</span>, <span class="fu">ceiling</span>(h<span class="sc">/</span><span class="dv">24</span>), <span class="st">&quot; días)&quot;</span>),</span>
<span id="cb126-30"><a href="Modelización.html#cb126-30" tabindex="-1"></a>                <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Últimos &quot;</span>, history_days, <span class="st">&quot; días + pronóstico reconvertido&quot;</span>),</span>
<span id="cb126-31"><a href="Modelización.html#cb126-31" tabindex="-1"></a>                <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia&quot;</span>) <span class="sc">+</span></span>
<span id="cb126-32"><a href="Modelización.html#cb126-32" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb126-33"><a href="Modelización.html#cb126-33" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">plot.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb126-34"><a href="Modelización.html#cb126-34" tabindex="-1"></a>                 <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb126-35"><a href="Modelización.html#cb126-35" tabindex="-1"></a>                 <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/hw-bc-zoom-1.png" width="960" /></p>
<ul>
<li><p>El modelo Holt–Winters Box–Cox conserva la estacionalidad y la estructura de la serie, generando predicciones coherentes con la dinámica histórica. La transformación Box–Cox mejora la estabilidad del modelo y evita explosiones de varianza en los pronósticos.</p></li>
<li><p>En los últimos 21 días históricos, se observa un patrón cíclico altamente repetitivo, con picos y valles diarios. A partir del punto de pronóstico (el último dato del conjunto de entrenamiento), el modelo mantiene el mismo patrón estacional, reproduciendo los picos y valles con amplitud similar, lo que demuestra que el componente estacional fue correctamente capturado.</p></li>
<li><p>Las bandas de confianza se expanden gradualmente conforme avanza el horizonte temporal, lo que refleja un aumento natural de la incertidumbre en predicciones futuras.</p></li>
<li><p>El modelo no muestra sesgos significativos: el promedio del pronóstico (línea azul) sigue de cerca el comportamiento central de los datos reales.</p></li>
<li><p>El modelo logra una predicción estable, con un patrón estacional diario bien ajustado y sin desviaciones sistemáticas. Las bandas de confianza muestran incertidumbre controlada y coherente con la naturaleza estocástica de la serie.</p></li>
</ul>
</div>
<div id="métricas-en-test-comparando-en-escala-original-holt-winter-y-boxcox" class="section level2 hasAnchor" number="5.12">
<h2><span class="header-section-number">5.12</span> Métricas en TEST comparando en <strong>escala original</strong> (Holt Winter y Box–Cox)<a href="Modelización.html#m%C3%A9tricas-en-test-comparando-en-escala-original-holt-winter-y-boxcox" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="Modelización.html#cb127-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb127-2"><a href="Modelización.html#cb127-2" tabindex="-1"></a><span class="co"># Evaluación en </span><span class="al">TEST</span><span class="co"> (RMSE y MAPE) en escala ORIGINAL</span></span>
<span id="cb127-3"><a href="Modelización.html#cb127-3" tabindex="-1"></a><span class="co"># Añade HW Box–Cox (reconvertido) a la tabla de comparación</span></span>
<span id="cb127-4"><a href="Modelización.html#cb127-4" tabindex="-1"></a><span class="co"># Requiere: y_test, h, df_hw_bc y (si existen) fc_hw_add/fc_hw_mul/ARIMA</span></span>
<span id="cb127-5"><a href="Modelización.html#cb127-5" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb127-6"><a href="Modelización.html#cb127-6" tabindex="-1"></a></span>
<span id="cb127-7"><a href="Modelización.html#cb127-7" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">exists</span>(<span class="st">&quot;y_test&quot;</span>))</span>
<span id="cb127-8"><a href="Modelización.html#cb127-8" tabindex="-1"></a></span>
<span id="cb127-9"><a href="Modelización.html#cb127-9" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(y_test), h)</span>
<span id="cb127-10"><a href="Modelización.html#cb127-10" tabindex="-1"></a>y_test_vec <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(y_test)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb127-11"><a href="Modelización.html#cb127-11" tabindex="-1"></a></span>
<span id="cb127-12"><a href="Modelización.html#cb127-12" tabindex="-1"></a><span class="co"># Predicciones de los modelos existentes (si existen)</span></span>
<span id="cb127-13"><a href="Modelización.html#cb127-13" tabindex="-1"></a>get_preds <span class="ot">&lt;-</span> <span class="cf">function</span>(obj, k) {</span>
<span id="cb127-14"><a href="Modelización.html#cb127-14" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(obj)) <span class="fu">return</span>(<span class="fu">rep</span>(<span class="cn">NA_real_</span>, k))</span>
<span id="cb127-15"><a href="Modelización.html#cb127-15" tabindex="-1"></a>  <span class="fu">as.numeric</span>(obj)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb127-16"><a href="Modelización.html#cb127-16" tabindex="-1"></a>}</span>
<span id="cb127-17"><a href="Modelización.html#cb127-17" tabindex="-1"></a></span>
<span id="cb127-18"><a href="Modelización.html#cb127-18" tabindex="-1"></a>pred_add   <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_hw_add&quot;</span>)) <span class="fu">get_preds</span>(fc_hw_add<span class="sc">$</span>mean, k) <span class="cf">else</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, k)</span>
<span id="cb127-19"><a href="Modelización.html#cb127-19" tabindex="-1"></a>pred_mul   <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_hw_mul&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(fc_hw_mul)) <span class="fu">get_preds</span>(fc_hw_mul<span class="sc">$</span>mean, k) <span class="cf">else</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, k)</span>
<span id="cb127-20"><a href="Modelización.html#cb127-20" tabindex="-1"></a>pred_arima <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_arima_simple&quot;</span>)) <span class="fu">get_preds</span>(fc_arima_simple<span class="sc">$</span>mean, k) <span class="cf">else</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, k)</span>
<span id="cb127-21"><a href="Modelización.html#cb127-21" tabindex="-1"></a>pred_hwbc  <span class="ot">&lt;-</span> <span class="fu">get_preds</span>(df_hw_bc<span class="sc">$</span>mean, k)</span>
<span id="cb127-22"><a href="Modelización.html#cb127-22" tabindex="-1"></a></span>
<span id="cb127-23"><a href="Modelización.html#cb127-23" tabindex="-1"></a><span class="co"># Métricas (si no están)</span></span>
<span id="cb127-24"><a href="Modelización.html#cb127-24" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;rmse&quot;</span>, <span class="at">mode =</span> <span class="st">&quot;function&quot;</span>)) {</span>
<span id="cb127-25"><a href="Modelización.html#cb127-25" tabindex="-1"></a>  rmse <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, pred) <span class="fu">sqrt</span>(<span class="fu">mean</span>((obs <span class="sc">-</span> pred)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb127-26"><a href="Modelización.html#cb127-26" tabindex="-1"></a>}</span>
<span id="cb127-27"><a href="Modelización.html#cb127-27" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;mape&quot;</span>, <span class="at">mode =</span> <span class="st">&quot;function&quot;</span>)) {</span>
<span id="cb127-28"><a href="Modelización.html#cb127-28" tabindex="-1"></a>  mape <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, pred) {</span>
<span id="cb127-29"><a href="Modelización.html#cb127-29" tabindex="-1"></a>    ok <span class="ot">&lt;-</span> obs <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">is.finite</span>(obs) <span class="sc">&amp;</span> <span class="fu">is.finite</span>(pred)</span>
<span id="cb127-30"><a href="Modelización.html#cb127-30" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(ok)) <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb127-31"><a href="Modelización.html#cb127-31" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>((obs[ok] <span class="sc">-</span> pred[ok]) <span class="sc">/</span> obs[ok])) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb127-32"><a href="Modelización.html#cb127-32" tabindex="-1"></a>  }</span>
<span id="cb127-33"><a href="Modelización.html#cb127-33" tabindex="-1"></a>}</span>
<span id="cb127-34"><a href="Modelización.html#cb127-34" tabindex="-1"></a></span>
<span id="cb127-35"><a href="Modelización.html#cb127-35" tabindex="-1"></a>tab_cmp_all <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb127-36"><a href="Modelización.html#cb127-36" tabindex="-1"></a>  <span class="at">Modelo =</span> <span class="fu">c</span>(<span class="st">&quot;HW Aditivo&quot;</span>, <span class="st">&quot;HW Multiplicativo&quot;</span>, <span class="st">&quot;ARIMA simple&quot;</span>, <span class="st">&quot;HW Box–Cox (aditivo)&quot;</span>),</span>
<span id="cb127-37"><a href="Modelización.html#cb127-37" tabindex="-1"></a>  <span class="at">RMSE   =</span> <span class="fu">c</span>(<span class="fu">rmse</span>(y_test_vec, pred_add),</span>
<span id="cb127-38"><a href="Modelización.html#cb127-38" tabindex="-1"></a>             <span class="fu">rmse</span>(y_test_vec, pred_mul),</span>
<span id="cb127-39"><a href="Modelización.html#cb127-39" tabindex="-1"></a>             <span class="fu">rmse</span>(y_test_vec, pred_arima),</span>
<span id="cb127-40"><a href="Modelización.html#cb127-40" tabindex="-1"></a>             <span class="fu">rmse</span>(y_test_vec, pred_hwbc)),</span>
<span id="cb127-41"><a href="Modelización.html#cb127-41" tabindex="-1"></a>  <span class="at">MAPE   =</span> <span class="fu">c</span>(<span class="fu">mape</span>(y_test_vec, pred_add),</span>
<span id="cb127-42"><a href="Modelización.html#cb127-42" tabindex="-1"></a>             <span class="fu">mape</span>(y_test_vec, pred_mul),</span>
<span id="cb127-43"><a href="Modelización.html#cb127-43" tabindex="-1"></a>             <span class="fu">mape</span>(y_test_vec, pred_arima),</span>
<span id="cb127-44"><a href="Modelización.html#cb127-44" tabindex="-1"></a>             <span class="fu">mape</span>(y_test_vec, pred_hwbc))</span>
<span id="cb127-45"><a href="Modelización.html#cb127-45" tabindex="-1"></a>)</span>
<span id="cb127-46"><a href="Modelización.html#cb127-46" tabindex="-1"></a></span>
<span id="cb127-47"><a href="Modelización.html#cb127-47" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(tab_cmp_all, <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb127-48"><a href="Modelización.html#cb127-48" tabindex="-1"></a>             <span class="at">caption =</span> <span class="st">&quot;Evaluación en TEST (escala original) — HW Aditivo, HW Multiplicativo, ARIMA simple y HW Box–Cox&quot;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:hw-bc-metrics">Table 5.3: </span>Evaluación en TEST (escala original) — HW Aditivo, HW Multiplicativo, ARIMA simple y HW Box–Cox</caption>
<thead>
<tr class="header">
<th align="left">Modelo</th>
<th align="right">RMSE</th>
<th align="right">MAPE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HW Aditivo</td>
<td align="right">468.700</td>
<td align="right">37.098</td>
</tr>
<tr class="even">
<td align="left">HW Multiplicativo</td>
<td align="right">394.586</td>
<td align="right">31.117</td>
</tr>
<tr class="odd">
<td align="left">ARIMA simple</td>
<td align="right">325.303</td>
<td align="right">27.377</td>
</tr>
<tr class="even">
<td align="left">HW Box–Cox (aditivo)</td>
<td align="right">465.434</td>
<td align="right">36.858</td>
</tr>
</tbody>
</table>
<ul>
<li><p>El Holt–Winters con Box–Cox (aditivo) no mejora de manera sustancial. La transformación Box–Cox estabiliza la varianza y suaviza valores extremos, pero al reconvertir a la escala original, el beneficio se diluye. Por eso sus métricas son casi idénticas a las del modelo aditivo original, aunque genera pronósticos más estables y visualmente más suaves.</p></li>
<li><p>Holt–Winters con Box–Cox proporciona una alternativa robusta cuando hay heterocedasticidad o valores extremos, aunque no mejora de forma drástica la precisión.</p></li>
</ul>
</div>
<div id="resumen-final-de-métricas-rmse-mape" class="section level2 hasAnchor" number="5.13">
<h2><span class="header-section-number">5.13</span> Resumen final de métricas (RMSE / MAPE)<a href="Modelización.html#resumen-final-de-m%C3%A9tricas-rmse-mape" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="Modelización.html#cb128-1" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb128-2"><a href="Modelización.html#cb128-2" tabindex="-1"></a><span class="co"># RESUMEN FINAL DE MÉTRICAS (RMSE / MAPE) EN ESCALA ORIGINAL</span></span>
<span id="cb128-3"><a href="Modelización.html#cb128-3" tabindex="-1"></a><span class="co"># Detecta y consolida: SARIMA (fc), ARIMA simple, HW (add/mult),</span></span>
<span id="cb128-4"><a href="Modelización.html#cb128-4" tabindex="-1"></a><span class="co"># HW Box–Cox (reconvertido), y ARIMA (log) si existe.</span></span>
<span id="cb128-5"><a href="Modelización.html#cb128-5" tabindex="-1"></a><span class="co"># Requiere: y_test, h, rmse(), mape()</span></span>
<span id="cb128-6"><a href="Modelización.html#cb128-6" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb128-7"><a href="Modelización.html#cb128-7" tabindex="-1"></a></span>
<span id="cb128-8"><a href="Modelización.html#cb128-8" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb128-9"><a href="Modelización.html#cb128-9" tabindex="-1"></a>  <span class="fu">library</span>(dplyr); <span class="fu">library</span>(tibble); <span class="fu">library</span>(ggplot2)</span>
<span id="cb128-10"><a href="Modelización.html#cb128-10" tabindex="-1"></a>})</span>
<span id="cb128-11"><a href="Modelización.html#cb128-11" tabindex="-1"></a></span>
<span id="cb128-12"><a href="Modelización.html#cb128-12" tabindex="-1"></a><span class="co"># --- 1) Validaciones y utilidades ---</span></span>
<span id="cb128-13"><a href="Modelización.html#cb128-13" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">exists</span>(<span class="st">&quot;y_test&quot;</span>), <span class="fu">exists</span>(<span class="st">&quot;h&quot;</span>))</span>
<span id="cb128-14"><a href="Modelización.html#cb128-14" tabindex="-1"></a></span>
<span id="cb128-15"><a href="Modelización.html#cb128-15" tabindex="-1"></a><span class="co"># función segura para extraer primeras k predicciones de un objeto &quot;mean&quot; forecast</span></span>
<span id="cb128-16"><a href="Modelización.html#cb128-16" tabindex="-1"></a>get_fc_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(obj, k) {</span>
<span id="cb128-17"><a href="Modelización.html#cb128-17" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(obj)) <span class="fu">return</span>(<span class="fu">rep</span>(<span class="cn">NA_real_</span>, k))</span>
<span id="cb128-18"><a href="Modelización.html#cb128-18" tabindex="-1"></a>  <span class="fu">as.numeric</span>(obj)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb128-19"><a href="Modelización.html#cb128-19" tabindex="-1"></a>}</span>
<span id="cb128-20"><a href="Modelización.html#cb128-20" tabindex="-1"></a></span>
<span id="cb128-21"><a href="Modelización.html#cb128-21" tabindex="-1"></a><span class="co"># --- 2) Longitud de comparación y vector </span><span class="al">TEST</span><span class="co"> (escala original) ---</span></span>
<span id="cb128-22"><a href="Modelización.html#cb128-22" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(y_test), h)</span>
<span id="cb128-23"><a href="Modelización.html#cb128-23" tabindex="-1"></a>y_test_vec <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(y_test)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb128-24"><a href="Modelización.html#cb128-24" tabindex="-1"></a></span>
<span id="cb128-25"><a href="Modelización.html#cb128-25" tabindex="-1"></a><span class="co"># --- 3) Recolección de predicciones por modelo (si existen) ---</span></span>
<span id="cb128-26"><a href="Modelización.html#cb128-26" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb128-27"><a href="Modelización.html#cb128-27" tabindex="-1"></a></span>
<span id="cb128-28"><a href="Modelización.html#cb128-28" tabindex="-1"></a><span class="co"># SARIMA (auto.arima original) -&gt; objeto &#39;fc&#39;</span></span>
<span id="cb128-29"><a href="Modelización.html#cb128-29" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc&quot;</span>)) {</span>
<span id="cb128-30"><a href="Modelización.html#cb128-30" tabindex="-1"></a>  preds[[<span class="st">&quot;SARIMA (auto.arima)&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">get_fc_mean</span>(fc<span class="sc">$</span>mean, k)</span>
<span id="cb128-31"><a href="Modelización.html#cb128-31" tabindex="-1"></a>}</span>
<span id="cb128-32"><a href="Modelización.html#cb128-32" tabindex="-1"></a></span>
<span id="cb128-33"><a href="Modelización.html#cb128-33" tabindex="-1"></a><span class="co"># ARIMA simple (train/test mismo split) -&gt; objeto &#39;fc_arima_simple&#39;</span></span>
<span id="cb128-34"><a href="Modelización.html#cb128-34" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_arima_simple&quot;</span>)) {</span>
<span id="cb128-35"><a href="Modelización.html#cb128-35" tabindex="-1"></a>  preds[[<span class="st">&quot;ARIMA simple&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">get_fc_mean</span>(fc_arima_simple<span class="sc">$</span>mean, k)</span>
<span id="cb128-36"><a href="Modelización.html#cb128-36" tabindex="-1"></a>}</span>
<span id="cb128-37"><a href="Modelización.html#cb128-37" tabindex="-1"></a></span>
<span id="cb128-38"><a href="Modelización.html#cb128-38" tabindex="-1"></a><span class="co"># Holt–Winters Aditivo -&gt; objeto &#39;fc_hw_add&#39;</span></span>
<span id="cb128-39"><a href="Modelización.html#cb128-39" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_hw_add&quot;</span>)) {</span>
<span id="cb128-40"><a href="Modelización.html#cb128-40" tabindex="-1"></a>  preds[[<span class="st">&quot;HW Aditivo&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">get_fc_mean</span>(fc_hw_add<span class="sc">$</span>mean, k)</span>
<span id="cb128-41"><a href="Modelización.html#cb128-41" tabindex="-1"></a>}</span>
<span id="cb128-42"><a href="Modelización.html#cb128-42" tabindex="-1"></a></span>
<span id="cb128-43"><a href="Modelización.html#cb128-43" tabindex="-1"></a><span class="co"># Holt–Winters Multiplicativo -&gt; objeto &#39;fc_hw_mul&#39; (puede ser NULL)</span></span>
<span id="cb128-44"><a href="Modelización.html#cb128-44" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_hw_mul&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(fc_hw_mul)) {</span>
<span id="cb128-45"><a href="Modelización.html#cb128-45" tabindex="-1"></a>  preds[[<span class="st">&quot;HW Multiplicativo&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">get_fc_mean</span>(fc_hw_mul<span class="sc">$</span>mean, k)</span>
<span id="cb128-46"><a href="Modelización.html#cb128-46" tabindex="-1"></a>}</span>
<span id="cb128-47"><a href="Modelización.html#cb128-47" tabindex="-1"></a></span>
<span id="cb128-48"><a href="Modelización.html#cb128-48" tabindex="-1"></a><span class="co"># Holt–Winters Box–Cox (aditivo) -&gt; data.frame &#39;df_hw_bc&#39; (ya en original)</span></span>
<span id="cb128-49"><a href="Modelización.html#cb128-49" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;df_hw_bc&quot;</span>)) {</span>
<span id="cb128-50"><a href="Modelización.html#cb128-50" tabindex="-1"></a>  preds[[<span class="st">&quot;HW Box–Cox (aditivo)&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(df_hw_bc<span class="sc">$</span>mean)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb128-51"><a href="Modelización.html#cb128-51" tabindex="-1"></a>}</span>
<span id="cb128-52"><a href="Modelización.html#cb128-52" tabindex="-1"></a></span>
<span id="cb128-53"><a href="Modelización.html#cb128-53" tabindex="-1"></a><span class="co"># ARIMA (log) -&gt; objeto &#39;fc_log&#39; (reconvertimos con expm1)</span></span>
<span id="cb128-54"><a href="Modelización.html#cb128-54" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_log&quot;</span>)) {</span>
<span id="cb128-55"><a href="Modelización.html#cb128-55" tabindex="-1"></a>  preds[[<span class="st">&quot;ARIMA (log)&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">expm1</span>(<span class="fu">as.numeric</span>(fc_log<span class="sc">$</span>mean))[<span class="fu">seq_len</span>(k)]</span>
<span id="cb128-56"><a href="Modelización.html#cb128-56" tabindex="-1"></a>}</span>
<span id="cb128-57"><a href="Modelización.html#cb128-57" tabindex="-1"></a></span>
<span id="cb128-58"><a href="Modelización.html#cb128-58" tabindex="-1"></a><span class="co"># Si no hay ningún modelo, avisar y salir</span></span>
<span id="cb128-59"><a href="Modelización.html#cb128-59" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(preds)) {</span>
<span id="cb128-60"><a href="Modelización.html#cb128-60" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;No se encontraron objetos de pronóstico para resumir.</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb128-61"><a href="Modelización.html#cb128-61" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb128-62"><a href="Modelización.html#cb128-62" tabindex="-1"></a>  <span class="co"># --- 4) Cálculo de métricas ---</span></span>
<span id="cb128-63"><a href="Modelización.html#cb128-63" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;rmse&quot;</span>, <span class="at">mode =</span> <span class="st">&quot;function&quot;</span>)) {</span>
<span id="cb128-64"><a href="Modelización.html#cb128-64" tabindex="-1"></a>    rmse <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, pred) <span class="fu">sqrt</span>(<span class="fu">mean</span>((obs <span class="sc">-</span> pred)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb128-65"><a href="Modelización.html#cb128-65" tabindex="-1"></a>  }</span>
<span id="cb128-66"><a href="Modelización.html#cb128-66" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;mape&quot;</span>, <span class="at">mode =</span> <span class="st">&quot;function&quot;</span>)) {</span>
<span id="cb128-67"><a href="Modelización.html#cb128-67" tabindex="-1"></a>    mape <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, pred) {</span>
<span id="cb128-68"><a href="Modelización.html#cb128-68" tabindex="-1"></a>      ok <span class="ot">&lt;-</span> obs <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">is.finite</span>(obs) <span class="sc">&amp;</span> <span class="fu">is.finite</span>(pred)</span>
<span id="cb128-69"><a href="Modelización.html#cb128-69" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(ok)) <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb128-70"><a href="Modelización.html#cb128-70" tabindex="-1"></a>      <span class="fu">mean</span>(<span class="fu">abs</span>((obs[ok] <span class="sc">-</span> pred[ok]) <span class="sc">/</span> obs[ok])) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb128-71"><a href="Modelización.html#cb128-71" tabindex="-1"></a>    }</span>
<span id="cb128-72"><a href="Modelización.html#cb128-72" tabindex="-1"></a>  }</span>
<span id="cb128-73"><a href="Modelización.html#cb128-73" tabindex="-1"></a></span>
<span id="cb128-74"><a href="Modelización.html#cb128-74" tabindex="-1"></a>  tabla <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(preds), <span class="cf">function</span>(nm) {</span>
<span id="cb128-75"><a href="Modelización.html#cb128-75" tabindex="-1"></a>    pr <span class="ot">&lt;-</span> preds[[nm]]</span>
<span id="cb128-76"><a href="Modelización.html#cb128-76" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb128-77"><a href="Modelización.html#cb128-77" tabindex="-1"></a>      <span class="at">Modelo =</span> nm,</span>
<span id="cb128-78"><a href="Modelización.html#cb128-78" tabindex="-1"></a>      <span class="at">RMSE   =</span> <span class="fu">rmse</span>(y_test_vec, pr),</span>
<span id="cb128-79"><a href="Modelización.html#cb128-79" tabindex="-1"></a>      <span class="at">MAPE   =</span> <span class="fu">mape</span>(y_test_vec, pr)</span>
<span id="cb128-80"><a href="Modelización.html#cb128-80" tabindex="-1"></a>    )</span>
<span id="cb128-81"><a href="Modelización.html#cb128-81" tabindex="-1"></a>  }) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb128-82"><a href="Modelización.html#cb128-82" tabindex="-1"></a></span>
<span id="cb128-83"><a href="Modelización.html#cb128-83" tabindex="-1"></a>  <span class="co"># Ranking por RMSE y % mejora respecto al peor</span></span>
<span id="cb128-84"><a href="Modelización.html#cb128-84" tabindex="-1"></a>  tabla <span class="ot">&lt;-</span> tabla <span class="sc">|&gt;</span></span>
<span id="cb128-85"><a href="Modelización.html#cb128-85" tabindex="-1"></a>    <span class="fu">arrange</span>(RMSE) <span class="sc">|&gt;</span></span>
<span id="cb128-86"><a href="Modelización.html#cb128-86" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Rank_RMSE =</span> <span class="fu">row_number</span>(),</span>
<span id="cb128-87"><a href="Modelización.html#cb128-87" tabindex="-1"></a>           <span class="at">Mejora_vs_Peor =</span> <span class="dv">100</span> <span class="sc">*</span> (<span class="fu">max</span>(RMSE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> RMSE) <span class="sc">/</span> <span class="fu">max</span>(RMSE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb128-88"><a href="Modelización.html#cb128-88" tabindex="-1"></a></span>
<span id="cb128-89"><a href="Modelización.html#cb128-89" tabindex="-1"></a>  <span class="co"># --- 5) Mostrar tabla ---</span></span>
<span id="cb128-90"><a href="Modelización.html#cb128-90" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(tabla, <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb128-91"><a href="Modelización.html#cb128-91" tabindex="-1"></a>               <span class="at">caption =</span> <span class="st">&quot;Resumen final de desempeño en TEST (escala original)&quot;</span>)</span>
<span id="cb128-92"><a href="Modelización.html#cb128-92" tabindex="-1"></a></span>
<span id="cb128-93"><a href="Modelización.html#cb128-93" tabindex="-1"></a>  <span class="co"># --- 6) (Opcional) Gráfico de barras por RMSE ---</span></span>
<span id="cb128-94"><a href="Modelización.html#cb128-94" tabindex="-1"></a>  <span class="fu">ggplot</span>(tabla, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(Modelo, RMSE), <span class="at">y =</span> RMSE)) <span class="sc">+</span></span>
<span id="cb128-95"><a href="Modelización.html#cb128-95" tabindex="-1"></a>    <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb128-96"><a href="Modelización.html#cb128-96" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb128-97"><a href="Modelización.html#cb128-97" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.1f&quot;</span>, RMSE)), <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb128-98"><a href="Modelización.html#cb128-98" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Comparación de RMSE por modelo&quot;</span>,</span>
<span id="cb128-99"><a href="Modelización.html#cb128-99" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Modelo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;RMSE (menor es mejor)&quot;</span>) <span class="sc">+</span></span>
<span id="cb128-100"><a href="Modelización.html#cb128-100" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb128-101"><a href="Modelización.html#cb128-101" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb128-102"><a href="Modelización.html#cb128-102" tabindex="-1"></a>          <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb128-103"><a href="Modelización.html#cb128-103" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">max</span>(tabla<span class="sc">$</span>RMSE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="fl">1.1</span>)</span>
<span id="cb128-104"><a href="Modelización.html#cb128-104" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/resumen-final-metricas-1.png" width="960" /></p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="Modelización.html#cb129-1" tabindex="-1"></a><span class="co"># --- Funciones de métricas (por si acaso) ---</span></span>
<span id="cb129-2"><a href="Modelización.html#cb129-2" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;rmse&quot;</span>, <span class="at">mode =</span> <span class="st">&quot;function&quot;</span>)) {</span>
<span id="cb129-3"><a href="Modelización.html#cb129-3" tabindex="-1"></a>  rmse <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, pred) <span class="fu">sqrt</span>(<span class="fu">mean</span>((obs <span class="sc">-</span> pred)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb129-4"><a href="Modelización.html#cb129-4" tabindex="-1"></a>}</span>
<span id="cb129-5"><a href="Modelización.html#cb129-5" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;mape&quot;</span>, <span class="at">mode =</span> <span class="st">&quot;function&quot;</span>)) {</span>
<span id="cb129-6"><a href="Modelización.html#cb129-6" tabindex="-1"></a>  mape <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, pred) {</span>
<span id="cb129-7"><a href="Modelización.html#cb129-7" tabindex="-1"></a>    ok <span class="ot">&lt;-</span> <span class="fu">is.finite</span>(obs) <span class="sc">&amp;</span> <span class="fu">is.finite</span>(pred) <span class="sc">&amp;</span> obs <span class="sc">!=</span> <span class="dv">0</span></span>
<span id="cb129-8"><a href="Modelización.html#cb129-8" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(ok)) <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb129-9"><a href="Modelización.html#cb129-9" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>((obs[ok] <span class="sc">-</span> pred[ok]) <span class="sc">/</span> obs[ok])) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb129-10"><a href="Modelización.html#cb129-10" tabindex="-1"></a>  }</span>
<span id="cb129-11"><a href="Modelización.html#cb129-11" tabindex="-1"></a>}</span>
<span id="cb129-12"><a href="Modelización.html#cb129-12" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;mae&quot;</span>, <span class="at">mode =</span> <span class="st">&quot;function&quot;</span>)) {</span>
<span id="cb129-13"><a href="Modelización.html#cb129-13" tabindex="-1"></a>  mae <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, pred) <span class="fu">mean</span>(<span class="fu">abs</span>(obs <span class="sc">-</span> pred), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb129-14"><a href="Modelización.html#cb129-14" tabindex="-1"></a>}</span>
<span id="cb129-15"><a href="Modelización.html#cb129-15" tabindex="-1"></a></span>
<span id="cb129-16"><a href="Modelización.html#cb129-16" tabindex="-1"></a><span class="co"># --- Vector de verdad (</span><span class="al">TEST</span><span class="co">) acotado a k ---</span></span>
<span id="cb129-17"><a href="Modelización.html#cb129-17" tabindex="-1"></a><span class="co"># (asumiendo que ya definiste y_test, h y k)</span></span>
<span id="cb129-18"><a href="Modelización.html#cb129-18" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(y_test), h)</span>
<span id="cb129-19"><a href="Modelización.html#cb129-19" tabindex="-1"></a>y_test_vec <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(y_test)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb129-20"><a href="Modelización.html#cb129-20" tabindex="-1"></a></span>
<span id="cb129-21"><a href="Modelización.html#cb129-21" tabindex="-1"></a><span class="co"># --- Construir lista de predicciones realmente disponibles ---</span></span>
<span id="cb129-22"><a href="Modelización.html#cb129-22" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb129-23"><a href="Modelización.html#cb129-23" tabindex="-1"></a></span>
<span id="cb129-24"><a href="Modelización.html#cb129-24" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_hw_add&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(fc_hw_add)) {</span>
<span id="cb129-25"><a href="Modelización.html#cb129-25" tabindex="-1"></a>  preds[[<span class="st">&quot;HW Aditivo&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(fc_hw_add<span class="sc">$</span>mean)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb129-26"><a href="Modelización.html#cb129-26" tabindex="-1"></a>}</span>
<span id="cb129-27"><a href="Modelización.html#cb129-27" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;df_hw_bc&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(df_hw_bc)) {</span>
<span id="cb129-28"><a href="Modelización.html#cb129-28" tabindex="-1"></a>  preds[[<span class="st">&quot;HW Box–Cox (aditivo)&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(df_hw_bc<span class="sc">$</span>mean)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb129-29"><a href="Modelización.html#cb129-29" tabindex="-1"></a>}</span>
<span id="cb129-30"><a href="Modelización.html#cb129-30" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_hw_mul&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(fc_hw_mul)) {</span>
<span id="cb129-31"><a href="Modelización.html#cb129-31" tabindex="-1"></a>  preds[[<span class="st">&quot;HW Multiplicativo&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(fc_hw_mul<span class="sc">$</span>mean)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb129-32"><a href="Modelización.html#cb129-32" tabindex="-1"></a>}</span>
<span id="cb129-33"><a href="Modelización.html#cb129-33" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_arima_simple&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(fc_arima_simple)) {</span>
<span id="cb129-34"><a href="Modelización.html#cb129-34" tabindex="-1"></a>  preds[[<span class="st">&quot;ARIMA simple&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(fc_arima_simple<span class="sc">$</span>mean)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb129-35"><a href="Modelización.html#cb129-35" tabindex="-1"></a>}</span>
<span id="cb129-36"><a href="Modelización.html#cb129-36" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(fc)) {</span>
<span id="cb129-37"><a href="Modelización.html#cb129-37" tabindex="-1"></a>  preds[[<span class="st">&quot;SARIMA (auto.arima)&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>mean)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb129-38"><a href="Modelización.html#cb129-38" tabindex="-1"></a>}</span>
<span id="cb129-39"><a href="Modelización.html#cb129-39" tabindex="-1"></a><span class="co"># Si tienes otro modelo (p. ej. ARIMA log) añádelo así:</span></span>
<span id="cb129-40"><a href="Modelización.html#cb129-40" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_exp&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(fc_exp)) {</span>
<span id="cb129-41"><a href="Modelización.html#cb129-41" tabindex="-1"></a>  <span class="co"># fc_exp debe ser un vector numérico en escala original</span></span>
<span id="cb129-42"><a href="Modelización.html#cb129-42" tabindex="-1"></a>  preds[[<span class="st">&quot;ARIMA (log)&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(fc_exp)[<span class="fu">seq_len</span>(k)]</span>
<span id="cb129-43"><a href="Modelización.html#cb129-43" tabindex="-1"></a>}</span>
<span id="cb129-44"><a href="Modelización.html#cb129-44" tabindex="-1"></a></span>
<span id="cb129-45"><a href="Modelización.html#cb129-45" tabindex="-1"></a><span class="co"># --- Tabla final con list-column y métricas por fila ---</span></span>
<span id="cb129-46"><a href="Modelización.html#cb129-46" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb129-47"><a href="Modelización.html#cb129-47" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb129-48"><a href="Modelización.html#cb129-48" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb129-49"><a href="Modelización.html#cb129-49" tabindex="-1"></a>tabla <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb129-50"><a href="Modelización.html#cb129-50" tabindex="-1"></a>  <span class="at">Modelo =</span> <span class="fu">names</span>(preds),</span>
<span id="cb129-51"><a href="Modelización.html#cb129-51" tabindex="-1"></a>  <span class="at">Pred   =</span> <span class="fu">unname</span>(preds)</span>
<span id="cb129-52"><a href="Modelización.html#cb129-52" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb129-53"><a href="Modelización.html#cb129-53" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb129-54"><a href="Modelización.html#cb129-54" tabindex="-1"></a>    <span class="at">RMSE =</span> <span class="fu">map_dbl</span>(Pred, <span class="sc">~</span> <span class="fu">rmse</span>(y_test_vec, .x)),</span>
<span id="cb129-55"><a href="Modelización.html#cb129-55" tabindex="-1"></a>    <span class="at">MAPE =</span> <span class="fu">map_dbl</span>(Pred, <span class="sc">~</span> <span class="fu">mape</span>(y_test_vec, .x)),</span>
<span id="cb129-56"><a href="Modelización.html#cb129-56" tabindex="-1"></a>    <span class="at">MAE  =</span> <span class="fu">map_dbl</span>(Pred, <span class="sc">~</span> <span class="fu">mae</span> (y_test_vec, .x))</span>
<span id="cb129-57"><a href="Modelización.html#cb129-57" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb129-58"><a href="Modelización.html#cb129-58" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Pred)</span>
<span id="cb129-59"><a href="Modelización.html#cb129-59" tabindex="-1"></a></span>
<span id="cb129-60"><a href="Modelización.html#cb129-60" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(tabla, <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb129-61"><a href="Modelización.html#cb129-61" tabindex="-1"></a>  <span class="at">caption =</span> <span class="st">&quot;Comparación en TEST — RMSE, MAPE y MAE (escala original)&quot;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:unnamed-chunk-56">Table 5.4: </span>Comparación en TEST — RMSE, MAPE y MAE (escala original)</caption>
<thead>
<tr class="header">
<th align="left">Modelo</th>
<th align="right">RMSE</th>
<th align="right">MAPE</th>
<th align="right">MAE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HW Aditivo</td>
<td align="right">468.700</td>
<td align="right">37.098</td>
<td align="right">414.311</td>
</tr>
<tr class="even">
<td align="left">HW Box–Cox (aditivo)</td>
<td align="right">465.434</td>
<td align="right">36.858</td>
<td align="right">411.644</td>
</tr>
<tr class="odd">
<td align="left">HW Multiplicativo</td>
<td align="right">394.586</td>
<td align="right">31.117</td>
<td align="right">348.839</td>
</tr>
<tr class="even">
<td align="left">ARIMA simple</td>
<td align="right">325.303</td>
<td align="right">27.377</td>
<td align="right">302.346</td>
</tr>
<tr class="odd">
<td align="left">SARIMA (auto.arima)</td>
<td align="right">280.641</td>
<td align="right">23.245</td>
<td align="right">258.154</td>
</tr>
<tr class="even">
<td align="left">ARIMA (log)</td>
<td align="right">149.209</td>
<td align="right">12.046</td>
<td align="right">131.731</td>
</tr>
</tbody>
</table>
<ul>
<li><p>El <strong><em>ARIMA (log)</em></strong> es el modelo más preciso y estable, su transformación logarítmica estabilizó la varianza y suavizó los picos extremos, redujo los errores de manera drástica (RMSE ≈ 149, MAPE ≈ 12%). Es el modelo más adecuado para pronósticos precisos y consistentes en contextos con alta variabilidad o ruido.</p></li>
<li><p>El <strong><em>SARIMA (auto.arima)</em></strong> también muestra un excelente desempeño, incorpora componentes estacionales (periodicidad de 24 horas) que reflejan patrones horarios o diarios, su RMSE (280.6) y MAPE (23.2%) indican alta precisión sin requerir transformaciones adicionales. Es un modelo balanceado entre complejidad y exactitud.</p></li>
<li><p>El <strong><em>ARIMA simple</em></strong> (sin estacionalidad explícita) sigue siendo competitivo, logra capturar buena parte de la estructura temporal con pocos parámetros, su rendimiento (RMSE = 325.3, MAPE = 27.4%) lo posiciona por encima de todos los Holt–Winters.</p></li>
<li><p>Los modelos Holt–Winters (HW) presentan resultados claramente inferiores, aunque coherentes con su simplicidad:</p>
<ul>
<li>El <strong><em>HW aditivo</em></strong> es el más limitado, porque no ajusta amplitudes variables.</li>
<li>El <strong><em>HW multiplicativo</em></strong> mejora sustancialmente, al modelar estacionalidad proporcional al nivel de la serie.</li>
<li>El <strong><em>HW Box–Cox</em></strong> suaviza la varianza pero no alcanza mejoras sustanciales frente al HW clásico.</li>
</ul></li>
<li><p>Los modelos ARIMA y SARIMA superan ampliamente a los de Holt–Winters porque logran capturar dependencias dinámicas, estacionalidad compleja y no linealidades que los modelos de suavizamiento no pueden representar.</p></li>
<li><p>El ARIMA log-transformado se consolida como el modelo óptimo para la serie, al combinar estabilidad de varianza, bajo error absoluto y porcentual, y una excelente capacidad de ajuste temporal. El SARIMA es una alternativa igualmente robusta para escenarios donde se desea mantener la serie en escala original y enfatizar la estacionalidad. Los modelos Holt–Winters, si bien más simples, son útiles para análisis exploratorios o pronósticos rápidos, pero no alcanzan la precisión de los modelos ARIMA.</p></li>
</ul>
</div>
<div id="gráficas-de-predicción-por-modelo" class="section level2 hasAnchor" number="5.14">
<h2><span class="header-section-number">5.14</span> Gráficas de predicción por modelo<a href="Modelización.html#gr%C3%A1ficas-de-predicci%C3%B3n-por-modelo" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="Modelización.html#cb130-1" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb130-2"><a href="Modelización.html#cb130-2" tabindex="-1"></a>  <span class="fu">library</span>(dplyr); <span class="fu">library</span>(tibble); <span class="fu">library</span>(ggplot2); <span class="fu">library</span>(lubridate)</span>
<span id="cb130-3"><a href="Modelización.html#cb130-3" tabindex="-1"></a>})</span>
<span id="cb130-4"><a href="Modelización.html#cb130-4" tabindex="-1"></a></span>
<span id="cb130-5"><a href="Modelización.html#cb130-5" tabindex="-1"></a><span class="co"># -------- Utilidades --------</span></span>
<span id="cb130-6"><a href="Modelización.html#cb130-6" tabindex="-1"></a>build_fc_df <span class="ot">&lt;-</span> <span class="cf">function</span>(fc_obj, t_start, label, <span class="at">from_log =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb130-7"><a href="Modelización.html#cb130-7" tabindex="-1"></a>  <span class="co"># fc_obj: objeto forecast con $mean/$lower/$upper o data.frame ya listo</span></span>
<span id="cb130-8"><a href="Modelización.html#cb130-8" tabindex="-1"></a>  <span class="co"># t_start: POSIXct fin del histórico (última observación)</span></span>
<span id="cb130-9"><a href="Modelización.html#cb130-9" tabindex="-1"></a>  <span class="co"># label: nombre del modelo para título</span></span>
<span id="cb130-10"><a href="Modelización.html#cb130-10" tabindex="-1"></a>  <span class="co"># from_log: si TRUE, aplica expm1 a medias/bandas</span></span>
<span id="cb130-11"><a href="Modelización.html#cb130-11" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(fc_obj)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb130-12"><a href="Modelización.html#cb130-12" tabindex="-1"></a></span>
<span id="cb130-13"><a href="Modelización.html#cb130-13" tabindex="-1"></a>  <span class="co"># Caso forecast::forecast</span></span>
<span id="cb130-14"><a href="Modelización.html#cb130-14" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">&quot;mean&quot;</span>,<span class="st">&quot;lower&quot;</span>,<span class="st">&quot;upper&quot;</span>) <span class="sc">%in%</span> <span class="fu">names</span>(fc_obj))) {</span>
<span id="cb130-15"><a href="Modelización.html#cb130-15" tabindex="-1"></a>    h <span class="ot">&lt;-</span> <span class="fu">length</span>(fc_obj<span class="sc">$</span>mean)</span>
<span id="cb130-16"><a href="Modelización.html#cb130-16" tabindex="-1"></a>    f_times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> t_start <span class="sc">+</span> <span class="fu">hours</span>(<span class="dv">1</span>), <span class="at">by =</span> <span class="st">&quot;1 hour&quot;</span>, <span class="at">length.out =</span> h)</span>
<span id="cb130-17"><a href="Modelización.html#cb130-17" tabindex="-1"></a>    mean_v <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(fc_obj<span class="sc">$</span>mean)</span>
<span id="cb130-18"><a href="Modelización.html#cb130-18" tabindex="-1"></a>    lo80_v <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(fc_obj<span class="sc">$</span>lower[,<span class="st">&quot;80%&quot;</span>])</span>
<span id="cb130-19"><a href="Modelización.html#cb130-19" tabindex="-1"></a>    hi80_v <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(fc_obj<span class="sc">$</span>upper[,<span class="st">&quot;80%&quot;</span>])</span>
<span id="cb130-20"><a href="Modelización.html#cb130-20" tabindex="-1"></a>    lo95_v <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(fc_obj<span class="sc">$</span>lower[,<span class="st">&quot;95%&quot;</span>])</span>
<span id="cb130-21"><a href="Modelización.html#cb130-21" tabindex="-1"></a>    hi95_v <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(fc_obj<span class="sc">$</span>upper[,<span class="st">&quot;95%&quot;</span>])</span>
<span id="cb130-22"><a href="Modelización.html#cb130-22" tabindex="-1"></a></span>
<span id="cb130-23"><a href="Modelización.html#cb130-23" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isTRUE</span>(from_log)) {</span>
<span id="cb130-24"><a href="Modelización.html#cb130-24" tabindex="-1"></a>      mean_v <span class="ot">&lt;-</span> <span class="fu">expm1</span>(mean_v); lo80_v <span class="ot">&lt;-</span> <span class="fu">expm1</span>(lo80_v); hi80_v <span class="ot">&lt;-</span> <span class="fu">expm1</span>(hi80_v)</span>
<span id="cb130-25"><a href="Modelización.html#cb130-25" tabindex="-1"></a>      lo95_v <span class="ot">&lt;-</span> <span class="fu">expm1</span>(lo95_v); hi95_v <span class="ot">&lt;-</span> <span class="fu">expm1</span>(hi95_v)</span>
<span id="cb130-26"><a href="Modelización.html#cb130-26" tabindex="-1"></a>    }</span>
<span id="cb130-27"><a href="Modelización.html#cb130-27" tabindex="-1"></a></span>
<span id="cb130-28"><a href="Modelización.html#cb130-28" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">tibble</span>(</span>
<span id="cb130-29"><a href="Modelización.html#cb130-29" tabindex="-1"></a>      <span class="at">modelo =</span> label,</span>
<span id="cb130-30"><a href="Modelización.html#cb130-30" tabindex="-1"></a>      <span class="at">time   =</span> f_times,</span>
<span id="cb130-31"><a href="Modelización.html#cb130-31" tabindex="-1"></a>      <span class="at">mean   =</span> mean_v,</span>
<span id="cb130-32"><a href="Modelización.html#cb130-32" tabindex="-1"></a>      <span class="at">lo80   =</span> lo80_v,</span>
<span id="cb130-33"><a href="Modelización.html#cb130-33" tabindex="-1"></a>      <span class="at">hi80   =</span> hi80_v,</span>
<span id="cb130-34"><a href="Modelización.html#cb130-34" tabindex="-1"></a>      <span class="at">lo95   =</span> lo95_v,</span>
<span id="cb130-35"><a href="Modelización.html#cb130-35" tabindex="-1"></a>      <span class="at">hi95   =</span> hi95_v</span>
<span id="cb130-36"><a href="Modelización.html#cb130-36" tabindex="-1"></a>    ))</span>
<span id="cb130-37"><a href="Modelización.html#cb130-37" tabindex="-1"></a>  }</span>
<span id="cb130-38"><a href="Modelización.html#cb130-38" tabindex="-1"></a></span>
<span id="cb130-39"><a href="Modelización.html#cb130-39" tabindex="-1"></a>  <span class="co"># Caso data.frame ya convertido (espera columnas: time, mean, lo80, hi80[, lo95, hi95])</span></span>
<span id="cb130-40"><a href="Modelización.html#cb130-40" tabindex="-1"></a>  req_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;time&quot;</span>,<span class="st">&quot;mean&quot;</span>,<span class="st">&quot;lo80&quot;</span>,<span class="st">&quot;hi80&quot;</span>)</span>
<span id="cb130-41"><a href="Modelización.html#cb130-41" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.data.frame</span>(fc_obj) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(req_cols <span class="sc">%in%</span> <span class="fu">names</span>(fc_obj))) {</span>
<span id="cb130-42"><a href="Modelización.html#cb130-42" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(fc_obj)</span>
<span id="cb130-43"><a href="Modelización.html#cb130-43" tabindex="-1"></a>    out<span class="sc">$</span>modelo <span class="ot">&lt;-</span> label</span>
<span id="cb130-44"><a href="Modelización.html#cb130-44" tabindex="-1"></a>    <span class="co"># Si trae columnas 95% las respetamos; si no, las estimamos como NA</span></span>
<span id="cb130-45"><a href="Modelización.html#cb130-45" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">&quot;lo95&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(out))) out<span class="sc">$</span>lo95 <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb130-46"><a href="Modelización.html#cb130-46" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">&quot;hi95&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(out))) out<span class="sc">$</span>hi95 <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb130-47"><a href="Modelización.html#cb130-47" tabindex="-1"></a>    <span class="fu">return</span>(out[,<span class="fu">c</span>(<span class="st">&quot;modelo&quot;</span>,<span class="st">&quot;time&quot;</span>,<span class="st">&quot;mean&quot;</span>,<span class="st">&quot;lo80&quot;</span>,<span class="st">&quot;hi80&quot;</span>,<span class="st">&quot;lo95&quot;</span>,<span class="st">&quot;hi95&quot;</span>)])</span>
<span id="cb130-48"><a href="Modelización.html#cb130-48" tabindex="-1"></a>  }</span>
<span id="cb130-49"><a href="Modelización.html#cb130-49" tabindex="-1"></a></span>
<span id="cb130-50"><a href="Modelización.html#cb130-50" tabindex="-1"></a>  <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb130-51"><a href="Modelización.html#cb130-51" tabindex="-1"></a>}</span>
<span id="cb130-52"><a href="Modelización.html#cb130-52" tabindex="-1"></a></span>
<span id="cb130-53"><a href="Modelización.html#cb130-53" tabindex="-1"></a>plot_zoom_model <span class="ot">&lt;-</span> <span class="cf">function</span>(hist_df, fc_df, title_txt,</span>
<span id="cb130-54"><a href="Modelización.html#cb130-54" tabindex="-1"></a>                            <span class="at">history_days =</span> <span class="dv">21</span>,</span>
<span id="cb130-55"><a href="Modelización.html#cb130-55" tabindex="-1"></a>                            <span class="at">y_limits =</span> <span class="cn">NULL</span>,</span>
<span id="cb130-56"><a href="Modelización.html#cb130-56" tabindex="-1"></a>                            <span class="at">breaks_x =</span> <span class="st">&quot;3 days&quot;</span>, <span class="at">fmt_x =</span> <span class="st">&quot;%d-%b&quot;</span>) {</span>
<span id="cb130-57"><a href="Modelización.html#cb130-57" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(fc_df) <span class="sc">||</span> <span class="fu">nrow</span>(fc_df) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb130-58"><a href="Modelización.html#cb130-58" tabindex="-1"></a>  t_max <span class="ot">&lt;-</span> <span class="fu">max</span>(hist_df<span class="sc">$</span>time, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb130-59"><a href="Modelización.html#cb130-59" tabindex="-1"></a>  t_ini <span class="ot">&lt;-</span> t_max <span class="sc">-</span> <span class="fu">days</span>(history_days)</span>
<span id="cb130-60"><a href="Modelización.html#cb130-60" tabindex="-1"></a>  t_fin <span class="ot">&lt;-</span> <span class="fu">max</span>(fc_df<span class="sc">$</span>time, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb130-61"><a href="Modelización.html#cb130-61" tabindex="-1"></a></span>
<span id="cb130-62"><a href="Modelización.html#cb130-62" tabindex="-1"></a>  hist_zoom <span class="ot">&lt;-</span> <span class="fu">filter</span>(hist_df, time <span class="sc">&gt;=</span> t_ini)</span>
<span id="cb130-63"><a href="Modelización.html#cb130-63" tabindex="-1"></a></span>
<span id="cb130-64"><a href="Modelización.html#cb130-64" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb130-65"><a href="Modelización.html#cb130-65" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="at">data =</span> fc_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">ymin =</span> lo95, <span class="at">ymax =</span> hi95),</span>
<span id="cb130-66"><a href="Modelización.html#cb130-66" tabindex="-1"></a>                <span class="at">fill =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.12</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb130-67"><a href="Modelización.html#cb130-67" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="at">data =</span> fc_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">ymin =</span> lo80, <span class="at">ymax =</span> hi80),</span>
<span id="cb130-68"><a href="Modelización.html#cb130-68" tabindex="-1"></a>                <span class="at">fill =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.22</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb130-69"><a href="Modelización.html#cb130-69" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> fc_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mean),</span>
<span id="cb130-70"><a href="Modelización.html#cb130-70" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">&quot;#1f77b4&quot;</span>, <span class="at">linewidth =</span> <span class="fl">1.0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb130-71"><a href="Modelización.html#cb130-71" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> hist_zoom, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> y),</span>
<span id="cb130-72"><a href="Modelización.html#cb130-72" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">&quot;grey40&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.45</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb130-73"><a href="Modelización.html#cb130-73" tabindex="-1"></a>    <span class="fu">scale_x_datetime</span>(<span class="at">limits =</span> <span class="fu">c</span>(t_ini, t_fin),</span>
<span id="cb130-74"><a href="Modelización.html#cb130-74" tabindex="-1"></a>                     <span class="at">date_breaks =</span> breaks_x, <span class="at">date_labels =</span> fmt_x) <span class="sc">+</span></span>
<span id="cb130-75"><a href="Modelización.html#cb130-75" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> title_txt,</span>
<span id="cb130-76"><a href="Modelización.html#cb130-76" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Últimos &quot;</span>, history_days, <span class="st">&quot; días de historia + predicción&quot;</span>),</span>
<span id="cb130-77"><a href="Modelización.html#cb130-77" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Tiempo&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Potencia (escala original)&quot;</span>) <span class="sc">+</span></span>
<span id="cb130-78"><a href="Modelización.html#cb130-78" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb130-79"><a href="Modelización.html#cb130-79" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb130-80"><a href="Modelización.html#cb130-80" tabindex="-1"></a>          <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb130-81"><a href="Modelización.html#cb130-81" tabindex="-1"></a>          <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb130-82"><a href="Modelización.html#cb130-82" tabindex="-1"></a></span>
<span id="cb130-83"><a href="Modelización.html#cb130-83" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(y_limits)) {</span>
<span id="cb130-84"><a href="Modelización.html#cb130-84" tabindex="-1"></a>    p <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> y_limits)</span>
<span id="cb130-85"><a href="Modelización.html#cb130-85" tabindex="-1"></a>  }</span>
<span id="cb130-86"><a href="Modelización.html#cb130-86" tabindex="-1"></a>  <span class="fu">print</span>(p)</span>
<span id="cb130-87"><a href="Modelización.html#cb130-87" tabindex="-1"></a>}</span>
<span id="cb130-88"><a href="Modelización.html#cb130-88" tabindex="-1"></a></span>
<span id="cb130-89"><a href="Modelización.html#cb130-89" tabindex="-1"></a><span class="co"># -------- Datos históricos (últimos N días) --------</span></span>
<span id="cb130-90"><a href="Modelización.html#cb130-90" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">exists</span>(<span class="st">&quot;df_impu&quot;</span>), <span class="fu">exists</span>(<span class="st">&quot;time_col&quot;</span>))</span>
<span id="cb130-91"><a href="Modelización.html#cb130-91" tabindex="-1"></a>history_days <span class="ot">&lt;-</span> <span class="dv">21</span></span>
<span id="cb130-92"><a href="Modelización.html#cb130-92" tabindex="-1"></a>hist_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb130-93"><a href="Modelización.html#cb130-93" tabindex="-1"></a>  <span class="at">time =</span> <span class="fu">as.POSIXct</span>(df_impu[[time_col]], <span class="at">tz =</span> TZ),</span>
<span id="cb130-94"><a href="Modelización.html#cb130-94" tabindex="-1"></a>  <span class="at">y    =</span> <span class="fu">as.numeric</span>(df_impu<span class="sc">$</span>val_impu)</span>
<span id="cb130-95"><a href="Modelización.html#cb130-95" tabindex="-1"></a>)</span>
<span id="cb130-96"><a href="Modelización.html#cb130-96" tabindex="-1"></a>t_max <span class="ot">&lt;-</span> <span class="fu">max</span>(hist_df<span class="sc">$</span>time, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb130-97"><a href="Modelización.html#cb130-97" tabindex="-1"></a></span>
<span id="cb130-98"><a href="Modelización.html#cb130-98" tabindex="-1"></a><span class="co"># -------- Construir data frames de pronóstico por modelo (condicional) --------</span></span>
<span id="cb130-99"><a href="Modelización.html#cb130-99" tabindex="-1"></a>fc_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb130-100"><a href="Modelización.html#cb130-100" tabindex="-1"></a></span>
<span id="cb130-101"><a href="Modelización.html#cb130-101" tabindex="-1"></a><span class="co"># SARIMA principal (auto.arima) -&gt; &#39;fc&#39;</span></span>
<span id="cb130-102"><a href="Modelización.html#cb130-102" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc&quot;</span>)) {</span>
<span id="cb130-103"><a href="Modelización.html#cb130-103" tabindex="-1"></a>  fc_list[[<span class="st">&quot;SARIMA (auto.arima)&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">build_fc_df</span>(fc, t_max, <span class="st">&quot;SARIMA (auto.arima)&quot;</span>)</span>
<span id="cb130-104"><a href="Modelización.html#cb130-104" tabindex="-1"></a>}</span>
<span id="cb130-105"><a href="Modelización.html#cb130-105" tabindex="-1"></a></span>
<span id="cb130-106"><a href="Modelización.html#cb130-106" tabindex="-1"></a><span class="co"># ARIMA simple -&gt; &#39;fc_arima_simple&#39;</span></span>
<span id="cb130-107"><a href="Modelización.html#cb130-107" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_arima_simple&quot;</span>)) {</span>
<span id="cb130-108"><a href="Modelización.html#cb130-108" tabindex="-1"></a>  fc_list[[<span class="st">&quot;ARIMA simple&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">build_fc_df</span>(fc_arima_simple, t_max, <span class="st">&quot;ARIMA simple&quot;</span>)</span>
<span id="cb130-109"><a href="Modelización.html#cb130-109" tabindex="-1"></a>}</span>
<span id="cb130-110"><a href="Modelización.html#cb130-110" tabindex="-1"></a></span>
<span id="cb130-111"><a href="Modelización.html#cb130-111" tabindex="-1"></a><span class="co"># HW aditivo -&gt; &#39;fc_hw_add&#39;</span></span>
<span id="cb130-112"><a href="Modelización.html#cb130-112" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_hw_add&quot;</span>)) {</span>
<span id="cb130-113"><a href="Modelización.html#cb130-113" tabindex="-1"></a>  fc_list[[<span class="st">&quot;HW Aditivo&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">build_fc_df</span>(fc_hw_add, t_max, <span class="st">&quot;Holt–Winters (aditivo)&quot;</span>)</span>
<span id="cb130-114"><a href="Modelización.html#cb130-114" tabindex="-1"></a>}</span>
<span id="cb130-115"><a href="Modelización.html#cb130-115" tabindex="-1"></a></span>
<span id="cb130-116"><a href="Modelización.html#cb130-116" tabindex="-1"></a><span class="co"># HW multiplicativo -&gt; &#39;fc_hw_mul&#39;</span></span>
<span id="cb130-117"><a href="Modelización.html#cb130-117" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_hw_mul&quot;</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(fc_hw_mul)) {</span>
<span id="cb130-118"><a href="Modelización.html#cb130-118" tabindex="-1"></a>  fc_list[[<span class="st">&quot;HW Multiplicativo&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">build_fc_df</span>(fc_hw_mul, t_max, <span class="st">&quot;Holt–Winters (multiplicativo)&quot;</span>)</span>
<span id="cb130-119"><a href="Modelización.html#cb130-119" tabindex="-1"></a>}</span>
<span id="cb130-120"><a href="Modelización.html#cb130-120" tabindex="-1"></a></span>
<span id="cb130-121"><a href="Modelización.html#cb130-121" tabindex="-1"></a><span class="co"># HW Box–Cox (aditivo) ya reconvertido (si preparaste df_hw_bc: time/mean/lo80/hi80[/lo95/hi95])</span></span>
<span id="cb130-122"><a href="Modelización.html#cb130-122" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;df_hw_bc&quot;</span>)) {</span>
<span id="cb130-123"><a href="Modelización.html#cb130-123" tabindex="-1"></a>  fc_list[[<span class="st">&quot;HW Box–Cox (aditivo)&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">build_fc_df</span>(df_hw_bc, t_max, <span class="st">&quot;Holt–Winters Box–Cox (aditivo)&quot;</span>)</span>
<span id="cb130-124"><a href="Modelización.html#cb130-124" tabindex="-1"></a>}</span>
<span id="cb130-125"><a href="Modelización.html#cb130-125" tabindex="-1"></a></span>
<span id="cb130-126"><a href="Modelización.html#cb130-126" tabindex="-1"></a><span class="co"># ARIMA en log -&gt; &#39;fc_log&#39; (reconvertimos con expm1)</span></span>
<span id="cb130-127"><a href="Modelización.html#cb130-127" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;fc_log&quot;</span>)) {</span>
<span id="cb130-128"><a href="Modelización.html#cb130-128" tabindex="-1"></a>  fc_list[[<span class="st">&quot;ARIMA (log)&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">build_fc_df</span>(fc_log, t_max, <span class="st">&quot;ARIMA (log → original)&quot;</span>, <span class="at">from_log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb130-129"><a href="Modelización.html#cb130-129" tabindex="-1"></a>}</span>
<span id="cb130-130"><a href="Modelización.html#cb130-130" tabindex="-1"></a></span>
<span id="cb130-131"><a href="Modelización.html#cb130-131" tabindex="-1"></a><span class="co"># -------- Graficar uno por uno (solo los disponibles) --------</span></span>
<span id="cb130-132"><a href="Modelización.html#cb130-132" tabindex="-1"></a><span class="co"># Ajusta y_limits si quieres forzar un rango (p.ej. c(0, 10000)); déjalo NULL para automático</span></span>
<span id="cb130-133"><a href="Modelización.html#cb130-133" tabindex="-1"></a>y_limits <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb130-134"><a href="Modelización.html#cb130-134" tabindex="-1"></a></span>
<span id="cb130-135"><a href="Modelización.html#cb130-135" tabindex="-1"></a><span class="cf">for</span> (nm <span class="cf">in</span> <span class="fu">names</span>(fc_list)) {</span>
<span id="cb130-136"><a href="Modelización.html#cb130-136" tabindex="-1"></a>  <span class="fu">plot_zoom_model</span>(hist_df, fc_list[[nm]],</span>
<span id="cb130-137"><a href="Modelización.html#cb130-137" tabindex="-1"></a>                  <span class="at">title_txt =</span> <span class="fu">paste</span>(<span class="st">&quot;Zoom final del pronóstico —&quot;</span>, nm),</span>
<span id="cb130-138"><a href="Modelización.html#cb130-138" tabindex="-1"></a>                  <span class="at">history_days =</span> history_days,</span>
<span id="cb130-139"><a href="Modelización.html#cb130-139" tabindex="-1"></a>                  <span class="at">y_limits =</span> y_limits,</span>
<span id="cb130-140"><a href="Modelización.html#cb130-140" tabindex="-1"></a>                  <span class="at">breaks_x =</span> <span class="st">&quot;3 days&quot;</span>, <span class="at">fmt_x =</span> <span class="st">&quot;%d-%b&quot;</span>)</span>
<span id="cb130-141"><a href="Modelización.html#cb130-141" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="propuesta-pronostico-subestacion_files/figure-html/zooms-por-modelo-1.png" width="1056" /><img src="propuesta-pronostico-subestacion_files/figure-html/zooms-por-modelo-2.png" width="1056" /><img src="propuesta-pronostico-subestacion_files/figure-html/zooms-por-modelo-3.png" width="1056" /><img src="propuesta-pronostico-subestacion_files/figure-html/zooms-por-modelo-4.png" width="1056" /><img src="propuesta-pronostico-subestacion_files/figure-html/zooms-por-modelo-5.png" width="1056" /><img src="propuesta-pronostico-subestacion_files/figure-html/zooms-por-modelo-6.png" width="1056" /></p>
</div>
<div id="resumen-de-tiempos-de-ejecución-del-código-1" class="section level2 hasAnchor" number="5.15">
<h2><span class="header-section-number">5.15</span> Resumen de tiempos de ejecución del código<a href="Modelización.html#resumen-de-tiempos-de-ejecuci%C3%B3n-del-c%C3%B3digo-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="Modelización.html#cb131-1" tabindex="-1"></a>tabla_tiempos <span class="ot">&lt;-</span> <span class="fu">report_timing_table</span>()</span>
<span id="cb131-2"><a href="Modelización.html#cb131-2" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(tabla_tiempos)) {</span>
<span id="cb131-3"><a href="Modelización.html#cb131-3" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(tabla_tiempos, <span class="at">caption =</span> <span class="st">&quot;Resumen de tiempos por bloque&quot;</span>)</span>
<span id="cb131-4"><a href="Modelización.html#cb131-4" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb131-5"><a href="Modelización.html#cb131-5" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;No se registraron bloques cronometrados.</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb131-6"><a href="Modelización.html#cb131-6" tabindex="-1"></a>}</span></code></pre></div>
<table>
<caption><span id="tab:timing-report1">Table 5.5: </span>Resumen de tiempos por bloque</caption>
<thead>
<tr class="header">
<th align="left">Bloque</th>
<th align="right">Tiempo</th>
<th align="left">Unidad</th>
<th align="left">Estado</th>
<th align="left">Mensaje</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Imputación (na.interp)</td>
<td align="right">0.020</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">ACF/PACF (original)</td>
<td align="right">0.111</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">ACF/PACF (diferenciada)</td>
<td align="right">0.105</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">Ajuste SARIMA + Pronóstico</td>
<td align="right">253.181</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Changepoint</td>
<td align="right">0.017</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">Ajuste SARIMA TS log-transformada</td>
<td align="right">442.243</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">HW - Preprocesamiento</td>
<td align="right">13.801</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">HW - Split TRAIN/TEST</td>
<td align="right">0.967</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">HW - Aditivo y multiplicativo</td>
<td align="right">47.004</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">HW - ARIMA simple</td>
<td align="right">332.070</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">HW - Box-CoX</td>
<td align="right">22.967</td>
<td align="left">s</td>
<td align="left">OK</td>
<td align="left"></td>
</tr>
</tbody>
</table>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="Preprocesamiento.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="Modelos_estacionarios_1.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": false,
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["propuesta-pronostico-subestacion.pdf", "propuesta-pronostico-subestacion.epub"],
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection",
    "toc_depth": 2
  }
});
});
</script>

</body>

</html>
